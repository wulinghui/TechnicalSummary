<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>模板开发 | 资料总结</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="个人资料总结，存放笔记">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.76dfa4dd.css" as="style"><link rel="preload" href="/assets/js/app.7f63dd6c.js" as="script"><link rel="preload" href="/assets/js/2.fe5f2a1d.js" as="script"><link rel="preload" href="/assets/js/3.eb8c603e.js" as="script"><link rel="preload" href="/assets/js/33.05d371fe.js" as="script"><link rel="prefetch" href="/assets/js/10.fe6b23fc.js"><link rel="prefetch" href="/assets/js/100.523c1b31.js"><link rel="prefetch" href="/assets/js/101.bbee1e6c.js"><link rel="prefetch" href="/assets/js/102.36d68ded.js"><link rel="prefetch" href="/assets/js/103.482d8685.js"><link rel="prefetch" href="/assets/js/104.9b20475d.js"><link rel="prefetch" href="/assets/js/105.0edc73b7.js"><link rel="prefetch" href="/assets/js/106.a9abfe31.js"><link rel="prefetch" href="/assets/js/107.2178a4c5.js"><link rel="prefetch" href="/assets/js/108.21d19ed0.js"><link rel="prefetch" href="/assets/js/109.5e1e3698.js"><link rel="prefetch" href="/assets/js/11.7d4a2ffb.js"><link rel="prefetch" href="/assets/js/110.ccc910aa.js"><link rel="prefetch" href="/assets/js/111.fcfd17d0.js"><link rel="prefetch" href="/assets/js/112.f91ccf6e.js"><link rel="prefetch" href="/assets/js/113.5cd28a7e.js"><link rel="prefetch" href="/assets/js/114.4ca8676c.js"><link rel="prefetch" href="/assets/js/115.c4d64d4e.js"><link rel="prefetch" href="/assets/js/116.47ba7426.js"><link rel="prefetch" href="/assets/js/117.3062ccb9.js"><link rel="prefetch" href="/assets/js/118.27991bba.js"><link rel="prefetch" href="/assets/js/119.53538539.js"><link rel="prefetch" href="/assets/js/12.ac798cdb.js"><link rel="prefetch" href="/assets/js/120.e9666755.js"><link rel="prefetch" href="/assets/js/121.73a1660e.js"><link rel="prefetch" href="/assets/js/122.59ac137e.js"><link rel="prefetch" href="/assets/js/123.b9124c91.js"><link rel="prefetch" href="/assets/js/124.12ffcf50.js"><link rel="prefetch" href="/assets/js/125.0403278b.js"><link rel="prefetch" href="/assets/js/126.cec37905.js"><link rel="prefetch" href="/assets/js/127.605a5010.js"><link rel="prefetch" href="/assets/js/128.a4cf61d9.js"><link rel="prefetch" href="/assets/js/129.164a08ce.js"><link rel="prefetch" href="/assets/js/13.8de4385c.js"><link rel="prefetch" href="/assets/js/130.1d4164bd.js"><link rel="prefetch" href="/assets/js/131.7796e583.js"><link rel="prefetch" href="/assets/js/132.c79c715f.js"><link rel="prefetch" href="/assets/js/133.48384f22.js"><link rel="prefetch" href="/assets/js/134.bf85bfff.js"><link rel="prefetch" href="/assets/js/135.1244d4cb.js"><link rel="prefetch" href="/assets/js/136.6650b052.js"><link rel="prefetch" href="/assets/js/137.e9f394e2.js"><link rel="prefetch" href="/assets/js/138.ae16527d.js"><link rel="prefetch" href="/assets/js/139.df1c969c.js"><link rel="prefetch" href="/assets/js/14.d82e6d84.js"><link rel="prefetch" href="/assets/js/140.a80aa424.js"><link rel="prefetch" href="/assets/js/141.10ab646d.js"><link rel="prefetch" href="/assets/js/142.508278ee.js"><link rel="prefetch" href="/assets/js/143.62aa16a7.js"><link rel="prefetch" href="/assets/js/144.c734b314.js"><link rel="prefetch" href="/assets/js/145.7dae44b0.js"><link rel="prefetch" href="/assets/js/146.b08fb7ab.js"><link rel="prefetch" href="/assets/js/147.6fee9f53.js"><link rel="prefetch" href="/assets/js/148.5a09fe8b.js"><link rel="prefetch" href="/assets/js/149.27046d2c.js"><link rel="prefetch" href="/assets/js/15.f0dc0e66.js"><link rel="prefetch" href="/assets/js/150.c05ae37c.js"><link rel="prefetch" href="/assets/js/151.57194eb1.js"><link rel="prefetch" href="/assets/js/152.bc7ad385.js"><link rel="prefetch" href="/assets/js/153.b3c7d891.js"><link rel="prefetch" href="/assets/js/154.0d3a00e5.js"><link rel="prefetch" href="/assets/js/155.b9afdc01.js"><link rel="prefetch" href="/assets/js/156.bfc71798.js"><link rel="prefetch" href="/assets/js/157.43852835.js"><link rel="prefetch" href="/assets/js/158.785caaa2.js"><link rel="prefetch" href="/assets/js/159.1716fd78.js"><link rel="prefetch" href="/assets/js/16.1217969a.js"><link rel="prefetch" href="/assets/js/160.54dfc0be.js"><link rel="prefetch" href="/assets/js/161.3a486b71.js"><link rel="prefetch" href="/assets/js/162.4365dac4.js"><link rel="prefetch" href="/assets/js/163.9e0305ed.js"><link rel="prefetch" href="/assets/js/164.9af7099c.js"><link rel="prefetch" href="/assets/js/165.07230640.js"><link rel="prefetch" href="/assets/js/166.a13e993d.js"><link rel="prefetch" href="/assets/js/167.233c305e.js"><link rel="prefetch" href="/assets/js/168.86996235.js"><link rel="prefetch" href="/assets/js/169.c643487c.js"><link rel="prefetch" href="/assets/js/17.65771bc0.js"><link rel="prefetch" href="/assets/js/170.fed7e19e.js"><link rel="prefetch" href="/assets/js/171.a191947e.js"><link rel="prefetch" href="/assets/js/172.a2368c89.js"><link rel="prefetch" href="/assets/js/173.aad8acd6.js"><link rel="prefetch" href="/assets/js/174.e5c4e9f4.js"><link rel="prefetch" href="/assets/js/175.ef19ddcf.js"><link rel="prefetch" href="/assets/js/176.7b8490c3.js"><link rel="prefetch" href="/assets/js/177.7d1f01a3.js"><link rel="prefetch" href="/assets/js/178.c5ea1f87.js"><link rel="prefetch" href="/assets/js/179.e54bc218.js"><link rel="prefetch" href="/assets/js/18.69d253af.js"><link rel="prefetch" href="/assets/js/180.a0fc0bcd.js"><link rel="prefetch" href="/assets/js/181.8029f765.js"><link rel="prefetch" href="/assets/js/182.72075fe8.js"><link rel="prefetch" href="/assets/js/183.f74d77ba.js"><link rel="prefetch" href="/assets/js/184.3277cbcd.js"><link rel="prefetch" href="/assets/js/185.15940a23.js"><link rel="prefetch" href="/assets/js/186.810a303a.js"><link rel="prefetch" href="/assets/js/187.9c8777f6.js"><link rel="prefetch" href="/assets/js/188.fed55d48.js"><link rel="prefetch" href="/assets/js/189.7f09c5db.js"><link rel="prefetch" href="/assets/js/19.87ab5597.js"><link rel="prefetch" href="/assets/js/190.082d7cbc.js"><link rel="prefetch" href="/assets/js/191.9fb2ec38.js"><link rel="prefetch" href="/assets/js/192.167d2083.js"><link rel="prefetch" href="/assets/js/193.d1eeb947.js"><link rel="prefetch" href="/assets/js/194.09e61c12.js"><link rel="prefetch" href="/assets/js/195.969efb5f.js"><link rel="prefetch" href="/assets/js/196.3932e830.js"><link rel="prefetch" href="/assets/js/197.1dc355f6.js"><link rel="prefetch" href="/assets/js/198.1ad8dbbf.js"><link rel="prefetch" href="/assets/js/199.c6b23b90.js"><link rel="prefetch" href="/assets/js/20.3d741608.js"><link rel="prefetch" href="/assets/js/200.81a125db.js"><link rel="prefetch" href="/assets/js/201.5e2fd593.js"><link rel="prefetch" href="/assets/js/202.51a3fbc4.js"><link rel="prefetch" href="/assets/js/203.4ae7c4f4.js"><link rel="prefetch" href="/assets/js/204.5ba79932.js"><link rel="prefetch" href="/assets/js/205.05bb64e4.js"><link rel="prefetch" href="/assets/js/206.c1d5472b.js"><link rel="prefetch" href="/assets/js/207.ad43feb1.js"><link rel="prefetch" href="/assets/js/208.250144c5.js"><link rel="prefetch" href="/assets/js/209.41667b8a.js"><link rel="prefetch" href="/assets/js/21.23841fc1.js"><link rel="prefetch" href="/assets/js/210.b85ec988.js"><link rel="prefetch" href="/assets/js/211.8f2f9335.js"><link rel="prefetch" href="/assets/js/212.dea21e7c.js"><link rel="prefetch" href="/assets/js/213.9074d848.js"><link rel="prefetch" href="/assets/js/214.baaf02d5.js"><link rel="prefetch" href="/assets/js/215.e3149f2c.js"><link rel="prefetch" href="/assets/js/216.5ede3f02.js"><link rel="prefetch" href="/assets/js/217.06eb8901.js"><link rel="prefetch" href="/assets/js/218.ffe5fc66.js"><link rel="prefetch" href="/assets/js/219.69c6166f.js"><link rel="prefetch" href="/assets/js/22.b55e8e09.js"><link rel="prefetch" href="/assets/js/220.a83c1ecf.js"><link rel="prefetch" href="/assets/js/221.fb65c799.js"><link rel="prefetch" href="/assets/js/222.1ff261ff.js"><link rel="prefetch" href="/assets/js/223.807c2de7.js"><link rel="prefetch" href="/assets/js/224.33540594.js"><link rel="prefetch" href="/assets/js/225.21d88d75.js"><link rel="prefetch" href="/assets/js/226.00d419d7.js"><link rel="prefetch" href="/assets/js/227.19678a11.js"><link rel="prefetch" href="/assets/js/228.d09fe33c.js"><link rel="prefetch" href="/assets/js/229.c8dcc95e.js"><link rel="prefetch" href="/assets/js/23.d7449079.js"><link rel="prefetch" href="/assets/js/230.7477ad3f.js"><link rel="prefetch" href="/assets/js/231.f1013950.js"><link rel="prefetch" href="/assets/js/232.1e07d0e6.js"><link rel="prefetch" href="/assets/js/233.34e0f2b8.js"><link rel="prefetch" href="/assets/js/234.645446d8.js"><link rel="prefetch" href="/assets/js/235.3368fdbc.js"><link rel="prefetch" href="/assets/js/236.35ed0de0.js"><link rel="prefetch" href="/assets/js/237.4a189e89.js"><link rel="prefetch" href="/assets/js/238.d6580ef3.js"><link rel="prefetch" href="/assets/js/239.c518fd70.js"><link rel="prefetch" href="/assets/js/24.26f18aa6.js"><link rel="prefetch" href="/assets/js/240.14979636.js"><link rel="prefetch" href="/assets/js/241.95c3b00d.js"><link rel="prefetch" href="/assets/js/242.a214e307.js"><link rel="prefetch" href="/assets/js/243.273af8d4.js"><link rel="prefetch" href="/assets/js/244.e2d74303.js"><link rel="prefetch" href="/assets/js/245.fe562cb9.js"><link rel="prefetch" href="/assets/js/246.b40011af.js"><link rel="prefetch" href="/assets/js/247.dc1a9aae.js"><link rel="prefetch" href="/assets/js/248.d691ac20.js"><link rel="prefetch" href="/assets/js/249.191f742a.js"><link rel="prefetch" href="/assets/js/25.198594bf.js"><link rel="prefetch" href="/assets/js/250.205b92cf.js"><link rel="prefetch" href="/assets/js/251.acb8a80e.js"><link rel="prefetch" href="/assets/js/26.c817356c.js"><link rel="prefetch" href="/assets/js/27.6b812306.js"><link rel="prefetch" href="/assets/js/28.9048721b.js"><link rel="prefetch" href="/assets/js/29.bfda8510.js"><link rel="prefetch" href="/assets/js/30.eb1b6ab9.js"><link rel="prefetch" href="/assets/js/31.3f3dbd2f.js"><link rel="prefetch" href="/assets/js/32.006bc754.js"><link rel="prefetch" href="/assets/js/34.27cd6ff5.js"><link rel="prefetch" href="/assets/js/35.35409a6d.js"><link rel="prefetch" href="/assets/js/36.fd6a950b.js"><link rel="prefetch" href="/assets/js/37.c8fd6ef4.js"><link rel="prefetch" href="/assets/js/38.028a36a2.js"><link rel="prefetch" href="/assets/js/39.e4494792.js"><link rel="prefetch" href="/assets/js/4.ff2df22c.js"><link rel="prefetch" href="/assets/js/40.979dec53.js"><link rel="prefetch" href="/assets/js/41.ff9662db.js"><link rel="prefetch" href="/assets/js/42.5c1441fc.js"><link rel="prefetch" href="/assets/js/43.9657eae8.js"><link rel="prefetch" href="/assets/js/44.a6cb5e5c.js"><link rel="prefetch" href="/assets/js/45.c675440c.js"><link rel="prefetch" href="/assets/js/46.06205970.js"><link rel="prefetch" href="/assets/js/47.ded0c65e.js"><link rel="prefetch" href="/assets/js/48.296a6f26.js"><link rel="prefetch" href="/assets/js/49.1b2ec2ab.js"><link rel="prefetch" href="/assets/js/5.ecde23f9.js"><link rel="prefetch" href="/assets/js/50.e551e67f.js"><link rel="prefetch" href="/assets/js/51.122d5b68.js"><link rel="prefetch" href="/assets/js/52.c0444208.js"><link rel="prefetch" href="/assets/js/53.f47d6b86.js"><link rel="prefetch" href="/assets/js/54.e9c9b41b.js"><link rel="prefetch" href="/assets/js/55.77010c1f.js"><link rel="prefetch" href="/assets/js/56.387aacbb.js"><link rel="prefetch" href="/assets/js/57.ddcf78ad.js"><link rel="prefetch" href="/assets/js/58.908b88fc.js"><link rel="prefetch" href="/assets/js/59.8ff535f1.js"><link rel="prefetch" href="/assets/js/6.b928f1b9.js"><link rel="prefetch" href="/assets/js/60.c5018386.js"><link rel="prefetch" href="/assets/js/61.1514e08b.js"><link rel="prefetch" href="/assets/js/62.79bc9197.js"><link rel="prefetch" href="/assets/js/63.a6cb5e14.js"><link rel="prefetch" href="/assets/js/64.f149661c.js"><link rel="prefetch" href="/assets/js/65.30fa2026.js"><link rel="prefetch" href="/assets/js/66.e7f9f54e.js"><link rel="prefetch" href="/assets/js/67.7361f4a3.js"><link rel="prefetch" href="/assets/js/68.b67cc099.js"><link rel="prefetch" href="/assets/js/69.ba730416.js"><link rel="prefetch" href="/assets/js/7.b0514d37.js"><link rel="prefetch" href="/assets/js/70.45b9e858.js"><link rel="prefetch" href="/assets/js/71.2055eaae.js"><link rel="prefetch" href="/assets/js/72.75ec1304.js"><link rel="prefetch" href="/assets/js/73.3aa09b6b.js"><link rel="prefetch" href="/assets/js/74.fb3013f1.js"><link rel="prefetch" href="/assets/js/75.c837c896.js"><link rel="prefetch" href="/assets/js/76.9e6df886.js"><link rel="prefetch" href="/assets/js/77.4eb09ab0.js"><link rel="prefetch" href="/assets/js/78.06d19c8c.js"><link rel="prefetch" href="/assets/js/79.dfde586d.js"><link rel="prefetch" href="/assets/js/8.f86f2563.js"><link rel="prefetch" href="/assets/js/80.476da6d1.js"><link rel="prefetch" href="/assets/js/81.2b778375.js"><link rel="prefetch" href="/assets/js/82.abbf449f.js"><link rel="prefetch" href="/assets/js/83.24b0e8ea.js"><link rel="prefetch" href="/assets/js/84.f8694c96.js"><link rel="prefetch" href="/assets/js/85.f030e8b6.js"><link rel="prefetch" href="/assets/js/86.18853c72.js"><link rel="prefetch" href="/assets/js/87.4eca3df6.js"><link rel="prefetch" href="/assets/js/88.26b81c78.js"><link rel="prefetch" href="/assets/js/89.ae216049.js"><link rel="prefetch" href="/assets/js/9.7a3e1618.js"><link rel="prefetch" href="/assets/js/90.b0ee8ab4.js"><link rel="prefetch" href="/assets/js/91.a07b34f1.js"><link rel="prefetch" href="/assets/js/92.1c2952b1.js"><link rel="prefetch" href="/assets/js/93.e199901d.js"><link rel="prefetch" href="/assets/js/94.a901578c.js"><link rel="prefetch" href="/assets/js/95.641f6644.js"><link rel="prefetch" href="/assets/js/96.84a54aa3.js"><link rel="prefetch" href="/assets/js/97.c489ec61.js"><link rel="prefetch" href="/assets/js/98.5fb17174.js"><link rel="prefetch" href="/assets/js/99.c004152a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.76dfa4dd.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="资料总结" class="logo"> <span class="site-name can-hide">资料总结</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/goVersion181/" class="nav-link">go</a></div><div class="nav-item"><a href="/pages/springFramework/" class="nav-link">java</a></div><div class="nav-item"><a href="/pages/e5d517/" class="nav-link">云原生</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/pages/410b25/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/00291d/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/pages/846ee6/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/pages/5465c3/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/853b5b/" class="nav-link">设计模式详解</a></li><li class="dropdown-item"><!----> <a href="/pages/ebc515/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/pages/57778e/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/pages/282cd0/" class="nav-link">项目</a></li><li class="dropdown-item"><!----> <a href="/pages/2cd810/" class="nav-link">理论基础</a></li><li class="dropdown-item"><!----> <a href="/pages/6acd46/" class="nav-link">运营</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/wulinghui/TechnicalSummary" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src=""> <div class="blogger-info"><h3>linghui Wu</h3> <span>一只努力学飞的鱼</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/goVersion181/" class="nav-link">go</a></div><div class="nav-item"><a href="/pages/springFramework/" class="nav-link">java</a></div><div class="nav-item"><a href="/pages/e5d517/" class="nav-link">云原生</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/pages/410b25/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/00291d/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/pages/846ee6/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/pages/5465c3/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/853b5b/" class="nav-link">设计模式详解</a></li><li class="dropdown-item"><!----> <a href="/pages/ebc515/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/pages/57778e/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/pages/282cd0/" class="nav-link">项目</a></li><li class="dropdown-item"><!----> <a href="/pages/2cd810/" class="nav-link">理论基础</a></li><li class="dropdown-item"><!----> <a href="/pages/6acd46/" class="nav-link">运营</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/wulinghui/TechnicalSummary" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/e5d517/" class="sidebar-link">01-云原生概念</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>k8s</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/517943/" class="sidebar-link">基础介绍</a></li><li><a href="/pages/c1223e/" class="sidebar-link">安装</a></li><li><a href="/pages/6ed476/" class="sidebar-link">命令详解</a></li><li><a href="/pages/a11481/" class="sidebar-link">Pod配置以及生命周期</a></li><li><a href="/pages/ad6362/" class="sidebar-link">Pod调度</a></li><li><a href="/pages/eed6b8/" class="sidebar-link">Pod控制器</a></li><li><a href="/pages/49c21a/" class="sidebar-link">Service详解</a></li><li><a href="/pages/7a877a/" class="sidebar-link">数据存储</a></li><li><a href="/pages/33d194/" class="sidebar-link">安全</a></li><li><a href="/pages/29fa5c/" class="sidebar-link">网络</a></li><li><a href="/pages/97cddc/" class="sidebar-link">调度框架</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Helm包管理</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/0d135c/" class="sidebar-link">初步使用</a></li><li><a href="/pages/db70b4/" class="sidebar-link">Charts</a></li><li><a href="/pages/425e64/" aria-current="page" class="active sidebar-link">模板开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/425e64/#_1-内置对象" class="sidebar-link">1. 内置对象</a></li><li class="sidebar-sub-header level2"><a href="/pages/425e64/#_2-values-文件" class="sidebar-link">2. Values 文件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_2-1-删除默认-key" class="sidebar-link">2.1 删除默认 KEY</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/425e64/#_3-函数和管道" class="sidebar-link">3. 函数和管道</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_3-1-管道" class="sidebar-link">3.1 管道</a></li><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_3-2-default-函数" class="sidebar-link">3.2 default 函数</a></li><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_3-3-运算符函数" class="sidebar-link">3.3 运算符函数</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/425e64/#_4-流程控制" class="sidebar-link">4. 流程控制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_4-1-if-else" class="sidebar-link">4.1 if/else</a></li><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_4-2-空格控制" class="sidebar-link">4.2 空格控制</a></li><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_4-3-使用-with-修改作用域" class="sidebar-link">4.3 使用 with 修改作用域</a></li><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_4-4-range-循环操作" class="sidebar-link">4.4 range 循环操作</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/425e64/#_5-变量" class="sidebar-link">5. 变量</a></li><li class="sidebar-sub-header level2"><a href="/pages/425e64/#_6-命名模板" class="sidebar-link">6. 命名模板</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_6-1-partials-和-文件" class="sidebar-link">6.1 partials 和 _ 文件</a></li><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_6-2-define和-template" class="sidebar-link">6.2 define和 template</a></li><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_6-3-设置模板范围" class="sidebar-link">6.3 设置模板范围</a></li><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_6-4-include-函数" class="sidebar-link">6.4 include 函数</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/425e64/#_7-访问文件" class="sidebar-link">7. 访问文件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_7-1-基本示例" class="sidebar-link">7.1 基本示例</a></li><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_7-2-glob-模式" class="sidebar-link">7.2 Glob 模式</a></li><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_7-3-configmap-和-secrets" class="sidebar-link">7.3 ConfigMap 和 Secrets</a></li><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_7-4-编码" class="sidebar-link">7.4 编码</a></li><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_7-5-lines" class="sidebar-link">7.5 Lines</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/425e64/#_8-notes-txt-文件" class="sidebar-link">8. NOTES.txt 文件</a></li><li class="sidebar-sub-header level2"><a href="/pages/425e64/#_9-subcharts-和-global-values" class="sidebar-link">9. Subcharts 和 Global Values</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_9-1-创建子chart" class="sidebar-link">9.1 创建子chart</a></li><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_9-2-添加-values-和-模板" class="sidebar-link">9.2 添加 values 和 模板</a></li><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_9-3-从父-chart-覆盖-values" class="sidebar-link">9.3 从父 chart 覆盖 values</a></li><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_9-4-全局值" class="sidebar-link">9.4 全局值</a></li><li class="sidebar-sub-header level3"><a href="/pages/425e64/#_9-5-共享模板" class="sidebar-link">9.5 共享模板</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/425e64/#_10-模板调试" class="sidebar-link">10. 模板调试</a></li></ul></li><li><a href="/pages/9cf826/" class="sidebar-link">Chart Hooks</a></li><li><a href="/pages/8008ac/" class="sidebar-link">创建一个chart</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>k8s实战部署</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/pages/7322db/" class="sidebar-link">总结-实战与基本原理</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>监控</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>日志</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DevOps</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ServiceMesh</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/pages/076b5d/" class="sidebar-link">Knative</a></li><li><a href="/pages/6d3863/" class="sidebar-link">spring-cloud-kubernetes</a></li><li><a href="/pages/cb6fc2/" class="sidebar-link">ms总结</a></li><li><a href="/pages/fff88c/" class="sidebar-link">架构升级踩坑之路</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/categories/?category=Kubernetes" title="分类" data-v-06970110>Kubernetes</a></li><li data-v-06970110><a href="/categories/?category=k8s" title="分类" data-v-06970110>k8s</a></li><li data-v-06970110><a href="/categories/?category=Helm%E5%8C%85%E7%AE%A1%E7%90%86" title="分类" data-v-06970110>Helm包管理</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://gitee.com/hellowllh/projects" target="_blank" title="作者" class="beLink" data-v-06970110>wulinghui</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2023-01-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">模板开发<!----></h1>  <div class="theme-vdoing-content content__default"><div><h1 id="模板开发"><a class="header-anchor" href="#模板开发">#</a> 模板开发</h1> <h2 id="_1-内置对象"><a class="header-anchor" href="#_1-内置对象">#</a> 1. 内置对象</h2> <p>前面我们介绍了 Helm Chart 的一些基本概念和使用,接下来我们重点介绍下 Chart 模板的编写。模板会渲染成 Kubernetes 的资源清单文件。</p> <p>前面提到过我们可以在模板中使用 <code>{{ .Release.Name }}</code> 获取 release 的名称,Release 是我们可以在模板中访问的几个顶级对象之一：</p> <ul><li><code>Release</code>：该对象描述了 release 本身的相关信息,它内部有几个对象：
<ul><li><code>Release.Name</code>：release 名称</li> <li><code>Release.Namespace</code>：release 安装到的命名空间</li> <li><code>Release.IsUpgrade</code>：如果当前操作是升级或回滚,则该值为 true</li> <li><code>Release.IsInstall</code>：如果当前操作是安装,则将其设置为 true</li> <li><code>Release.Revision</code>：release 的 revision 版本号,在安装的时候,值为1,每次升级或回滚都会增加</li> <li><code>Reelase.Service</code>：渲染当前模板的服务,在 Helm 上,实际上该值始终为 Helm</li></ul></li> <li><code>Values</code>：从 <code>values.yaml</code> 文件和用户提供的 values 文件传递到模板的 Values 值,默认情况下,Values 是空的。</li> <li><code>Chart</code>：获取 <code>Chart.yaml</code> 文件的内容,该文件中的任何数据都可以访问,例如 <code>{{ .Chart.Name }}-{{ .Chart.Version}}</code> 可以渲染成 <code>mychart-0.1.0</code>,该对象下面可用的字段前面我们已经提到过了。</li> <li><code>Files</code>：可以访问 chart 中的所有非特殊文件,虽然无法使用它来访问模板文件,但是可以来访问 chart 中的其他文件。
<ul><li><code>Files.Get</code>：用于根据名称获取文件（比如 <code>.Files.Get config.ini</code>）</li> <li><code>Files.GetBytes</code>：用于以 bytes 数组而不是字符串的形式来获取文件内容的函数,这对于类似于图片之类的东西很有用</li> <li><code>Files.Glob</code>：用于返回名称于给定的 shell glob 模式匹配的文件列表</li> <li><code>Files.Lines</code>：可以逐行读取文件的函数,对于遍历文件中的每行内容很有用</li> <li><code>Files.AsSecrets</code>：将文件内容以 Base64 编码的字符串返回的函数</li> <li><code>Files.AsConfig</code>：将文件正文作为 YAML 字典返回的函数</li></ul></li> <li><code>Capabilities</code>：提供了获取有关 Kubernetes 集群支持功能的信息的对象
<ul><li><code>Capabilities.APIVersions</code>：支持的版本集合</li> <li><code>Capabilities.APIVersions.Has $version</code>：判断一个版本（比如 <code>batch/v1</code>）或资源（比如 <code>apps/v1/Deployment</code>）是否可用</li> <li><code>Capabilities.Kube.Version</code>：Kubernetes 的版本</li> <li><code>Capabilities.Kube</code>：是 Kubernetes 版本的缩写</li> <li><code>Capabilities.Kube.Major</code>：Kubernetes 主版本</li> <li><code>Capabilities.Kube.Minor</code>：Kubernetes 的次版本</li></ul></li> <li><code>Template</code>：包含当前正在执行的模板的相关信息
<ul><li><code>Name</code>：当前模板的命名空间文件路径（比如 <code>mychart/templates/mytemplate.yaml</code>）</li> <li><code>BaePath</code>：当前 chart 的模板目录的命名空间路径（比如 <code>mychart/templates</code>）</li></ul></li></ul> <p>需要注意的是内置的对象始终是以大写字母开头的,这也是符合 Go 的命名约定的,创建自己的名称的时候,可以自由使用以适合你团队的约定,一些团队,比如 Kubernetes Charts 团队,选择仅使用首字母小写,以区分本地名称和内置名称,这里我们也会遵循该约定。</p> <h2 id="_2-values-文件"><a class="header-anchor" href="#_2-values-文件">#</a> 2. Values 文件</h2> <p>前面我们介绍了 Helm 模板提供的内置对象,其中就有一个内置对象 <code>Values</code>,该对象提供对传递到 chart 中的 values 值的访问,其内容主要有4个来源：</p> <ul><li>chart 文件中的 <code>values.yaml</code> 文件</li> <li>如果这是子 chart,父 chart 的 <code>values.yaml</code> 文件</li> <li>用 <code>-f</code> 参数传递给 <code>helm install</code> 或 <code>helm upgrade</code> 的 values 值文件（例如 <code>helm install -f myvals.yaml ./mychart</code>）</li> <li>用 <code>--set</code> 传递的各个参数（例如 <code>helm install --set foo=bar ./mychart</code>）</li></ul> <p><code>values.yaml</code> 文件是默认值,可以被父 chart 的 <code>values.yaml</code> 文件覆盖,而后者又可以由用户提供的 values 值文件覆盖,而该文件又可以被 <code>--set</code> 参数覆盖。</p> <p>values 值文件是纯 YAML 文件,我们可以来编辑 <code>mychart/values.yaml</code> 文件然后编辑 <code>ConfigMap</code> 模板。删除 <code>values.yaml</code> 中的默认设置后,我们将只设置一个参数：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">favoriteDrink</span><span class="token punctuation">:</span> coffee
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在我们可以在模板中直接使用它：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favoriteDrink <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>可以看到在最后一行我们将 <code>favoriteDrink</code> 作为 <code>Values</code> 的属性进行访问：<code>{{ .Values.favoriteDrink }}</code>。我们可以来看看是如何渲染的：</p> <div class="language-shell line-numbers-mode"><pre v-pre="" class="language-shell"><code><span class="token punctuation">[</span>root@master helm<span class="token punctuation">]</span><span class="token comment"># helm install --generate-name --dry-run --debug ./mychart</span>
install.go:178: <span class="token punctuation">[</span>debug<span class="token punctuation">]</span> Original chart version: <span class="token string">&quot;&quot;</span>
install.go:195: <span class="token punctuation">[</span>debug<span class="token punctuation">]</span> CHART <span class="token environment constant">PATH</span><span class="token builtin class-name">:</span> /mnt/k8s/helm/mychart

NAME: mychart-1663567115
LAST DEPLOYED: Mon Sep <span class="token number">19</span> <span class="token number">13</span>:58:35 <span class="token number">2022</span>
NAMESPACE: default
STATUS: pending-install
REVISION: <span class="token number">1</span>
<span class="token environment constant">USER</span>-SUPPLIED VALUES:
<span class="token punctuation">{</span><span class="token punctuation">}</span>

COMPUTED VALUES:
affinity: <span class="token punctuation">{</span><span class="token punctuation">}</span>
HOOKS:
---
<span class="token comment"># Source: mychart/templates/configmap.yaml</span>
apiVersion: v1
kind: ConfigMap
metadata:
  name: mychart-1663567115-configmap
data:
  myvalue: <span class="token string">&quot;Hello World&quot;</span>
  drink: coffee
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>由于在默认的 <code>values.yaml</code> 文件中将 favoriteDrink 设置为了 coffee,所以这就是模板中显示的值,我们可以通过在调用 <code>helm install</code> 的过程中添加 <code>--set</code> 参数来覆盖它：</p> <div class="language-shell line-numbers-mode"><pre v-pre="" class="language-shell"><code><span class="token punctuation">[</span>root@master helm<span class="token punctuation">]</span><span class="token comment"># helm install --generate-name --dry-run --debug --set favoriteDrink=slurm ./mychart</span>
install.go:178: <span class="token punctuation">[</span>debug<span class="token punctuation">]</span> Original chart version: <span class="token string">&quot;&quot;</span>
install.go:195: <span class="token punctuation">[</span>debug<span class="token punctuation">]</span> CHART <span class="token environment constant">PATH</span><span class="token builtin class-name">:</span> /mnt/k8s/helm/mychart

NAME: mychart-1663567182
LAST DEPLOYED: Mon Sep <span class="token number">19</span> <span class="token number">13</span>:59:42 <span class="token number">2022</span>
NAMESPACE: default
STATUS: pending-install
REVISION: <span class="token number">1</span>
<span class="token environment constant">USER</span>-SUPPLIED VALUES:
favoriteDrink: slurm

COMPUTED VALUES:
affinity: <span class="token punctuation">{</span><span class="token punctuation">}</span>
autoscaling:
  enabled: <span class="token boolean">false</span>
  maxReplicas: <span class="token number">100</span>
  minReplicas: <span class="token number">1</span>
  targetCPUUtilizationPercentage: <span class="token number">80</span>
favoriteDrink: slurm
fullnameOverride: <span class="token string">&quot;&quot;</span>
image:
---
<span class="token comment"># Source: mychart/templates/configmap.yaml</span>
apiVersion: v1
kind: ConfigMap
metadata:
  name: mychart-1663567182-configmap
data:
  myvalue: <span class="token string">&quot;Hello World&quot;</span>
  drink: slurm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>因为 <code>--set</code> 的优先级高于默认的 <code>values.yaml</code> 文件,所以我们的模板会生成 <code>drink: slurm</code>。Values 值文件也可以包含更多结构化的内容,例如我们可以在 <code>values.yaml</code> 文件中创建一个 favorite 的部分,然后在其中添加几个 keys：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">favorite</span><span class="token punctuation">:</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> coffee
  <span class="token key atrule">food</span><span class="token punctuation">:</span> pizza
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>现在我们再去修改下我们的模板：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.drink <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.food <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_2-1-删除默认-key"><a class="header-anchor" href="#_2-1-删除默认-key">#</a> 2.1 删除默认 KEY</h3> <p>如果你需要从默认值中删除 key,则可以将该 key 的值覆盖为 null,在这种情况下,Helm 将从覆盖的 values 中删除该 key。例如,在 Drupal chart 中配置一个 liveness 探针:</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
  <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /user/login
    <span class="token key atrule">port</span><span class="token punctuation">:</span> http
  <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">120</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如果你想使用 <code>--set livenessProbe.exec.command=[cat, docroot/CHANGELOG.txt]</code> 将 livenessProbe 的处理程序覆盖为 <code>exec</code> 而不是 <code>httpGet</code>,则 Helm 会将默认键和覆盖键合并在一起,如下所示：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
  <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /user/login
    <span class="token key atrule">port</span><span class="token punctuation">:</span> http
  <span class="token key atrule">exec</span><span class="token punctuation">:</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> cat
    <span class="token punctuation">-</span> docroot/CHANGELOG.txt
  <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">120</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>但是,这样却有一个问题,因为你不能声明多个 livenessProbe 处理程序,为了解决这个问题,你可以让 Helm 通过将 <code>livenessProbe.httpGet</code> 设置为 null 来删除它：</p> <div class="language-shell line-numbers-mode"><pre v-pre="" class="language-shell"><code>$ helm <span class="token function">install</span> stable/drupal <span class="token parameter variable">--set</span> <span class="token assign-left variable">image</span><span class="token operator">=</span>my-registry/drupal:0.1.0 <span class="token parameter variable">--set</span> <span class="token assign-left variable">livenessProbe.exec.command</span><span class="token operator">=</span><span class="token punctuation">[</span>cat, docroot/CHANGELOG.txt<span class="token punctuation">]</span> <span class="token parameter variable">--set</span> <span class="token assign-left variable">livenessProbe.httpGet</span><span class="token operator">=</span>null
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>到这里我们已经了解到了几个内置对象,并利用它们将信息注入到了模板中,现在我们来看看模板引擎的另外方面：函数和管道。</p> <h2 id="_3-函数和管道"><a class="header-anchor" href="#_3-函数和管道">#</a> 3. 函数和管道</h2> <p>现在我们已经了解了如何将信息加入到模板中,但是这些信息都是直接原样的放置过去的,有时候,我们希望以一种对我们更有用的方式来转换提供的数据。</p> <p>下面让我们从一个最佳实践开始：将 <code>.Values</code> 对象中的字符串注入模板时,我们应该引用这些字符串,我们可以通过在 template 指令中调用 <code>quote</code> 函数来实现,比如：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> quote .Values.favorite.drink <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> quote .Values.favorite.food <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>模板函数遵循的语法规则是 <code>functionName arg1 arg2...</code>,在上面的代码片段中,<code>quote .Values.favorite.drink</code> 会调用 <code>quote</code> 函数并传递一个单个参数。</p> <p>Helm 有60多种可用的函数,其中一些是由 <a href="https://godoc.org/text/template" target="_blank" rel="noopener noreferrer">Go 模板语言<OutboundLink></OutboundLink></a>本身定义的,其他大多数都是 <a href="https://masterminds.github.io/sprig/" target="_blank" rel="noopener noreferrer">Sprig 模板库<OutboundLink></OutboundLink></a>提供的,接下来我们会通过部分示例来逐步介绍其中的一些功能函数。</p> <blockquote><p>当我们谈论 <code>Helm 模板语言</code> 的时候,就好像是特定于 Helm 一样,但实际上它是 Go 模板语言加上一些额外的函数以及各种封装程序的组合,以将某些对象暴露给模板。当我们需要学习模板的时候,Go 模板上有许多资源会对我们有所帮助的。</p></blockquote> <h3 id="_3-1-管道"><a class="header-anchor" href="#_3-1-管道">#</a> 3.1 管道</h3> <p>模板语言有一个强大的功能就是**管道（Pipeline）**概念,管道利用 UNIX 的概念,将一系列模板命令链接在一起,一起对外提供服务,换句话说,管道是按顺序完成多项工作的有效方式,我们来使用管道重写上面的示例模板：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.drink <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.food <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在这里我们没有调用 <code>quote ARGUMENT</code> 函数,而是颠倒了下顺序,我们使用管道符（|）将参数<strong>发送</strong>给函数：<code>.Values.favorite.drink | quote</code>,使用管道,我们可以将多个功能链接在一起：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.drink <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.food <span class="token punctuation">|</span> upper <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><blockquote><p>反转顺序是模板中常见的做法,我们会看到 <code>.val | quote</code> 比 <code>quote .val</code> 用法更多,虽然两种方法都是可以的。</p></blockquote> <p>最后,模板渲染后,会产生如下所示的结果：</p> <div class="language-shell line-numbers-mode"><pre v-pre="" class="language-shell"><code><span class="token punctuation">[</span>root@master helm<span class="token punctuation">]</span><span class="token comment"># helm install --generate-name --dry-run --debug ./mychart</span>
install.go:178: <span class="token punctuation">[</span>debug<span class="token punctuation">]</span> Original chart version: <span class="token string">&quot;&quot;</span>
install.go:195: <span class="token punctuation">[</span>debug<span class="token punctuation">]</span> CHART <span class="token environment constant">PATH</span><span class="token builtin class-name">:</span> /mnt/k8s/helm/mychart

NAME: mychart-1663567467
LAST DEPLOYED: Mon Sep <span class="token number">19</span> <span class="token number">14</span>:04:27 <span class="token number">2022</span>
NAMESPACE: default
STATUS: pending-install
REVISION: <span class="token number">1</span>
<span class="token environment constant">USER</span>-SUPPLIED VALUES:
<span class="token punctuation">{</span><span class="token punctuation">}</span>

COMPUTED VALUES:
affinity: <span class="token punctuation">{</span><span class="token punctuation">}</span>
autoscaling:
  enabled: <span class="token boolean">false</span>
  maxReplicas: <span class="token number">100</span>
  minReplicas: <span class="token number">1</span>
  targetCPUUtilizationPercentage: <span class="token number">80</span>
favorite:
  drink: coffee
  food: pizza
favoriteDrink: coffee
fullnameOverride: <span class="token string">&quot;&quot;</span>
---
<span class="token comment"># Source: mychart/templates/configmap.yaml</span>
apiVersion: v1
kind: ConfigMap
metadata:
  name: mychart-1663567467-configmap
data:
  myvalue: <span class="token string">&quot;Hello World&quot;</span>
  drink: <span class="token string">&quot;coffee&quot;</span>
  food: <span class="token string">&quot;PIZZA&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>我们可以看到 values 中的 <code>pizza</code> 值已经被转换成了 <code>&quot;PIZZA&quot;</code>。当这样传递参数的时候,第一个求值结果（<code>.Values.favorite.drink</code>）会作为一个参数发送给函数,我们可以修改上面的 <code>drink</code> 示例,用一个带有两个参数的函数进行说明：<code>repeat COUNT STRING</code>。</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.drink <span class="token punctuation">|</span> repeat 5 <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.food <span class="token punctuation">|</span> upper <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>repeat</code> 函数将重复字符串给定的次数,渲染后我们可以得到如下的输出结果：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token comment"># Source: mychart/templates/configmap.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1575966939<span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token string">&quot;coffeecoffeecoffeecoffeecoffee&quot;</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token string">&quot;PIZZA&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_3-2-default-函数"><a class="header-anchor" href="#_3-2-default-函数">#</a> 3.2 default 函数</h3> <p>在模板中经常会使用到的一个函数是 <code>default</code> 函数：<code>default DEFAULT_VALUE GIVEN_VALUE</code>,该函数允许你在模板内部指定默认值,我们来修改上面示例中的模板：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.food <span class="token punctuation">|</span> default &quot;rice&quot; <span class="token punctuation">|</span> upper <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>正常运行,我们还是可以得到 <code>values.yaml</code> 文件中定义的 pizza：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token comment"># Source: mychart/templates/configmap.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1575966939<span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token string">&quot;coffeecoffeecoffeecoffeecoffee&quot;</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token string">&quot;PIZZA&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>现在我们从 <code>values.yaml</code> 文件中移除 food 的定义：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">favorite</span><span class="token punctuation">:</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> coffee
  <span class="token comment"># food: pizza</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>现在我们重新运行 <code>helm install --generate-name --dry-run --debug ./mychart</code> 将渲染成如下的 YAML 文件：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token comment"># Source: mychart/templates/configmap.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1575967394<span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token string">&quot;coffeecoffeecoffeecoffeecoffee&quot;</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token string">&quot;RICE&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在一个真实的 chart 模板中,所有的静态默认值都应位于 <code>values.yaml</code> 文件中,并且不应该重复使用 <code>default</code> 函数,但是,默认命令非常适合计算不能在 <code>values.yaml</code> 文件中声明的 values 值,例如：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.food <span class="token punctuation">|</span> default (printf &quot;%s<span class="token punctuation">-</span>rice&quot; (include &quot;mychart.fullname&quot; .)) <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre v-pre="" class="language-shell"><code><span class="token comment"># Source: mychart/templates/configmap.yaml</span>
apiVersion: v1
kind: ConfigMap
metadata:
  name: mychart-1663569147-configmap
data:
  myvalue: <span class="token string">&quot;Hello World&quot;</span>
  drink: <span class="token string">&quot;coffee&quot;</span>
  food: mychart-1663569147-rice
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>不过在有些地方,<code>if</code> 条件语句可能比 default 函数更合适,我们会在后面了解到。</p> <p>模板函数和管道是将数据转换后然后将其插入到 YAML 文件中的一种强大方法,但是有的时候有必要添加一些模板逻辑,这些逻辑比仅仅插入字符串要复杂得多,下面我们将来了解模板语言中提供的控制流程。</p> <h3 id="_3-3-运算符函数"><a class="header-anchor" href="#_3-3-运算符函数">#</a> 3.3 运算符函数</h3> <p>另外需要注意的是在模板中,运算符（eq、ne、lt、gt、and、or 等等）均实现为函数,在管道中,运算符可以用括号<code>（）</code>进行分割。</p> <h2 id="_4-流程控制"><a class="header-anchor" href="#_4-流程控制">#</a> 4. 流程控制</h2> <p>控制流程为模板作者提供了控制模板生成流程的功能,Helm 的模板语言提供了以下一些流程控制：</p> <ul><li><code>if/else</code> 条件语句</li> <li><code>with</code> 指定一个作用域范围</li> <li><code>range</code> 提供类似于 <code>for each</code> 这样的循环样式</li></ul> <p>除此之外,还提供了一些声明和使用命名模板的操作：</p> <ul><li><code>define</code> 在模板内部声明一个新的命名模板</li> <li><code>template</code> 导入一个命名模板</li> <li><code>block</code> 声明了一种特殊的可填充模板区域。</li></ul> <p>这里我们先来了解 <code>if</code>、<code>with</code>、<code>range</code> 语句的使用,其他将在后面的<code>命名模板</code>部分介绍。</p> <h3 id="_4-1-if-else"><a class="header-anchor" href="#_4-1-if-else">#</a> 4.1 if/else</h3> <p>首先我们先来了解下有条件地在模板中包含一个文本区域,就是 <code>if/else</code> ,这个条件判断的基本结构如下所示：</p> <div class="language-go line-numbers-mode"><pre v-pre="" class="language-go"><code><span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token keyword">if</span> PIPELINE <span class="token punctuation">}</span><span class="token punctuation">}</span>
  # Do something
<span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token keyword">else</span> <span class="token keyword">if</span> OTHER PIPELINE <span class="token punctuation">}</span><span class="token punctuation">}</span>
  # Do something <span class="token keyword">else</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> <span class="token keyword">else</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
  # Default <span class="token keyword">case</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>可以看到我们这里判断的是管道而不是一个 values 值,这是因为控制结构可以执行整个管道,而不仅仅是判断值。如果值为以下的一些内容,则将管道判断为 false：</p> <ul><li>布尔 false</li> <li>数字零</li> <li>一个空字符串</li> <li>nil（empty 或者 null）</li> <li>一个空集合（map、slice、tuple、dict、array）</li></ul> <p>在其他条件下,条件都为真。</p> <p>现在我们在上面的示例模板 ConfigMap 中添加一个简单的条件,如果 drink 设置为 coffee,我们就添加另外一个设置：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.drink <span class="token punctuation">|</span> default &quot;tea&quot; <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.food <span class="token punctuation">|</span> upper <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> if eq .Values.favorite.drink &quot;coffee&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>mug<span class="token punctuation">:</span> true<span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>我们把 values.yaml 文件内容设置成下面的样子：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">favorite</span><span class="token punctuation">:</span>
  <span class="token comment"># drink: coffee</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> pizza
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>由于我们注释掉了 <code>drink: coffee</code>,所以渲染后输出不会包含 <code>mug: true</code> 的标志,但是如果我们把注释取消掉,则应该输出如下所示的内容：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token comment"># Source: mychart/templates/configmap.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1575970308<span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token string">&quot;coffee&quot;</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token string">&quot;PIZZA&quot;</span>
  <span class="token key atrule">mug</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这是因为上面模板中我们添加了 <code>if eq .Values.favorite.drink &quot;coffee&quot;</code> 这样的条件判断,相当于是判断 <code>.Values.favorite.drink</code> 值是否等于 <code>&quot;coffee&quot;</code>,如果相等则渲染 <code>mug: true</code>。</p> <h3 id="_4-2-空格控制"><a class="header-anchor" href="#_4-2-空格控制">#</a> 4.2 空格控制</h3> <p>还有一个非常重要的功能点就是关于空格的控制,因为空格对于 YAML 文件非常重要的,不是说任意缩进就可以,依然还是以前面的例子为例,我们来格式化下模板格式以更易于阅读：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.drink <span class="token punctuation">|</span> default &quot;tea&quot; <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.food <span class="token punctuation">|</span> upper <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> if eq .Values.favorite.drink &quot;coffee&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token key atrule">mug</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>现在我们的模板看上去更易于阅读了,但是我们通过模板引擎来渲染下,却会得到如下的错误信息：</p> <div class="language-shell line-numbers-mode"><pre v-pre="" class="language-shell"><code><span class="token punctuation">[</span>root@master helm<span class="token punctuation">]</span><span class="token comment"># helm install --generate-name --dry-run --debug ./mychart</span>
install.go:178: <span class="token punctuation">[</span>debug<span class="token punctuation">]</span> Original chart version: <span class="token string">&quot;&quot;</span>
install.go:195: <span class="token punctuation">[</span>debug<span class="token punctuation">]</span> CHART <span class="token environment constant">PATH</span><span class="token builtin class-name">:</span> /mnt/k8s/helm/mychart

Error: INSTALLATION FAILED: YAML parse error on mychart/templates/configmap.yaml: error converting YAML to JSON: yaml: line <span class="token number">9</span>: did not <span class="token function">find</span> expected key
helm.go:84: <span class="token punctuation">[</span>debug<span class="token punctuation">]</span> error converting YAML to JSON: yaml: line <span class="token number">9</span>: did not <span class="token function">find</span> expected key
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这是因为我们在模板中添加了空格,生成了不正确的 YAML 文件：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1575970308<span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token string">&quot;coffee&quot;</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token string">&quot;PIZZA&quot;</span>
    <span class="token key atrule">mug</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>我们可以看到 <code>mug: true</code> 的缩进是有问题的,不符合 YAML 文件格式,现在我们讲缩进去掉试看看：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.drink <span class="token punctuation">|</span> default &quot;tea&quot; <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.food <span class="token punctuation">|</span> upper <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> if eq .Values.favorite.drink &quot;coffee&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">mug</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>重新渲染模板,然后可以发现已经可以正常通过了,但是渲染出来的 YAML 文件格式看上去还是有点奇怪：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token comment"># Source: mychart/templates/configmap.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1663569522<span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token string">&quot;coffee&quot;</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token string">&quot;PIZZA&quot;</span>
  
  <span class="token key atrule">mug</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>我们可以看到得到的 YAML 文件中多了一些空行,这是因为模板引擎渲染的时候它会删除 <code>{{</code> 和 <code>}}</code> 之间的内容,但是会完全保留其余的空格。我们知道在 YAML 文件中空格是有意义的,所以管理空格就变得非常重要了,不过 Helm 模板也提供了一些工具来帮助我们管理空格。</p> <p>首先可以使用特殊字符修改模板声明的花括号语法,以告诉模板引擎去掉空格。<code>{{-</code> 添加了破折号和空格表示应将左边的空格移除,<code>-}}</code>表示将右边的空格移除,<code>另外也需要注意的是,换行符也是空格</code>。</p> <blockquote><p>需要注意的时候要确保 <code>-</code> 和指令的其余部分之间要有空格,<code>{{- 3 }}</code> 表示删除左边的空格并打印3,但是 <code>{{-3 }}</code>表示打印<code>-3</code>。</p></blockquote> <p>使用这个语法,我们可以修改上面的模板来移除多余的空行：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.drink <span class="token punctuation">|</span> default &quot;tea&quot; <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.food <span class="token punctuation">|</span> upper <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> if eq .Values.favorite.drink &quot;coffee&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">mug</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>渲染后可以看到空行被移除掉了：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token comment"># Source: mychart/templates/configmap.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1663569580<span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token string">&quot;coffee&quot;</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token string">&quot;PIZZA&quot;</span>
  <span class="token key atrule">mug</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>为了更加清楚地说明这个问题,我们用<code>*</code>来代替将要删除的每个空格,行尾的<code>*</code>表示被删除的换行符：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.drink <span class="token punctuation">|</span> default &quot;tea&quot; <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.food <span class="token punctuation">|</span> upper <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>*
<span class="token important">**</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> if eq .Values.favorite.drink &quot;coffee&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">mug</span><span class="token punctuation">:</span> true*
<span class="token important">**</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>所以我们这里用 <code>{{-</code> 表示的就是删除本行开头的两个空格以及上一行的换行符,这样是不是就将空行都删除了啊。</p> <p>在使用移除空格的时候还需要小心,比如下面的操作：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.food <span class="token punctuation">|</span> upper <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> if eq .Values.favorite.drink &quot;coffee&quot; <span class="token punctuation">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">mug</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我们依然还是可以用 <code>*</code> 来代替空格进行分析,如下所示：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.drink <span class="token punctuation">|</span> default &quot;tea&quot; <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.favorite.food <span class="token punctuation">|</span> upper <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>*
<span class="token important">**</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> if eq .Values.favorite.drink &quot;coffee&quot; <span class="token punctuation">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span>*
  <span class="token key atrule">mug</span><span class="token punctuation">:</span> true*
<span class="token important">**</span><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>第一个 <code>{{-</code> 会删除前面的空格和前面的换行符,然后后面的 <code>-}}</code> 会删除当前行的换行符,这样就会把 <code>mug: true</code> 移动到 <code>food: &quot;PIZZA&quot;</code> 后面去了,最终渲染过后就会变成：<code>food: &quot;PIZZA&quot;mug: true</code>,因为在两侧都去掉换行符。</p> <blockquote><p>有关模板中空格控制的详细信息,可以查看 <a href="https://godoc.org/text/template" target="_blank" rel="noopener noreferrer">Go 模板官方文档<OutboundLink></OutboundLink></a>介绍。</p></blockquote> <p>也可以使用<code>indent 函数</code></p> <h3 id="_4-3-使用-with-修改作用域"><a class="header-anchor" href="#_4-3-使用-with-修改作用域">#</a> 4.3 使用 with 修改作用域</h3> <p>接下来需要了解的是 <code>with</code> 操作,它可以控制变量的作用域,然后重新用 <code>.</code> 调用就表示对当前作用域的引用,所以,<code>.Values</code> 是告诉模板引擎在当前作用域下内查找 Values 对象。</p> <p><code>with</code> 语句的语法和 <code>if</code> 语句比较类似：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span> with PIPELINE <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token comment"># 限制范围</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>范围可以更改,可以让你将当前范围 <code>.</code> 设置为特定的对象,例如,我们一直在使用 <code>.Values.favorites</code>,让我们重写下模板文件 ConfigMap 来更改 <code>.</code> 的范围指向 <code>.Values.favorites</code>：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> with .Values.favorite <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .drink <span class="token punctuation">|</span> default &quot;tea&quot; <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .food <span class="token punctuation">|</span> upper <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>我们这里将前面练习的 <code>if</code> 条件语句删除了,在模板中我们添加了一个 <code>{{- with .Values.favorite }}</code> 的语句,意思就是说在 <code>with</code> 语句的作用范围内可以用 <code>.</code> 表示 <code>.Values.favorite</code> 了,所以我们可以引用 <code>.drink</code> 和 <code>.food</code> 了,但是在 <code>{{ end }}</code> 之后就会重置为之前的作用域了。</p> <p>不过需要注意得是,在受限的作用域范围内,你无法从父级范围访问到其他对象,比如,下面得模板会失败：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> with .Values.favorite <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .drink <span class="token punctuation">|</span> default &quot;tea&quot; <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .food <span class="token punctuation">|</span> upper <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">release</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>因为 <code>Release.Name</code> 并不在 <code>.</code> 的限制范围内,所以会产生错误,但是,如果我们交换最后两行,则就可以正常工作了,因为 <code>{{ end }}</code> 之后会重置作用域。</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> with .Values.favorite <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .drink <span class="token punctuation">|</span> default &quot;tea&quot; <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .food <span class="token punctuation">|</span> upper <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">release</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>下面我先来了解下 <code>range</code>,然后我们再去了解下模板变量,它可以为上面得这个范围问题提供一种解决方案。</p> <h3 id="_4-4-range-循环操作"><a class="header-anchor" href="#_4-4-range-循环操作">#</a> 4.4 range 循环操作</h3> <p>我们知道许多编程语言都支持使用 <code>for</code> 循环、<code>foreach</code> 循环或者类似功能机制进行循环迭代,在 Helm 得模板语言中,迭代集合得方法是使用 <code>range</code> 运算符。</p> <p>比如首先我们在 <code>values.yaml</code> 文件中添加一份 pizza 馅料列表：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">favorite</span><span class="token punctuation">:</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> coffee
  <span class="token key atrule">food</span><span class="token punctuation">:</span> pizza
<span class="token key atrule">pizzaToppings</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mushrooms
  <span class="token punctuation">-</span> cheese
  <span class="token punctuation">-</span> peppers
  <span class="token punctuation">-</span> onions
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>现在我们有了 <code>pizzaToppings</code> 列表（在模板中称为切片）,我们可以来修改下模板将列表打印到 ConfigMap 中：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> with .Values.favorite <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .drink <span class="token punctuation">|</span> default &quot;tea&quot; <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .food <span class="token punctuation">|</span> upper <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">toppings</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> range .Values.pizzaToppings <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> . <span class="token punctuation">|</span> title <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>我们仔细观察下模板中的 <code>toppings:</code> 列表,<code>range</code> 函数将遍历 <code>Values.pizzaToppings</code> 列表,我们看到里面使用了一个 <code>.</code>,类似于上面我们用 <code>with</code> 设置范围一样,运算符也是这样的,每次循环,<code>.</code> 都会被设置为当前的 <code>pizzaTopping</code>,也就是说第一次设置为<code>mushrooms</code>,第二次迭代设置为<code>cheese</code>,依次类推。</p> <p>我们可以直接传递 <code>.</code> 这个值到管道上,所以我们这里 <code>{{ . | title | quote }}</code> 就相当于发送 <code>.</code> 给 <code>title</code>（标题大小写函数）函数,然后发送给 <code>quote</code> 函数,我们渲染这个模板,会输出如下的内容：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token comment"># Source: mychart/templates/configmap.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1575975849<span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token string">&quot;coffee&quot;</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token string">&quot;PIZZA&quot;</span>
  <span class="token key atrule">toppings</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;Mushrooms&quot;</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;Cheese&quot;</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;Peppers&quot;</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;Onions&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>在上面模板中,我们做了一些小小的特殊处理,<code>toppings: |-</code> 行表示声明一个多行字符串,所以其实我们的 <code>toppings</code> 列表不是一个 YAML 列表,而是一个比较大的字符串,这是因为 ConfigMap 中的数据由 <code>key/value</code> 对组成,所有 key 和 value 都是简单的字符串,要了解为什么是这样的,可以查看 <a href="https://kubernetes.io/docs/user-guide/configmap/" target="_blank" rel="noopener noreferrer">Kubernetes ConfigMap 文档<OutboundLink></OutboundLink></a>,不过这个细节对我们这里不重要。</p> <p>有时候,在模板中快速创建一个列表,然后遍历该列表很有用,Helm 模板具有简化该功能的函数：<code>tuple</code>。元组是固定大小的列表集合,但是具有任意数据类型,下面是元组的大概使用方法：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">sizes</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> range tuple &quot;small&quot; &quot;medium&quot; &quot;large&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> . <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>上面的模板最终会被渲染成如下的 YAML：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">sizes</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
  <span class="token punctuation">-</span> small
  <span class="token punctuation">-</span> medium
  <span class="token punctuation">-</span> large
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="_5-变量"><a class="header-anchor" href="#_5-变量">#</a> 5. 变量</h2> <p>有了函数、管道、对象以及控制结构,我们可以想象下大多数编程语言中更基本的思想之一：<code>变量</code>。在模板中,变量的使用频率较低,但是,我们还是可以使用他们来简化代码,以及更好地使用 <code>with</code> 和 <code>range</code>。</p> <p>在前面的示例中,我们知道下面的模板渲染会出错：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> with .Values.favorite <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .drink <span class="token punctuation">|</span> default &quot;tea&quot; <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .food <span class="token punctuation">|</span> upper <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">release</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>因为 <code>Release.Name</code> 不在 <code>with</code> 语句块限制的范围之内,解决作用域问题的一种方法是将对象分配给在不考虑当前作用域情况下访问的变量。</p> <p>在 Helm 模板中,变量是对另外一个对象的命名引用。它遵循 <code>$name</code> 格式,变量使用特殊的赋值运算符进行赋值 <code>:=</code>,我们可以修改上面的模板,为 <code>Release.Name</code> 声明一个变量：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> $relname <span class="token punctuation">:</span>= .Release.Name <span class="token punctuation">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> with .Values.favorite <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .drink <span class="token punctuation">|</span> default &quot;tea&quot; <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .food <span class="token punctuation">|</span> upper <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">release</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> $relname <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>注意在 <code>with</code> 语句之前,我们先分配了 <code>$relname := .Release.Name</code>,然后在 <code>with</code> 语句块中,<code>$relname</code> 变量仍然表示 release 的名称,我们渲染该模板,可以得到如下的正确结果：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token comment"># Source: mychart/templates/configmap.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1575982655<span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token string">&quot;coffee&quot;</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token string">&quot;PIZZA&quot;</span>
  <span class="token key atrule">release</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span><span class="token number">1575982655</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>变量在 <code>range</code> 循环里面非常有用,它们可以用于类似于列表的对象来捕获索引和 value 值：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">toppings</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> range $index<span class="token punctuation">,</span> $topping <span class="token punctuation">:</span>= .Values.pizzaToppings <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span> $index <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> $topping <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>注意 <code>range</code> 在前面,然后是变量,然后是赋值运算符,然后才是列表,这会将整数索引（从0开始）分配给 <code>$index</code>,并将 value 值分配给 <code>$topping</code>,上面的内容会被渲染成如下内容：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">toppings</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
  <span class="token key atrule">0</span><span class="token punctuation">:</span> mushrooms
  <span class="token key atrule">1</span><span class="token punctuation">:</span> cheese
  <span class="token key atrule">2</span><span class="token punctuation">:</span> peppers
  <span class="token key atrule">3</span><span class="token punctuation">:</span> onions
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>对于同时具有 key 和 value 的数据结构,我们也可以使用 <code>range</code> 来获得 key、value 的值,比如,我们可以像这样循环遍历 <code>.Values.favorite</code>：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> range $key<span class="token punctuation">,</span> $val <span class="token punctuation">:</span>= .Values.favorite <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> $key <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> $val <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在第一次迭代中,<code>$key</code> 是 <code>drink</code>,<code>$val</code> 是 <code>coffee</code>,在第二次迭代中,<code>$key</code> 是 <code>food</code>,<code>$val</code> 是 <code>pizza</code>。运行上面的命令将生成下面的内容：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token comment"># Source: mychart/templates/configmap.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1575983119<span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token string">&quot;coffee&quot;</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token string">&quot;pizza&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>一般来说变量不是全局的,它们的作用域是声明它们的块区域,之前,我们在模板的顶层分配了 <code>$relname</code>,该变量将在整个模板的范围内,但是在我们上面的示例中,<code>$key</code> 和 <code>$val</code> 作用域只在 <code>{{ range... }}{{ end }}</code> 区域内。</p> <p>但是,有一个始终是全局变量的 <code>$</code> 始终指向顶层根上下文,当我们在 <code>range</code> 循环内需要知道 chart 包的 release 名称的时候,该功能就非常有用了,比如下面的模板文件：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> range .Values.tlsSecrets <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .name <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token comment"># helm 模板经常使用 `.`,但是这里是无效的,用 `$` 是可以生效的。</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> template &quot;fullname&quot; $ <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token comment"># 这里不能引用 `.Chart.Name`,但是可用使用 `$.Chart.Name`</span>
    <span class="token key atrule">helm.sh/chart</span><span class="token punctuation">:</span> <span class="token string">&quot;{{ $.Chart.Name }}-{{ $.Chart.Version }}&quot;</span>
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> <span class="token string">&quot;{{ $.Release.Name }}&quot;</span>
    <span class="token comment"># 值来自于 Chart.yaml 文件中的 appVersion</span>
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> <span class="token string">&quot;{{ $.Chart.AppVersion }}&quot;</span>
    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> <span class="token string">&quot;{{ $.Release.Service }}&quot;</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> kubernetes.io/tls
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">tls.crt</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .certificate <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">tls.key</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .key <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">---</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>到现在为止,我们只研究了在一个文件中声明的一个模板,但是,Helm 模板语言的强大功能之一是它能够声明多个模板并将其一起使用。</p> <h2 id="_6-命名模板"><a class="header-anchor" href="#_6-命名模板">#</a> 6. 命名模板</h2> <p>前面我们都是只操作的一个模板,现在我们来尝试使用多个模板文件。在本节中,我们可以了解到如何在一个文件中定义命名模板,然后在其他地方使用它们。命名模板（有时也叫子模板）只是在文件内部定义的有名称的模板。主要有两种创建方式以及几种不同的使用方式。</p> <p>当使用命名模板的时候有几个重要细节：模板名称是<strong>全局</strong>的,如果声明两个具有相同名称的模板,则会使用最后被加载的模板。由于子 chart 中的模板是与顶级模板一起编译的,所以需要谨慎命名。</p> <p>一种流行的命名约定是在每个定义的模板前添加 chart 名称：<code>{{ define &quot;mychart.labels&quot; }}</code>,通过使用特定的 chart 名作为前缀,我们可以避免由于两个不同的 chart 实现了相同名称的模板而引起的冲突。</p> <h3 id="_6-1-partials-和-文件"><a class="header-anchor" href="#_6-1-partials-和-文件">#</a> 6.1 partials 和 _ 文件</h3> <p>到目前为止,我们只使用了一个模板文件,但是 Helm 的模板语言允许我们创建命名的嵌入式模板,可以在其他位置进行访问。在编写这些模板之前,有一些值得一提的命名约定：</p> <ul><li><code>templates/</code> 中的大多数文件都被视为 Kubernetes 资源清单文件（NOTES.txt 除外）</li> <li>以 <code>_</code> 开头命名的文件也不会被当做 Kubernetes 资源清单文件</li> <li>下划线开头的文件不会被当做资源清单之外,还可以被其他 chart 模板调用</li></ul> <p><code>_</code> 开头的这些文件其实就是 Helm 中的 <code>partials</code> 文件,所以其实我们完全可以将命名模板定义在这些 <code>partials</code> 文件中,默认就是 <code>_helpers.tpl</code> 文件,其实在前面我们创建的 <code>mychart</code> 包中也可以找到这个文件。</p> <h3 id="_6-2-define和-template"><a class="header-anchor" href="#_6-2-define和-template">#</a> 6.2 define和 template</h3> <p><code>define</code> 关键字可以让我们在模板文件中创建命名模板,它的语法如下所示：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span> define &quot;MY.NAME&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token comment"># 模板内容区域</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>比如我们可以定义一个模板来封装下 Kubernetes 的 labels 标签：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> define &quot;mychart.labels&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">generator</span><span class="token punctuation">:</span> helm
    <span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> now <span class="token punctuation">|</span> htmlDate <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>现在我们可以将该模板嵌入到前面的 ConfigMap 模板中,然后将其包含在模板中：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> define &quot;mychart.labels&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">generator</span><span class="token punctuation">:</span> helm
    <span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> now <span class="token punctuation">|</span> htmlDate <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> template &quot;mychart.labels&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> range $key<span class="token punctuation">,</span> $val <span class="token punctuation">:</span>= .Values.favorite <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> $key <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> $val <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>当模板引擎读取这个文件的时候,它会存储 <code>mychart.labels</code> 的引用,直到该模板被调用,然后会内联渲染该模板。我们渲染这个模板可以都到如下所示的结果（记得先删掉默认生成的 <code>_helpers.tpl</code> 文件）：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token comment"># Source: mychart/templates/configmap.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1576034036<span class="token punctuation">-</span>configmap
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">generator</span><span class="token punctuation">:</span> helm
    <span class="token key atrule">date</span><span class="token punctuation">:</span> 2022<span class="token punctuation">-</span>9<span class="token punctuation">-</span><span class="token number">11</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token string">&quot;coffee&quot;</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token string">&quot;pizza&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>一般来说,Helm 中约定将这些模板统一放到一个 partials 文件中,通常就是 <code>_helpers.tpl</code> 文件中,我们将上面的命名模板移动到该文件（<code>templates/_helpers.tpl</code>）中去：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span>/* 生成基本的 Label 标签 <span class="token important">*/</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> define &quot;mychart.labels&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">generator</span><span class="token punctuation">:</span> helm
    <span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> now <span class="token punctuation">|</span> htmlDate <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>一般来说,我们也会用一个简单的块（<code>{{/*...*/}}</code>）来注释这个命名模板的作用。</p> <p>现在虽然我们把命名模板放到了 <code>_helpers.tpl</code> 文件中,但是我们在 <code>configmap.yaml</code> 模板中还是可以访问,因为命名模板是全局的：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> template &quot;mychart.labels&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> range $key<span class="token punctuation">,</span> $val <span class="token punctuation">:</span>= .Values.favorite <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> $key <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> $val <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>因为上面我们提到过命名模板是全局的,我们可以再渲染下上面的模板可以得到正确的结果。</p> <h3 id="_6-3-设置模板范围"><a class="header-anchor" href="#_6-3-设置模板范围">#</a> 6.3 设置模板范围</h3> <p>上面我们定义的模板中,还没有使用到任何对象,只使用了函数,现在我们来修改下定义的命名模板,包含 chart 的名称和版本：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span>/* 生成基本的 Label 标签 <span class="token important">*/</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> define &quot;mychart.labels&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">generator</span><span class="token punctuation">:</span> helm
    <span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> now <span class="token punctuation">|</span> htmlDate <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token key atrule">chart</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Chart.Name <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Chart.Version <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>现在我们来渲染下模板,会出现下面的错误：</p> <div class="language-shell line-numbers-mode"><pre v-pre="" class="language-shell"><code>$ helm <span class="token function">install</span> --generate-name --dry-run <span class="token parameter variable">--debug</span> ./mychart
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们可以看到提示 <code>labels.chart</code> 为 <code>nil</code>,这是因为我们使用的 <code>.Chart.Name</code> 不在定义的这个模板的作用域范围内,当渲染命名模板（使用 <code>define</code> 定义）的时候,它将接收模板调用传递的作用域。在我们这个示例中,我们是这样引用这个模板的：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> template &quot;mychart.labels&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>没有传入任何作用域,所以在模板内我们无法访问 <code>.</code> 中的任何内容,当然要解决很简单,我们只需要把作用域范围传递给模板即可：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> template &quot;mychart.labels&quot; . <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">...</span><span class="token punctuation">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>我们这里在使用 <code>template</code> 调用模板的时候传递了 <code>.</code>,我们可以很容易传递 <code>.Values</code> 或者 <code>.Values.favorite</code> 或者我们想要的任何范围,但是这里我们想要的是顶级作用域,所以我们传递的是 <code>.</code>。</p> <p>现在我们再来重新渲染我们的模板,可以得到如下所示的结果：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token comment"># Source: mychart/templates/configmap.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1576035668<span class="token punctuation">-</span>configmap
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">generator</span><span class="token punctuation">:</span> helm
    <span class="token key atrule">date</span><span class="token punctuation">:</span> 2022<span class="token punctuation">-</span>9<span class="token punctuation">-</span><span class="token number">11</span>
    <span class="token key atrule">chart</span><span class="token punctuation">:</span> mychart
    <span class="token key atrule">version</span><span class="token punctuation">:</span> 0.1.0
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token string">&quot;coffee&quot;</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token string">&quot;pizza&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>现在 <code>{{ .Chart.Name }}</code> 解析为了 mychart,而 <code>{{ .Chart.Version }}</code> 解析为了 <code>0.1.0</code>。</p> <h3 id="_6-4-include-函数"><a class="header-anchor" href="#_6-4-include-函数">#</a> 6.4 include 函数</h3> <p>假设我们定义了一个如下所示的简单模板：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> define &quot;mychart.app&quot; <span class="token punctuation">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">app_name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Chart.Name <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">app_version</span><span class="token punctuation">:</span> <span class="token string">&quot;{{ .Chart.Version }}&quot;</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">-</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>现在我们想把上面的内容插入到模板的 <code>labels</code> 部分,在 <code>data</code> 部分也想要这个内容：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span> template &quot;mychart.app&quot; . <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> range $key<span class="token punctuation">,</span> $val <span class="token punctuation">:</span>= .Values.favorite <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> $key <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> $val <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> template &quot;mychart.app&quot; . <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>但是我们直接渲染上面的模板还是会有错误：</p> <div class="language-shell line-numbers-mode"><pre v-pre="" class="language-shell"><code>$ helm <span class="token function">install</span> --generate-name --dry-run <span class="token parameter variable">--debug</span> ./mychart

Error: unable to build kubernetes objects from release manifest: error validati
ng <span class="token string">&quot;&quot;</span><span class="token builtin class-name">:</span> error validating data: <span class="token punctuation">[</span>ValidationError<span class="token punctuation">(</span>ConfigMap<span class="token punctuation">)</span>: unknown field <span class="token string">&quot;app_n
ame&quot;</span> <span class="token keyword">in</span> io.k8s.api.core.v1.ConfigMap, ValidationError<span class="token punctuation">(</span>ConfigMap<span class="token punctuation">)</span>: unknown field
 <span class="token string">&quot;app_version&quot;</span> <span class="token keyword">in</span> io.k8s.api.core.v1.ConfigMap<span class="token punctuation">]</span>
helm.go:76: <span class="token punctuation">[</span>debug<span class="token punctuation">]</span> error validating <span class="token string">&quot;&quot;</span><span class="token builtin class-name">:</span> error validating data: <span class="token punctuation">[</span>ValidationErro
r<span class="token punctuation">(</span>ConfigMap<span class="token punctuation">)</span>: unknown field <span class="token string">&quot;app_name&quot;</span> <span class="token keyword">in</span> io.k8s.api.core.v1.ConfigMap, Validat
ionError<span class="token punctuation">(</span>ConfigMap<span class="token punctuation">)</span>: unknown field <span class="token string">&quot;app_version&quot;</span> <span class="token keyword">in</span> io.k8s.api.core.v1.ConfigMap<span class="token punctuation">]</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>因为 <code>template</code> 只是一个动作,而不是一个函数,所以无法将模板调用的输出传递给其他函数,只是内联插入,相当于渲染的结果是这样的：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> measly<span class="token punctuation">-</span>whippet<span class="token punctuation">-</span>configmap
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app_name</span><span class="token punctuation">:</span> mychart
<span class="token key atrule">app_version</span><span class="token punctuation">:</span> <span class="token string">&quot;0.1.0+1478129847&quot;</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token string">&quot;coffee&quot;</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token string">&quot;pizza&quot;</span>
  <span class="token key atrule">app_name</span><span class="token punctuation">:</span> mychart
<span class="token key atrule">app_version</span><span class="token punctuation">:</span> <span class="token string">&quot;0.1.0+1478129847&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>很明显上面的 YAML 文件是不符合 ConfigMap 资源对象的格式要求的,所以报错了。为解决这个问题,Helm 提供了代替 <code>template</code> 的函数 <code>include</code>,可以将模板的内容导入到当前的管道中,这样就可以在管道中传递给其他函数进行处理了,如下所示：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> include &quot;mychart.app&quot; . <span class="token punctuation">|</span> indent 4 <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> range $key<span class="token punctuation">,</span> $val <span class="token punctuation">:</span>= .Values.favorite <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> $key <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> $val <span class="token punctuation">|</span> quote <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> include &quot;mychart.app&quot; . <span class="token punctuation">|</span> indent 2 <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>现在我们重新渲染就可以得到正确的结果了,这是因为我们用 <code>include</code> 函数得到模板内容后通过管道传给了后面的 <code>indent</code> 函数来保证了缩进：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code> <span class="token key atrule">Source</span><span class="token punctuation">:</span> mychart/templates/configmap.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1576036671<span class="token punctuation">-</span>configmap
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app_name</span><span class="token punctuation">:</span> mychart
    <span class="token key atrule">app_version</span><span class="token punctuation">:</span> <span class="token string">&quot;0.1.0&quot;</span>
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">myvalue</span><span class="token punctuation">:</span> <span class="token string">&quot;Hello World&quot;</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> <span class="token string">&quot;coffee&quot;</span>
  <span class="token key atrule">food</span><span class="token punctuation">:</span> <span class="token string">&quot;pizza&quot;</span>
  <span class="token key atrule">app_name</span><span class="token punctuation">:</span> mychart
  <span class="token key atrule">app_version</span><span class="token punctuation">:</span> <span class="token string">&quot;0.1.0&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><blockquote><p>在 Helm 模板中最好使用 <code>include</code> 而不是 <code>template</code>,这样可以更好地处理 YAML 文档的输出格式。</p></blockquote> <h2 id="_7-访问文件"><a class="header-anchor" href="#_7-访问文件">#</a> 7. 访问文件</h2> <p>在上一节中我们介绍了几种创建和访问命名模板的方法,这使得从另一个模板中导入一个模板变得很容易,但是有时候需要导入一个不是模板的文件并注入其内容,而不通过模板渲染器获得内容。</p> <p>Helm 提供了一个 <code>.Files</code> 对象对文件的访问,但是在模板中使用这个对象之前,还有几个需要注意的事项值得一提：</p> <ul><li>可以在 Helm chart 中添加额外的文件,这些文件也会被打包,不过需要注意,由于 Kubernetes 对象的存储限制,Charts 必须小于 1M</li> <li>由于一些安全原因,通过 <code>.Files</code> 对象无法访问某些文件
<ul><li>无法访问 <code>templates/</code> 下面的文件</li> <li>无法访问使用 <code>.helmignore</code> 排除的文件</li></ul></li> <li>Chart 不会保留 UNIX 模式的信息,所以,当使用 <code>.Files</code> 对象时,文件级别的权限不会对文件的可用性产生影响。</li></ul> <h3 id="_7-1-基本示例"><a class="header-anchor" href="#_7-1-基本示例">#</a> 7.1 基本示例</h3> <p>现在我们来编写一个模板,将3个文件读入到 <code>ConfigMap</code> 模板中,首先我们在 chart 中添加3个文件,将3个文件都直接放置在 <code>mychart/</code> 目录中。</p> <p><code>config1.toml</code>:</p> <div class="language- line-numbers-mode"><pre v-pre="" class="language-text"><code>message = Hello from config 1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>config2.toml</code>:</p> <div class="language- line-numbers-mode"><pre v-pre="" class="language-text"><code>message = This is config 2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>config3.toml</code>:</p> <div class="language- line-numbers-mode"><pre v-pre="" class="language-text"><code>message = Goodbye from config 3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>3个文件都是简单的 TOML 文件,我们知道这些文件的名称,所以我们可以使用 <code>range</code> 函数来遍历它们,并将其内容注入到 <code>ConfigMap</code> 中去。</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> $files <span class="token punctuation">:</span>= .Files <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> range tuple &quot;config1.toml&quot; &quot;config2.toml&quot; &quot;config3.toml&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span> . <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span> $files.Get . <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这里我们声明了一个 <code>$files</code> 的变量来保存 <code>.Files</code> 对象的引用,还使用了 <code>tuple</code> 函数来循环文件列表,然后我们打印每个文件夹 <code>{{ . }}: |-</code>,后面使用 <code>{{ $files.Get . }}</code> 获取文件内容。</p> <p>现在我们渲染这个模板会产生包含3个文件内容的单个 ConfigMap：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token comment"># Source: mychart/templates/configmap.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1576046462<span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">config1.toml</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    message = Hello from config 1

  <span class="token key atrule">config2.toml</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    message = This is config 2

  <span class="token key atrule">config3.toml</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    message = Goodbye from config 3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>另外在处理文件的时候,对文件路径本身执行一些标准操作可能非常有用,为了解决这个问题,Helm 从 Go 的路径包中导入了许多功能供你使用,它们都可以使用与 Go 包中相同的相同名称来访问,但是首字母需要小写,比如 Base 需要变成 base,导入的函数有：- Base - Dir - Ext - IsAbs - Clean。</p> <h3 id="_7-2-glob-模式"><a class="header-anchor" href="#_7-2-glob-模式">#</a> 7.2 Glob 模式</h3> <p>随着 chart 的增长,你可能需要更多地组织文件,因此 Helm 提供了 <code>Files.Glob</code> 的方法来帮助我们获取具有 <code>glob</code> 模式的文件。</p> <p><code>.Glob</code> 返回 <code>Files</code> 类型,所以你可以在返回的对象上调用任何 <code>Files</code> 方法。比如,我们的文件目录结构如下所示：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">foo/</span><span class="token punctuation">:</span>
  foo.txt foo.yaml

<span class="token key atrule">bar/</span><span class="token punctuation">:</span>
  bar.go bar.conf bar.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>我们可以用 <code>Glob</code> 进行多种选择：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span>$root <span class="token punctuation">:</span>= .<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span>range $path<span class="token punctuation">,</span> $bytes <span class="token punctuation">:</span>= .Files.Glob &quot;<span class="token important">**.yaml&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span>$path<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span>$root.Files.Get $path<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span>end<span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>或者</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span>$root <span class="token punctuation">:</span>= .<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span>range $path<span class="token punctuation">,</span> $bytes <span class="token punctuation">:</span>= .Files.Glob &quot;foo/<span class="token important">*&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span>$path<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">:</span> <span class="token string">'{{ $root.Files.Get $path | b64enc }}'</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span>end<span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_7-3-configmap-和-secrets"><a class="header-anchor" href="#_7-3-configmap-和-secrets">#</a> 7.3 ConfigMap 和 Secrets</h3> <p>想要将文件内容同时放入 ConfigMap 和 Secrets 中,以便在运行时安装到 Pod 中,这种需求很常见,为了解决这个问题,Helm 在 <code>Files</code> 类型上添加了一个实用的方法。</p> <p>根据上面的目录结构,我们可以按照如下的方式进行处理：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> conf
<span class="token key atrule">data</span><span class="token punctuation">:</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> (.Files.Glob &quot;foo/<span class="token important">*&quot;).AsConfig</span> <span class="token punctuation">|</span> indent 2 <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> very<span class="token punctuation">-</span>secret
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">data</span><span class="token punctuation">:</span>
<span class="token punctuation">{</span><span class="token punctuation">{</span> (.Files.Glob &quot;bar/<span class="token important">*&quot;).AsSecrets</span> <span class="token punctuation">|</span> indent 2 <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="_7-4-编码"><a class="header-anchor" href="#_7-4-编码">#</a> 7.4 编码</h3> <p>我们也可以导入一个文件并用 <code>base64</code> 编码进行编码：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>secret
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">token</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span> .Files.Get &quot;config1.toml&quot; <span class="token punctuation">|</span> b64enc <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>上面将采用我们上面的 <code>config1.toml</code> 文件并对其内容进行 <code>base64</code> 编码,渲染会得到如下所示的结果：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token comment"># Source: mychart1/templates/secert.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart1<span class="token punctuation">-</span>1663578612<span class="token punctuation">-</span>secret
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">token</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    bWVzc2FnZSA9IEhlbGxvIGZyb20gY29uZmlnIDEK
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_7-5-lines"><a class="header-anchor" href="#_7-5-lines">#</a> 7.5 Lines</h3> <p>有时,需要访问模板中文件的每一行内容,Helm 也提供了方法的 <code>Lines</code> 方法,我们可以使用 <code>range</code> 函数遍历每行内容：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">some-file.txt</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> range .Files.Lines &quot;foo/bar.txt&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span> . <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在 Helm 安装的时候无法将文件传递到 chart 外部,所以,如果你要求用户提供数据的话,则必须使用 <code>helm install -f</code> 或者 <code>helm install --set</code> 来获取。</p> <h2 id="_8-notes-txt-文件"><a class="header-anchor" href="#_8-notes-txt-文件">#</a> 8. NOTES.txt 文件</h2> <p>在本节中我们将来了解为 chart 用户提供说明的一个 <code>NOTES.txt</code> 文件,在 chart 安装或者升级结束时,Helm 可以为用户打印出一些有用的信息,使用模板也可以自定义这些信息。</p> <p>要将安装说明添加到 chart 中,只需要创建一个 <code>templates/NOTES.txt</code> 文件,该文件纯文本的,但是可以像模板一样进行处理,并具有所有常规模板的功能和可用对象。</p> <p>现在让我们来创建一个简单的 <code>NOTES.txt</code> 文件：</p> <div class="language-txt line-numbers-mode"><pre v-pre="" class="language-txt"><code>Thank you for installing {{ .Chart.Name }}.

Your release is named {{ .Release.Name }}.

To learn more about the release, try:

  $ helm status {{ .Release.Name }}
  $ helm get {{ .Release.Name }}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>现在我们运行 <code>helm install ./mychart</code>,我们就可以在底部看到这样的消息：</p> <div class="language-shell line-numbers-mode"><pre v-pre="" class="language-shell"><code>
NOTES:
Thank you <span class="token keyword">for</span> installing mychart.

Your release is named rude-cardinal.

To learn <span class="token function">more</span> about the release, try:

  $ helm status rude-cardinal
  $ helm get rude-cardinal
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>用这种方式可以向用户提供一个有关如何使用其新安装的 chart 的详细信息,强烈建议创建 <code>NOTES.txt</code> 文件,虽然这不是必须的。</p> <h2 id="_9-subcharts-和-global-values"><a class="header-anchor" href="#_9-subcharts-和-global-values">#</a> 9. Subcharts 和 Global Values</h2> <p>到现在为止,我们从单一模板,到多个模板文件,但是都仅仅是处理的一个 chart 包,但是 charts 可能具有一些依赖项,我们称为 <code>subcharts（子 chart）</code>,接下来我们将创建一个子 chart。</p> <p>同样在深入了解之前,我们需要了解下子 chart 相关的一些信息。</p> <ul><li>子 chart 是<strong>独立</strong>的,这意味着子 chart 不能显示依赖其父 chart</li> <li>所以子 chart 无法访问其父级的值</li> <li>父 chart 可以覆盖子 chart 的值</li> <li>Helm 中有可以被所有 charts 访问的全局值的概念</li></ul> <h3 id="_9-1-创建子chart"><a class="header-anchor" href="#_9-1-创建子chart">#</a> 9.1 创建子chart</h3> <p>同样还是在之前操作的 <code>mychart/</code> 这个 chart 包中,我们来尝试添加一些新的子 chart：</p> <div class="language-shell line-numbers-mode"><pre v-pre="" class="language-shell"><code>$ <span class="token builtin class-name">cd</span> mychart/charts
$ helm create mysubchart
Creating mysubchart
$ <span class="token function">rm</span> <span class="token parameter variable">-rf</span> mysubchart/templates/*.*
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我们删除了所有的基本模板,这样我们可以从头开始。</p> <h3 id="_9-2-添加-values-和-模板"><a class="header-anchor" href="#_9-2-添加-values-和-模板">#</a> 9.2 添加 values 和 模板</h3> <p>接下来我们为 mysubchart 这个子 chart 创建一个简单的模板和 values 值文件,<code>mychart/charts/mysubchart</code> 中已经有一个 <code>values.yaml</code> 文件了,在文件中添加下面的 values：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">dessert</span><span class="token punctuation">:</span> cake
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>下面我们再创建一个新的 ConfigMap 模板 <code>mychart/charts/mysubchart/templates/configmap.yaml</code>：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>cfgmap2
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">dessert</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.dessert <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>因为每个子 chart 都是独立的 chart,所以我们可以单独测试 <code>mysubchart</code>：</p> <div class="language-shell line-numbers-mode"><pre v-pre="" class="language-shell"><code><span class="token punctuation">[</span>root@master helm<span class="token punctuation">]</span><span class="token comment"># helm install --generate-name --dry-run --debug mychart1/charts/subchart  </span>
install.go:178: <span class="token punctuation">[</span>debug<span class="token punctuation">]</span> Original chart version: <span class="token string">&quot;&quot;</span>
install.go:195: <span class="token punctuation">[</span>debug<span class="token punctuation">]</span> CHART <span class="token environment constant">PATH</span><span class="token builtin class-name">:</span> /mnt/k8s/helm/mychart1/charts/subchart

NAME: subchart-1663581452
LAST DEPLOYED: Mon Sep <span class="token number">19</span> <span class="token number">17</span>:57:33 <span class="token number">2022</span>
NAMESPACE: default
STATUS: pending-install
REVISION: <span class="token number">1</span>
TEST SUITE: None
<span class="token environment constant">USER</span>-SUPPLIED VALUES:
<span class="token punctuation">{</span><span class="token punctuation">}</span>

COMPUTED VALUES:
affinity: <span class="token punctuation">{</span><span class="token punctuation">}</span>
autoscaling:
  enabled: <span class="token boolean">false</span>
  maxReplicas: <span class="token number">100</span>
  minReplicas: <span class="token number">1</span>
  targetCPUUtilizationPercentage: <span class="token number">80</span>
dessert: cake
fullnameOverride: <span class="token string">&quot;&quot;</span>
image:
  pullPolicy: IfNotPresent
  repository: nginx
  tag: <span class="token string">&quot;&quot;</span>
imagePullSecrets: <span class="token punctuation">[</span><span class="token punctuation">]</span>
ingress:
  annotations: <span class="token punctuation">{</span><span class="token punctuation">}</span>
  className: <span class="token string">&quot;&quot;</span>
  enabled: <span class="token boolean">false</span>
  hosts:
  - host: chart-example.local
    paths:
    - path: /
      pathType: ImplementationSpecific
  tls: <span class="token punctuation">[</span><span class="token punctuation">]</span>
nameOverride: <span class="token string">&quot;&quot;</span>
nodeSelector: <span class="token punctuation">{</span><span class="token punctuation">}</span>
podAnnotations: <span class="token punctuation">{</span><span class="token punctuation">}</span>
podSecurityContext: <span class="token punctuation">{</span><span class="token punctuation">}</span>
replicaCount: <span class="token number">1</span>
resources: <span class="token punctuation">{</span><span class="token punctuation">}</span>
securityContext: <span class="token punctuation">{</span><span class="token punctuation">}</span>
service:
  port: <span class="token number">80</span>
  type: ClusterIP
serviceAccount:
  annotations: <span class="token punctuation">{</span><span class="token punctuation">}</span>
  create: <span class="token boolean">true</span>
  name: <span class="token string">&quot;&quot;</span>
tolerations: <span class="token punctuation">[</span><span class="token punctuation">]</span>

HOOKS:
MANIFEST:
---
<span class="token comment"># Source: subchart/templates/configmap.yaml</span>
apiVersion: v1
kind: ConfigMap
metadata:
  name: subchart-1663581452-cfgmap2
data:
  dessert: cake
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><h3 id="_9-3-从父-chart-覆盖-values"><a class="header-anchor" href="#_9-3-从父-chart-覆盖-values">#</a> 9.3 从父 chart 覆盖 values</h3> <p>我们原来的 chart - mychart 现在是 mysubchart 的父级 chart 了。由于 mychart 是父级,所以我们可以在 mychart 中指定配置,并将该配置发送到 mysubchart 中去,比如,我们可以这样修改 <code>mychart/values.yaml</code>：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">favorite</span><span class="token punctuation">:</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> coffee
  <span class="token key atrule">food</span><span class="token punctuation">:</span> pizza
<span class="token key atrule">pizzaToppings</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mushrooms
  <span class="token punctuation">-</span> cheese
  <span class="token punctuation">-</span> peppers
  <span class="token punctuation">-</span> onions

<span class="token key atrule">mysubchart</span><span class="token punctuation">:</span>
  <span class="token key atrule">dessert</span><span class="token punctuation">:</span> ice cream
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>最后两行,<code>mysubchart</code> 部分中的所有指令都回被发送到 <code>mysubchart</code> 子 chart 中,所以,如果我们现在渲染模板,我们可以看到 <code>mysubchart</code> 的 ConfigMap 会被渲染成如下的内容：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token comment"># Source: mychart/charts/mysubchart/templates/configmap.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1576051914<span class="token punctuation">-</span>cfgmap2
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">dessert</span><span class="token punctuation">:</span> ice cream
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>我们可以看到顶层的 values 值覆盖了子 chart 中的值。这里有一个细节需要注意,我们没有将 <code>mychart/charts/mysubchart/templates/configmap.yaml</code> 模板更改为指向 <code>.Values.mysubchart.dessert</code>,因为从该模板的角度来看,该值仍然位于 <code>.Values.dessert</code>,当模板引擎传递 values 值的时候,它会设置这个作用域,所以,对于 <code>mysubchart</code> 模板,<code>.Values</code> 中仅仅提供用于该子 chart 的值。</p> <p>但是有时候如果我们确实希望某些值可以用于所有模板,这个时候就可以使用全局 chart values 值来完成了。</p> <h3 id="_9-4-全局值"><a class="header-anchor" href="#_9-4-全局值">#</a> 9.4 全局值</h3> <p>全局值是可以从任何 chart 或子 chart 中都可以访问的值,全局值需要显示的声明,不能将现有的非全局对象当作全局对象使用。</p> <p>Values 数据类型具有一个名为 <code>Values.global</code> 的保留部分,可以在其中设置全局值,我们在 <code>mychart/values.yaml</code> 文件中添加一个全局值：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">favorite</span><span class="token punctuation">:</span>
  <span class="token key atrule">drink</span><span class="token punctuation">:</span> coffee
  <span class="token key atrule">food</span><span class="token punctuation">:</span> pizza
<span class="token key atrule">pizzaToppings</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> mushrooms
  <span class="token punctuation">-</span> cheese
  <span class="token punctuation">-</span> peppers
  <span class="token punctuation">-</span> onions

<span class="token key atrule">mysubchart</span><span class="token punctuation">:</span>
  <span class="token key atrule">dessert</span><span class="token punctuation">:</span> ice cream
<span class="token key atrule">global</span><span class="token punctuation">:</span>
  <span class="token key atrule">salad</span><span class="token punctuation">:</span> caesar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>由于全局值的原因,在 <code>mychart/templates/configmap.yaml</code> 和 <code>mysubchart/templates/configmap.yaml</code> 下面都应该可以以 <code>{{ .Values.global.salad }}</code> 的形式来访问这个值。</p> <p><code>mychart/templates/configmap.yaml</code>：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">salad</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.global.salad <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>mysubchart/templates/configmap.yaml</code>:</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Release.Name <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">-</span>cfgmap2
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">dessert</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.dessert <span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token key atrule">salad</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">{</span> .Values.global.salad <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后我们渲染这个模板,可以得到如下所示的内容：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token comment"># Source: mychart/charts/mysubchart/templates/configmap.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1576053485<span class="token punctuation">-</span>cfgmap2
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">dessert</span><span class="token punctuation">:</span> ice cream
  <span class="token key atrule">salad</span><span class="token punctuation">:</span> caesar
<span class="token punctuation">---</span>
<span class="token comment"># Source: mychart/templates/configmap.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mychart<span class="token punctuation">-</span>1576053485<span class="token punctuation">-</span>configmap
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">salad</span><span class="token punctuation">:</span> caesar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>全局值对于传递这样的数据比较有用。</p> <h3 id="_9-5-共享模板"><a class="header-anchor" href="#_9-5-共享模板">#</a> 9.5 共享模板</h3> <p>父级 chart 和子 chart 可以共享模板,任何 chart 中已定义的块都可以用于其他 chart。比如,我们可以定义一个简单的模板,如下所示：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">-</span> define &quot;labels&quot; <span class="token punctuation">}</span><span class="token punctuation">}</span>from<span class="token punctuation">:</span> mychart<span class="token punctuation">{</span><span class="token punctuation">{</span> end <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>前面我们提到过可以使用在模板中使用 <code>include</code> 和 <code>template</code>,但是使用 <code>include</code> 的一个优点是可以动态引入模板的内容：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token punctuation">{</span><span class="token punctuation">{</span> include $mytemplate <span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="_10-模板调试"><a class="header-anchor" href="#_10-模板调试">#</a> 10. 模板调试</h2> <p>调试模板可能比较麻烦,因为渲染的模板会发送到 Kubernetes API server,而 API server 可能会因为格式以外的一些原因而拒绝 YAML 文件。</p> <p>下面这些命令可以帮助你调试一些问题：</p> <ul><li><code>helm lint</code> 是验证 chart 是否遵循最佳实践的首选工具</li> <li><code>helm install --dry-run --debug</code> 或者 <code>helm template --debug</code>：前面我们已经使用了这个技巧,这个是让服务器渲染模板,然后返回生成的资源清单文件的好方法,而且不会真正的去安装这些资源</li> <li><code>helm get manifest</code>：这是查看服务器上安装了哪些模板的好方法</li></ul> <p>当你的 YAML 文件无法解析的时候,但你想要查看生成的内容的时候,检索 YAML 的一种简单方法是注释掉模板中的问题部分,然后重新运行 <code>helm install --dry-run --debug</code>：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v2
<span class="token comment"># some: problem section</span>
<span class="token comment"># {{ .Values.foo | quote }}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>上面的内容将呈现并返回完整的注释：</p> <div class="language-yaml line-numbers-mode"><pre v-pre="" class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v2
<span class="token comment"># some: problem section</span>
<span class="token comment">#  &quot;bar&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这提供了一种查看生成的内容的快速方法。</p></div></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/wulinghui/TechnicalSummary/edit/master/docs/Kubernetes/02.k8s/35.Helm包管理/03.模板开发.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/01/27, 14:38:59</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/db70b4/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Charts</div></a> <a href="/pages/9cf826/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Chart Hooks</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/db70b4/" class="prev">Charts</a></span> <span class="next"><a href="/pages/9cf826/">Chart Hooks</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/fff88c/"><div>
            架构升级踩坑之路
            <!----></div></a> <span class="date">02-27</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/ba6503/"><div>
            总结
            <!----></div></a> <span class="date">02-27</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/1b4e40/"><div>
            语法学习
            <!----></div></a> <span class="date">02-27</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:873406903@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/wulinghui" title="GitHub(移步到gitee)" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/hellowllh/projects" title="gitee" target="_blank" class="iconfont icon-gitee"></a><a href="https://blog.csdn.net/qq_41720208" title="CSDN" target="_blank" class="iconfont icon-gitee"></a><a href="https://www.cnblogs.com/wlh1995" title="博客园" target="_blank" class="iconfont icon-bokeyuan"></a></div> 
    | Copyright © 2021-2025
    <span>Wu lingui | <a href="" target="_blank"></a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.7f63dd6c.js" defer></script><script src="/assets/js/2.fe5f2a1d.js" defer></script><script src="/assets/js/3.eb8c603e.js" defer></script><script src="/assets/js/33.05d371fe.js" defer></script>
  </body>
</html>
