<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>流量管理 | 资料总结</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="个人资料总结，存放笔记">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.76dfa4dd.css" as="style"><link rel="preload" href="/assets/js/app.7f63dd6c.js" as="script"><link rel="preload" href="/assets/js/2.fe5f2a1d.js" as="script"><link rel="preload" href="/assets/js/3.eb8c603e.js" as="script"><link rel="preload" href="/assets/js/63.a6cb5e14.js" as="script"><link rel="prefetch" href="/assets/js/10.fe6b23fc.js"><link rel="prefetch" href="/assets/js/100.523c1b31.js"><link rel="prefetch" href="/assets/js/101.bbee1e6c.js"><link rel="prefetch" href="/assets/js/102.36d68ded.js"><link rel="prefetch" href="/assets/js/103.482d8685.js"><link rel="prefetch" href="/assets/js/104.9b20475d.js"><link rel="prefetch" href="/assets/js/105.0edc73b7.js"><link rel="prefetch" href="/assets/js/106.a9abfe31.js"><link rel="prefetch" href="/assets/js/107.2178a4c5.js"><link rel="prefetch" href="/assets/js/108.21d19ed0.js"><link rel="prefetch" href="/assets/js/109.5e1e3698.js"><link rel="prefetch" href="/assets/js/11.7d4a2ffb.js"><link rel="prefetch" href="/assets/js/110.ccc910aa.js"><link rel="prefetch" href="/assets/js/111.fcfd17d0.js"><link rel="prefetch" href="/assets/js/112.f91ccf6e.js"><link rel="prefetch" href="/assets/js/113.5cd28a7e.js"><link rel="prefetch" href="/assets/js/114.4ca8676c.js"><link rel="prefetch" href="/assets/js/115.c4d64d4e.js"><link rel="prefetch" href="/assets/js/116.47ba7426.js"><link rel="prefetch" href="/assets/js/117.3062ccb9.js"><link rel="prefetch" href="/assets/js/118.27991bba.js"><link rel="prefetch" href="/assets/js/119.53538539.js"><link rel="prefetch" href="/assets/js/12.ac798cdb.js"><link rel="prefetch" href="/assets/js/120.e9666755.js"><link rel="prefetch" href="/assets/js/121.73a1660e.js"><link rel="prefetch" href="/assets/js/122.59ac137e.js"><link rel="prefetch" href="/assets/js/123.b9124c91.js"><link rel="prefetch" href="/assets/js/124.12ffcf50.js"><link rel="prefetch" href="/assets/js/125.0403278b.js"><link rel="prefetch" href="/assets/js/126.cec37905.js"><link rel="prefetch" href="/assets/js/127.605a5010.js"><link rel="prefetch" href="/assets/js/128.a4cf61d9.js"><link rel="prefetch" href="/assets/js/129.164a08ce.js"><link rel="prefetch" href="/assets/js/13.8de4385c.js"><link rel="prefetch" href="/assets/js/130.1d4164bd.js"><link rel="prefetch" href="/assets/js/131.7796e583.js"><link rel="prefetch" href="/assets/js/132.c79c715f.js"><link rel="prefetch" href="/assets/js/133.48384f22.js"><link rel="prefetch" href="/assets/js/134.bf85bfff.js"><link rel="prefetch" href="/assets/js/135.1244d4cb.js"><link rel="prefetch" href="/assets/js/136.6650b052.js"><link rel="prefetch" href="/assets/js/137.e9f394e2.js"><link rel="prefetch" href="/assets/js/138.ae16527d.js"><link rel="prefetch" href="/assets/js/139.df1c969c.js"><link rel="prefetch" href="/assets/js/14.d82e6d84.js"><link rel="prefetch" href="/assets/js/140.a80aa424.js"><link rel="prefetch" href="/assets/js/141.10ab646d.js"><link rel="prefetch" href="/assets/js/142.508278ee.js"><link rel="prefetch" href="/assets/js/143.62aa16a7.js"><link rel="prefetch" href="/assets/js/144.c734b314.js"><link rel="prefetch" href="/assets/js/145.7dae44b0.js"><link rel="prefetch" href="/assets/js/146.b08fb7ab.js"><link rel="prefetch" href="/assets/js/147.6fee9f53.js"><link rel="prefetch" href="/assets/js/148.5a09fe8b.js"><link rel="prefetch" href="/assets/js/149.27046d2c.js"><link rel="prefetch" href="/assets/js/15.f0dc0e66.js"><link rel="prefetch" href="/assets/js/150.c05ae37c.js"><link rel="prefetch" href="/assets/js/151.57194eb1.js"><link rel="prefetch" href="/assets/js/152.bc7ad385.js"><link rel="prefetch" href="/assets/js/153.b3c7d891.js"><link rel="prefetch" href="/assets/js/154.0d3a00e5.js"><link rel="prefetch" href="/assets/js/155.b9afdc01.js"><link rel="prefetch" href="/assets/js/156.bfc71798.js"><link rel="prefetch" href="/assets/js/157.43852835.js"><link rel="prefetch" href="/assets/js/158.785caaa2.js"><link rel="prefetch" href="/assets/js/159.1716fd78.js"><link rel="prefetch" href="/assets/js/16.1217969a.js"><link rel="prefetch" href="/assets/js/160.54dfc0be.js"><link rel="prefetch" href="/assets/js/161.3a486b71.js"><link rel="prefetch" href="/assets/js/162.4365dac4.js"><link rel="prefetch" href="/assets/js/163.9e0305ed.js"><link rel="prefetch" href="/assets/js/164.9af7099c.js"><link rel="prefetch" href="/assets/js/165.07230640.js"><link rel="prefetch" href="/assets/js/166.a13e993d.js"><link rel="prefetch" href="/assets/js/167.233c305e.js"><link rel="prefetch" href="/assets/js/168.86996235.js"><link rel="prefetch" href="/assets/js/169.c643487c.js"><link rel="prefetch" href="/assets/js/17.65771bc0.js"><link rel="prefetch" href="/assets/js/170.fed7e19e.js"><link rel="prefetch" href="/assets/js/171.a191947e.js"><link rel="prefetch" href="/assets/js/172.a2368c89.js"><link rel="prefetch" href="/assets/js/173.aad8acd6.js"><link rel="prefetch" href="/assets/js/174.e5c4e9f4.js"><link rel="prefetch" href="/assets/js/175.ef19ddcf.js"><link rel="prefetch" href="/assets/js/176.7b8490c3.js"><link rel="prefetch" href="/assets/js/177.7d1f01a3.js"><link rel="prefetch" href="/assets/js/178.c5ea1f87.js"><link rel="prefetch" href="/assets/js/179.e54bc218.js"><link rel="prefetch" href="/assets/js/18.69d253af.js"><link rel="prefetch" href="/assets/js/180.a0fc0bcd.js"><link rel="prefetch" href="/assets/js/181.8029f765.js"><link rel="prefetch" href="/assets/js/182.72075fe8.js"><link rel="prefetch" href="/assets/js/183.f74d77ba.js"><link rel="prefetch" href="/assets/js/184.3277cbcd.js"><link rel="prefetch" href="/assets/js/185.15940a23.js"><link rel="prefetch" href="/assets/js/186.810a303a.js"><link rel="prefetch" href="/assets/js/187.9c8777f6.js"><link rel="prefetch" href="/assets/js/188.fed55d48.js"><link rel="prefetch" href="/assets/js/189.7f09c5db.js"><link rel="prefetch" href="/assets/js/19.87ab5597.js"><link rel="prefetch" href="/assets/js/190.082d7cbc.js"><link rel="prefetch" href="/assets/js/191.9fb2ec38.js"><link rel="prefetch" href="/assets/js/192.167d2083.js"><link rel="prefetch" href="/assets/js/193.d1eeb947.js"><link rel="prefetch" href="/assets/js/194.09e61c12.js"><link rel="prefetch" href="/assets/js/195.969efb5f.js"><link rel="prefetch" href="/assets/js/196.3932e830.js"><link rel="prefetch" href="/assets/js/197.1dc355f6.js"><link rel="prefetch" href="/assets/js/198.1ad8dbbf.js"><link rel="prefetch" href="/assets/js/199.c6b23b90.js"><link rel="prefetch" href="/assets/js/20.3d741608.js"><link rel="prefetch" href="/assets/js/200.81a125db.js"><link rel="prefetch" href="/assets/js/201.5e2fd593.js"><link rel="prefetch" href="/assets/js/202.51a3fbc4.js"><link rel="prefetch" href="/assets/js/203.4ae7c4f4.js"><link rel="prefetch" href="/assets/js/204.5ba79932.js"><link rel="prefetch" href="/assets/js/205.05bb64e4.js"><link rel="prefetch" href="/assets/js/206.c1d5472b.js"><link rel="prefetch" href="/assets/js/207.ad43feb1.js"><link rel="prefetch" href="/assets/js/208.250144c5.js"><link rel="prefetch" href="/assets/js/209.41667b8a.js"><link rel="prefetch" href="/assets/js/21.23841fc1.js"><link rel="prefetch" href="/assets/js/210.b85ec988.js"><link rel="prefetch" href="/assets/js/211.8f2f9335.js"><link rel="prefetch" href="/assets/js/212.dea21e7c.js"><link rel="prefetch" href="/assets/js/213.9074d848.js"><link rel="prefetch" href="/assets/js/214.baaf02d5.js"><link rel="prefetch" href="/assets/js/215.e3149f2c.js"><link rel="prefetch" href="/assets/js/216.5ede3f02.js"><link rel="prefetch" href="/assets/js/217.06eb8901.js"><link rel="prefetch" href="/assets/js/218.ffe5fc66.js"><link rel="prefetch" href="/assets/js/219.69c6166f.js"><link rel="prefetch" href="/assets/js/22.b55e8e09.js"><link rel="prefetch" href="/assets/js/220.a83c1ecf.js"><link rel="prefetch" href="/assets/js/221.fb65c799.js"><link rel="prefetch" href="/assets/js/222.1ff261ff.js"><link rel="prefetch" href="/assets/js/223.807c2de7.js"><link rel="prefetch" href="/assets/js/224.33540594.js"><link rel="prefetch" href="/assets/js/225.21d88d75.js"><link rel="prefetch" href="/assets/js/226.00d419d7.js"><link rel="prefetch" href="/assets/js/227.19678a11.js"><link rel="prefetch" href="/assets/js/228.d09fe33c.js"><link rel="prefetch" href="/assets/js/229.c8dcc95e.js"><link rel="prefetch" href="/assets/js/23.d7449079.js"><link rel="prefetch" href="/assets/js/230.7477ad3f.js"><link rel="prefetch" href="/assets/js/231.f1013950.js"><link rel="prefetch" href="/assets/js/232.1e07d0e6.js"><link rel="prefetch" href="/assets/js/233.34e0f2b8.js"><link rel="prefetch" href="/assets/js/234.645446d8.js"><link rel="prefetch" href="/assets/js/235.3368fdbc.js"><link rel="prefetch" href="/assets/js/236.35ed0de0.js"><link rel="prefetch" href="/assets/js/237.4a189e89.js"><link rel="prefetch" href="/assets/js/238.d6580ef3.js"><link rel="prefetch" href="/assets/js/239.c518fd70.js"><link rel="prefetch" href="/assets/js/24.26f18aa6.js"><link rel="prefetch" href="/assets/js/240.14979636.js"><link rel="prefetch" href="/assets/js/241.95c3b00d.js"><link rel="prefetch" href="/assets/js/242.a214e307.js"><link rel="prefetch" href="/assets/js/243.273af8d4.js"><link rel="prefetch" href="/assets/js/244.e2d74303.js"><link rel="prefetch" href="/assets/js/245.fe562cb9.js"><link rel="prefetch" href="/assets/js/246.b40011af.js"><link rel="prefetch" href="/assets/js/247.dc1a9aae.js"><link rel="prefetch" href="/assets/js/248.d691ac20.js"><link rel="prefetch" href="/assets/js/249.191f742a.js"><link rel="prefetch" href="/assets/js/25.198594bf.js"><link rel="prefetch" href="/assets/js/250.205b92cf.js"><link rel="prefetch" href="/assets/js/251.acb8a80e.js"><link rel="prefetch" href="/assets/js/26.c817356c.js"><link rel="prefetch" href="/assets/js/27.6b812306.js"><link rel="prefetch" href="/assets/js/28.9048721b.js"><link rel="prefetch" href="/assets/js/29.bfda8510.js"><link rel="prefetch" href="/assets/js/30.eb1b6ab9.js"><link rel="prefetch" href="/assets/js/31.3f3dbd2f.js"><link rel="prefetch" href="/assets/js/32.006bc754.js"><link rel="prefetch" href="/assets/js/33.05d371fe.js"><link rel="prefetch" href="/assets/js/34.27cd6ff5.js"><link rel="prefetch" href="/assets/js/35.35409a6d.js"><link rel="prefetch" href="/assets/js/36.fd6a950b.js"><link rel="prefetch" href="/assets/js/37.c8fd6ef4.js"><link rel="prefetch" href="/assets/js/38.028a36a2.js"><link rel="prefetch" href="/assets/js/39.e4494792.js"><link rel="prefetch" href="/assets/js/4.ff2df22c.js"><link rel="prefetch" href="/assets/js/40.979dec53.js"><link rel="prefetch" href="/assets/js/41.ff9662db.js"><link rel="prefetch" href="/assets/js/42.5c1441fc.js"><link rel="prefetch" href="/assets/js/43.9657eae8.js"><link rel="prefetch" href="/assets/js/44.a6cb5e5c.js"><link rel="prefetch" href="/assets/js/45.c675440c.js"><link rel="prefetch" href="/assets/js/46.06205970.js"><link rel="prefetch" href="/assets/js/47.ded0c65e.js"><link rel="prefetch" href="/assets/js/48.296a6f26.js"><link rel="prefetch" href="/assets/js/49.1b2ec2ab.js"><link rel="prefetch" href="/assets/js/5.ecde23f9.js"><link rel="prefetch" href="/assets/js/50.e551e67f.js"><link rel="prefetch" href="/assets/js/51.122d5b68.js"><link rel="prefetch" href="/assets/js/52.c0444208.js"><link rel="prefetch" href="/assets/js/53.f47d6b86.js"><link rel="prefetch" href="/assets/js/54.e9c9b41b.js"><link rel="prefetch" href="/assets/js/55.77010c1f.js"><link rel="prefetch" href="/assets/js/56.387aacbb.js"><link rel="prefetch" href="/assets/js/57.ddcf78ad.js"><link rel="prefetch" href="/assets/js/58.908b88fc.js"><link rel="prefetch" href="/assets/js/59.8ff535f1.js"><link rel="prefetch" href="/assets/js/6.b928f1b9.js"><link rel="prefetch" href="/assets/js/60.c5018386.js"><link rel="prefetch" href="/assets/js/61.1514e08b.js"><link rel="prefetch" href="/assets/js/62.79bc9197.js"><link rel="prefetch" href="/assets/js/64.f149661c.js"><link rel="prefetch" href="/assets/js/65.30fa2026.js"><link rel="prefetch" href="/assets/js/66.e7f9f54e.js"><link rel="prefetch" href="/assets/js/67.7361f4a3.js"><link rel="prefetch" href="/assets/js/68.b67cc099.js"><link rel="prefetch" href="/assets/js/69.ba730416.js"><link rel="prefetch" href="/assets/js/7.b0514d37.js"><link rel="prefetch" href="/assets/js/70.45b9e858.js"><link rel="prefetch" href="/assets/js/71.2055eaae.js"><link rel="prefetch" href="/assets/js/72.75ec1304.js"><link rel="prefetch" href="/assets/js/73.3aa09b6b.js"><link rel="prefetch" href="/assets/js/74.fb3013f1.js"><link rel="prefetch" href="/assets/js/75.c837c896.js"><link rel="prefetch" href="/assets/js/76.9e6df886.js"><link rel="prefetch" href="/assets/js/77.4eb09ab0.js"><link rel="prefetch" href="/assets/js/78.06d19c8c.js"><link rel="prefetch" href="/assets/js/79.dfde586d.js"><link rel="prefetch" href="/assets/js/8.f86f2563.js"><link rel="prefetch" href="/assets/js/80.476da6d1.js"><link rel="prefetch" href="/assets/js/81.2b778375.js"><link rel="prefetch" href="/assets/js/82.abbf449f.js"><link rel="prefetch" href="/assets/js/83.24b0e8ea.js"><link rel="prefetch" href="/assets/js/84.f8694c96.js"><link rel="prefetch" href="/assets/js/85.f030e8b6.js"><link rel="prefetch" href="/assets/js/86.18853c72.js"><link rel="prefetch" href="/assets/js/87.4eca3df6.js"><link rel="prefetch" href="/assets/js/88.26b81c78.js"><link rel="prefetch" href="/assets/js/89.ae216049.js"><link rel="prefetch" href="/assets/js/9.7a3e1618.js"><link rel="prefetch" href="/assets/js/90.b0ee8ab4.js"><link rel="prefetch" href="/assets/js/91.a07b34f1.js"><link rel="prefetch" href="/assets/js/92.1c2952b1.js"><link rel="prefetch" href="/assets/js/93.e199901d.js"><link rel="prefetch" href="/assets/js/94.a901578c.js"><link rel="prefetch" href="/assets/js/95.641f6644.js"><link rel="prefetch" href="/assets/js/96.84a54aa3.js"><link rel="prefetch" href="/assets/js/97.c489ec61.js"><link rel="prefetch" href="/assets/js/98.5fb17174.js"><link rel="prefetch" href="/assets/js/99.c004152a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.76dfa4dd.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="资料总结" class="logo"> <span class="site-name can-hide">资料总结</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/goVersion181/" class="nav-link">go</a></div><div class="nav-item"><a href="/pages/springFramework/" class="nav-link">java</a></div><div class="nav-item"><a href="/pages/e5d517/" class="nav-link">云原生</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/pages/410b25/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/00291d/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/pages/846ee6/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/pages/5465c3/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/853b5b/" class="nav-link">设计模式详解</a></li><li class="dropdown-item"><!----> <a href="/pages/ebc515/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/pages/57778e/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/pages/282cd0/" class="nav-link">项目</a></li><li class="dropdown-item"><!----> <a href="/pages/2cd810/" class="nav-link">理论基础</a></li><li class="dropdown-item"><!----> <a href="/pages/6acd46/" class="nav-link">运营</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/wulinghui/TechnicalSummary" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src=""> <div class="blogger-info"><h3>linghui Wu</h3> <span>一只努力学飞的鱼</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/goVersion181/" class="nav-link">go</a></div><div class="nav-item"><a href="/pages/springFramework/" class="nav-link">java</a></div><div class="nav-item"><a href="/pages/e5d517/" class="nav-link">云原生</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/pages/410b25/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/00291d/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/pages/846ee6/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/pages/5465c3/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/853b5b/" class="nav-link">设计模式详解</a></li><li class="dropdown-item"><!----> <a href="/pages/ebc515/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/pages/57778e/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/pages/282cd0/" class="nav-link">项目</a></li><li class="dropdown-item"><!----> <a href="/pages/2cd810/" class="nav-link">理论基础</a></li><li class="dropdown-item"><!----> <a href="/pages/6acd46/" class="nav-link">运营</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/wulinghui/TechnicalSummary" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/e5d517/" class="sidebar-link">01-云原生概念</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>k8s</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>监控</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>日志</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DevOps</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>ServiceMesh</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/baba29/" class="sidebar-link">Istio概述</a></li><li><a href="/pages/735e4b/" class="sidebar-link">Istio安装</a></li><li><a href="/pages/a08be6/" aria-current="page" class="active sidebar-link">流量管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/a08be6/#_1-gateway" class="sidebar-link">1. Gateway</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a08be6/#_1-1-简单路由实例" class="sidebar-link">1.1 简单路由实例</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/a08be6/#_2-virtualservice详解" class="sidebar-link">2. VirtualService详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a08be6/#_2-1-route详解" class="sidebar-link">2.1 route详解</a></li><li class="sidebar-sub-header level3"><a href="/pages/a08be6/#_2-2-match" class="sidebar-link">2.2 match</a></li><li class="sidebar-sub-header level3"><a href="/pages/a08be6/#_2-3-路由目标-routedestination" class="sidebar-link">2.3 路由目标(RouteDestination)</a></li><li class="sidebar-sub-header level3"><a href="/pages/a08be6/#_2-4-http重定向-httpredirect" class="sidebar-link">2.4 HTTP重定向（HTTPRedirect）</a></li><li class="sidebar-sub-header level3"><a href="/pages/a08be6/#_2-5-http重写-httprewrite" class="sidebar-link">2.5 HTTP重写（HTTPRewrite）</a></li><li class="sidebar-sub-header level3"><a href="/pages/a08be6/#_2-6-http重试-httpretry" class="sidebar-link">2.6 HTTP重试（HTTPRetry）</a></li><li class="sidebar-sub-header level3"><a href="/pages/a08be6/#_2-7-http流量镜像-mirror" class="sidebar-link">2.7 HTTP流量镜像（Mirror）</a></li><li class="sidebar-sub-header level3"><a href="/pages/a08be6/#_2-8-http故障注入-httpfaultinjection" class="sidebar-link">2.8 HTTP故障注入（HTTPFaultInjection）</a></li><li class="sidebar-sub-header level3"><a href="/pages/a08be6/#_2-9-http跨域资源共享-corspolicy" class="sidebar-link">2.9 HTTP跨域资源共享（CorsPolicy）</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/a08be6/#_3-destinationrule" class="sidebar-link">3. DestinationRule</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a08be6/#_3-1-负载均衡器设置" class="sidebar-link">3.1 负载均衡器设置</a></li><li class="sidebar-sub-header level3"><a href="/pages/a08be6/#_3-2-连接池配置" class="sidebar-link">3.2 连接池配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/a08be6/#_3-3-异常点检测" class="sidebar-link">3.3 异常点检测</a></li><li class="sidebar-sub-header level3"><a href="/pages/a08be6/#_3-4-tls-设置" class="sidebar-link">3.4 TLS 设置</a></li><li class="sidebar-sub-header level3"><a href="/pages/a08be6/#_3-5-端口流量策略" class="sidebar-link">3.5 端口流量策略</a></li><li class="sidebar-sub-header level3"><a href="/pages/a08be6/#_3-6-服务子集" class="sidebar-link">3.6 服务子集</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/a08be6/#_4-实战" class="sidebar-link">4. 实战</a></li><li class="sidebar-sub-header level2"><a href="/pages/a08be6/#_5-实战-观察故障注入" class="sidebar-link">5. 实战：观察故障注入</a></li></ul></li><li><a href="/pages/809099/" class="sidebar-link">istio安全</a></li><li><a href="/pages/811549/" class="sidebar-link">高级功能</a></li><li><a href="/pages/b8c72b/" class="sidebar-link">实际案例</a></li><li><a href="/pages/ff6964/" class="sidebar-link">Istio总结</a></li></ul></section></li><li><a href="/pages/076b5d/" class="sidebar-link">Knative</a></li><li><a href="/pages/6d3863/" class="sidebar-link">spring-cloud-kubernetes</a></li><li><a href="/pages/cb6fc2/" class="sidebar-link">ms总结</a></li><li><a href="/pages/fff88c/" class="sidebar-link">架构升级踩坑之路</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/categories/?category=Kubernetes" title="分类" data-v-06970110>Kubernetes</a></li><li data-v-06970110><a href="/categories/?category=ServiceMesh" title="分类" data-v-06970110>ServiceMesh</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://gitee.com/hellowllh/projects" target="_blank" title="作者" class="beLink" data-v-06970110>wulinghui</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2023-01-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">流量管理<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="流量管理"><a href="#流量管理" class="header-anchor">#</a> 流量管理</h1> <h2 id="_1-gateway"><a href="#_1-gateway" class="header-anchor">#</a> 1. Gateway</h2> <p>在安装 Istio 的时候，安装了入口和出口网关。<strong>这两个网关实际都运行了一个 Envoy 代理实例，它们在网格的边缘作为负载均衡器运行。入口网关接收入站连接，而出口网关接收从集群出去的连接</strong>。</p> <p>使用入口网关，我们可以对进入集群的流量应用路由规则。</p> <p>我们可以有一个指向入口网关的单一外部 IP 地址，并根据Header将流量路由到集群内的不同服务。</p> <p><img src="img/image-20221108221812047.png" alt="image-20221108221812047"></p> <p>使用 Gateway 资源来配置网关。</p> <p>下面是一个网关资源的例子：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>gateway
   <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
   <span class="token key atrule">servers</span><span class="token punctuation">:</span>
   <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
       <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
       <span class="token key atrule">name</span><span class="token punctuation">:</span> http
       <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
     <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> dev.example.com
     <span class="token punctuation">-</span> test.example.com

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>网关资源描述了负载均衡器的<code>暴露端口</code>、<code>协议</code>、<code>SNI</code>配置等。</p> <table><thead><tr><th>GateWay字段名称</th> <th>字段含义</th></tr></thead> <tbody><tr><td>metadata.name</td> <td>Gateway 名称</td></tr> <tr><td>metadata.namespace</td> <td>Gateway 命名空间</td></tr> <tr><td>spec.selector</td> <td>Gateway 使用填写的标签键值对匹配配置下发的边缘代理网关实例</td></tr> <tr><td>spec.servers.port.number</td> <td>端口</td></tr> <tr><td>spec.servers.port.protocol</td> <td>通信协议，支持：HTTP, HTTPS, GRPC, HTTP2, MONGO, TCP, TLS，请注意同一网关同一端口的协议配置需要保持一致。</td></tr> <tr><td>spec.servers.port.name</td> <td>端口名称</td></tr> <tr><td>spec.severs.hosts</td> <td>域名，支持通配符 *</td></tr> <tr><td>spec.servers.tls.httpsRedirect</td> <td>值为 true 时，边缘代理网关会对所有 http 请求返回 301 重定向，要求客户端发起 https 请求</td></tr> <tr><td>spec.servers.tls.mode</td> <td>配置当前端口的 TLS 安全认证模式，如需要开启当前端口的安全认证则需要填写。支持：PASSTHROUGH, SIMPLE, MUTUAL, AUTO_PASSTHROUGH, ISTIO_MUTUAL</td></tr> <tr><td>spec.servers.tls.credentialName</td> <td>配置发现 TLS 证书密钥的 secret 的名称</td></tr> <tr><td>spec.servers.tls.serverCertificate</td> <td>设置端口的 TLS 证书密钥通过 file mount 形式（不推荐，推荐采用填写 credentialName 字段加载证书私钥）挂载时需要填写的证书路径字段，Istio 默认使用网关所在命名空间下 istio-ingressgateway-certs secret 加载证书至路径 /etc/istio/ingressgateway-certs</td></tr> <tr><td>spec.servers.tls.privateKey</td> <td>设置端口的 TLS 证书密钥通过 file mount 形式（不推荐，推荐采用填写 credentialName 字段加载证书私钥）挂载时需要填写的私钥路径字段，Istio 默认使用网关所在命名空间下 istio-ingressgateway-certs secret 加载私钥至路径 /etc/istio/ingressgateway-certs</td></tr> <tr><td>spec.servers.tls.caCertificates</td> <td>设置端口的 TLS 证书密钥通过 file mount 形式（不推荐，推荐采用填写 credentialName 字段加载证书私钥）挂载时需要填写的跟证书路径字段，Istio 默认使用网关所在命名空间下 istio-ingressgateway-ca-certs 加载根证书至路径 /etc/istio/ingressgateway-ca-certs，双向认证时需要配置根证书</td></tr></tbody></table> <blockquote><p>SNI，即服务器名称指示，是TLS协议的扩展。它指示在“握手”过程开始时浏览器正在联系哪个主机名；允许服务器为多个站点安全地托管多个SSL证书，多个网站存在于同一IP地址上。</p></blockquote> <p>上述配置文件的解释：</p> <ul><li>配置了一个代理，做为负载均衡器</li> <li>为入口暴露80端口</li> <li>配置应用于istio入口网关代理</li> <li><code>hosts</code> 字段作为一个过滤器，只有以 <code>dev.example.com</code> 和 <code>test.example.com</code> 为目的地的流量会被允许通过。</li></ul> <p><strong>为了控制和转发流量到集群内运行的实际 Kubernetes 服务，我们必须用特定的主机名（例如 <code>dev.example.com</code> 和 <code>test.example.com</code>）配置一个VirtualService，然后将网关连接到它</strong>。</p> <p><img src="img/image-20221027200733625.png" alt="image-20221027200733625"></p> <h3 id="_1-1-简单路由实例"><a href="#_1-1-简单路由实例" class="header-anchor">#</a> 1.1 简单路由实例</h3> <p>部署一个tomcat，并通过istio网关进行访问。</p> <p>tomcatdeploy.yaml ：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> microservice
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> hub.c.163.com/library/tomcat<span class="token punctuation">:</span>latest
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>创建一个tomcat service，tomcatsvc.yaml ：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> microservice
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> tomcat
<span class="token key atrule">status</span><span class="token punctuation">:</span>
  <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>部署一个Gateway资源：</p> <p>ingressgateway80.yaml</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingressgateway80
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> http
        <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
      <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">'*'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><blockquote><p>这设置*，可以使用ip地址来访问入口网关，如果配置为具体域名，需要修改hosts文件（真实域名需要修改A记录）</p></blockquote> <p>现在还没有绑定<strong>VirtualService</strong>，所以网关还不知道将流量路由到哪里，为 <code>tomcat</code> 服务创建一个 VirtualService，并将其绑定到 Gateway 资源上：</p> <p>tomcat-virtualservice.yaml：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">-</span>virtualservice
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">&quot;*&quot;</span>  
  <span class="token key atrule">gateways</span><span class="token punctuation">:</span> <span class="token comment">#把VirtualService绑定到ingressgateway80这个网关</span>
    <span class="token punctuation">-</span> ingressgateway80
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span> <span class="token comment">#表示路由到tomcat这个service，microservice表示命名空间</span>
        <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
            <span class="token key atrule">host</span><span class="token punctuation">:</span> tomcat.microservice.svc.cluster.local
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>访问：curl -v 网关外部ip:80</p> <blockquote><p>注意其中的header，其中有一个server=istio-envoy，这表明请求经过了envoy代理</p></blockquote> <h2 id="_2-virtualservice详解"><a href="#_2-virtualservice详解" class="header-anchor">#</a> 2. VirtualService详解</h2> <p>使用 VirtualService 资源在 Istio 服务网格中进行流量路由。通过 VirtualService，我们可以定义流量路由规则，并在客户端试图连接到服务时应用这些规则。</p> <p>具体的配置含义：</p> <table><thead><tr><th style="text-align:center;">VirtualService字段名称</th> <th style="text-align:left;">字段说明</th></tr></thead> <tbody><tr><td style="text-align:center;">spec.hosts</td> <td style="text-align:left;">定义路由规则关联一组的 hosts，可以是带有通配符的 DNS 名称或者 IP 地址（IP 地址仅能应用于来源流量为边缘代理网关）。该字段能应用于 HTTP 和 TCP 流量。在 Kubernetes 环境中，可以使用 service 的名称作为缩写，Istio 会按照 VirtualService所在 namespace 补齐缩写，例如在 default namespace 的 VirtualService 包含 host 缩写 reviews 会被补齐为 reviews.default.svc.cluster.local。为避免误配置，推荐填写 host 全称</td></tr> <tr><td style="text-align:center;">spec.gateways</td> <td style="text-align:left;">定义应用路由规则的来源流量，可以是一个或多个网关，或网格内部的 sidecar，指定方式为 <gateway namespace="">/<gateway name="">，保留字段 mesh 表示网格内部所有的 sidecar，当该参数缺省时，会默认填写 mesh，即该路由规则的来源流量为网格内部所有 sidecar</gateway></gateway></td></tr> <tr><td style="text-align:center;">spec.http</td> <td style="text-align:left;">定义一组有序的（优先匹配靠前的路由规则）应用于 HTTP 流量的路由规则，HTTP 路由规则会应用于网格内部的 service 端口命名为 http-, http2-, grpc- 开头的流量以及来自 gateway 的协议为 HTTP, HTTP2, GRPC, TLS-Terminated-HTTPS 的流量</td></tr> <tr><td style="text-align:center;">spec.http.match</td> <td style="text-align:left;">定义路由的匹配规则列表，单个匹配规则项内所有条件是且关系，列表中多个匹配规则之间为或关系</td></tr> <tr><td style="text-align:center;">spec.http.route</td> <td style="text-align:left;">定义路由转发目的地列表，一条 HTTP 路由可以是重定向或转发（默认），转发的目的地可以是一个或多个服务（服务版本）。同时也可以配置权重、header 操作等行为</td></tr> <tr><td style="text-align:center;">spec.http.redirect</td> <td style="text-align:left;">定义路由重定向，一条 HTTP 路由可以是重定向或转发（默认），如规则中指定了 passthrough 选项，route、redirect 均会被忽略。可将 HTTP 301 重定向到另外的 URL 或 Authority</td></tr> <tr><td style="text-align:center;">spec.http.rewrite</td> <td style="text-align:left;">定义重写 HTTP URL 或 Authority headers，不能与重定向同时配置，重写操作会在转发前执行</td></tr> <tr><td style="text-align:center;">spec.http.timeout</td> <td style="text-align:left;">定义 HTTP 请求的超时时间</td></tr> <tr><td style="text-align:center;">spec.http.retries</td> <td style="text-align:left;">定义 HTTP 请求的重试策略</td></tr> <tr><td style="text-align:center;">spec.http.fault</td> <td style="text-align:left;">定义 HTTP 流量的故障注入策略，开启时超时和重试策略不会开启</td></tr> <tr><td style="text-align:center;">spec.http.mirror</td> <td style="text-align:left;">定义将 HTTP 流量复制到另一个指定的目的端，被复制的流量按照“best effort”原则，sidecar/网关不会等待复制流量的响应结果就会从源目的端返回响应。镜像流量的目的服务端会产生监控指标。</td></tr> <tr><td style="text-align:center;">spec.http.mirrorPercent</td> <td style="text-align:left;">定义流量镜像的复制百分比，缺省时复制100%的流量。最大值为100</td></tr> <tr><td style="text-align:center;">spec.http.corsPolicy</td> <td style="text-align:left;">定义 CORS 策略（跨域资源共享，Cross-Origin Resource Sharing，CORS）</td></tr> <tr><td style="text-align:center;">spec.http.headers</td> <td style="text-align:left;">定义 header 操作规则，包括 request 和 response header 的更新，增加，移除操作</td></tr> <tr><td style="text-align:center;">spec.tcp</td> <td style="text-align:left;">定义一组有序的（优先匹配靠前的路由规则）应用于 TCP 流量的路由规则，该路由规则会应用于任何非 HTTP 和 TLS 的端口</td></tr> <tr><td style="text-align:center;">spec.tcp.match</td> <td style="text-align:left;">定义 TCP 流量路由的匹配规则列表，单个匹配规则项内所有条件是且关系，列表中多个匹配规则之间为或关系</td></tr> <tr><td style="text-align:center;">spec.tcp.route</td> <td style="text-align:left;">定义 TCP 连接转发的目的端</td></tr> <tr><td style="text-align:center;">spec.tls</td> <td style="text-align:left;">定义一组有序的（优先匹配靠前的路由规则）应用于未终止的 TLS 或 HTTPS 流量的路由规则，该路由规则会应用于网格内部的 service 端口命名为 https-，tls- 开头的流量，来自 gateway 的端口协议为 HTTPS, TLS 的未终止加密流量，Service Entry 使用 HTTPS, TLS 协议的端口。当 https-, tls- 端口未关联 VirtualService 规则时将会被视为 TCP 流量</td></tr> <tr><td style="text-align:center;">spec.tls.match</td> <td style="text-align:left;">定义 TLS 流量路由的匹配规则列表，单个匹配规则项内所有条件是且关系，列表中多个匹配规则之间为或关系</td></tr> <tr><td style="text-align:center;">spec.tls.route</td> <td style="text-align:left;">定义连接转发的目的端</td></tr></tbody></table> <h3 id="_2-1-route详解"><a href="#_2-1-route详解" class="header-anchor">#</a> 2.1 route详解</h3> <p>HTTPRoute规则的功能是：满足HTTPMatchRequest条件的流量都被路由到<code>HTTPRouteDestination</code>，执行<code>重定向（HTTPRedirect</code>）、<code>重写（HTTPRewrite）</code>、<code>重试（HTTPRetry</code>）、<code>故障注入（HTTPFaultInjection）</code>、<code>跨站（CorsPolicy）策略</code>等。HTTPRoute不仅可以做路由匹配，还可以做一些写操作来修改请求本身。</p> <h3 id="_2-2-match"><a href="#_2-2-match" class="header-anchor">#</a> 2.2 match</h3> <p>match是进行路由的匹配条件。</p> <p>其支持以下一些字段的定义：</p> <ul><li><p>uri、scheme、method、authority：这四个字段都是StringMatch类型，匹配请求时都支持exact、prefix和regex三种模式的匹配。、</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
  <span class="token comment"># 代表匹配uri以advertisment开头的请求</span>
  <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
      <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">&quot;/advertisment&quot;</span>  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>headers：匹配请求中的Header，是一个map类型。map的key是字符串类型，value是StringMatch类型。即对于每一个Header的值，都可以使用精确、前缀和正则三种方式进行匹配。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
<span class="token comment"># 匹配header key为source value为north</span>
  <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
    <span class="token key atrule">source</span><span class="token punctuation">:</span>
      <span class="token key atrule">exact</span><span class="token punctuation">:</span> north
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>port：表示请求服务的端口。大部分服务只开放一个端口，这也是在微服务中推荐的做法，在这种场景下可以不指定port；</p></li> <li><p>sourceLabels：是一个map类型的键值对，表示请求来源负载匹配标签。这在很多情况有用，可以对一组服务都打一个相同的标签，然后使用sourceLabels字段对这些服务实施相同的流量规则。在Kubernetes平台上，这里的Label就是Pod上的标签。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">http</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>    
  <span class="token punctuation">-</span> <span class="token key atrule">sourceLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> testA
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>gateway：表示规则应用的Gateway名称，语义同VirtualService 上面的gateway定义，是一个更细的Match条件，会覆盖在VirtualService上配置的gateway。</p></li></ul> <blockquote><p>在VirtualService中match字段都是数组类型。HTTPMatchRequest中的诸多属性如uri、header、method等都是“与”逻辑，而数组中几个元素间关系是“或”逻辑。</p></blockquote> <p>例子：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">heraders</span><span class="token punctuation">:</span>
      <span class="token key atrule">source</span><span class="token punctuation">:</span>
        <span class="token key atrule">exact</span><span class="token punctuation">:</span> north
    <span class="token key atrule">uri</span><span class="token punctuation">:</span>
      <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">&quot;/advertisment&quot;</span>
  <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
      <span class="token key atrule">prefix</span><span class="token punctuation">:</span> <span class="token string">&quot;/forecast&quot;</span>    
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>match包含两个HTTPMatchRequest元素，其条件的语义是：headers中的source取值为“north”，且uri以“/advertisment”开头的请求，或者uri以“/forecast”开头的请求。</p> <h3 id="_2-3-路由目标-routedestination"><a href="#_2-3-路由目标-routedestination" class="header-anchor">#</a> 2.3 路由目标(RouteDestination)</h3> <p>route字段是一个HTTPRouteDestination类型的数组，表示满足条件的流量目标。</p> <p>在HTTPRouteDestination中主要有三个字段：<code>destination</code>（请求目标）、<code>weight</code>（权重）、和<code>headers</code>（HTTP头操作），destination是必选字段。</p> <ul><li><p>destination: 这个字段是一个Destination类型结构，通过host、subset和port三个属性来描述。表示最终将流量路由到此目标。<code>host</code>是Destination必选字段，表示在Istio中注册的服务名，建议写全域名。<code>subset</code>表示在host上定义的一个子集。例如，在灰度发布中将版本定义为subset，配置路由策略会将流量转发到不同版本的subset上。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">...</span>..
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> forecast
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> forecast
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> forecast
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div></li> <li><p>weight: 表示流量分配的比例，在一个route下多个destination的weight总和要求是100。默认100，必填字段。</p> <p>示例：从原有的v1版本中切分20%的流量到v2版本，这也是灰度发布常用的一个流量策略，即不区分内容，平等的从总流量中切出一部分流量给新版本。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">...</span>..
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> forecast
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> forecast
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">20</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> forecast
        <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">80</span>    

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li> <li><p>headers：提供了对HTTP header的一种操作机制，可以修改一次HTTP请求中的Request或Response的值，包含request和response两个字段。</p> <ul><li>request：表示在发请求给目标地址时修改Request的header。</li> <li>response：表示在返回应答时修改Response的header</li> <li>对应的类型都是HeaderOperations类型，使用set、add、remove字段来定义对Header的操作。
<ul><li>set：使用map上的key和value覆盖Request和Response中对应的Header</li> <li>add：追加map上的key和value到原有的Header</li> <li>remove：删除在列表中华指定的Header</li></ul></li></ul></li></ul> <h3 id="_2-4-http重定向-httpredirect"><a href="#_2-4-http重定向-httpredirect" class="header-anchor">#</a> 2.4 HTTP重定向（HTTPRedirect）</h3> <p>Istio对于HTTP除了做流量路由，还可以做适当的其他操作，很多原来需要在代码中进行的HTTP操作，在使用Istio后通过这些配置都可以达到同样的效果。</p> <p>通过HTTPRedirect可以发送一个301重定向的应答给服务调用方，简单讲就是从一个URL到另外一个URL的永久重定向。用户输入一个URL，通过HTTPRedirect可以将其跳转到另一个URL。比较常见的场景：有一个在线网站，网址变了，通过这样的重定向，可以在用户输入老地址时跳转到新地址。
比如：</p> <ul><li>用户请求老地址：http://forecast/advertisement</li> <li>服务端返回301重定向新地址 http://new-forecast/recommendation/activity</li> <li>用户请求新地址http://new-forecast/recommendation/activity</li> <li>得到新地址</li></ul> <p>HTTPRedirect包括两个重要的字段来表示重定向的目标。</p> <ul><li>uri：替换URL中的uri部分</li> <li>authority：替换URL中的Authority部分</li></ul> <p>示例：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>apiVersion<span class="token punctuation">:</span>networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> forecast
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> weather
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> forecast
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span> 
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /advertisement
    <span class="token key atrule">redirect</span><span class="token punctuation">:</span>
      <span class="token key atrule">uri</span><span class="token punctuation">:</span> /recommendation/activity
      <span class="token key atrule">authority</span><span class="token punctuation">:</span> new<span class="token punctuation">-</span>forecast    

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>对forecast服务所有前缀是<code>/advertisement</code>的请求都会被重定向到new-forecast的<code>/recommendation/activity</code>地址。</p> <h3 id="_2-5-http重写-httprewrite"><a href="#_2-5-http重写-httprewrite" class="header-anchor">#</a> 2.5 HTTP重写（HTTPRewrite）</h3> <p>通过HTTP重写可以在将请求转发给目标服务前修改HTTP请求中指定部分的内容，不同于重定向，用户是可见，HTTP重写对用户是不可见的，因为是在服务端进行的。</p> <p>和重定向配置类似，重写HTTP也包括uri和authority这两个字段。</p> <ul><li>uri：重写URL中的Path部分</li> <li>authority：重写URL中的Authority</li></ul> <p>和HTTPRedirect规则稍有不同的是，HTTPRedirect的uri只能替换全部的Path，HTTPRewrite的uri是可以重写前缀的，即如果原来匹配条件是前缀匹配，则修改后只修改匹配到的前缀。</p> <p>示例：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> forecast
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> weather
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> forecast
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uri</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /advertisement
    <span class="token key atrule">rewrite</span><span class="token punctuation">:</span>
      <span class="token key atrule">uri</span><span class="token punctuation">:</span> /recommendation/activity
    <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> forecast   

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>前缀匹配<code>/advertisement</code>的请求，其请求uri中的这部分前缀会被<code>/recommendation/activity</code>替换</p> <h3 id="_2-6-http重试-httpretry"><a href="#_2-6-http重试-httpretry" class="header-anchor">#</a> 2.6 HTTP重试（HTTPRetry）</h3> <p>HTTP重试是解决很多请求异常最直接、简单的方法，尤其是在工作环境比较复杂的场景下，可提高总体的服务质量。</p> <p>但是重试使用不当也会有问题，最糟糕的情况是重试一直不成功，反而增加延迟和性能开销。所以，根据系统运行环境、服务自身特点，配置适当的重试规则显得尤为重要。</p> <p>HTTPRetry可以定义请求失败时的重试策略，重试策略包括重试次数、超时、重试条件等，这里分别描述相应的三个字段。</p> <ul><li>attempts：必选字段，定义重试的次数</li> <li>perTryTimeout：每次重试超时的时间，单位可以是ms、s、m和h</li> <li>retryOn：进行重试的条件，可以是多个条件，以逗号分隔</li></ul> <p>其中重试条件retryOn的取值可以包括以下几种:</p> <ul><li>5xx：在上游服务返回5xx应答码，或者在没有返回时重试</li> <li>gateway-error：类似于5xx异常，只对502、503和504应答码进行重试。</li> <li>connect-failure：在链接上游服务失败时重试</li> <li>retriable-4xx：在上游服务返回可重试的4xx应答码时执行重试。</li> <li>refused-stream：在上游服务使用REFUSED_STREAM错误码重置时执行重试。</li> <li>cancelled：gRPC应答的Header中状态码是cancelled时执行重试。</li> <li>deadline-exceeded：在gRPC应答的Header中状态码是deadline-exceeded时执行重试</li> <li>internal：在gRPC应答的Header中状态码是internal时执行重试</li> <li>resource-exhausted：在gRPC应答的Header中状态码是resource-exhausted时执行重试</li> <li>unavailable：在gRPC应答的Header中状态码是unavailable时执行重试。</li></ul> <p>示例：</p> <p>配置了一个重试策略，在<code>5xx,connect-failure</code>条件下进行最多5次重试，每次重试超时为3秒</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">medata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> forecast
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> weather
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> forecast
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> forecast
    <span class="token key atrule">retries</span><span class="token punctuation">:</span>
      <span class="token key atrule">attempts</span><span class="token punctuation">:</span> <span class="token number">5</span>
      <span class="token key atrule">perTryTimeout</span><span class="token punctuation">:</span> 3s
      <span class="token key atrule">retryOn</span><span class="token punctuation">:</span> 5xx<span class="token punctuation">,</span>connect<span class="token punctuation">-</span>failure    
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_2-7-http流量镜像-mirror"><a href="#_2-7-http流量镜像-mirror" class="header-anchor">#</a> 2.7 HTTP流量镜像（Mirror）</h3> <p>HTTP流量镜像指的是将流量转发到原目标地址的同时将流量给另外一个目标地址镜像一份。把生产环境中的实际流量镜像一份到另外一个系统上，完全不会对生产系统产生影响，这里只是镜像了一份流量，数据面代理只需要关注原来转发的流量就可以，不用等待镜像目标地址的返回。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io<span class="token punctuation">:</span>v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> forecast
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> weather
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> forecast
  <span class="token key atrule">http</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> forecast
      <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">mirror</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> forecast
      <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_2-8-http故障注入-httpfaultinjection"><a href="#_2-8-http故障注入-httpfaultinjection" class="header-anchor">#</a> 2.8 HTTP故障注入（HTTPFaultInjection）</h3> <p>HTTPFaultInjection通过delay和abort两个字段设置延时和中止两种故障，分别表示Proxy延迟转发HTTP请求和中止HTTP请求。</p> <ul><li><p>延迟故障注入</p> <p>HTTPFaultInjection中的延迟故障使用HTTPFaultInjection.Delay 类型描述延时故障，表示在发送请求前进行一段延时，模拟网络、远端服务负载均衡等各种原因导致的失败，主要是如下两个字段：</p> <ul><li>fixedDelay：一个必选字段，表示延迟时间，单位可以是毫秒、秒、分钟和小时，要求至少大于1毫秒</li> <li>percentage：配置的延迟故障作用在多少的比例的请求上，通过这种方式可以只让部分请求发生故障。</li></ul> <p>示例：</p> <p>forecast服务v1版本上的1.5%的请求产生10秒的延时</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">...</span><span class="token punctuation">...</span>
<span class="token key atrule">route</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> forecast
    <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
<span class="token key atrule">fault</span><span class="token punctuation">:</span>
  <span class="token key atrule">delay</span><span class="token punctuation">:</span>
    <span class="token key atrule">percenttage</span><span class="token punctuation">:</span>
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">1.5</span>
    <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 10s     
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li> <li><p>请求中止故障注入</p> <p>HTTPFaultInjection 使用HTTPFaultInjection.Abort 描述中止故障，模拟服务端异常，给调用的客户端返回预先定义的错误状态码，主要有以下两个字段：</p> <ul><li>httpStatus：是一个必选字段，表示中止的HTTP状态码</li> <li>percentage：配置中止故障作用在多少比例的请求上，通过这种方式可以只让部分请求发生故障，用法通延迟故障</li></ul> <p>示例：</p> <p>让forecast服务v1版本上1.5%的请求返回“500”代码</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">...</span><span class="token punctuation">...</span>
<span class="token key atrule">route</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> forecast
    <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
<span class="token key atrule">fault</span><span class="token punctuation">:</span>
  <span class="token key atrule">abort</span><span class="token punctuation">:</span>
    <span class="token key atrule">percnetage</span><span class="token punctuation">:</span> 
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">1.5</span>
    <span class="token key atrule">httpStatus</span><span class="token punctuation">:</span> <span class="token number">500</span>    
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div></li></ul> <h3 id="_2-9-http跨域资源共享-corspolicy"><a href="#_2-9-http跨域资源共享-corspolicy" class="header-anchor">#</a> 2.9 HTTP跨域资源共享（CorsPolicy）</h3> <p>当一个资源向该资源所在服务器的不同的域发起请求时，就会产生一个跨域的HTTP请求。出于安全考虑，浏览器会限制从脚本发起的跨域HTTP请求。通过跨域资源共享CORS（Cross Origin Resource Sharing）机制可允许web应用服务器进行跨域访问控制，使跨域数据传递安全进行。在实现上是在HTTP Header中追加一些额外的信息来通知浏览器准许以上访问。</p> <p>在 VirtualService 中可以对满足条件的请求配置跨域资源共享。有allowOrigin、allowMethods、allowHeader、exposeHeader、maxAge、allowCredentials，其实都是被转化为 Access-Control-* 的Header。 如下所示，允许源自news.com的GET方法的请求的访问:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">...</span><span class="token punctuation">...</span>
<span class="token key atrule">http</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> forecast
    <span class="token key atrule">corsPolicy</span><span class="token punctuation">:</span>
      <span class="token key atrule">allowOrigin</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> news.com
      <span class="token key atrule">allowMethods</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> GET
      <span class="token key atrule">maxAge</span><span class="token punctuation">:</span> <span class="token string">&quot;2d&quot;</span>    

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="_3-destinationrule"><a href="#_3-destinationrule" class="header-anchor">#</a> 3. DestinationRule</h2> <p>在讲解virtualService中，路由目标对象destination中会包含Service子集的subset字段，这个服务子集就是通过DestinationRule定义的。</p> <p>比如：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers<span class="token punctuation">-</span>destination
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">host</span><span class="token punctuation">:</span> customers.default.svc.cluster.local
   <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
   <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
     <span class="token key atrule">labels</span><span class="token punctuation">:</span>
       <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
   <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
     <span class="token key atrule">labels</span><span class="token punctuation">:</span>
       <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>上述定义了两个子集，v1和v2，同时根据标签来决定哪个Pod需要包含在子集中。</p> <table><thead><tr><th><strong>DestinationRule字段名称</strong></th> <th><strong>字段含义</strong></th></tr></thead> <tbody><tr><td>spec.host</td> <td>关联 DestinationRule 配置的服务名称，可以是自动发现的服务（例如 Kubernetes service name），或通过 ServiceEntry 声明的 hosts。如填写的服务名无法在上述源中找到，则该 DestinationRule 中定义的规则无效</td></tr> <tr><td>spec.subsets</td> <td>定义服务的版本（subsets），版本可通过标签键值对匹配匹配服务中的endpoints。可以在 subsets 级覆盖流量策略配置</td></tr> <tr><td>spec.trafficPolicy</td> <td>定义流量策略，包括负载均衡、连接池、健康检查、TLS 策略</td></tr> <tr><td>spec.trafficPolicy.loadBalancer</td> <td>配置负载均衡算法，可配置：简单负载均衡算法（round robin, least conn, random...），一致性哈希（会话保持，支持按 header name，cookie，IP，query parameter 哈希），地域感知负载均衡算法</td></tr> <tr><td>spec.trafficPolicy.connectionPool</td> <td>配置与上游服务的连接量，可设置 TCP/HTTP 的连接池</td></tr> <tr><td>spec.trafficPolicy.outlierDetection</td> <td>配置从负载均衡池中驱逐不健康的 hosts</td></tr> <tr><td>spec.trafficPolicy.tls</td> <td>连接上游服务的 client 端 TLS 相关配置，与 PeerAuthentication 策略（server 端 TLS 模式配置）配合使用</td></tr> <tr><td>spec.trafficPolicy.portLevelSettings</td> <td>配置端口级别的流量策略，端口级别的流量策略会覆盖服务 / subsets 级别的流量策略配置</td></tr></tbody></table> <p><strong>通过 DestinationRule，我们可以定义设置，如负载均衡配置、连接池大小、局部异常检测等，在路由发生后应用于流量。我们可以在 <code>trafficPolicy</code> 字段下设置流量策略</strong>。以下是这些设置：</p> <ul><li>负载均衡器设置</li> <li>连接池设置</li> <li>局部异常点检测</li> <li>客户端 TLS 设置</li> <li>端口流量策略</li></ul> <h3 id="_3-1-负载均衡器设置"><a href="#_3-1-负载均衡器设置" class="header-anchor">#</a> 3.1 负载均衡器设置</h3> <p>通过负载均衡器设置，我们可以控制目的地使用哪种负载均衡算法。</p> <p>示例：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers<span class="token punctuation">-</span>destination
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">host</span><span class="token punctuation">:</span> customers.default.svc.cluster.local
   <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
     <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
       <span class="token key atrule">simple</span><span class="token punctuation">:</span> ROUND_ROBIN <span class="token comment">#将负载均衡算法设置为轮询方式</span>
   <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
   <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
     <span class="token key atrule">labels</span><span class="token punctuation">:</span>
       <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
   <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
     <span class="token key atrule">labels</span><span class="token punctuation">:</span>
       <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li><p>simple字段：</p> <p>提供的负载均衡算法如下：</p> <ul><li>ROUND_ROBIN:轮询算法，如果未指定，则默认采用这种算法。</li> <li>LEAST_CONN:最少连接算法，算法实现是从两个随机选择的服务后端选择一个活动请求数较少 的后端实例。</li> <li>RANDOM:从可用的健康实例中随机选择一个。</li> <li>PASSTHROUGH:直接转发连接到客户端连接的目标地址，即没有做负载均衡。</li></ul></li> <li><p>consistentHash字段：</p> <p>一致性hash，并根据 HTTP 头、cookies 或其他请求属性提供会话亲和性。</p> <ul><li>httpHeaderName: 基于Header。</li> <li>httpCookie: 基于Cookie。</li> <li>useSourceIp:基于源IP计算哈希值。</li> <li>minimumRingSize:哈希环上虚拟节点数的最小值，节点数越多则负载均衡越精细。</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
   <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
     <span class="token key atrule">consistentHash</span><span class="token punctuation">:</span>
       <span class="token key atrule">httpCookie</span><span class="token punctuation">:</span>
         <span class="token key atrule">name</span><span class="token punctuation">:</span> location
         <span class="token key atrule">ttl</span><span class="token punctuation">:</span> 4s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li></ul> <h3 id="_3-2-连接池配置"><a href="#_3-2-连接池配置" class="header-anchor">#</a> 3.2 连接池配置</h3> <p>可以在 TCP 和 HTTP 层面应用于上游服务的每个主机，我们可以用它们来控制连接量</p> <ul><li><p>TCP连接池配置</p> <ul><li>maxConnections:上游服务的所有实例建立的最大连接数，默认是 1024，属于 TCP层的配
置，对于 HTTP，只用于 HTTP/1.1，因为 HTTP/2对每个主机都使用单个连接。</li> <li>connectTimeout:TCP连接超时，表示主机网络连接超时，可以改善因调用服务变慢导致整个链路
变慢的情况。</li> <li>tcpKeepalive:设置TCP keepalives，是Istio1.1新支持的配置，定期给对端发送一个keepalive的探测包，判断连接是否可用。</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">host</span><span class="token punctuation">:</span> myredissrv.prod.svc.cluster.local
   <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
     <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
       <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
         <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">50</span>
         <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> 25ms
         <span class="token key atrule">tcpKeepalive</span><span class="token punctuation">:</span>
           <span class="token key atrule">probes</span><span class="token punctuation">:</span> <span class="token number">5</span>
           <span class="token key atrule">time</span><span class="token punctuation">:</span> <span class="token number">3600</span>
           <span class="token key atrule">interval</span><span class="token punctuation">:</span> 60s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div></li> <li><p>http连接池配置</p> <ul><li><p>http1MaxPendingRequests: 最大等待 HTTP 请求数，默认值是 1024，只适用于HTTP/1.1 的服务，因为 HTTP/2 协议的请求在到来时会立即复用连接，不会在连接池等待。</p></li> <li><p>http2MaxRequests:最大请求数，默认是1024。只适用于HTTP/2服务，因为HTTP/1.1使用最大连
接数maxConnections即可，表示上游服务的所有实例处理的最大请求数</p></li> <li><p>maxRequestsPerConnection:每个连接的最大请求数。HTTP/1.1和HTTP/2连接池都遵循此参数。如果没有设置，则没有限制。设置为1时表示每个连接只处理一个请求，也就是禁用了Keep-alive</p></li> <li><p>maxRetries:最大重试次数，默认是3，表示服务可以执行的最大重试次数。</p> <p>如果调用端因为偶尔抖动导致请求直接失败，则可能会带来业务损失，一般建议配置重试，若重试成功则可正常返回数据， 只不过比原来响应得慢一点，但重试次数太多会影响性能，要谨慎使用。</p></li> <li><p>idleTimeout:空闲超时，定义在多长时间内没有活动请求则关闭连接。</p></li></ul></li></ul> <p>http可以和tcp配置使用，示例：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">host</span><span class="token punctuation">:</span> myredissrv.prod.svc.cluster.local
   <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
     <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
       <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
         <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">80</span>
         <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> 25ms
       <span class="token key atrule">http</span><span class="token punctuation">:</span>
         <span class="token key atrule">http2MaxRequests</span><span class="token punctuation">:</span> <span class="token number">800</span>
         <span class="token key atrule">maxRequestsPerConnection</span><span class="token punctuation">:</span> <span class="token number">10</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>配置最大80个连接，只允许最多有800个并发请求，每个连接 的请求数不超过10个，连接超时是25毫秒。</p> <h3 id="_3-3-异常点检测"><a href="#_3-3-异常点检测" class="header-anchor">#</a> 3.3 异常点检测</h3> <p>异常点检测是一个断路器的实现，它跟踪上游服务中每个主机（Pod）的状态。如果一个主机开始返回 5xx HTTP 错误，它就会在预定的时间内被从负载均衡池中弹出。对于 TCP 服务，Envoy 将连接超时或失败计算为错误。</p> <p>两种健康检查：</p> <ul><li>主动型的健康检查：定期探测目标服务实例，根据应答来判断服务实例的健康状态。如负载均衡器中的健康检查</li> <li>被动型的健康检查：通过实际的访问情况来找出不健康的实例，如isito中的异常点检查。</li></ul> <p>异常实例检查相关的配置：</p> <ul><li>consecutiveErrors:实例被驱逐前的连续错误次数，默认是 5。对于 HTTP 服务，返回 502、503 和 504 的请求会被认为异常;对于 TCP 服务，连接超时或者连接错误事件会被认为异常。</li> <li>interval:驱逐的时间间隔，默认值为10秒，要求大于1毫秒，单位可以是时、分、毫秒。</li> <li>baseEjectionTime:最小驱逐时间。一个实例被驱逐的时间等于这个最小驱逐时间乘以驱逐的次数。这样一个因多次异常被驱逐的实例，被驱逐的时间会越来越长。默认值为30秒，要求大于1毫秒，单 位可以是时、分、毫秒。</li> <li>maxEjectionPercent:指负载均衡池中可以被驱逐的故障实例的最大比例，默认是10%，设置这个值是为了避免太多的服务实例被驱逐导致服务整体能力下降。</li> <li>minHealthPercent:最小健康实例比例，是Istio 1.1新增的配置。当负载均衡池中的健康实例数的 例大于这个比例时，异常点检查机制可用;当可用实例数的比例小于这个比例时，异常点检查功能将被禁用，所有服务实例不管被认定为健康还是不健康，都可以接收请求。参数的默认值为50%。</li></ul> <p>下面是一个例子，它设置了 500 个并发的 HTTP2 请求（<code>http2MaxRequests</code>）的限制，每个连接不超过 10 个请求（<code>maxRequestsPerConnection</code>）到该服务。每 5 分钟扫描一次上游主机（Pod）（<code>interval</code>），如果其中任何一个主机连续失败 10 次（<code>contracticalErrors</code>），Envoy 会将其弹出 10 分钟（<code>baseEjectionTime</code>）。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
   <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
     <span class="token key atrule">http</span><span class="token punctuation">:</span>
       <span class="token key atrule">http2MaxRequests</span><span class="token punctuation">:</span> <span class="token number">500</span>
       <span class="token key atrule">maxRequestsPerConnection</span><span class="token punctuation">:</span> <span class="token number">10</span>
   <span class="token key atrule">outlierDetection</span><span class="token punctuation">:</span>
     <span class="token key atrule">consecutiveErrors</span><span class="token punctuation">:</span> <span class="token number">10</span>
     <span class="token key atrule">interval</span><span class="token punctuation">:</span> 5m
     <span class="token key atrule">baseEjectionTime</span><span class="token punctuation">:</span> 10m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="_3-4-tls-设置"><a href="#_3-4-tls-设置" class="header-anchor">#</a> 3.4 TLS 设置</h3> <p>包含任何与上游服务连接的 TLS 相关设置。下面是一个使用提供的证书配置 mTLS 的例子:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
   <span class="token key atrule">tls</span><span class="token punctuation">:</span>
     <span class="token key atrule">mode</span><span class="token punctuation">:</span> MUTUAL
     <span class="token key atrule">clientCertificate</span><span class="token punctuation">:</span> /etc/certs/cert.pem
     <span class="token key atrule">privateKey</span><span class="token punctuation">:</span> /etc/certs/key.pem
     <span class="token key atrule">caCertificates</span><span class="token punctuation">:</span> /etc/certs/ca.pem

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><blockquote><p>mtls : 双向认证,客户机和服务器都通过证书颁发机构彼此验证身份。</p> <p>由同一个 root ca 生成两套证书，即客户端证书和服务端证书。客户端使用 https 访问服务端时，双方会交换证书，并进行认证，认证通过方可通信。</p></blockquote> <p>其他支持的 TLS 模式有 <code>DISABLE</code>（<strong>没有 TLS 连接</strong>），<code>SIMPLE</code>（<strong>在上游端点发起 TLS 连接</strong>），以及 <code>ISTIO_MUTUAL</code>（与 <code>MUTUAL</code> 类似，<strong>使用 Istio 的 mTLS 证书</strong>）。</p> <h3 id="_3-5-端口流量策略"><a href="#_3-5-端口流量策略" class="header-anchor">#</a> 3.5 端口流量策略</h3> <p>在端口上配置流量策略，且端口上流量策略会覆盖全局的流量策略。
关于配置方法与TrafficPolicy没有大差别，一个关键的差别字段就是 <code>port</code>。</p> <p>示例：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
   <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
     <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
       <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">80</span>
   <span class="token key atrule">portLevelSettings</span><span class="token punctuation">:</span>
   <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
       <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
     <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
       <span class="token key atrule">simple</span><span class="token punctuation">:</span> LEAST_CONN
     <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
       <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
         <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">100</span>
   <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
       <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">8000</span>
     <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span>
       <span class="token key atrule">simple</span><span class="token punctuation">:</span> ROUND_ROBIN
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="_3-6-服务子集"><a href="#_3-6-服务子集" class="header-anchor">#</a> 3.6 服务子集</h3> <p>Subset，定义服务的子集。</p> <p>属性：</p> <ul><li>name: Subset的名字，为必选字段。通过VirtualService引用的就是这个名字。</li> <li>labels:Subset上的标签，通过一组标签定义了属于这个Subset的服务实例。比如最常用的标识服
务版本的Version标签。</li> <li>trafficPolicy:应用到这个Subset上的流量策略。</li></ul> <p>示例：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">...</span>..
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span> forecast
  <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">trafficPolicy</span><span class="token punctuation">:</span>
     <span class="token key atrule">connectionPool</span><span class="token punctuation">:</span>
       <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
         <span class="token key atrule">maxConnections</span><span class="token punctuation">:</span> <span class="token number">80</span>    <span class="token comment"># 给一个特定的Subset配置最大连接数</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_4-实战"><a href="#_4-实战" class="header-anchor">#</a> 4. 实战</h2> <blockquote><p>使用权重在不同的服务版本之间路由流量</p></blockquote> <ul><li><p>先部署一个Gateway</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> http
        <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
      <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token string">'*'</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master weight<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f gateway.yaml</span>
<span class="token comment">#将default加入istio中</span>
<span class="token punctuation">[</span>root@master weight<span class="token punctuation">]</span><span class="token comment"># kubectl label namespace default istio-injection=enabled</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>部署一个应用（deploy和service）</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
       <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">template</span><span class="token punctuation">:</span>
     <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
         <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
     <span class="token key atrule">spec</span><span class="token punctuation">:</span>
       <span class="token key atrule">containers</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mszlu/web<span class="token punctuation">-</span>frontend<span class="token punctuation">:</span>1.0.0
           <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
           <span class="token key atrule">name</span><span class="token punctuation">:</span> web
           <span class="token key atrule">ports</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
           <span class="token key atrule">env</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CUSTOMER_SERVICE_URL
               <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'http://customers.default.svc.cluster.local'</span>
<span class="token punctuation">---</span>
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">ports</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
       <span class="token key atrule">name</span><span class="token punctuation">:</span> http
       <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> web-frontend.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>CUSTOMER_SERVICE_URL是说上述的web-frontend服务需要访问一个customers的服务，所以我们需要部署一个customer的服务</p></li> <li><p>部署 Customers 服务的 v1版本</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment             
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers<span class="token punctuation">-</span>v1
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
     <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
       <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
       <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
   <span class="token key atrule">template</span><span class="token punctuation">:</span>
     <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
         <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
     <span class="token key atrule">spec</span><span class="token punctuation">:</span>
       <span class="token key atrule">containers</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mszlu/customers<span class="token punctuation">:</span>1.0.0
           <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
           <span class="token key atrule">name</span><span class="token punctuation">:</span> svc
           <span class="token key atrule">ports</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>
<span class="token punctuation">---</span>
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
   <span class="token key atrule">ports</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
       <span class="token key atrule">name</span><span class="token punctuation">:</span> http
       <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> customers-v1.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>为 <code>web-frontend</code> 创建一个 VirtualService，并将其绑定到 Gateway 资源上</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token string">'*'</span>
   <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> gateway
   <span class="token key atrule">http</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
             <span class="token key atrule">host</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend.default.svc.cluster.local
             <span class="token key atrule">port</span><span class="token punctuation">:</span>
               <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> web-frontend-vs.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>访问gateway</p> <p><img src="img/image-20221116004036404.png" alt="image-20221116004036404"></p></li> <li><p>创建 DestinationRule，并定义两个子集，代表 v1 和 v2 版本</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">host</span><span class="token punctuation">:</span> customers.default.svc.cluster.local
   <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
     <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">version</span><span class="token punctuation">:</span> v2

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> customers-dr.yaml 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>创建 VirtualService 并在目标中指定 v1子集</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token string">'customers.default.svc.cluster.local'</span>
   <span class="token key atrule">http</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
             <span class="token key atrule">host</span><span class="token punctuation">:</span> customers.default.svc.cluster.local
             <span class="token key atrule">port</span><span class="token punctuation">:</span>
               <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
             <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>每当有请求被发送到 Kubernetes Customers 服务时，它将被路由到同一服务的 v1子集</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> customers-vs.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>部署 v2 版的 Customers 服务</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers<span class="token punctuation">-</span>v2
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
     <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
       <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
       <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
   <span class="token key atrule">template</span><span class="token punctuation">:</span>
     <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
         <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
     <span class="token key atrule">spec</span><span class="token punctuation">:</span>
       <span class="token key atrule">containers</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mszlu/customers<span class="token punctuation">:</span>2.0.0
           <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
           <span class="token key atrule">name</span><span class="token punctuation">:</span> svc
           <span class="token key atrule">ports</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> customers-v2.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>使用 <code>weight</code> 字段并修改 VirtualService，使 50% 的流量被发送到 v1 子集，另 50% 发送到 v2 子集</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token string">'customers.default.svc.cluster.local'</span>
   <span class="token key atrule">http</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
             <span class="token key atrule">host</span><span class="token punctuation">:</span> customers.default.svc.cluster.local
             <span class="token key atrule">port</span><span class="token punctuation">:</span>
               <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
             <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
           <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span>
         <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
             <span class="token key atrule">host</span><span class="token punctuation">:</span> customers.default.svc.cluster.local
             <span class="token key atrule">port</span><span class="token punctuation">:</span>
               <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
             <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
           <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">50</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> customers-50-50.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>测试</p> <p>刷新页面，在v1和v2版本之间切换，更改权重 刷新页面观察</p> <p><img src="img/image-20221116011107400.png" alt="image-20221116011107400"></p></li></ul> <blockquote><p>使用请求属性在多个服务版本之间路由流量</p></blockquote> <ul><li><p>部署 Gateway</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
   <span class="token key atrule">servers</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
         <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
         <span class="token key atrule">name</span><span class="token punctuation">:</span> http
         <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
       <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token string">'*'</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> gateway.yaml 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>部署Web前端、Customers v1、Customers v2，以及相应的 VirtualServices 和 DestinationRule。一旦一切部署完毕，所有流量将被路由到 Customers v1。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
       <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">template</span><span class="token punctuation">:</span>
     <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
         <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
     <span class="token key atrule">spec</span><span class="token punctuation">:</span>
       <span class="token key atrule">containers</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mszlu/web<span class="token punctuation">-</span>frontend<span class="token punctuation">:</span>1.0.0
           <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
           <span class="token key atrule">name</span><span class="token punctuation">:</span> web
           <span class="token key atrule">ports</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
           <span class="token key atrule">env</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CUSTOMER_SERVICE_URL
               <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'http://customers.default.svc.cluster.local'</span>
<span class="token punctuation">---</span>
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">ports</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
       <span class="token key atrule">name</span><span class="token punctuation">:</span> http
       <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token punctuation">---</span>
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token string">'*'</span>
   <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> gateway
   <span class="token key atrule">http</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
             <span class="token key atrule">host</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend.default.svc.cluster.local
             <span class="token key atrule">port</span><span class="token punctuation">:</span>
               <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> web-frontend.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers<span class="token punctuation">-</span>v1
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
     <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
       <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
       <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
   <span class="token key atrule">template</span><span class="token punctuation">:</span>
     <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
         <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
     <span class="token key atrule">spec</span><span class="token punctuation">:</span>
       <span class="token key atrule">containers</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mszlu/customers<span class="token punctuation">:</span>1.0.0
           <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
           <span class="token key atrule">name</span><span class="token punctuation">:</span> svc
           <span class="token key atrule">ports</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>
<span class="token punctuation">---</span>
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers<span class="token punctuation">-</span>v2
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
     <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
       <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
       <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
   <span class="token key atrule">template</span><span class="token punctuation">:</span>
     <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
         <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
     <span class="token key atrule">spec</span><span class="token punctuation">:</span>
       <span class="token key atrule">containers</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mszlu/customers<span class="token punctuation">:</span>2.0.0
           <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
           <span class="token key atrule">name</span><span class="token punctuation">:</span> svc
           <span class="token key atrule">ports</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>
<span class="token punctuation">---</span>
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
   <span class="token key atrule">ports</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
       <span class="token key atrule">name</span><span class="token punctuation">:</span> http
       <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>
<span class="token punctuation">---</span>
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token string">'customers.default.svc.cluster.local'</span>
   <span class="token key atrule">http</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
             <span class="token key atrule">host</span><span class="token punctuation">:</span> customers.default.svc.cluster.local
             <span class="token key atrule">port</span><span class="token punctuation">:</span>
               <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
             <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
<span class="token punctuation">---</span>
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">host</span><span class="token punctuation">:</span> customers.default.svc.cluster.local
   <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
     <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v2
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">version</span><span class="token punctuation">:</span> v2

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> customers.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>此时测试，流量都来自于v1.</p></li> <li><p>更新VirtualService，如果请求中包含一个 header <code>user: debug</code>，就把流量路由到 Customers v2，没有就路由到v1</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token string">'customers.default.svc.cluster.local'</span>
   <span class="token key atrule">http</span><span class="token punctuation">:</span>
   <span class="token punctuation">-</span> <span class="token key atrule">match</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">headers</span><span class="token punctuation">:</span>
         <span class="token key atrule">user</span><span class="token punctuation">:</span>
           <span class="token key atrule">exact</span><span class="token punctuation">:</span> debug
     <span class="token key atrule">route</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
         <span class="token key atrule">host</span><span class="token punctuation">:</span> customers.default.svc.cluster.local
         <span class="token key atrule">port</span><span class="token punctuation">:</span>
           <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
         <span class="token key atrule">subset</span><span class="token punctuation">:</span> v2
   <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
       <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
           <span class="token key atrule">host</span><span class="token punctuation">:</span> customers.default.svc.cluster.local
           <span class="token key atrule">port</span><span class="token punctuation">:</span>
             <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
           <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> customers-vs.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>测试</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">curl</span> <span class="token parameter variable">-H</span> <span class="token string">&quot;user: debug&quot;</span> http://GATEWAY_URL/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul> <h2 id="_5-实战-观察故障注入"><a href="#_5-实战-观察故障注入" class="header-anchor">#</a> 5. 实战：观察故障注入</h2> <blockquote><p>部署 Web 前端和 Customer V1 服务。然后，我们将在 Zipkin、Kiali 和 Grafana 中注入故障和延迟，并观察它们</p></blockquote> <p><img src="img/image-20221109231005787.png" alt="image-20221109231005787"></p> <ul><li><p>部署Gateway</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ingressgateway80
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
  <span class="token key atrule">servers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
        <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> http
        <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
      <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">'*'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> ingressgateway80.yaml 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>部署 Web Frontend、Service 和 VirtualService。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>  <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
  <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
  <span class="token key atrule">spec</span><span class="token punctuation">:</span>
    <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">selector</span><span class="token punctuation">:</span>
      <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
    <span class="token key atrule">template</span><span class="token punctuation">:</span>
      <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
        <span class="token key atrule">labels</span><span class="token punctuation">:</span>
          <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
          <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">spec</span><span class="token punctuation">:</span>
        <span class="token key atrule">containers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mszlu/web<span class="token punctuation">-</span>frontend<span class="token punctuation">:</span>1.0.0
            <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
            <span class="token key atrule">name</span><span class="token punctuation">:</span> web
            <span class="token key atrule">ports</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
            <span class="token key atrule">env</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CUSTOMER_SERVICE_URL
                <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'http://customers.default.svc.cluster.local'</span>
<span class="token punctuation">---</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
  <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
  <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
  <span class="token key atrule">spec</span><span class="token punctuation">:</span>
    <span class="token key atrule">selector</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> http
        <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token punctuation">---</span>
  <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
  <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
  <span class="token key atrule">spec</span><span class="token punctuation">:</span>
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'*'</span>
    <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ingressgateway80
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
              <span class="token key atrule">host</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend.default.svc.cluster.local
              <span class="token key atrule">port</span><span class="token punctuation">:</span>
                <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> web-frontend.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>部署 Customers v1 和相应的资源</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>  <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
  <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> customers<span class="token punctuation">-</span>v1
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
  <span class="token key atrule">spec</span><span class="token punctuation">:</span>
    <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">selector</span><span class="token punctuation">:</span>
      <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
        <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
    <span class="token key atrule">template</span><span class="token punctuation">:</span>
      <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
        <span class="token key atrule">labels</span><span class="token punctuation">:</span>
          <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
          <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
      <span class="token key atrule">spec</span><span class="token punctuation">:</span>
        <span class="token key atrule">containers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mszlu/customers<span class="token punctuation">:</span>1.0.0
            <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
            <span class="token key atrule">name</span><span class="token punctuation">:</span> svc
            <span class="token key atrule">ports</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>
<span class="token punctuation">---</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
  <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
  <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
  <span class="token key atrule">spec</span><span class="token punctuation">:</span>
    <span class="token key atrule">selector</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> http
        <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>
<span class="token punctuation">---</span>
  <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> DestinationRule
  <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
  <span class="token key atrule">spec</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> customers.default.svc.cluster.local
    <span class="token key atrule">subsets</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> v1
        <span class="token key atrule">labels</span><span class="token punctuation">:</span>
          <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
<span class="token punctuation">---</span>
  <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
  <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
  <span class="token key atrule">spec</span><span class="token punctuation">:</span>
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'customers.default.svc.cluster.local'</span>
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
              <span class="token key atrule">host</span><span class="token punctuation">:</span> customers.default.svc.cluster.local
              <span class="token key atrule">port</span><span class="token punctuation">:</span>
                <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
              <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
        <span class="token key atrule">fault</span><span class="token punctuation">:</span>
          <span class="token key atrule">delay</span><span class="token punctuation">:</span>
            <span class="token key atrule">percent</span><span class="token punctuation">:</span> <span class="token number">50</span>
            <span class="token key atrule">fixedDelay</span><span class="token punctuation">:</span> 5s

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> customers-delay.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>测试</p> <p>另开一个窗口，循环请求</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">curl</span> http://<span class="token variable">$GATEWAY_URL</span>/<span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>打开Grafana ，进入Istio Service Dashboard，你会发现客户端请求持续时间图上的持续时间增加了</p> <p><img src="img/image-20221116152317286.png" alt="image-20221116152317286"></p> <p>打开zipkin，选择 <code>serviceName</code> 和 <code>web-frontend.default</code>，然后添加<code>minDuration</code> 条件，输入 5s，点击搜索按钮，找到 trace。</p> <p>点击其中一个 trace，打开详细信息页面。在详情页上，我们会发现持续时间是 5 秒。</p> <p><img src="img/image-20221116152543458.png" alt="image-20221116152543458"></p> <p>单个 trace 有 4 个 span——点击 第3 个span，代表从 <code>web-frontend</code> 到客户服务的请求。</p> <p>你会注意到在细节中，<code>response_flags</code> 标签设置为 <code>DI</code>。&quot;DI&quot; 代表 &quot;延迟注入&quot;，表示该请求被延迟了。</p></li> <li><p>再次更新 VirtualService，这一次，我们将注入一个故障，对 50% 的请求返回 HTTP 500</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>  <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
  <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
  <span class="token key atrule">spec</span><span class="token punctuation">:</span>
    <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'customers.default.svc.cluster.local'</span>
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
              <span class="token key atrule">host</span><span class="token punctuation">:</span> customers.default.svc.cluster.local
              <span class="token key atrule">port</span><span class="token punctuation">:</span>
                <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
              <span class="token key atrule">subset</span><span class="token punctuation">:</span> v1
        <span class="token key atrule">fault</span><span class="token punctuation">:</span>
          <span class="token key atrule">abort</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpStatus</span><span class="token punctuation">:</span> <span class="token number">500</span>
            <span class="token key atrule">percentage</span><span class="token punctuation">:</span> 
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token number">50</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> customers-fault.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>回到 Grafana 并打开 Istio Service Dashboard，我们会注意到客户端的成功率在下降。</p> <p><img src="img/image-20221116153648735.png" alt="image-20221116153648735"></p> <p>在 Zipkin 中也有类似的情况。如果我们再次搜索 trace（我们可以删除最小持续时间），我们会发现有错误的 trace 会以红色显示</p> <p><img src="img/image-20221116153340495.png" alt="image-20221116153340495"></p> <p>打开 Kiali，通过点击 Graph 项查看服务图。你会注意到 <code>web-frontend</code> 服务有一个红色的边框</p> <p><img src="img/image-20221116153426741.png" alt="image-20221116153426741"></p> <p>点击 <code>web-frontend</code> 服务，看看右边的侧边栏，你会发现 HTTP 请求的细节。图中显示了成功和失败的百分比，这两个数字都在 50% 左右，这与我们在 VirtualService 中设置的百分比值相一致。</p></li></ul> <p><img src="img/image-20221116153521384.png" alt="image-20221116153521384"></p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/wulinghui/TechnicalSummary/edit/master/docs/Kubernetes/15.ServiceMesh/04.流量管理.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/01/26, 22:57:26</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/735e4b/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Istio安装</div></a> <a href="/pages/809099/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">istio安全</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/735e4b/" class="prev">Istio安装</a></span> <span class="next"><a href="/pages/809099/">istio安全</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/fff88c/"><div>
            架构升级踩坑之路
            <!----></div></a> <span class="date">02-27</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/ba6503/"><div>
            总结
            <!----></div></a> <span class="date">02-27</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/1b4e40/"><div>
            语法学习
            <!----></div></a> <span class="date">02-27</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:873406903@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/wulinghui" title="GitHub(移步到gitee)" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/hellowllh/projects" title="gitee" target="_blank" class="iconfont icon-gitee"></a><a href="https://blog.csdn.net/qq_41720208" title="CSDN" target="_blank" class="iconfont icon-gitee"></a><a href="https://www.cnblogs.com/wlh1995" title="博客园" target="_blank" class="iconfont icon-bokeyuan"></a></div> 
    | Copyright © 2021-2025
    <span>Wu lingui | <a href="" target="_blank"></a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.7f63dd6c.js" defer></script><script src="/assets/js/2.fe5f2a1d.js" defer></script><script src="/assets/js/3.eb8c603e.js" defer></script><script src="/assets/js/63.a6cb5e14.js" defer></script>
  </body>
</html>
