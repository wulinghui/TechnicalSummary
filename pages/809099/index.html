<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>istio安全 | 资料总结</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="个人资料总结，存放笔记">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.76dfa4dd.css" as="style"><link rel="preload" href="/assets/js/app.7f63dd6c.js" as="script"><link rel="preload" href="/assets/js/2.fe5f2a1d.js" as="script"><link rel="preload" href="/assets/js/3.eb8c603e.js" as="script"><link rel="preload" href="/assets/js/64.f149661c.js" as="script"><link rel="prefetch" href="/assets/js/10.fe6b23fc.js"><link rel="prefetch" href="/assets/js/100.523c1b31.js"><link rel="prefetch" href="/assets/js/101.bbee1e6c.js"><link rel="prefetch" href="/assets/js/102.36d68ded.js"><link rel="prefetch" href="/assets/js/103.482d8685.js"><link rel="prefetch" href="/assets/js/104.9b20475d.js"><link rel="prefetch" href="/assets/js/105.0edc73b7.js"><link rel="prefetch" href="/assets/js/106.a9abfe31.js"><link rel="prefetch" href="/assets/js/107.2178a4c5.js"><link rel="prefetch" href="/assets/js/108.21d19ed0.js"><link rel="prefetch" href="/assets/js/109.5e1e3698.js"><link rel="prefetch" href="/assets/js/11.7d4a2ffb.js"><link rel="prefetch" href="/assets/js/110.ccc910aa.js"><link rel="prefetch" href="/assets/js/111.fcfd17d0.js"><link rel="prefetch" href="/assets/js/112.f91ccf6e.js"><link rel="prefetch" href="/assets/js/113.5cd28a7e.js"><link rel="prefetch" href="/assets/js/114.4ca8676c.js"><link rel="prefetch" href="/assets/js/115.c4d64d4e.js"><link rel="prefetch" href="/assets/js/116.47ba7426.js"><link rel="prefetch" href="/assets/js/117.3062ccb9.js"><link rel="prefetch" href="/assets/js/118.27991bba.js"><link rel="prefetch" href="/assets/js/119.53538539.js"><link rel="prefetch" href="/assets/js/12.ac798cdb.js"><link rel="prefetch" href="/assets/js/120.e9666755.js"><link rel="prefetch" href="/assets/js/121.73a1660e.js"><link rel="prefetch" href="/assets/js/122.59ac137e.js"><link rel="prefetch" href="/assets/js/123.b9124c91.js"><link rel="prefetch" href="/assets/js/124.12ffcf50.js"><link rel="prefetch" href="/assets/js/125.0403278b.js"><link rel="prefetch" href="/assets/js/126.cec37905.js"><link rel="prefetch" href="/assets/js/127.605a5010.js"><link rel="prefetch" href="/assets/js/128.a4cf61d9.js"><link rel="prefetch" href="/assets/js/129.164a08ce.js"><link rel="prefetch" href="/assets/js/13.8de4385c.js"><link rel="prefetch" href="/assets/js/130.1d4164bd.js"><link rel="prefetch" href="/assets/js/131.7796e583.js"><link rel="prefetch" href="/assets/js/132.c79c715f.js"><link rel="prefetch" href="/assets/js/133.48384f22.js"><link rel="prefetch" href="/assets/js/134.bf85bfff.js"><link rel="prefetch" href="/assets/js/135.1244d4cb.js"><link rel="prefetch" href="/assets/js/136.6650b052.js"><link rel="prefetch" href="/assets/js/137.e9f394e2.js"><link rel="prefetch" href="/assets/js/138.ae16527d.js"><link rel="prefetch" href="/assets/js/139.df1c969c.js"><link rel="prefetch" href="/assets/js/14.d82e6d84.js"><link rel="prefetch" href="/assets/js/140.a80aa424.js"><link rel="prefetch" href="/assets/js/141.10ab646d.js"><link rel="prefetch" href="/assets/js/142.508278ee.js"><link rel="prefetch" href="/assets/js/143.62aa16a7.js"><link rel="prefetch" href="/assets/js/144.c734b314.js"><link rel="prefetch" href="/assets/js/145.7dae44b0.js"><link rel="prefetch" href="/assets/js/146.b08fb7ab.js"><link rel="prefetch" href="/assets/js/147.6fee9f53.js"><link rel="prefetch" href="/assets/js/148.5a09fe8b.js"><link rel="prefetch" href="/assets/js/149.27046d2c.js"><link rel="prefetch" href="/assets/js/15.f0dc0e66.js"><link rel="prefetch" href="/assets/js/150.c05ae37c.js"><link rel="prefetch" href="/assets/js/151.57194eb1.js"><link rel="prefetch" href="/assets/js/152.bc7ad385.js"><link rel="prefetch" href="/assets/js/153.b3c7d891.js"><link rel="prefetch" href="/assets/js/154.0d3a00e5.js"><link rel="prefetch" href="/assets/js/155.b9afdc01.js"><link rel="prefetch" href="/assets/js/156.bfc71798.js"><link rel="prefetch" href="/assets/js/157.43852835.js"><link rel="prefetch" href="/assets/js/158.785caaa2.js"><link rel="prefetch" href="/assets/js/159.1716fd78.js"><link rel="prefetch" href="/assets/js/16.1217969a.js"><link rel="prefetch" href="/assets/js/160.54dfc0be.js"><link rel="prefetch" href="/assets/js/161.3a486b71.js"><link rel="prefetch" href="/assets/js/162.4365dac4.js"><link rel="prefetch" href="/assets/js/163.9e0305ed.js"><link rel="prefetch" href="/assets/js/164.9af7099c.js"><link rel="prefetch" href="/assets/js/165.07230640.js"><link rel="prefetch" href="/assets/js/166.a13e993d.js"><link rel="prefetch" href="/assets/js/167.233c305e.js"><link rel="prefetch" href="/assets/js/168.86996235.js"><link rel="prefetch" href="/assets/js/169.c643487c.js"><link rel="prefetch" href="/assets/js/17.65771bc0.js"><link rel="prefetch" href="/assets/js/170.fed7e19e.js"><link rel="prefetch" href="/assets/js/171.a191947e.js"><link rel="prefetch" href="/assets/js/172.a2368c89.js"><link rel="prefetch" href="/assets/js/173.aad8acd6.js"><link rel="prefetch" href="/assets/js/174.e5c4e9f4.js"><link rel="prefetch" href="/assets/js/175.ef19ddcf.js"><link rel="prefetch" href="/assets/js/176.7b8490c3.js"><link rel="prefetch" href="/assets/js/177.7d1f01a3.js"><link rel="prefetch" href="/assets/js/178.c5ea1f87.js"><link rel="prefetch" href="/assets/js/179.e54bc218.js"><link rel="prefetch" href="/assets/js/18.69d253af.js"><link rel="prefetch" href="/assets/js/180.a0fc0bcd.js"><link rel="prefetch" href="/assets/js/181.8029f765.js"><link rel="prefetch" href="/assets/js/182.72075fe8.js"><link rel="prefetch" href="/assets/js/183.f74d77ba.js"><link rel="prefetch" href="/assets/js/184.3277cbcd.js"><link rel="prefetch" href="/assets/js/185.15940a23.js"><link rel="prefetch" href="/assets/js/186.810a303a.js"><link rel="prefetch" href="/assets/js/187.9c8777f6.js"><link rel="prefetch" href="/assets/js/188.fed55d48.js"><link rel="prefetch" href="/assets/js/189.7f09c5db.js"><link rel="prefetch" href="/assets/js/19.87ab5597.js"><link rel="prefetch" href="/assets/js/190.082d7cbc.js"><link rel="prefetch" href="/assets/js/191.9fb2ec38.js"><link rel="prefetch" href="/assets/js/192.167d2083.js"><link rel="prefetch" href="/assets/js/193.d1eeb947.js"><link rel="prefetch" href="/assets/js/194.09e61c12.js"><link rel="prefetch" href="/assets/js/195.969efb5f.js"><link rel="prefetch" href="/assets/js/196.3932e830.js"><link rel="prefetch" href="/assets/js/197.1dc355f6.js"><link rel="prefetch" href="/assets/js/198.1ad8dbbf.js"><link rel="prefetch" href="/assets/js/199.c6b23b90.js"><link rel="prefetch" href="/assets/js/20.3d741608.js"><link rel="prefetch" href="/assets/js/200.81a125db.js"><link rel="prefetch" href="/assets/js/201.5e2fd593.js"><link rel="prefetch" href="/assets/js/202.51a3fbc4.js"><link rel="prefetch" href="/assets/js/203.4ae7c4f4.js"><link rel="prefetch" href="/assets/js/204.5ba79932.js"><link rel="prefetch" href="/assets/js/205.05bb64e4.js"><link rel="prefetch" href="/assets/js/206.c1d5472b.js"><link rel="prefetch" href="/assets/js/207.ad43feb1.js"><link rel="prefetch" href="/assets/js/208.250144c5.js"><link rel="prefetch" href="/assets/js/209.41667b8a.js"><link rel="prefetch" href="/assets/js/21.23841fc1.js"><link rel="prefetch" href="/assets/js/210.b85ec988.js"><link rel="prefetch" href="/assets/js/211.8f2f9335.js"><link rel="prefetch" href="/assets/js/212.dea21e7c.js"><link rel="prefetch" href="/assets/js/213.9074d848.js"><link rel="prefetch" href="/assets/js/214.baaf02d5.js"><link rel="prefetch" href="/assets/js/215.e3149f2c.js"><link rel="prefetch" href="/assets/js/216.5ede3f02.js"><link rel="prefetch" href="/assets/js/217.06eb8901.js"><link rel="prefetch" href="/assets/js/218.ffe5fc66.js"><link rel="prefetch" href="/assets/js/219.69c6166f.js"><link rel="prefetch" href="/assets/js/22.b55e8e09.js"><link rel="prefetch" href="/assets/js/220.a83c1ecf.js"><link rel="prefetch" href="/assets/js/221.fb65c799.js"><link rel="prefetch" href="/assets/js/222.1ff261ff.js"><link rel="prefetch" href="/assets/js/223.807c2de7.js"><link rel="prefetch" href="/assets/js/224.33540594.js"><link rel="prefetch" href="/assets/js/225.21d88d75.js"><link rel="prefetch" href="/assets/js/226.00d419d7.js"><link rel="prefetch" href="/assets/js/227.19678a11.js"><link rel="prefetch" href="/assets/js/228.d09fe33c.js"><link rel="prefetch" href="/assets/js/229.c8dcc95e.js"><link rel="prefetch" href="/assets/js/23.d7449079.js"><link rel="prefetch" href="/assets/js/230.7477ad3f.js"><link rel="prefetch" href="/assets/js/231.f1013950.js"><link rel="prefetch" href="/assets/js/232.1e07d0e6.js"><link rel="prefetch" href="/assets/js/233.34e0f2b8.js"><link rel="prefetch" href="/assets/js/234.645446d8.js"><link rel="prefetch" href="/assets/js/235.3368fdbc.js"><link rel="prefetch" href="/assets/js/236.35ed0de0.js"><link rel="prefetch" href="/assets/js/237.4a189e89.js"><link rel="prefetch" href="/assets/js/238.d6580ef3.js"><link rel="prefetch" href="/assets/js/239.c518fd70.js"><link rel="prefetch" href="/assets/js/24.26f18aa6.js"><link rel="prefetch" href="/assets/js/240.14979636.js"><link rel="prefetch" href="/assets/js/241.95c3b00d.js"><link rel="prefetch" href="/assets/js/242.a214e307.js"><link rel="prefetch" href="/assets/js/243.273af8d4.js"><link rel="prefetch" href="/assets/js/244.e2d74303.js"><link rel="prefetch" href="/assets/js/245.fe562cb9.js"><link rel="prefetch" href="/assets/js/246.b40011af.js"><link rel="prefetch" href="/assets/js/247.dc1a9aae.js"><link rel="prefetch" href="/assets/js/248.d691ac20.js"><link rel="prefetch" href="/assets/js/249.191f742a.js"><link rel="prefetch" href="/assets/js/25.198594bf.js"><link rel="prefetch" href="/assets/js/250.205b92cf.js"><link rel="prefetch" href="/assets/js/251.acb8a80e.js"><link rel="prefetch" href="/assets/js/26.c817356c.js"><link rel="prefetch" href="/assets/js/27.6b812306.js"><link rel="prefetch" href="/assets/js/28.9048721b.js"><link rel="prefetch" href="/assets/js/29.bfda8510.js"><link rel="prefetch" href="/assets/js/30.eb1b6ab9.js"><link rel="prefetch" href="/assets/js/31.3f3dbd2f.js"><link rel="prefetch" href="/assets/js/32.006bc754.js"><link rel="prefetch" href="/assets/js/33.05d371fe.js"><link rel="prefetch" href="/assets/js/34.27cd6ff5.js"><link rel="prefetch" href="/assets/js/35.35409a6d.js"><link rel="prefetch" href="/assets/js/36.fd6a950b.js"><link rel="prefetch" href="/assets/js/37.c8fd6ef4.js"><link rel="prefetch" href="/assets/js/38.028a36a2.js"><link rel="prefetch" href="/assets/js/39.e4494792.js"><link rel="prefetch" href="/assets/js/4.ff2df22c.js"><link rel="prefetch" href="/assets/js/40.979dec53.js"><link rel="prefetch" href="/assets/js/41.ff9662db.js"><link rel="prefetch" href="/assets/js/42.5c1441fc.js"><link rel="prefetch" href="/assets/js/43.9657eae8.js"><link rel="prefetch" href="/assets/js/44.a6cb5e5c.js"><link rel="prefetch" href="/assets/js/45.c675440c.js"><link rel="prefetch" href="/assets/js/46.06205970.js"><link rel="prefetch" href="/assets/js/47.ded0c65e.js"><link rel="prefetch" href="/assets/js/48.296a6f26.js"><link rel="prefetch" href="/assets/js/49.1b2ec2ab.js"><link rel="prefetch" href="/assets/js/5.ecde23f9.js"><link rel="prefetch" href="/assets/js/50.e551e67f.js"><link rel="prefetch" href="/assets/js/51.122d5b68.js"><link rel="prefetch" href="/assets/js/52.c0444208.js"><link rel="prefetch" href="/assets/js/53.f47d6b86.js"><link rel="prefetch" href="/assets/js/54.e9c9b41b.js"><link rel="prefetch" href="/assets/js/55.77010c1f.js"><link rel="prefetch" href="/assets/js/56.387aacbb.js"><link rel="prefetch" href="/assets/js/57.ddcf78ad.js"><link rel="prefetch" href="/assets/js/58.908b88fc.js"><link rel="prefetch" href="/assets/js/59.8ff535f1.js"><link rel="prefetch" href="/assets/js/6.b928f1b9.js"><link rel="prefetch" href="/assets/js/60.c5018386.js"><link rel="prefetch" href="/assets/js/61.1514e08b.js"><link rel="prefetch" href="/assets/js/62.79bc9197.js"><link rel="prefetch" href="/assets/js/63.a6cb5e14.js"><link rel="prefetch" href="/assets/js/65.30fa2026.js"><link rel="prefetch" href="/assets/js/66.e7f9f54e.js"><link rel="prefetch" href="/assets/js/67.7361f4a3.js"><link rel="prefetch" href="/assets/js/68.b67cc099.js"><link rel="prefetch" href="/assets/js/69.ba730416.js"><link rel="prefetch" href="/assets/js/7.b0514d37.js"><link rel="prefetch" href="/assets/js/70.45b9e858.js"><link rel="prefetch" href="/assets/js/71.2055eaae.js"><link rel="prefetch" href="/assets/js/72.75ec1304.js"><link rel="prefetch" href="/assets/js/73.3aa09b6b.js"><link rel="prefetch" href="/assets/js/74.fb3013f1.js"><link rel="prefetch" href="/assets/js/75.c837c896.js"><link rel="prefetch" href="/assets/js/76.9e6df886.js"><link rel="prefetch" href="/assets/js/77.4eb09ab0.js"><link rel="prefetch" href="/assets/js/78.06d19c8c.js"><link rel="prefetch" href="/assets/js/79.dfde586d.js"><link rel="prefetch" href="/assets/js/8.f86f2563.js"><link rel="prefetch" href="/assets/js/80.476da6d1.js"><link rel="prefetch" href="/assets/js/81.2b778375.js"><link rel="prefetch" href="/assets/js/82.abbf449f.js"><link rel="prefetch" href="/assets/js/83.24b0e8ea.js"><link rel="prefetch" href="/assets/js/84.f8694c96.js"><link rel="prefetch" href="/assets/js/85.f030e8b6.js"><link rel="prefetch" href="/assets/js/86.18853c72.js"><link rel="prefetch" href="/assets/js/87.4eca3df6.js"><link rel="prefetch" href="/assets/js/88.26b81c78.js"><link rel="prefetch" href="/assets/js/89.ae216049.js"><link rel="prefetch" href="/assets/js/9.7a3e1618.js"><link rel="prefetch" href="/assets/js/90.b0ee8ab4.js"><link rel="prefetch" href="/assets/js/91.a07b34f1.js"><link rel="prefetch" href="/assets/js/92.1c2952b1.js"><link rel="prefetch" href="/assets/js/93.e199901d.js"><link rel="prefetch" href="/assets/js/94.a901578c.js"><link rel="prefetch" href="/assets/js/95.641f6644.js"><link rel="prefetch" href="/assets/js/96.84a54aa3.js"><link rel="prefetch" href="/assets/js/97.c489ec61.js"><link rel="prefetch" href="/assets/js/98.5fb17174.js"><link rel="prefetch" href="/assets/js/99.c004152a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.76dfa4dd.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="资料总结" class="logo"> <span class="site-name can-hide">资料总结</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/goVersion181/" class="nav-link">go</a></div><div class="nav-item"><a href="/pages/springFramework/" class="nav-link">java</a></div><div class="nav-item"><a href="/pages/e5d517/" class="nav-link">云原生</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/pages/410b25/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/00291d/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/pages/846ee6/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/pages/5465c3/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/853b5b/" class="nav-link">设计模式详解</a></li><li class="dropdown-item"><!----> <a href="/pages/ebc515/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/pages/57778e/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/pages/282cd0/" class="nav-link">项目</a></li><li class="dropdown-item"><!----> <a href="/pages/2cd810/" class="nav-link">理论基础</a></li><li class="dropdown-item"><!----> <a href="/pages/6acd46/" class="nav-link">运营</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/wulinghui/TechnicalSummary" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src=""> <div class="blogger-info"><h3>linghui Wu</h3> <span>一只努力学飞的鱼</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/goVersion181/" class="nav-link">go</a></div><div class="nav-item"><a href="/pages/springFramework/" class="nav-link">java</a></div><div class="nav-item"><a href="/pages/e5d517/" class="nav-link">云原生</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/pages/410b25/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/00291d/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/pages/846ee6/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/pages/5465c3/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/853b5b/" class="nav-link">设计模式详解</a></li><li class="dropdown-item"><!----> <a href="/pages/ebc515/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/pages/57778e/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/pages/282cd0/" class="nav-link">项目</a></li><li class="dropdown-item"><!----> <a href="/pages/2cd810/" class="nav-link">理论基础</a></li><li class="dropdown-item"><!----> <a href="/pages/6acd46/" class="nav-link">运营</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/wulinghui/TechnicalSummary" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/e5d517/" class="sidebar-link">01-云原生概念</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>k8s</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>监控</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>日志</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DevOps</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>ServiceMesh</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/baba29/" class="sidebar-link">Istio概述</a></li><li><a href="/pages/735e4b/" class="sidebar-link">Istio安装</a></li><li><a href="/pages/a08be6/" class="sidebar-link">流量管理</a></li><li><a href="/pages/809099/" aria-current="page" class="active sidebar-link">istio安全</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/809099/#_1-isito认证" class="sidebar-link">1. Isito认证</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/809099/#_1-1-对等认证" class="sidebar-link">1.1 对等认证</a></li><li class="sidebar-sub-header level3"><a href="/pages/809099/#_1-2-请求认证" class="sidebar-link">1.2 请求认证</a></li><li class="sidebar-sub-header level3"><a href="/pages/809099/#_1-3-mtls" class="sidebar-link">1.3 mTLS</a></li><li class="sidebar-sub-header level3"><a href="/pages/809099/#_1-4-实战-启用mtls" class="sidebar-link">1.4 实战：启用mTLS</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/809099/#_2-授权" class="sidebar-link">2. 授权</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/809099/#_2-1-source" class="sidebar-link">2.1 source</a></li><li class="sidebar-sub-header level3"><a href="/pages/809099/#_2-2-操作operation" class="sidebar-link">2.2 操作operation</a></li><li class="sidebar-sub-header level3"><a href="/pages/809099/#_2-3-条件" class="sidebar-link">2.3 条件</a></li><li class="sidebar-sub-header level3"><a href="/pages/809099/#_2-4-实战-授权-访问控制" class="sidebar-link">2.4 实战：授权（访问控制）</a></li></ul></li></ul></li><li><a href="/pages/811549/" class="sidebar-link">高级功能</a></li><li><a href="/pages/b8c72b/" class="sidebar-link">实际案例</a></li><li><a href="/pages/ff6964/" class="sidebar-link">Istio总结</a></li></ul></section></li><li><a href="/pages/076b5d/" class="sidebar-link">Knative</a></li><li><a href="/pages/6d3863/" class="sidebar-link">spring-cloud-kubernetes</a></li><li><a href="/pages/cb6fc2/" class="sidebar-link">ms总结</a></li><li><a href="/pages/fff88c/" class="sidebar-link">架构升级踩坑之路</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/categories/?category=Kubernetes" title="分类" data-v-06970110>Kubernetes</a></li><li data-v-06970110><a href="/categories/?category=ServiceMesh" title="分类" data-v-06970110>ServiceMesh</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://gitee.com/hellowllh/projects" target="_blank" title="作者" class="beLink" data-v-06970110>wulinghui</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2023-01-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">istio安全<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="安全"><a href="#安全" class="header-anchor">#</a> 安全</h1> <p>安全涉及到认证和授权这两个概念。</p> <h2 id="_1-isito认证"><a href="#_1-isito认证" class="header-anchor">#</a> 1. Isito认证</h2> <p>对于网格中的每个工作负载，Istio 提供一个 X.509 证书。一个名为 <code>pilot-agent</code> 的代理在每个 Envoy 代理旁边运行，并与控制平面（<code>istiod</code>）一起工作，自动进行密钥和证书的轮转。</p> <blockquote><p>在实现层面，<code>istio-agent</code> 是指 sidecar 容器中的 <code>pilot-agent</code> 进程</p></blockquote> <p><img src="img/id-prov.svg" alt="身份供应"></p> <p>Istio Agent 与 Envoy sidecar 一起工作，通过安全地传递配置和Secret，帮助它们连接到服务网格。</p> <p>Istio 的身份和证书管理是通过 <code>SDS（安全发现服务）</code>来实现的。</p> <p>如果没有 SDS，证书必须作为Secret创建，然后装入代理容器的文件系统中。当证书过期时，需要更新Secret，并重新部署代理，因为 Envoy 不会从磁盘动态重新加载证书。</p> <p>当使用 SDS 时，SDS 服务器将证书推送给 Envoy 实例。每当证书过期时，SDS 会推送更新的证书，Envoy 可以立即使用它们。不需要重新部署代理服务器，也不需要中断流量。在 Istio 中，Istio Agent 作为 SDS 服务器，实现了SDS接口。</p> <p>其执行的流程如下所示：</p> <ul><li>首先 Istio 提供一个 gRPC 服务来接受证书签名请求（CSRs）</li> <li>Envoy 通过 SDS API 发送证书和密钥请求</li> <li>在收到 SDS 请求后，<code>istio-agent</code> 创建私钥和 CSR，然后将 CSR 及其凭据发送到 Istiod 中的 CA 服务进行签名</li> <li>CA 验证 CSR 中携带的凭据并签署 CSR 以生成证书</li> <li><code>istio-agent</code> 通过 Envoy SDS API 将私钥与从 Istio CA 收到的证书发送给 Envoy</li> <li>上述 CSR 过程会周期性地重复，以处理证书和密钥轮转</li></ul> <p><strong>Istio 提供两种类型的认证</strong>：对等认证和请求认证。</p> <h3 id="_1-1-对等认证"><a href="#_1-1-对等认证" class="header-anchor">#</a> 1.1 对等认证</h3> <p><strong>对等认证用于服务间的认证，以验证建立连接的客户端</strong>。</p> <p>当两个服务试图进行通信时，双向 TLS 要求它们都向对方提供证书，因此双方都知道它们在与谁交谈。如果我们想在服务之间启用严格的双向 TLS，我们可以<strong>使用 PeerAuthentication 资源，将 mTLS 模式设置为 STRICT</strong>。</p> <p>使用 PeerAuthentication 资源，我们可以打开整个服务网格的双向 TLS（mTLS），而不需要做任何代码修改。</p> <p>然而，<strong>Istio 也支持一种优雅的模式，我们可以选择在一个工作负载或命名空间内进入双向 TLS。这种模式被称为许可模式</strong>。</p> <p>当你安装 Istio 时，许可模式是默认启用的。启用许可模式后，如果客户端试图通过双向TLS 连接，Istio 将提供双向TLS。如果客户端不使用双向 TLS，Istio 也可以用纯文本响应。你可以允许客户端做或不做 mTLS。</p> <h3 id="_1-2-请求认证"><a href="#_1-2-请求认证" class="header-anchor">#</a> 1.2 请求认证</h3> <p><strong>请求认证（RequestAuthentication 资源）验证了附加在请求上的凭证，它被用于终端用户认证</strong>。</p> <p>请求级认证是通过 <a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">JSON Web Tokens（JWT）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 验证完成的。Istio 支持任何 OpenID Connect 提供商，如 Auth0、Firebase 或 Google Auth、Keycloak、ORY Hydra。我们可以使用 JWT 令牌来验证用户。</p> <h3 id="_1-3-mtls"><a href="#_1-3-mtls" class="header-anchor">#</a> 1.3 mTLS</h3> <p><strong>服务中的工作负载之间的通信是通过 Envoy 代理进行的。当一个工作负载使用 mTLS 向另一个工作负载发送请求时，Istio 会将流量重新路由到 sidecar 代理（Envoy）</strong>。</p> <p>然后，sidecar Envoy 开始与服务器端的 Envoy 进行 mTLS 握手。在握手过程中，调用者会进行安全命名检查，以验证服务器证书中的服务账户是否被授权运行目标服务。一旦 mTLS 连接建立，Istio 就会将请求从客户端的 Envoy 代理转发到服务器端的 Envoy 代理。在服务器端的授权后，sidecar 将流量转发到工作负载。</p> <p>我们可以在服务的目标规则中改变 mTLS 行为。支持的 TLS 模式有：<code>DISABLE</code>（无 TLS 连接）、<code>SIMPLE</code>（向上游端点发起 TLS 连接）、<code>MUTUAL</code>（通过出示客户端证书进行认证来使用 mTLS）和 <code>ISTIO_MUTUAL</code>（与 <code>MUTUAL</code> 类似，但使用 Istio 自动生成的证书进行 mTLS）。</p> <p><strong>许可模式（Permissive Mode）是一个特殊的选项</strong>，<strong>它允许一个服务同时接受纯文本流量和 mTLS 流量。这个功能的目的是为了改善 mTLS 的用户体验</strong>。</p> <p><strong>默认情况下，Istio 使用许可模式配置目标工作负载。Istio 跟踪使用 Istio 代理的工作负载，并自动向其发送 mTLS 流量。如果工作负载没有代理，Istio 将发送纯文本流量</strong>。</p> <p>当使用许可模式时，服务器接受纯文本流量和 mTLS 流量，不会破坏任何东西。许可模式给了我们时间来安装和配置 sidecar，以逐步发送 mTLS 流量。</p> <p><strong>一旦所有的工作负载都安装了 sidecar，我们就可以切换到严格的 mTLS 模式</strong>。要做到这一点，<strong>我们可以创建一个 <code>PeerAuthentication</code> 资源。我们可以防止非双向 TLS 流量，并要求所有通信都使用 mTLS</strong>。</p> <p>比如：</p> <p>在根命名空间下（istio-system）创建策略，用于在整个网格中执行</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> PeerAuthentication
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> default
   <span class="token key atrule">namespace</span><span class="token punctuation">:</span> istio<span class="token punctuation">-</span>system
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">mtls</span><span class="token punctuation">:</span>
     <span class="token key atrule">mode</span><span class="token punctuation">:</span> STRICT
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>还可以<strong>指定 <code>selector</code> 字段，将策略仅应用于网格中的特定工作负载：</strong></p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> PeerAuthentication
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> default
   <span class="token key atrule">namespace</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>namespace
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
       <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
   <span class="token key atrule">mtls</span><span class="token punctuation">:</span>
     <span class="token key atrule">mode</span><span class="token punctuation">:</span> STRICT
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_1-4-实战-启用mtls"><a href="#_1-4-实战-启用mtls" class="header-anchor">#</a> 1.4 实战：启用mTLS</h3> <ul><li><p>部署Gateway</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
   <span class="token key atrule">servers</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
         <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
         <span class="token key atrule">name</span><span class="token punctuation">:</span> http
         <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
       <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token string">'*'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master security<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f gateway.yaml </span>
gateway.networking.istio.io/gateway created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>部署示例应用程序（Web Frontend 和 Customers 服务），Web 前端的部署将不包含 Envoy 代理 sidecar，而 Customers 服务将被注入 sidecar。通过这个设置，我们将看到 Istio 如何同时发送 mTLS 和纯文本流量，以及如何将 TLS 模式改为 STRICT。</p></li> <li><p>在开始部署之前，我们将禁用 <code>default</code> 命名空间中的自动 sidecar 注入，这样代理就不会被注入到 Web 前端部署中。在我们部署 Customers 服务之前，我们将再次启用注入。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl label namespace default istio-injection-
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>部署 <code>web-frontend</code>：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
       <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">template</span><span class="token punctuation">:</span>
     <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
         <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
     <span class="token key atrule">spec</span><span class="token punctuation">:</span>
       <span class="token key atrule">containers</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mszlu/web<span class="token punctuation">-</span>frontend<span class="token punctuation">:</span>1.0.0
           <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
           <span class="token key atrule">name</span><span class="token punctuation">:</span> web
           <span class="token key atrule">ports</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
           <span class="token key atrule">env</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CUSTOMER_SERVICE_URL
               <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'http://customers.default.svc.cluster.local'</span>
<span class="token punctuation">---</span>
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">ports</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
       <span class="token key atrule">name</span><span class="token punctuation">:</span> http
       <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token punctuation">---</span>
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token string">'*'</span>
   <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> gateway
   <span class="token key atrule">http</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
             <span class="token key atrule">host</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend.default.svc.cluster.local
             <span class="token key atrule">port</span><span class="token punctuation">:</span>
               <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master security<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f web-frontend.yaml</span>
deployment.apps/web-frontend created
service/web-frontend created
virtualservice.networking.istio.io/web-frontend created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>启用自动注入：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl label namespace default istio-injection<span class="token operator">=</span>enabled
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>部署 Customers 服务的 v1 版本：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers<span class="token punctuation">-</span>v1
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
     <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
       <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
       <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
   <span class="token key atrule">template</span><span class="token punctuation">:</span>
     <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
         <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
     <span class="token key atrule">spec</span><span class="token punctuation">:</span>
       <span class="token key atrule">containers</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mszlu/customers<span class="token punctuation">:</span>1.0.0
           <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
           <span class="token key atrule">name</span><span class="token punctuation">:</span> svc
           <span class="token key atrule">ports</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>
<span class="token punctuation">---</span>
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
   <span class="token key atrule">ports</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
       <span class="token key atrule">name</span><span class="token punctuation">:</span> http
       <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>
<span class="token punctuation">---</span>
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token string">'customers.default.svc.cluster.local'</span>
   <span class="token key atrule">http</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
             <span class="token key atrule">host</span><span class="token punctuation">:</span> customers.default.svc.cluster.local
             <span class="token key atrule">port</span><span class="token punctuation">:</span>
               <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master security<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f customers-v1.yaml</span>
deployment.apps/customers-v1 created
service/customers created
virtualservice.networking.istio.io/customers created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>这个时候访问可以得到正确的页面，之所以有效，是因为采用了许可模式，纯文本流量被发送到没有代理的服务。在这种情况下，入口网关将纯文本流量发送到 Web 前端，因为没有代理。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master security<span class="token punctuation">]</span><span class="token comment"># curl http://192.168.200.101:30539</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>打开kiali看一下，会发现 Kiali 检测到<strong>从入口网关到 Web 前端的调用。然而，对 Customers 服务的调用是来自未知的服务。这是因为 Web 前端旁边没有代理，Istio 不知道这个服务是谁、在哪里、是什么</strong>。</p> <p><img src="img/image-20221117205113960.png" alt="image-20221117205113960"></p></li> <li><p>更新 Customers 的 VirtualService 并将网关附加到它上面。这将使我们能够直接调用 Customers 的服务。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token string">'customers.default.svc.cluster.local'</span>
   <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> gateway
   <span class="token key atrule">http</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
             <span class="token key atrule">host</span><span class="token punctuation">:</span> customers.default.svc.cluster.local
             <span class="token key atrule">port</span><span class="token punctuation">:</span>
               <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master security<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f vs-customers-gateway.yaml</span>
virtualservice.networking.istio.io/customers configured
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>现在<strong>我们可以指定 Host 头了，我们就可以通过入口网关将请求发送到 Customers 服务</strong>：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master security<span class="token punctuation">]</span><span class="token comment"># curl -H &quot;Host: customers.default.svc.cluster.local&quot; http://192.168.200.101:30539</span>
<span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Jewel Schaefer&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Raleigh Larson&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Eloise Senger&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Moshe Zieme&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Filiberto Lubowitz&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Ms.Kadin Kling&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Jennyfer Bergstrom&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Candelario Rutherford&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Kenyatta Flatley&quot;</span><span class="token punctuation">}</span>,<span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span><span class="token string">&quot;Gianni Pouros&quot;</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>了通过 Ingress 给 Web 前端和 Customers 服务产生一些流量，打开两个终端窗口，分别运行一条命令：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">curl</span> <span class="token parameter variable">-H</span> <span class="token string">&quot;Host: customers.default.svc.cluster.local&quot;</span> http://192.168.200.101:30539<span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">do</span> <span class="token function">curl</span> http://192.168.200.101:30539<span class="token punctuation">;</span> <span class="token keyword">done</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>打开 Kiali，看一下图表。在 Display 下拉菜单中，确保我们选中 Security 选项。你应该看到一个类似于下图的图表：</p> <p><img src="img/image-20221117205626930.png" alt="image-20221117205626930"></p> <p><strong>注意在入口网关和 Customers 服务之间有一个挂锁图标，这意味着流量是使用 mTLS 发送的</strong>。</p> <p>在未知的（web 前端）和 Customers 服务之间，以及 <code>istio-ingress-gateway</code> 和 web 前端之间，都没有挂锁。<strong>Istio 在没有注入 sidecar 的情况下向服务发送纯文本流量</strong>。</p></li> <li><p>如果我们在 STRICT 模式下启用 mTLS 会发生什么？</p> <p>我们预计从前端到 Customers 服务的调用会开始失败，因为没有注入代理来进行 mTLS 通信。另一方面，从入口网关到 Customers 服务的调用将继续工作。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> PeerAuthentication
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> default
   <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">mtls</span><span class="token punctuation">:</span>
     <span class="token key atrule">mode</span><span class="token punctuation">:</span> STRICT
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master security<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f strict-mtls.yaml</span>
peerauthentication.security.istio.io/default created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>这个时候前端将看到ECONNRESET的错误，这个错误表明，Customers 端关闭了连接。在我们的例子中，这是因为它期待着一个 mTLS 连接</p></li> <li><p>另一方面，我们直接向 Customers 服务发出的请求继续工作，因为 Customers 服务旁边有一个 Envoy 代理在运行，它可以进行 mTLS。</p></li> <li><p>如果我们删除之前部署的 PeerAuthentication 资源（<code>kubectl delete peerauthentication default</code>），Istio 就会恢复到默认状态（PERMISSIVE 模式），错误也会消失。</p></li></ul> <h2 id="_2-授权"><a href="#_2-授权" class="header-anchor">#</a> 2. 授权</h2> <p>即使认证通过，也不一定能访问资源，这个就需要授权。</p> <p>Istio 允许我们使用 <code>AuthorizationPolicy</code> 资源在网格、命名空间和工作负载层面定义访问控制。<code>AuthorizationPolicy</code> 支持 DENY、ALLOW、AUDIT 和 CUSTOM 操作。</p> <p><strong>每个 Envoy 代理实例都运行一个授权引擎，在运行时对请求进行授权。当请求到达代理时，引擎会根据授权策略评估请求的上下文，并返回 ALLOW 或 DENY。AUDIT 动作决定是否记录符合规则的请求。注意，AUDIT 策略并不影响请求被允许或拒绝</strong>。</p> <p>为了执行访问控制，我们可以创建一个授权策略来应用于我们的工作负载。</p> <p><code>AuthorizationPolicy</code> 资源是我们可以利用 <code>PeerAuthentication</code> 策略和 <code>RequestAuthentication</code> 策略中的主体的地方。</p> <p><strong>在定义 <code>AuthorizationPolicy</code> 的时候，我们需要考虑三个部分</strong>。</p> <ol><li>选择要应用该策略的工作负载</li> <li>要采取的行动（拒绝、允许或审计）</li> <li>采取该行动的规则</li></ol> <p>让我们看看下面这个例子如何与 <code>AuthorizationPolicy</code> 资源中的字段相对应。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> customers<span class="token punctuation">-</span>deny
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
  <span class="token key atrule">action</span><span class="token punctuation">:</span> DENY
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span>
        <span class="token key atrule">notNamespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><strong>使用 <code>selector</code> 和 <code>matchLabels</code>，我们可以选择策略所适用的工作负载</strong>。在我们的案例中，我们选择的是所有设置了 <code>app: customers</code> 和 <code>version: v2</code> 标签的工作负载。action 字段被设置为 <code>DENY</code>。</p> <p>最后，我们在 rules 字段中定义所有规则。我们例子中的规则是说，<strong>当请求来自 <code>default</code> 命名空间之外时，拒绝对 <code>customers v2</code> 工作负载的请求（action）</strong>。</p> <p><strong>除了规则中的 <code>from</code> 字段外，我们还可以使用 <code>to</code> 和 <code>when</code> 字段进一步定制规则</strong>。让我们看一个使用这些字段的例子。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> customers<span class="token punctuation">-</span>deny
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
      <span class="token key atrule">version</span><span class="token punctuation">:</span> v2
  <span class="token key atrule">action</span><span class="token punctuation">:</span> DENY
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span>
        <span class="token key atrule">notNamespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">to</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">operation</span><span class="token punctuation">:</span>
         <span class="token key atrule">methods</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;GET&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">when</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> request.headers <span class="token punctuation">[</span>User<span class="token punctuation">-</span>Agent<span class="token punctuation">]</span>
       <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Mozilla/*&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>我们在规则部分添加了 <code>to</code> 和 <code>when</code> 字段。如果我们翻译一下上面的规则，我们可以说，<strong>当客户的 GET 请求来自 <code>default</code> 命名空间之外，并且 <code>User Agent</code> 头的值与正则表达式 <code>Mozilla/\*</code> 相匹配时，我们会拒绝 customers v2 的工作负载</strong>。</p> <p>总的来说，<strong><code>to</code> 定义了策略所允许的行动，<code>from</code> 定义了谁可以采取这些行动，<code>when</code> 定义了每个请求必须具备的属性，以便被策略所允许，<code>selector</code> 定义了哪些工作负载将执行该策略</strong>。</p> <p><strong>如果一个工作负载有多个策略，则首先评估拒绝的策略</strong>。评估遵循这些规则：</p> <ol><li>如果有与请求相匹配的 DENY 策略，则拒绝该请求</li> <li>如果没有适合该工作负载的 ALLOW 策略，则拒绝该请求。</li> <li>如果有任何 ALLOW 策略与该请求相匹配，则允许该请求。</li> <li>拒绝该请求</li></ol> <h3 id="_2-1-source"><a href="#_2-1-source" class="header-anchor">#</a> 2.1 source</h3> <p>我们在上述例子中使用的source是 <code>notNamespaces</code>。我们还可以使用以下任何一个字段来指定请求的source，如表中所示。</p> <table><thead><tr><th>来源</th> <th>示例</th> <th>释义</th></tr></thead> <tbody><tr><td><code>principals</code></td> <td><code>principals: [&quot;my-service-account&quot;]</code></td> <td>任何是有 <code>my-service-account</code> 的工作负载</td></tr> <tr><td><code>notPrincipals</code></td> <td><code>notPrincipals: [&quot;my-service-account&quot;]</code></td> <td>除了 <code>my-service-account</code> 的任何工作负载</td></tr> <tr><td><code>requestPrincipals</code></td> <td><code>requestPrincipals: [&quot;my-issuer/hello&quot;]</code></td> <td>任何具有有效 JWT 和请求主体 <code>my-issuer/hello</code> 的工作负载</td></tr> <tr><td><code>notRequestPrincipals</code></td> <td><code>notRequestPrincipals: [&quot;*&quot;]</code></td> <td>任何没有请求主体的工作负载（只有有效的 JWT 令牌）。</td></tr> <tr><td><code>namespaces</code></td> <td><code>namespaces: [&quot;default&quot;]</code></td> <td>任何来自 <code>default</code> 命名空间的工作负载</td></tr> <tr><td><code>notNamespaces</code></td> <td><code>notNamespaces: [&quot;prod&quot;]</code></td> <td>任何不在 <code>prod</code> 命名空间的工作负载</td></tr> <tr><td><code>ipBlocks</code></td> <td><code>ipBlocks: [&quot;1.2.3.4&quot;,&quot;9.8.7.6/15&quot;]</code></td> <td>任何具有 <code>1.2.3.4</code> 的 IP 地址或来自 CIDR 块的 IP 地址的工作负载</td></tr> <tr><td><code>notIpBlock</code></td> <td><code>notIpBlocks: [&quot;1.2.3.4/24&quot;]</code></td> <td>Any IP address that's outside of the CIDR block</td></tr></tbody></table> <h3 id="_2-2-操作operation"><a href="#_2-2-操作operation" class="header-anchor">#</a> 2.2 操作operation</h3> <p><strong>operation被定义在 <code>to</code> 字段下，如果多于一个，则使用 <code>AND</code> 语义</strong>。就像source一样，操作是成对的，有正反两面的匹配。设置在操作字段的值是字符串：</p> <ul><li><code>hosts</code> 和 <code>notHosts</code></li> <li><code>ports</code> 和 <code>notPorts</code></li> <li><code>methods</code> 和 <code>notMethods</code></li> <li><code>paths</code> 和 <code>notPath</code></li></ul> <p>所有这些操作都适用于请求属性。例如，<strong>要在一个特定的请求路径上进行匹配，我们可以使用路径。<code>paths:[&quot;/api/\*&quot;,&quot;/admin&quot;]</code> 或特定的端口 <code>ports: [&quot;8080&quot;]</code></strong>，以此类推。</p> <h3 id="_2-3-条件"><a href="#_2-3-条件" class="header-anchor">#</a> 2.3 条件</h3> <p>为了指定条件，我们必须提供一个 <code>key</code> 字段。<code>key</code> 字段是一个 Istio 属性的名称。例如，<code>request.headers</code>、<code>source.ip</code>、<code>destination.port</code> 等等。关于支持的属性的完整列表，请参考 <a href="https://istio.io/latest/docs/reference/config/security/conditions/" target="_blank" rel="noopener noreferrer">授权政策条件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>条件的第二部分是 <code>values</code> 或 <code>notValues</code> 的字符串列表。下面是一个 <code>when</code> 条件的片段：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token punctuation">...</span>
  <span class="token punctuation">-</span> <span class="token key atrule">when</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> source.ip
       <span class="token key atrule">notValues</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;10.0.1.1&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_2-4-实战-授权-访问控制"><a href="#_2-4-实战-授权-访问控制" class="header-anchor">#</a> 2.4 实战：授权（访问控制）</h3> <p>在这个实验中，我们将学习如何使用授权策略来控制工作负载之间的访问。</p> <p>首先部署 Gateway：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Gateway
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> gateway
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">istio</span><span class="token punctuation">:</span> ingressgateway
   <span class="token key atrule">servers</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span>
         <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
         <span class="token key atrule">name</span><span class="token punctuation">:</span> http
         <span class="token key atrule">protocol</span><span class="token punctuation">:</span> HTTP
       <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token string">'*'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>将上述 YAML 保存为 <code>gateway.yaml</code>，并使用 <code>kubectl apply -f gateway.yaml</code> 部署网关。</p> <p>接下来，我们将创建 Web 前端部署、服务账户、服务 和 VirtualService。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
<span class="token punctuation">---</span>
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
       <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">template</span><span class="token punctuation">:</span>
     <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
         <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
     <span class="token key atrule">spec</span><span class="token punctuation">:</span>
       <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
       <span class="token key atrule">containers</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mszlu/web<span class="token punctuation">-</span>frontend<span class="token punctuation">:</span>1.0.0
           <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
           <span class="token key atrule">name</span><span class="token punctuation">:</span> web
           <span class="token key atrule">ports</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
           <span class="token key atrule">env</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CUSTOMER_SERVICE_URL
               <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">'http://customers.default.svc.cluster.local'</span>
<span class="token punctuation">---</span>
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">ports</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
       <span class="token key atrule">name</span><span class="token punctuation">:</span> http
       <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
<span class="token punctuation">---</span>
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token string">'*'</span>
   <span class="token key atrule">gateways</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> gateway
   <span class="token key atrule">http</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
             <span class="token key atrule">host</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend.default.svc.cluster.local
             <span class="token key atrule">port</span><span class="token punctuation">:</span>
               <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>将上述 YAML 保存为 <code>web-frontend.yaml</code>，并使用 <code>kubectl apply -f web-frontend.yaml</code> 创建资源。</p> <p>最后，我们将部署 customers v1 服务。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers<span class="token punctuation">-</span>v1
<span class="token punctuation">---</span>
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers<span class="token punctuation">-</span>v1
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
     <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
       <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
       <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
   <span class="token key atrule">template</span><span class="token punctuation">:</span>
     <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
         <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
     <span class="token key atrule">spec</span><span class="token punctuation">:</span>
       <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> customers<span class="token punctuation">-</span>v1
       <span class="token key atrule">containers</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> mszlu/customers<span class="token punctuation">:</span>1.0.0
           <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
           <span class="token key atrule">name</span><span class="token punctuation">:</span> svc
           <span class="token key atrule">ports</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>
<span class="token punctuation">---</span>
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
   <span class="token key atrule">labels</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
   <span class="token key atrule">ports</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
       <span class="token key atrule">name</span><span class="token punctuation">:</span> http
       <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3000</span>
<span class="token punctuation">---</span>
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.istio.io/v1alpha3
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> VirtualService
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> customers
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token string">'customers.default.svc.cluster.local'</span>
   <span class="token key atrule">http</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">route</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">destination</span><span class="token punctuation">:</span>
             <span class="token key atrule">host</span><span class="token punctuation">:</span> customers.default.svc.cluster.local
             <span class="token key atrule">port</span><span class="token punctuation">:</span>
               <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>将上述内容保存为 <code>customers-v1.yaml</code>，并使用 <code>kubectl apply -f customers-v1.yaml</code> 创建部署和服务。如果我们打开 <code>GATEWAY_URL</code>，应该会显示带有 customers v1 服务数据的 web 前端页面。</p> <p>让我们先创建一个授权策略，<strong>拒绝 <code>default</code> 命名空间的所有请求</strong>。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> deny<span class="token punctuation">-</span>all
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>将上述内容保存为 <code>deny-all.yaml</code>，并使用 <code>kubectl apply -f deny-all.yaml</code> 创建该策略。</p> <p>如果我们尝试访问 <code>GATEWAY_URL</code>，我们将得到以下响应。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">RBAC</span><span class="token punctuation">:</span> access denied
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>同样，如果我们试图在集群内运行一个 Pod，并从 <code>default</code> 命名空间内向 Web 前端或 customers 服务提出请求，我们会得到同样的错误。</p> <p>让我们试试吧。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code> $ kubectl run <span class="token function">curl</span> <span class="token parameter variable">--image</span><span class="token operator">=</span>radial/busyboxplus:curl <span class="token parameter variable">-i</span> <span class="token parameter variable">--tty</span>
 If you don't see a <span class="token builtin class-name">command</span> prompt, try pressing enter.
 <span class="token punctuation">[</span> root@curl:/ <span class="token punctuation">]</span>$ <span class="token function">curl</span> customers
 RBAC: access denied
 <span class="token punctuation">[</span> root@curl:/ <span class="token punctuation">]</span>$ <span class="token function">curl</span> web-frontend
 RBAC: access denied
 <span class="token punctuation">[</span> root@curl:/ <span class="token punctuation">]</span>$
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在这两种情况下，我们都得到了拒绝访问的错误。</p> <p>我们要做的第一件事是<strong>使用 <code>ALLOW</code> 动作，允许从入口网关向 <code>web-frontend</code> 应用程序发送请求。在规则中，我们指定了入口网关运行的源命名空间（<code>istio-system</code>）和入口网关的服务账户名称</strong>。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> allow<span class="token punctuation">-</span>ingress<span class="token punctuation">-</span>frontend
   <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
       <span class="token key atrule">app</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>frontend
   <span class="token key atrule">action</span><span class="token punctuation">:</span> ALLOW
   <span class="token key atrule">rules</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span>
             <span class="token key atrule">namespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;istio-system&quot;</span><span class="token punctuation">]</span>
         <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span>
             <span class="token key atrule">principals</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p>在kubernetes中，X.509证书的URI字段格式为：spiffe://<code>&lt;domain&gt;</code>/ns/<code>&lt;namespace&gt;</code>/sa/<code>&lt;serviceaccount&gt;</code>。</p> <p>这使Istio服务能够建立与接受与其他SPIFFE()兼容系统的连接。</p> <p>SPIFFE（Secure Production Identity Framework For Everyone）以特制的X.509证书形式为现代生产环境中的每个工作负载提供安全标识。SPIFFE消除了对应用程序级身份验证和复杂网络级ACL配置的需求。SPIFFE标准是许多CNCF参与者和其他相关方，聚集在一起提出的共同方法，使服务彼此呈现和授权他们的身份。</p></blockquote> <p>将上述内容保存为 <code>allow-ingress-frontend.yaml</code>，并使用 <code>kubectl apply -f allow-ingress-frontend.yaml</code> 创建策略。</p> <p>如果我们尝试从我们的主机向<code>GATEWAY_URL</code> 发出请求，这次我们会得到一个不同的错误。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code> $ <span class="token function">curl</span> http://<span class="token variable">$GATEWAY_URL</span>
 <span class="token string">&quot;Request failed with status code 403&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>请注意，策略需要几秒钟才能分发到所有代理，所以你可能仍然会看到 <code>RBAC：access denied</code> 的消息，时间为几秒钟。</p></blockquote> <p>这个错误来自 customers 服务——记得我们<strong>允许调用 Web 前端</strong>。然而，<code>web-frontend</code>仍然不能调用 customers 服务。</p> <p>如果我们回到我们在集群内运行的 curl Pod，尝试请求 <code>http://web-frontend</code>，我们会得到一个 RBAC 错误。<code>DENY</code> 策略是有效的，我们只允许从入口网关进行调用。</p> <p><strong>当我们部署 Web 前端时，我们也为 Pod 创建了一个服务账户（否则，命名空间中的所有 Pod 都被分配了默认的服务账户）。现在我们可以使用该服务账户来指定 customers 服务调用的来源</strong>。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> security.istio.io/v1beta1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> AuthorizationPolicy
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> allow<span class="token punctuation">-</span>web<span class="token punctuation">-</span>frontend<span class="token punctuation">-</span>customers
   <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
         <span class="token key atrule">app</span><span class="token punctuation">:</span> customers
         <span class="token key atrule">version</span><span class="token punctuation">:</span> v1
   <span class="token key atrule">action</span><span class="token punctuation">:</span> ALLOW
   <span class="token key atrule">rules</span><span class="token punctuation">:</span>
   <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">source</span><span class="token punctuation">:</span>
         <span class="token key atrule">namespaces</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span>
       <span class="token key atrule">source</span><span class="token punctuation">:</span>
         <span class="token key atrule">principals</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;cluster.local/ns/default/sa/web-frontend&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>将上述 YAML 保存为 <code>allow-web-frontend-customers.yaml</code>，并使用 <code>kubectl apply -f allow-web-frontend-customers.yaml</code> 创建策略。</p> <p>一旦策略被创建，我们将看到 Web 前端再次工作——它将获得 customers 服务的回应。</p> <p><strong>我们使用了多个授权策略，明确地允许从入口到前端以及从前端到 customers 服务的调用。使用 <code>deny-all</code> 策略是一个很好的开始，因为我们可以控制、管理，然后明确地允许我们希望在服务之间发生的通信。</strong></p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/wulinghui/TechnicalSummary/edit/master/docs/Kubernetes/15.ServiceMesh/05.istio安全.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/01/26, 22:57:26</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/a08be6/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">流量管理</div></a> <a href="/pages/811549/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">高级功能</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/a08be6/" class="prev">流量管理</a></span> <span class="next"><a href="/pages/811549/">高级功能</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/fff88c/"><div>
            架构升级踩坑之路
            <!----></div></a> <span class="date">02-27</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/ba6503/"><div>
            总结
            <!----></div></a> <span class="date">02-27</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/1b4e40/"><div>
            语法学习
            <!----></div></a> <span class="date">02-27</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:873406903@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/wulinghui" title="GitHub(移步到gitee)" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/hellowllh/projects" title="gitee" target="_blank" class="iconfont icon-gitee"></a><a href="https://blog.csdn.net/qq_41720208" title="CSDN" target="_blank" class="iconfont icon-gitee"></a><a href="https://www.cnblogs.com/wlh1995" title="博客园" target="_blank" class="iconfont icon-bokeyuan"></a></div> 
    | Copyright © 2021-2025
    <span>Wu lingui | <a href="" target="_blank"></a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.7f63dd6c.js" defer></script><script src="/assets/js/2.fe5f2a1d.js" defer></script><script src="/assets/js/3.eb8c603e.js" defer></script><script src="/assets/js/64.f149661c.js" defer></script>
  </body>
</html>
