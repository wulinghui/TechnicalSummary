<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>wordpress实战部署 | 资料总结</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="个人资料总结，存放笔记">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.76dfa4dd.css" as="style"><link rel="preload" href="/assets/js/app.7f63dd6c.js" as="script"><link rel="preload" href="/assets/js/2.fe5f2a1d.js" as="script"><link rel="preload" href="/assets/js/3.eb8c603e.js" as="script"><link rel="preload" href="/assets/js/39.e4494792.js" as="script"><link rel="prefetch" href="/assets/js/10.fe6b23fc.js"><link rel="prefetch" href="/assets/js/100.523c1b31.js"><link rel="prefetch" href="/assets/js/101.bbee1e6c.js"><link rel="prefetch" href="/assets/js/102.36d68ded.js"><link rel="prefetch" href="/assets/js/103.482d8685.js"><link rel="prefetch" href="/assets/js/104.9b20475d.js"><link rel="prefetch" href="/assets/js/105.0edc73b7.js"><link rel="prefetch" href="/assets/js/106.a9abfe31.js"><link rel="prefetch" href="/assets/js/107.2178a4c5.js"><link rel="prefetch" href="/assets/js/108.21d19ed0.js"><link rel="prefetch" href="/assets/js/109.5e1e3698.js"><link rel="prefetch" href="/assets/js/11.7d4a2ffb.js"><link rel="prefetch" href="/assets/js/110.ccc910aa.js"><link rel="prefetch" href="/assets/js/111.fcfd17d0.js"><link rel="prefetch" href="/assets/js/112.f91ccf6e.js"><link rel="prefetch" href="/assets/js/113.5cd28a7e.js"><link rel="prefetch" href="/assets/js/114.4ca8676c.js"><link rel="prefetch" href="/assets/js/115.c4d64d4e.js"><link rel="prefetch" href="/assets/js/116.47ba7426.js"><link rel="prefetch" href="/assets/js/117.3062ccb9.js"><link rel="prefetch" href="/assets/js/118.27991bba.js"><link rel="prefetch" href="/assets/js/119.53538539.js"><link rel="prefetch" href="/assets/js/12.ac798cdb.js"><link rel="prefetch" href="/assets/js/120.e9666755.js"><link rel="prefetch" href="/assets/js/121.73a1660e.js"><link rel="prefetch" href="/assets/js/122.59ac137e.js"><link rel="prefetch" href="/assets/js/123.b9124c91.js"><link rel="prefetch" href="/assets/js/124.12ffcf50.js"><link rel="prefetch" href="/assets/js/125.0403278b.js"><link rel="prefetch" href="/assets/js/126.cec37905.js"><link rel="prefetch" href="/assets/js/127.605a5010.js"><link rel="prefetch" href="/assets/js/128.a4cf61d9.js"><link rel="prefetch" href="/assets/js/129.164a08ce.js"><link rel="prefetch" href="/assets/js/13.8de4385c.js"><link rel="prefetch" href="/assets/js/130.1d4164bd.js"><link rel="prefetch" href="/assets/js/131.7796e583.js"><link rel="prefetch" href="/assets/js/132.c79c715f.js"><link rel="prefetch" href="/assets/js/133.48384f22.js"><link rel="prefetch" href="/assets/js/134.bf85bfff.js"><link rel="prefetch" href="/assets/js/135.1244d4cb.js"><link rel="prefetch" href="/assets/js/136.6650b052.js"><link rel="prefetch" href="/assets/js/137.e9f394e2.js"><link rel="prefetch" href="/assets/js/138.ae16527d.js"><link rel="prefetch" href="/assets/js/139.df1c969c.js"><link rel="prefetch" href="/assets/js/14.d82e6d84.js"><link rel="prefetch" href="/assets/js/140.a80aa424.js"><link rel="prefetch" href="/assets/js/141.10ab646d.js"><link rel="prefetch" href="/assets/js/142.508278ee.js"><link rel="prefetch" href="/assets/js/143.62aa16a7.js"><link rel="prefetch" href="/assets/js/144.c734b314.js"><link rel="prefetch" href="/assets/js/145.7dae44b0.js"><link rel="prefetch" href="/assets/js/146.b08fb7ab.js"><link rel="prefetch" href="/assets/js/147.6fee9f53.js"><link rel="prefetch" href="/assets/js/148.5a09fe8b.js"><link rel="prefetch" href="/assets/js/149.27046d2c.js"><link rel="prefetch" href="/assets/js/15.f0dc0e66.js"><link rel="prefetch" href="/assets/js/150.c05ae37c.js"><link rel="prefetch" href="/assets/js/151.57194eb1.js"><link rel="prefetch" href="/assets/js/152.bc7ad385.js"><link rel="prefetch" href="/assets/js/153.b3c7d891.js"><link rel="prefetch" href="/assets/js/154.0d3a00e5.js"><link rel="prefetch" href="/assets/js/155.b9afdc01.js"><link rel="prefetch" href="/assets/js/156.bfc71798.js"><link rel="prefetch" href="/assets/js/157.43852835.js"><link rel="prefetch" href="/assets/js/158.785caaa2.js"><link rel="prefetch" href="/assets/js/159.1716fd78.js"><link rel="prefetch" href="/assets/js/16.1217969a.js"><link rel="prefetch" href="/assets/js/160.54dfc0be.js"><link rel="prefetch" href="/assets/js/161.3a486b71.js"><link rel="prefetch" href="/assets/js/162.4365dac4.js"><link rel="prefetch" href="/assets/js/163.9e0305ed.js"><link rel="prefetch" href="/assets/js/164.9af7099c.js"><link rel="prefetch" href="/assets/js/165.07230640.js"><link rel="prefetch" href="/assets/js/166.a13e993d.js"><link rel="prefetch" href="/assets/js/167.233c305e.js"><link rel="prefetch" href="/assets/js/168.86996235.js"><link rel="prefetch" href="/assets/js/169.c643487c.js"><link rel="prefetch" href="/assets/js/17.65771bc0.js"><link rel="prefetch" href="/assets/js/170.fed7e19e.js"><link rel="prefetch" href="/assets/js/171.a191947e.js"><link rel="prefetch" href="/assets/js/172.a2368c89.js"><link rel="prefetch" href="/assets/js/173.aad8acd6.js"><link rel="prefetch" href="/assets/js/174.e5c4e9f4.js"><link rel="prefetch" href="/assets/js/175.ef19ddcf.js"><link rel="prefetch" href="/assets/js/176.7b8490c3.js"><link rel="prefetch" href="/assets/js/177.7d1f01a3.js"><link rel="prefetch" href="/assets/js/178.c5ea1f87.js"><link rel="prefetch" href="/assets/js/179.e54bc218.js"><link rel="prefetch" href="/assets/js/18.69d253af.js"><link rel="prefetch" href="/assets/js/180.a0fc0bcd.js"><link rel="prefetch" href="/assets/js/181.8029f765.js"><link rel="prefetch" href="/assets/js/182.72075fe8.js"><link rel="prefetch" href="/assets/js/183.f74d77ba.js"><link rel="prefetch" href="/assets/js/184.3277cbcd.js"><link rel="prefetch" href="/assets/js/185.15940a23.js"><link rel="prefetch" href="/assets/js/186.810a303a.js"><link rel="prefetch" href="/assets/js/187.9c8777f6.js"><link rel="prefetch" href="/assets/js/188.fed55d48.js"><link rel="prefetch" href="/assets/js/189.7f09c5db.js"><link rel="prefetch" href="/assets/js/19.87ab5597.js"><link rel="prefetch" href="/assets/js/190.082d7cbc.js"><link rel="prefetch" href="/assets/js/191.9fb2ec38.js"><link rel="prefetch" href="/assets/js/192.167d2083.js"><link rel="prefetch" href="/assets/js/193.d1eeb947.js"><link rel="prefetch" href="/assets/js/194.09e61c12.js"><link rel="prefetch" href="/assets/js/195.969efb5f.js"><link rel="prefetch" href="/assets/js/196.3932e830.js"><link rel="prefetch" href="/assets/js/197.1dc355f6.js"><link rel="prefetch" href="/assets/js/198.1ad8dbbf.js"><link rel="prefetch" href="/assets/js/199.c6b23b90.js"><link rel="prefetch" href="/assets/js/20.3d741608.js"><link rel="prefetch" href="/assets/js/200.81a125db.js"><link rel="prefetch" href="/assets/js/201.5e2fd593.js"><link rel="prefetch" href="/assets/js/202.51a3fbc4.js"><link rel="prefetch" href="/assets/js/203.4ae7c4f4.js"><link rel="prefetch" href="/assets/js/204.5ba79932.js"><link rel="prefetch" href="/assets/js/205.05bb64e4.js"><link rel="prefetch" href="/assets/js/206.c1d5472b.js"><link rel="prefetch" href="/assets/js/207.ad43feb1.js"><link rel="prefetch" href="/assets/js/208.250144c5.js"><link rel="prefetch" href="/assets/js/209.41667b8a.js"><link rel="prefetch" href="/assets/js/21.23841fc1.js"><link rel="prefetch" href="/assets/js/210.b85ec988.js"><link rel="prefetch" href="/assets/js/211.8f2f9335.js"><link rel="prefetch" href="/assets/js/212.dea21e7c.js"><link rel="prefetch" href="/assets/js/213.9074d848.js"><link rel="prefetch" href="/assets/js/214.baaf02d5.js"><link rel="prefetch" href="/assets/js/215.e3149f2c.js"><link rel="prefetch" href="/assets/js/216.5ede3f02.js"><link rel="prefetch" href="/assets/js/217.06eb8901.js"><link rel="prefetch" href="/assets/js/218.ffe5fc66.js"><link rel="prefetch" href="/assets/js/219.69c6166f.js"><link rel="prefetch" href="/assets/js/22.b55e8e09.js"><link rel="prefetch" href="/assets/js/220.a83c1ecf.js"><link rel="prefetch" href="/assets/js/221.fb65c799.js"><link rel="prefetch" href="/assets/js/222.1ff261ff.js"><link rel="prefetch" href="/assets/js/223.807c2de7.js"><link rel="prefetch" href="/assets/js/224.33540594.js"><link rel="prefetch" href="/assets/js/225.21d88d75.js"><link rel="prefetch" href="/assets/js/226.00d419d7.js"><link rel="prefetch" href="/assets/js/227.19678a11.js"><link rel="prefetch" href="/assets/js/228.d09fe33c.js"><link rel="prefetch" href="/assets/js/229.c8dcc95e.js"><link rel="prefetch" href="/assets/js/23.d7449079.js"><link rel="prefetch" href="/assets/js/230.7477ad3f.js"><link rel="prefetch" href="/assets/js/231.f1013950.js"><link rel="prefetch" href="/assets/js/232.1e07d0e6.js"><link rel="prefetch" href="/assets/js/233.34e0f2b8.js"><link rel="prefetch" href="/assets/js/234.645446d8.js"><link rel="prefetch" href="/assets/js/235.3368fdbc.js"><link rel="prefetch" href="/assets/js/236.35ed0de0.js"><link rel="prefetch" href="/assets/js/237.4a189e89.js"><link rel="prefetch" href="/assets/js/238.d6580ef3.js"><link rel="prefetch" href="/assets/js/239.c518fd70.js"><link rel="prefetch" href="/assets/js/24.26f18aa6.js"><link rel="prefetch" href="/assets/js/240.14979636.js"><link rel="prefetch" href="/assets/js/241.95c3b00d.js"><link rel="prefetch" href="/assets/js/242.a214e307.js"><link rel="prefetch" href="/assets/js/243.273af8d4.js"><link rel="prefetch" href="/assets/js/244.e2d74303.js"><link rel="prefetch" href="/assets/js/245.fe562cb9.js"><link rel="prefetch" href="/assets/js/246.b40011af.js"><link rel="prefetch" href="/assets/js/247.dc1a9aae.js"><link rel="prefetch" href="/assets/js/248.d691ac20.js"><link rel="prefetch" href="/assets/js/249.191f742a.js"><link rel="prefetch" href="/assets/js/25.198594bf.js"><link rel="prefetch" href="/assets/js/250.205b92cf.js"><link rel="prefetch" href="/assets/js/251.acb8a80e.js"><link rel="prefetch" href="/assets/js/26.c817356c.js"><link rel="prefetch" href="/assets/js/27.6b812306.js"><link rel="prefetch" href="/assets/js/28.9048721b.js"><link rel="prefetch" href="/assets/js/29.bfda8510.js"><link rel="prefetch" href="/assets/js/30.eb1b6ab9.js"><link rel="prefetch" href="/assets/js/31.3f3dbd2f.js"><link rel="prefetch" href="/assets/js/32.006bc754.js"><link rel="prefetch" href="/assets/js/33.05d371fe.js"><link rel="prefetch" href="/assets/js/34.27cd6ff5.js"><link rel="prefetch" href="/assets/js/35.35409a6d.js"><link rel="prefetch" href="/assets/js/36.fd6a950b.js"><link rel="prefetch" href="/assets/js/37.c8fd6ef4.js"><link rel="prefetch" href="/assets/js/38.028a36a2.js"><link rel="prefetch" href="/assets/js/4.ff2df22c.js"><link rel="prefetch" href="/assets/js/40.979dec53.js"><link rel="prefetch" href="/assets/js/41.ff9662db.js"><link rel="prefetch" href="/assets/js/42.5c1441fc.js"><link rel="prefetch" href="/assets/js/43.9657eae8.js"><link rel="prefetch" href="/assets/js/44.a6cb5e5c.js"><link rel="prefetch" href="/assets/js/45.c675440c.js"><link rel="prefetch" href="/assets/js/46.06205970.js"><link rel="prefetch" href="/assets/js/47.ded0c65e.js"><link rel="prefetch" href="/assets/js/48.296a6f26.js"><link rel="prefetch" href="/assets/js/49.1b2ec2ab.js"><link rel="prefetch" href="/assets/js/5.ecde23f9.js"><link rel="prefetch" href="/assets/js/50.e551e67f.js"><link rel="prefetch" href="/assets/js/51.122d5b68.js"><link rel="prefetch" href="/assets/js/52.c0444208.js"><link rel="prefetch" href="/assets/js/53.f47d6b86.js"><link rel="prefetch" href="/assets/js/54.e9c9b41b.js"><link rel="prefetch" href="/assets/js/55.77010c1f.js"><link rel="prefetch" href="/assets/js/56.387aacbb.js"><link rel="prefetch" href="/assets/js/57.ddcf78ad.js"><link rel="prefetch" href="/assets/js/58.908b88fc.js"><link rel="prefetch" href="/assets/js/59.8ff535f1.js"><link rel="prefetch" href="/assets/js/6.b928f1b9.js"><link rel="prefetch" href="/assets/js/60.c5018386.js"><link rel="prefetch" href="/assets/js/61.1514e08b.js"><link rel="prefetch" href="/assets/js/62.79bc9197.js"><link rel="prefetch" href="/assets/js/63.a6cb5e14.js"><link rel="prefetch" href="/assets/js/64.f149661c.js"><link rel="prefetch" href="/assets/js/65.30fa2026.js"><link rel="prefetch" href="/assets/js/66.e7f9f54e.js"><link rel="prefetch" href="/assets/js/67.7361f4a3.js"><link rel="prefetch" href="/assets/js/68.b67cc099.js"><link rel="prefetch" href="/assets/js/69.ba730416.js"><link rel="prefetch" href="/assets/js/7.b0514d37.js"><link rel="prefetch" href="/assets/js/70.45b9e858.js"><link rel="prefetch" href="/assets/js/71.2055eaae.js"><link rel="prefetch" href="/assets/js/72.75ec1304.js"><link rel="prefetch" href="/assets/js/73.3aa09b6b.js"><link rel="prefetch" href="/assets/js/74.fb3013f1.js"><link rel="prefetch" href="/assets/js/75.c837c896.js"><link rel="prefetch" href="/assets/js/76.9e6df886.js"><link rel="prefetch" href="/assets/js/77.4eb09ab0.js"><link rel="prefetch" href="/assets/js/78.06d19c8c.js"><link rel="prefetch" href="/assets/js/79.dfde586d.js"><link rel="prefetch" href="/assets/js/8.f86f2563.js"><link rel="prefetch" href="/assets/js/80.476da6d1.js"><link rel="prefetch" href="/assets/js/81.2b778375.js"><link rel="prefetch" href="/assets/js/82.abbf449f.js"><link rel="prefetch" href="/assets/js/83.24b0e8ea.js"><link rel="prefetch" href="/assets/js/84.f8694c96.js"><link rel="prefetch" href="/assets/js/85.f030e8b6.js"><link rel="prefetch" href="/assets/js/86.18853c72.js"><link rel="prefetch" href="/assets/js/87.4eca3df6.js"><link rel="prefetch" href="/assets/js/88.26b81c78.js"><link rel="prefetch" href="/assets/js/89.ae216049.js"><link rel="prefetch" href="/assets/js/9.7a3e1618.js"><link rel="prefetch" href="/assets/js/90.b0ee8ab4.js"><link rel="prefetch" href="/assets/js/91.a07b34f1.js"><link rel="prefetch" href="/assets/js/92.1c2952b1.js"><link rel="prefetch" href="/assets/js/93.e199901d.js"><link rel="prefetch" href="/assets/js/94.a901578c.js"><link rel="prefetch" href="/assets/js/95.641f6644.js"><link rel="prefetch" href="/assets/js/96.84a54aa3.js"><link rel="prefetch" href="/assets/js/97.c489ec61.js"><link rel="prefetch" href="/assets/js/98.5fb17174.js"><link rel="prefetch" href="/assets/js/99.c004152a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.76dfa4dd.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="资料总结" class="logo"> <span class="site-name can-hide">资料总结</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/goVersion181/" class="nav-link">go</a></div><div class="nav-item"><a href="/pages/springFramework/" class="nav-link">java</a></div><div class="nav-item"><a href="/pages/e5d517/" class="nav-link">云原生</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/pages/410b25/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/00291d/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/pages/846ee6/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/pages/5465c3/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/853b5b/" class="nav-link">设计模式详解</a></li><li class="dropdown-item"><!----> <a href="/pages/ebc515/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/pages/57778e/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/pages/282cd0/" class="nav-link">项目</a></li><li class="dropdown-item"><!----> <a href="/pages/2cd810/" class="nav-link">理论基础</a></li><li class="dropdown-item"><!----> <a href="/pages/6acd46/" class="nav-link">运营</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/wulinghui/TechnicalSummary" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src=""> <div class="blogger-info"><h3>linghui Wu</h3> <span>一只努力学飞的鱼</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/goVersion181/" class="nav-link">go</a></div><div class="nav-item"><a href="/pages/springFramework/" class="nav-link">java</a></div><div class="nav-item"><a href="/pages/e5d517/" class="nav-link">云原生</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/pages/410b25/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/00291d/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/pages/846ee6/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/pages/5465c3/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/853b5b/" class="nav-link">设计模式详解</a></li><li class="dropdown-item"><!----> <a href="/pages/ebc515/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/pages/57778e/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/pages/282cd0/" class="nav-link">项目</a></li><li class="dropdown-item"><!----> <a href="/pages/2cd810/" class="nav-link">理论基础</a></li><li class="dropdown-item"><!----> <a href="/pages/6acd46/" class="nav-link">运营</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/wulinghui/TechnicalSummary" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/e5d517/" class="sidebar-link">01-云原生概念</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>k8s</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/517943/" class="sidebar-link">基础介绍</a></li><li><a href="/pages/c1223e/" class="sidebar-link">安装</a></li><li><a href="/pages/6ed476/" class="sidebar-link">命令详解</a></li><li><a href="/pages/a11481/" class="sidebar-link">Pod配置以及生命周期</a></li><li><a href="/pages/ad6362/" class="sidebar-link">Pod调度</a></li><li><a href="/pages/eed6b8/" class="sidebar-link">Pod控制器</a></li><li><a href="/pages/49c21a/" class="sidebar-link">Service详解</a></li><li><a href="/pages/7a877a/" class="sidebar-link">数据存储</a></li><li><a href="/pages/33d194/" class="sidebar-link">安全</a></li><li><a href="/pages/29fa5c/" class="sidebar-link">网络</a></li><li><a href="/pages/97cddc/" class="sidebar-link">调度框架</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Helm包管理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>k8s实战部署</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/a3c23a/" class="sidebar-link">部署k8s1.24版本</a></li><li><a href="/pages/18f4c5/" class="sidebar-link">Harbor部署</a></li><li><a href="/pages/2c0ab9/" class="sidebar-link">StatefulSet讲解</a></li><li><a href="/pages/c5a8b8/" aria-current="page" class="active sidebar-link">wordpress实战部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/c5a8b8/#_1-原理" class="sidebar-link">1. 原理</a></li><li class="sidebar-sub-header level2"><a href="/pages/c5a8b8/#_2-高可用" class="sidebar-link">2. 高可用</a></li><li class="sidebar-sub-header level2"><a href="/pages/c5a8b8/#_3-稳定性" class="sidebar-link">3. 稳定性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/c5a8b8/#_3-1-避免单点故障" class="sidebar-link">3.1 避免单点故障</a></li><li class="sidebar-sub-header level3"><a href="/pages/c5a8b8/#_3-2-使用-pdb" class="sidebar-link">3.2 使用 PDB</a></li><li class="sidebar-sub-header level3"><a href="/pages/c5a8b8/#_3-3-健康检查" class="sidebar-link">3.3 健康检查</a></li><li class="sidebar-sub-header level3"><a href="/pages/c5a8b8/#_3-4-服务质量-qos" class="sidebar-link">3.4 服务质量 QoS</a></li><li class="sidebar-sub-header level4"><a href="/pages/c5a8b8/#_3-4-1-guaranteed-有保证的" class="sidebar-link">3.4.1 Guaranteed(有保证的)</a></li><li class="sidebar-sub-header level4"><a href="/pages/c5a8b8/#_3-4-2-burstable-不稳定的" class="sidebar-link">3.4.2 Burstable(不稳定的)</a></li><li class="sidebar-sub-header level4"><a href="/pages/c5a8b8/#_3-4-3-best-effort-尽最大努力" class="sidebar-link">3.4.3 Best-Effort(尽最大努力)</a></li><li class="sidebar-sub-header level4"><a href="/pages/c5a8b8/#_3-4-4-资源回收策略" class="sidebar-link">3.4.4 资源回收策略</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/c5a8b8/#_4-滚动更新" class="sidebar-link">4. 滚动更新</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/c5a8b8/#_4-1-失败原因" class="sidebar-link">4.1 失败原因</a></li><li class="sidebar-sub-header level3"><a href="/pages/c5a8b8/#_4-2-零宕机" class="sidebar-link">4.2 零宕机</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/c5a8b8/#_5-hpa" class="sidebar-link">5. HPA</a></li><li class="sidebar-sub-header level2"><a href="/pages/c5a8b8/#_6-安全性" class="sidebar-link">6. 安全性</a></li><li class="sidebar-sub-header level2"><a href="/pages/c5a8b8/#_7-持久化" class="sidebar-link">7. 持久化</a></li><li class="sidebar-sub-header level2"><a href="/pages/c5a8b8/#_8-ingress" class="sidebar-link">8. Ingress</a></li></ul></li><li><a href="/pages/76a20e/" class="sidebar-link">k8s部署IM项目-springCloud</a></li></ul></section></li><li><a href="/pages/7322db/" class="sidebar-link">总结-实战与基本原理</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>监控</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>日志</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DevOps</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ServiceMesh</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/pages/076b5d/" class="sidebar-link">Knative</a></li><li><a href="/pages/6d3863/" class="sidebar-link">spring-cloud-kubernetes</a></li><li><a href="/pages/cb6fc2/" class="sidebar-link">ms总结</a></li><li><a href="/pages/fff88c/" class="sidebar-link">架构升级踩坑之路</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/categories/?category=Kubernetes" title="分类" data-v-06970110>Kubernetes</a></li><li data-v-06970110><a href="/categories/?category=k8s" title="分类" data-v-06970110>k8s</a></li><li data-v-06970110><a href="/categories/?category=k8s%E5%AE%9E%E6%88%98%E9%83%A8%E7%BD%B2" title="分类" data-v-06970110>k8s实战部署</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://gitee.com/hellowllh/projects" target="_blank" title="作者" class="beLink" data-v-06970110>wulinghui</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2023-01-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">wordpress实战部署<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="wordpress实战部署"><a href="#wordpress实战部署" class="header-anchor">#</a> wordpress实战部署</h1> <p>wordpress是php实现的一个CMS系统，被广泛用来做为博客，网站等，应用度非常高，比较适合拿来做例子。</p> <p>我们需要达到的目的是让 Wordpress 应用具有高可用、滚动更新的过程中不能中断服务、数据要持久化不能丢失、当应用负载太高的时候能够自动进行扩容等等，这些是我们的应用部署到线上环境基本上要具备的一些能力，接下来我们就来一步一步完成这些需求。</p> <h2 id="_1-原理"><a href="#_1-原理" class="header-anchor">#</a> 1. 原理</h2> <p>有部署worpress首先要了解其原理，wordpress运行需要一个能够解析 PHP 的程序，和 MySQL 数据库就可以了。</p> <p>Wordpress 应用本身会频繁的和 MySQL 数据库进行交互，这种情况下如果将二者用容器部署在同一个 Pod 下面会高效很多，因为一个 Pod 下面的所有容器是共享同一个 network namespace 的，下面我们就来部署我们的应用，将我们的应用都部署到 kube-example 这个命名空间下面，所以首先创建一个命名空间：(namespace.yaml)</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后编写部署到 Kubernetes 下面的资源清单：(deployment.yaml)</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
        <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">:</span>5.3.2<span class="token punctuation">-</span>apache
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> wdport
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_HOST
          <span class="token key atrule">value</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">3306</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_USER
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_PASSWORD
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
        <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">args</span><span class="token punctuation">:</span>  <span class="token comment"># 新版本镜像有更新，需要使用下面的认证插件环境变量配置才会生效</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>default_authentication_plugin=mysql_native_password
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>character<span class="token punctuation">-</span>set<span class="token punctuation">-</span>server=utf8mb4
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>collation<span class="token punctuation">-</span>server=utf8mb4_unicode_ci
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> dbport
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
          <span class="token key atrule">value</span><span class="token punctuation">:</span> rootPassW0rd
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_DATABASE
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_USER
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_PASSWORD
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><p>由于我们这里 MySQL 和 Wordpress 在同一个 Pod 下面，所以在 Wordpress 中我们指定数据库地址的时候是用的 <code>127.0.0.1:3306</code>，因为这两个容器已经共享同一个 network namespace 了，这点很重要，然后如果我们要想把这个服务暴露给外部用户还得创建一个 Service 或者 Ingress 对象，这里我们一步一步来，暂时先创建一个 NodePort 类型的 Service：(service.yaml)</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> wdport
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>因为只需要暴露 Wordpress 这个应用，所以只匹配了一个名为 <code>wdport</code> 的端口，现在我们来创建上面的几个资源对象：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ kubectl apply <span class="token parameter variable">-f</span> namespace.yaml
$ kubectl apply <span class="token parameter variable">-f</span> deployment.yaml
$ kubectl apply <span class="token parameter variable">-f</span> service.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接下来就是等待拉取镜像，启动 Pod:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n kube-example                                        </span>
NAME                        READY   STATUS    RESTARTS   AGE
wordpress-5786b67ff-8wvhs   <span class="token number">2</span>/2     Running   <span class="token number">0</span>          7s
<span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># kubectl get service -n kube-example         </span>
NAME        TYPE       CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
wordpress   NodePort   <span class="token number">10.106</span>.115.145   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:32179/TCP   31s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>当 Pod 启动完成后，我们就可以通过上面的 <code>http://&lt;节点IP&gt;:32179</code> 这个 NodePort 端口来访问应用了。</p> <p>我们仔细想一想这一种方式有什么问题？首先一个 Pod 中的所有容器并没有启动的先后顺序，所以很有可能当 wordpress 这个容器启动起来去连接 mysql 这个容器的时候，mysql 还没有启动起来；</p> <p>另外一个问题是现在我们的应用是不是只有一个副本？会有单点问题，应用的性能也是一个问题，由于 Wordpress 应用本身是无状态应用，所以这种情况下一般我们只需要多部署几个副本即可，比如这里我们在 Deployment 的 YAML 文件中加上 <code>replicas:3</code> 这个属性。</p> <p>这个时候有一个什么问题呢？由于 MySQL 是有状态应用，每一个 Pod 里面的数据库的数据都是独立的，他们并没有共享，也就是说这3个 Pod 相当于是独立的3个 Wordpress 实例，所以应该怎么办呢？拆分，把 Wordpress 和 MySQL 这两个容器部署成独立的 Pod 就可以了，这样我们只需要对 Wordpress 应用增加副本，而数据库 MySQL 还是一个实例，所有的应用都连接到这一个数据库上面，是不是就可以解决这个问题了。</p> <h2 id="_2-高可用"><a href="#_2-高可用" class="header-anchor">#</a> 2. 高可用</h2> <p>现在我们将 Pod 中的两个容器进行拆分，将 Wordpress 和 MySQL 分别部署，然后 Wordpress 用多个副本进行部署就可以实现应用的高可用了，由于 MySQL 是有状态应用，一般来说需要用 StatefulSet 来进行管理，但是我们这里部署的 MySQL 并不是集群模式，而是单副本的，所以用 Deployment 也是没有问题的，当然如果要真正用于生产环境还是需要集群模式的：（mysql.yaml）</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>mysql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> dbport
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> mysql
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>mysql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> mysql
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
      <span class="token key atrule">tier</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
        <span class="token key atrule">tier</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
        <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">args</span><span class="token punctuation">:</span>  <span class="token comment"># 新版本镜像有更新，需要使用下面的认证插件环境变量配置才会生效</span>
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>default_authentication_plugin=mysql_native_password
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>character<span class="token punctuation">-</span>set<span class="token punctuation">-</span>server=utf8mb4
        <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>collation<span class="token punctuation">-</span>server=utf8mb4_unicode_ci
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> dbport
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
          <span class="token key atrule">value</span><span class="token punctuation">:</span> rootPassW0rd
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_DATABASE
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_USER
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_PASSWORD
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><p>我们这里给 MySQL 应用添加了一个 Service 对象，是因为 Wordpress 应用需要来连接数据库，之前在同一个 Pod 中用 <code>localhost</code> 即可，现在需要通过 Service 的 DNS 形式的域名进行连接。直接创建上面资源对象：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f mysql.yaml </span>
service/wordpress-mysql created
deployment.apps/wordpress-mysql created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接下来创建独立的 Wordpress 服务，对应的资源对象如下：（wordpress.yaml）</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> wdport
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
      <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
        <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
        <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">:</span>5.3.2<span class="token punctuation">-</span>apache
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> wdport
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_HOST
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>mysql<span class="token punctuation">:</span><span class="token number">3306</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_USER
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_PASSWORD
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><p>注意这里的环境变量 <code>WORDPRESS_DB_HOST</code> 的值将之前的 <code>localhost</code> 地址更改成了上面 MySQL 服务的 DNS 地址，完整的域名应该是 <code>wordpress-mysql.kube-example.svc.cluster.local:3306</code>，由于这两个应该都处于同一个命名空间，所以直接简写成 <code>wordpress-mysql:3306</code> 也是可以的。创建上面资源对象：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f wordpress.yaml</span>
service/wordpress created
deployment.apps/wordpress created
<span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -l app=wordpress -n kube-example</span>
NAME                               READY   STATUS    RESTARTS   AGE
wordpress-85b946ff8b-2mw87         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m2s
wordpress-85b946ff8b-72lnv         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m2s
wordpress-85b946ff8b-kfn88         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m2s
wordpress-mysql-5d7dccb894-l9mnt   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6m8s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以看到都已经是 <code>Running</code> 状态了，然后我们需要怎么来验证呢？是不是我们能想到的就是去访问下我们的 Wordpress 服务就可以了，我们这里还是使用的一个 NodePort 类型的 Service 来暴露服务：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -l app=wordpress -n kube-example</span>
NAME              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
wordpress         NodePort    <span class="token number">10.102</span>.253.21    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:32151/TCP   37s
wordpress-mysql   ClusterIP   <span class="token number">10.105</span>.179.202   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">3306</span>/TCP       103s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到 wordpress 服务产生了一个 32151 的端口，现在我们就可以通过 <code>http://&lt;节点的NodeIP&gt;:32151</code> 访问我们的应用了，在浏览器中打开，如果看到 wordpress 跳转到了安装页面，证明我们的安装是正确的，如果没有出现预期的效果，那么就需要去查看下 Pod 的日志来排查问题了，根据页面提示，填上对应的信息，点击<code>“安装”</code>即可，最终安装成功后，我们就可以看到熟悉的首页界面了：</p> <p><img src="img/image-20220923180933569.png" alt="image-20220923180933569"></p> <h2 id="_3-稳定性"><a href="#_3-稳定性" class="header-anchor">#</a> 3. 稳定性</h2> <p>现在 Wodpress 应用已经部署成功了，那么就万事大吉了吗？如果我们的网站访问量突然变大了怎么办，如果我们要更新我们的镜像该怎么办？所以要保证我们的网站能够非常稳定的提供服务，我们做得还不够，我们可以通过做些什么事情来提高网站的稳定性呢？</p> <h3 id="_3-1-避免单点故障"><a href="#_3-1-避免单点故障" class="header-anchor">#</a> 3.1 避免单点故障</h3> <p>为什么会有单点故障的问题呢？我们不是部署了多个副本的 Wordpress 应用吗？当我们设置 <code>replicas=1</code> 的时候肯定会存在单点故障问题，如果大于 1 但是所有副本都调度到了同一个节点的是不是同样就会存在单点问题了，这个节点挂了所有副本就都挂了，所以我们不仅需要设置多个副本数量，还需要让这些副本调度到不同的节点上，来打散避免单点故障，这个利用 Pod 反亲和性来实现了，我们可以加上如下所示的配置：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> wdport
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
      <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
        <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
        <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">:</span>5.3.2<span class="token punctuation">-</span>apache
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> wdport
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_HOST
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>mysql<span class="token punctuation">:</span><span class="token number">3306</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_USER
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_PASSWORD
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>
          <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>  <span class="token comment"># 软策略</span>
          <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>
            <span class="token key atrule">podAffinityTerm</span><span class="token punctuation">:</span>
              <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname
              <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
                <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app
                  <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                  <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> wordpress 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>这里的意思就是如果一个节点上面有 <code>app=wordpress</code> 这样的 Pod 的话，那么我们的 Pod 就尽可能别调度到这个节点上面来，因为我们这里的节点并不多，所以我使用的是软策略，因为如果使用硬策略的话，如果应用副本数超过了节点数就必然会有 Pod 调度不成功，如果你线上节点非常多的话（节点数大于 Pod 副本数），建议使用硬策略，更新后我们可以查看下 3 个副本被分散在了不同的节点上。</p> <h3 id="_3-2-使用-pdb"><a href="#_3-2-使用-pdb" class="header-anchor">#</a> 3.2 使用 PDB</h3> <p>有些时候线上的某些节点需要做一些维护操作，比如要升级内核，这个时候我们就需要将要维护的节点进行驱逐操作，驱逐节点首先是将节点设置为不可调度，这样可以避免有新的 Pod 调度上来，然后将该节点上的 Pod 全部删除，ReplicaSet 控制器检测到 Pod 数量减少了就会重新创建一个新的 Pod，调度到其他节点上面，这个过程是先删除，再创建，并非是滚动更新，因此更新过程中，如果一个服务的所有副本都在被驱逐的节点上，则可能导致该服务不可用。</p> <p>如果服务本身存在单点故障，所有副本都在同一个节点，驱逐的时候肯定就会造成服务不可用了，这种情况我们使用上面的反亲和性和多副本就可以解决这个问题。但是如果我们的服务本身就被打散在多个节点上，这些节点如果都被同时驱逐的话，那么这个服务的所有实例都会被同时删除，这个时候也会造成服务不可用了，这种情况下我们可以通过配置 PDB（PodDisruptionBudget）对象来避免所有副本同时被删除，比如我们可以设置在驱逐的时候 wordpress 应用最多只有一个副本不可用，其实就相当于逐个删除并在其它节点上重建：（pdb.yaml）</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> policy/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PodDisruptionBudget
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>pdb
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
      <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>直接创建这个资源对象即可：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f pdb.yaml </span>
Warning: policy/v1beta1 PodDisruptionBudget is deprecated <span class="token keyword">in</span> v1.21+, unavailable <span class="token keyword">in</span> v1.25+<span class="token punctuation">;</span> use policy/v1 PodDisruptionBudget
poddisruptionbudget.policy/wordpress-pdb created
<span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># kubectl get pdb -n kube-example</span>
NAME            MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE
wordpress-pdb   N/A             <span class="token number">1</span>                 <span class="token number">1</span>                     11s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>关于 PDB 的更多详细信息可以查看官方文档：https://kubernetes.io/docs/tasks/run-application/configure-pdb/。</p> <h3 id="_3-3-健康检查"><a href="#_3-3-健康检查" class="header-anchor">#</a> 3.3 健康检查</h3> <p>我们的应用现在还有一个非常重要的功能没有提供，那就是健康检查，我们知道健康检查是提高应用健壮性非常重要的手段，当我们检测到应用不健康的时候我们希望可以自动重启容器，当应用还没有准备好的时候我们也希望暂时不要对外提供服务，所以我们需要 <code>liveness probe</code> 和 <code>rediness probe</code> 两个健康检测探针，检查探针的方式有很多，我们这里当然可以认为如果容器的 80 端口可以成功访问那么就是健康的，对于一般的应用提供一个健康检查的 URL 会更好，这里我们添加一个如下所示的可读性探针，为什么不添加存活性探针呢？这里其实是考虑到线上错误排查的一个问题，如果当我们的应用出现了问题，然后就自动重启去掩盖错误的话，可能这个错误就会被永远忽略掉了，所以其实这是一个折衷的做法，不使用存活性探针，而是结合监控报警，保留错误现场，方便错误排查，但是可读写探针是一定需要添加的：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> wdport
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
      <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
        <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
        <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">:</span>5.3.2<span class="token punctuation">-</span>apache
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> wdport
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_HOST
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>mysql<span class="token punctuation">:</span><span class="token number">3306</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_USER
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_PASSWORD
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>
          <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>  <span class="token comment"># 软策略</span>
          <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>
            <span class="token key atrule">podAffinityTerm</span><span class="token punctuation">:</span>
              <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname
              <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
                <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app
                  <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                  <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> wordpress 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><p>增加上面的探针，每 5s 检测一次应用是否可读，这样只有当 <code>readinessProbe</code> 探针检测成功后才表示准备好接收流量了，这个时候才会更新 Service 的 Endpoints 对象。</p> <h3 id="_3-4-服务质量-qos"><a href="#_3-4-服务质量-qos" class="header-anchor">#</a> 3.4 服务质量 QoS</h3> <p><code>QoS</code> 是 <code>Quality of Service</code> 的缩写，即服务质量。为了实现资源被有效调度和分配的同时提高资源利用率，Kubernetes 针对不同服务质量的预期，通过 <code>QoS</code> 来对 Pod 进行服务质量管理。对于一个 Pod 来说，服务质量体现在两个具体的指标：CPU 和内存。当节点上内存资源紧张时，Kubernetes 会根据预先设置的不同 <code>QoS</code> 类别进行相应处理。</p> <p><code>QoS</code> 主要分为 <code>Guaranteed</code>、<code>Burstable</code> 和 <code>Best-Effort</code>三类，优先级从高到低。我们先分别来介绍下这三种服务类型的定义。</p> <h4 id="_3-4-1-guaranteed-有保证的"><a href="#_3-4-1-guaranteed-有保证的" class="header-anchor">#</a> 3.4.1 Guaranteed(有保证的)</h4> <p>属于该级别的 Pod 有以下两种：</p> <ul><li>Pod 中的所有容器都且仅设置了 CPU 和内存的 <strong>limits</strong></li> <li>Pod 中的所有容器都设置了 CPU 和内存的 requests 和 limits ，且单个容器内的<code>requests==limits</code>（requests不等于0）</li></ul> <p>Pod 中的所有容器都且仅设置了 limits，如下所示：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> foo
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 10m
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> bar
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>Pod 中的所有容器都设置了 requests 和 limits，且单个容器内的 requests==limits 的情况：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> foo
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 10m
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi
      <span class="token key atrule">requests</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 10m
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> bar
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi
      <span class="token key atrule">requests</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>容器 foo 和 bar 内 <code>resources</code> 的 <code>requests</code> 和 <code>limits</code> 均相等，该 Pod 的 <code>QoS</code> 级别属于 <code>Guaranteed</code>。</p> <h4 id="_3-4-2-burstable-不稳定的"><a href="#_3-4-2-burstable-不稳定的" class="header-anchor">#</a> 3.4.2 Burstable(不稳定的)</h4> <p>Pod 中只要有一个容器的 requests 和 limits 的设置不相同，那么该 Pod 的 QoS 即为 Burstable。如下所示容器 foo 指定了 resource，而容器 bar 未指定：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> foo
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 10m
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi
      <span class="token key atrule">requests</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 10m
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> bar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>容器 foo 设置了内存 limits，而容器 bar 设置了CPU limits：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> foo
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> bar
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>需要注意的是如果容器指定了 requests 而未指定 limits，则 limits 的值等于节点资源的最大值，如果容器指定了 limits 而未指定 requests，则 requests 的值等于 limits。</p> <h4 id="_3-4-3-best-effort-尽最大努力"><a href="#_3-4-3-best-effort-尽最大努力" class="header-anchor">#</a> 3.4.3 Best-Effort(尽最大努力)</h4> <p>如果 Pod 中所有容器的 resources 均未设置 requests 与 limits，该 Pod 的 QoS 即为 Best-Effort。如下所示容器 foo 和容器 bar 均未设置requests 和 limits：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> foo
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> bar
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_3-4-4-资源回收策略"><a href="#_3-4-4-资源回收策略" class="header-anchor">#</a> 3.4.4 资源回收策略</h4> <p>Kubernetes 通过 CGroup 给 Pod设置 QoS 级别，当资源不足时会优先 kill 掉优先级低的 Pod，在实际使用过程中，通过 <code>OOM</code> 分数值来实现，OOM 分数值范围为 0-1000，OOM 分数值根据 <code>OOM_ADJ</code>参数计算得出。</p> <p>对于 <code>Guaranteed</code> 级别的 Pod，OOM_ADJ 参数设置成了<code>-998</code>，对于 <code>Best-Effort</code> 级别的 Pod，OOM_ADJ 参数设置成了<code>1000</code>，对于 <code>Burstable</code> 级别的 Pod，OOM_ADJ 参数取值从 2 到 999。</p> <p>QoS Pods 被 kill 掉的场景和顺序如下所示：</p> <ul><li>Best-Effort Pods：系统用完了全部内存时，该类型 Pods 会最先被 kill 掉</li> <li>Burstable Pods：系统用完了全部内存，且没有 Best-Effort 类型的容器可以被 kill 时，该类型的 Pods 会被 kill 掉</li> <li>Guaranteed Pods：系统用完了全部内存，且没有 Burstable 与 Best-Effort 类型的容器可以被 kill 时，该类型的 pods 会被 kill 掉</li></ul> <p>所以如果资源充足，可将 QoS Pods 类型设置为 Guaranteed，用计算资源换业务性能和稳定性，减少排查问题时间和成本。如果想更好的提高资源利用率，业务服务可以设置为 Guaranteed，而其他服务根据重要程度可分别设置为 Burstable 或 Best-Effort，这就要看具体的场景了。</p> <p>比如我们这里如果想要尽可能提高 Wordpress 应用的稳定性，我们可以将其设置为 <code>Guaranteed</code> 类型的 Pod，我们现在没有设置 resources 资源，所以现在是 <code>Best-Effort</code> 类型的 Pod。</p> <p>现在如果要想给应用设置资源大小，就又有一个问题了，应该如何设置合适的资源大小呢？其实这就需要我们对自己的应用非常了解才行了，一般情况下我们可以先不设置资源，然后可以根据我们的应用的并发和访问量来进行压力测试，基本上可以大概计算出应用的资源使用量，我们这里可以使用 <a href="http://httpd.apache.org/docs/current/programs/ab.html" target="_blank" rel="noopener noreferrer">Apache Bench（AB Test）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 或者 <a href="https://fortio.org/" target="_blank" rel="noopener noreferrer">Fortio（Istio 测试工具）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这样的测试工具来测试，我们这里使用 Fortio 这个测试工具，比如每秒 1000 个请求和 8 个并发的连接的测试命令如下所示：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># rpm -i https://github.com/fortio/fortio/releases/download/v1.38.0/fortio-1.38.0-1.x86_64.rpm</span>

<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># </span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># fortio load -a -c 8 -qps 1000 -t 60s &quot;http://192.168.200.101:32760&quot;</span>
<span class="token comment"># range, mid point, percentile, count</span>
<span class="token operator">&gt;=</span> <span class="token number">0.000217831</span> <span class="token operator">&lt;=</span> <span class="token number">0.001</span> , <span class="token number">0.000608915</span> , <span class="token number">92.38</span>, <span class="token number">97</span>
<span class="token operator">&gt;</span> <span class="token number">0.001</span> <span class="token operator">&lt;=</span> <span class="token number">0.00166491</span> , <span class="token number">0.00133245</span> , <span class="token number">100.00</span>, <span class="token number">8</span>
<span class="token comment"># target 50% 0.000637432</span>
<span class="token comment"># target 75% 0.000851306</span>
<span class="token comment"># target 90% 0.000979631</span>
<span class="token comment"># target 99% 0.00157764</span>
<span class="token comment"># target 99.9% 0.00165618</span>
Sockets used: <span class="token number">105</span> <span class="token punctuation">(</span>for perfect keepalive, would be <span class="token number">8</span><span class="token punctuation">)</span>
Uniform: false, Jitter: <span class="token boolean">false</span>
IP addresses distribution:
<span class="token number">192.168</span>.200.101:32760: <span class="token number">105</span>
Code <span class="token number">200</span> <span class="token builtin class-name">:</span> <span class="token number">10162</span> <span class="token punctuation">(</span><span class="token number">100.0</span> %<span class="token punctuation">)</span>
Response Header Sizes <span class="token builtin class-name">:</span> count <span class="token number">10162</span> avg <span class="token number">278.18136</span> +/- <span class="token number">1.847</span> min <span class="token number">278</span> max <span class="token number">297</span> <span class="token function">sum</span> <span class="token number">2826879</span>
Response Body/Total Sizes <span class="token builtin class-name">:</span> count <span class="token number">10162</span> avg <span class="token number">26274.52</span> +/- <span class="token number">2.994</span> min <span class="token number">26271</span> max <span class="token number">26295</span> <span class="token function">sum</span> <span class="token number">267001670</span>
All <span class="token keyword">done</span> <span class="token number">10162</span> calls <span class="token punctuation">(</span>plus <span class="token number">8</span> warmup<span class="token punctuation">)</span> <span class="token number">47.235</span> ms avg, <span class="token number">169.3</span> qps
Successfully wrote <span class="token number">5572</span> bytes of Json data to <span class="token number">2022</span>-09-25-102015_192_168_200_101_32760_master.json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>也可以通过浏览器查看到最终测试结果：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># fortio server</span>
<span class="token number">10</span>:22:42 Fortio <span class="token number">1.38</span>.0 tcp-echo server listening on tcp <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8078
<span class="token number">10</span>:22:42 Fortio <span class="token number">1.38</span>.0 udp-echo server listening on udp <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8078
<span class="token number">10</span>:22:42 Fortio <span class="token number">1.38</span>.0 grpc <span class="token string">'ping'</span> server listening on tcp <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8079
<span class="token number">10</span>:22:42 Fortio <span class="token number">1.38</span>.0 https redirector server listening on tcp <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8081
<span class="token number">10</span>:22:42 Fortio <span class="token number">1.38</span>.0 http-echo server listening on tcp <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:8080
<span class="token number">10</span>:22:42 Data directory is /root
<span class="token number">10</span>:22:42 REST API on /fortio/rest/run, /fortio/rest/status, /fortio/rest/stop
         UI started - visit:
                http://localhost:8080/fortio/
         <span class="token punctuation">(</span>or any host/ip reachable on this server<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="img/image-20220925222317742.png" alt="image-20220925222317742"></p> <p>在测试期间我们可以用如下所示的命令查看应用的资源使用情况：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl top pods -l app=wordpress -n kube-example</span>
NAME                               CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   
wordpress-bff866b4d-6wkrk          727m         91Mi            
wordpress-bff866b4d-hsbw6          749m         66Mi            
wordpress-bff866b4d-ks7hd          772m         90Mi            
wordpress-mysql-5d8c9c4d88-bpdqd   694m         204Mi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>我们可以看到内存基本上都是处于 100Mi 以内，而 CPU 消耗就非常大了，但是由于 CPU 是可压缩资源，也就是说超过了限制应用也不会挂掉的，只是会变慢而已。所以我们这里可以给 Wordpress 应用添加如下所示的资源配置，如果你集群资源足够的话可以适当多分配一些资源：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token key atrule">limits</span><span class="token punctuation">:</span>
    <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 200m
    <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi
  <span class="token key atrule">requests</span><span class="token punctuation">:</span>
    <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 200m
    <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> wdport
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
      <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
        <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
        <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">:</span>5.3.2<span class="token punctuation">-</span>apache
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> wdport
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_HOST
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>mysql<span class="token punctuation">:</span><span class="token number">3306</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_USER
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_PASSWORD
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 200m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 200m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>
          <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>  <span class="token comment"># 软策略</span>
          <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>
            <span class="token key atrule">podAffinityTerm</span><span class="token punctuation">:</span>
              <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname
              <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
                <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app
                  <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                  <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> wordpress 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br></div></div><h2 id="_4-滚动更新"><a href="#_4-滚动更新" class="header-anchor">#</a> 4. 滚动更新</h2> <p>Deployment 控制器默认的就是滚动更新的更新策略，该策略可以在任何时间点更新应用的时候保证某些实例依然可以正常运行来防止应用 down 掉，当新部署的 Pod 启动并可以处理流量之后，才会去杀掉旧的 Pod。在使用过程中我们还可以指定 Kubernetes 在更新期间如何处理多个副本的切换方式，比如我们有一个3副本的应用，在更新的过程中是否应该立即创建这3个新的 Pod 并等待他们全部启动，或者杀掉一个之外的所有旧的 Pod，或者还是要一个一个的 Pod 进行替换？</p> <p>如果我们从旧版本到新版本进行滚动更新，只是简单的通过输出显示来判断哪些 Pod 是存活并准备就绪的，那么这个滚动更新的行为看上去肯定就是有效的，但是往往实际情况就是从旧版本到新版本的切换的过程并不总是十分顺畅的，应用程序很有可能会丢弃掉某些客户端的请求。比如我们在 Wordpress 应用中添加上如下的滚动更新策略，随便更改以下 Pod Template 中的参数，比如容器名更改为 blog：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> wdport
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
      <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
        <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> blog
        <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">:</span>5.3.2<span class="token punctuation">-</span>apache
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> wdport
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_HOST
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>mysql<span class="token punctuation">:</span><span class="token number">3306</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_USER
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_PASSWORD
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 200m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 200m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>
          <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>  <span class="token comment"># 软策略</span>
          <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>
            <span class="token key atrule">podAffinityTerm</span><span class="token punctuation">:</span>
              <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname
              <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
                <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app
                  <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                  <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> wordpress 

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br></div></div><p>然后更新应用，同时用 Fortio 工具在滚动更新过程中来测试应用是否可用：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># fortio load -a -c 8 -qps 1000 -t 60s &quot;http://192.168.200.101:30490&quot;</span>
Fortio <span class="token number">1.38</span>.0 running at <span class="token number">1000</span> queries per second, <span class="token number">2</span>-<span class="token operator">&gt;</span><span class="token number">2</span> procs, <span class="token keyword">for</span> 1m0s: http://192.168.200.101:32760
<span class="token number">10</span>:44:14 I httprunner.go:10<span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> Starting http <span class="token builtin class-name">test</span> <span class="token keyword">for</span> http://192.168.200.101:32760 with <span class="token number">8</span> threads at <span class="token number">1000.0</span> qps and parallel warmup
Starting at <span class="token number">1000</span> qps with <span class="token number">8</span> thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">[</span>gomax <span class="token number">2</span><span class="token punctuation">]</span> <span class="token keyword">for</span> 1m0s <span class="token builtin class-name">:</span> <span class="token number">7500</span> calls each <span class="token punctuation">(</span>total <span class="token number">60000</span><span class="token punctuation">)</span>
<span class="token number">10</span>:44:21 I http_client.go:89<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> Closing dead socket <span class="token number">192.168</span>.200.101:32760 <span class="token punctuation">(</span>err EOF at first <span class="token builtin class-name">read</span><span class="token punctuation">)</span>
<span class="token number">10</span>:44:21 I http_client.go:89<span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Closing dead socket <span class="token number">192.168</span>.200.101:32760 <span class="token punctuation">(</span>err EOF at first <span class="token builtin class-name">read</span><span class="token punctuation">)</span>
<span class="token number">10</span>:44:21 E http_client.go:90<span class="token operator"><span class="token file-descriptor important">3</span>&gt;</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> Read error <span class="token keyword">for</span> <span class="token number">192.168</span>.200.101:32760 <span class="token number">0</span> <span class="token builtin class-name">:</span> <span class="token builtin class-name">read</span> tcp <span class="token number">192.168</span>.200.101:36882-<span class="token operator">&gt;</span><span class="token number">192.168</span>.200.101:32760: read: connection reset by peer
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>从上面的输出可以看出有部分请求处理失败了，要弄清楚失败的原因就需要弄明白当应用在滚动更新期间重新路由流量时，从旧的 Pod 实例到新的实例究竟会发生什么，首先让我们先看看 Kubernetes 是如何管理工作负载连接的。</p> <h3 id="_4-1-失败原因"><a href="#_4-1-失败原因" class="header-anchor">#</a> 4.1 失败原因</h3> <p>我们这里通过 NodePort 去访问应用，实际上也是通过每个节点上面的 <code>kube-proxy</code> 通过更新 iptables 规则来实现的。</p> <p><img src="img/20200212151246.png" alt="kubernetes kube-proxy"></p> <p>Kubernetes 会根据 Pods 的状态去更新 Endpoints 对象，这样就可以保证 Endpoints 中包含的都是准备好处理请求的 Pod。一旦新的 Pod 处于活动状态并准备就绪后，Kubernetes 就将会停止旧的 Pod，从而将 Pod 的状态更新为 <code>“Terminating”</code>，然后从 Endpoints 对象中移除，并且发送一个 <code>SIGTERM</code> 信号给 Pod 的主进程。<code>SIGTERM</code> 信号就会让容器以正常的方式关闭，并且不接受任何新的连接。Pod 从 Endpoints 对象中被移除后，前面的负载均衡器就会将流量路由到其他（新的）Pod 中去。因为在负载均衡器注意到变更并更新其配置之前，终止信号就会去停用 Pod，而这个重新配置过程又是<strong>异步</strong>发生的，并不能保证正确的顺序，所以就可能导致很少的请求会被路由到已经终止的 Pod 上去了，也就出现了上面我们说的情况。</p> <h3 id="_4-2-零宕机"><a href="#_4-2-零宕机" class="header-anchor">#</a> 4.2 零宕机</h3> <p>那么如何增强我们的应用程序以实现真正的零宕机迁移更新呢？</p> <p>首先，要实现这个目标的先决条件是我们的容器要正确处理终止信号，在 <code>SIGTERM</code> 信号上实现优雅关闭。下一步需要添加 <code>readiness</code> 可读探针，来检查我们的应用程序是否已经准备好来处理流量了。为了解决 Pod 停止的时候不会阻塞并等到负载均衡器重新配置的问题，我们还需要使用 <code>preStop</code> 这个生命周期的钩子，在容器终止之前调用该钩子。</p> <p>生命周期钩子函数是<strong>同步</strong>的，所以必须在将最终停止信号发送到容器之前完成，在我们的示例中，我们使用该钩子简单的等待，然后 <code>SIGTERM</code> 信号将停止应用程序进程。同时，Kubernetes 将从 Endpoints 对象中删除该 Pod，所以该 Pod 将会从我们的负载均衡器中排除，基本上来说我们的生命周期钩子函数等待的时间可以确保在应用程序停止之前重新配置负载均衡器：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
  <span class="token comment"># ...</span>
<span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
  <span class="token key atrule">preStop</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sleep 20&quot;</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> wdport
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
      <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
        <span class="token key atrule">tier</span><span class="token punctuation">:</span> frontend
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> blog
        <span class="token key atrule">image</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">:</span>5.3.2<span class="token punctuation">-</span>apache
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> wdport
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_HOST
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>mysql<span class="token punctuation">:</span><span class="token number">3306</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_USER
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_PASSWORD
          <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
        <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
          <span class="token key atrule">preStop</span><span class="token punctuation">:</span>
            <span class="token key atrule">exec</span><span class="token punctuation">:</span>
              <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/bin/bash&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sleep 20&quot;</span><span class="token punctuation">]</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">limits</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 200m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 200m
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 100Mi
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>
        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>
          <span class="token key atrule">preferredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>  <span class="token comment"># 软策略</span>
          <span class="token punctuation">-</span> <span class="token key atrule">weight</span><span class="token punctuation">:</span> <span class="token number">1</span>
            <span class="token key atrule">podAffinityTerm</span><span class="token punctuation">:</span>
              <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname
              <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>
                <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
                <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> app
                  <span class="token key atrule">operator</span><span class="token punctuation">:</span> In
                  <span class="token key atrule">values</span><span class="token punctuation">:</span>
                  <span class="token punctuation">-</span> wordpress 

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br></div></div><p>我们这里使用 <code>preStop</code> 设置了一个 20s 的宽限期，Pod 在真正销毁前会先 sleep 等待 20s，这就相当于留了时间给 Endpoints 控制器和 kube-proxy 更新去 Endpoints 对象和转发规则，这段时间 Pod 虽然处于 Terminating 状态，即便在转发规则更新完全之前有请求被转发到这个 Terminating 的 Pod，依然可以被正常处理，因为它还在 sleep，没有被真正销毁。</p> <p>现在，当我们去查看滚动更新期间的 Pod 行为时，我们将看到正在终止的 Pod 处于 <code>Terminating</code> 状态，但是在等待时间结束之前不会关闭的，如果我们使用 <code>Fortio</code> 重新测试下，则会看到零失败请求的理想状态。</p> <h2 id="_5-hpa"><a href="#_5-hpa" class="header-anchor">#</a> 5. HPA</h2> <p>现在应用是固定的3个副本，但是往往在生产环境流量是不可控的，很有可能一次活动就会有大量的流量，3个副本很有可能抗不住大量的用户请求，这个时候我们就希望能够自动对 Pod 进行伸缩，直接使用前面我们学习的 HPA 这个资源对象就可以满足我们的需求了。</p> <p>直接使用<code>kubectl autoscale</code>命令来创建一个 <code>HPA</code> 对象</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># kubectl autoscale deployment wordpress --namespace kube-example --cpu-percent=20 --min=3 --max=6</span>
horizontalpodautoscaler.autoscaling/wordpress autoscaled
<span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa -n kube-example</span>
NAME        REFERENCE              TARGETS         MINPODS   MAXPODS   REPLICAS   AGE
wordpress   Deployment/wordpress   <span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span>/20%   <span class="token number">3</span>         <span class="token number">6</span>         <span class="token number">0</span>          6s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>此命令创建了一个关联资源 wordpress 的 HPA，最小的 Pod 副本数为3，最大为6。HPA 会根据设定的 cpu 使用率（20%）动态的增加或者减少 Pod 数量。同样，使用上面的 Fortio 工具来进行压测一次，看下能否进行自动的扩缩容：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># fortio load -a -c 8 -qps 1000 -t 60s &quot;http://192.168.200.101:30696&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在压测的过程中我们可以看到 HPA 的状态变化以及 Pod 数量也变成了6个：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get hpa -n kube-example</span>
NAME        REFERENCE              TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
wordpress   Deployment/wordpress   <span class="token number">71</span>%/20%   <span class="token number">3</span>         <span class="token number">6</span>         <span class="token number">6</span>          108s
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n kube-example</span>
NAME                               READY   STATUS    RESTARTS      AGE
wordpress-6ffcfb68b6-bmmgd         <span class="token number">0</span>/1     Running   <span class="token number">0</span>             19s
wordpress-6ffcfb68b6-mgkqm         <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>17m ago<span class="token punctuation">)</span>   13h
wordpress-6ffcfb68b6-pcxrm         <span class="token number">1</span>/1     Running   <span class="token number">0</span>             19s
wordpress-6ffcfb68b6-q94jx         <span class="token number">1</span>/1     Running   <span class="token number">0</span>             34s
wordpress-6ffcfb68b6-rghbj         <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>17m ago<span class="token punctuation">)</span>   13h
wordpress-6ffcfb68b6-rxtwg         <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>17m ago<span class="token punctuation">)</span>   13h
wordpress-mysql-5d8c9c4d88-22cqd   <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>17m ago<span class="token punctuation">)</span>   13h
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>当压测停止以后正常5分钟后就会自动进行缩容，变成最小的3个 Pod 副本。</p> <h2 id="_6-安全性"><a href="#_6-安全性" class="header-anchor">#</a> 6. 安全性</h2> <p>安全性这个和具体的业务应用有关系，比如我们这里的 Wordpress 也就是数据库的密码属于比较私密的信息，我们可以使用 Kubernetes 中的 Secret 资源对象来存储比较私密的信息：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># kubectl create secret generic wordpress-db-pwd --from-literal=dbpwd=wordpress -n kube-example</span>
secret/wordpress-db-pwd created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后将 Deployment 资源对象中的数据库密码环境变量通过 Secret 对象读取：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">env</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_HOST
  <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>mysql<span class="token punctuation">:</span><span class="token number">3306</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_USER
  <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> WORDPRESS_DB_PASSWORD
  <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
    <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>db<span class="token punctuation">-</span>pwd
      <span class="token key atrule">key</span><span class="token punctuation">:</span> dbpwd
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>这样我们就不会在 YAML 文件中看到明文的数据库密码了，当然安全性都是相对的，Secret 资源对象也只是简单的将密码做了一次 Base64 编码而已，对于一些特殊场景安全性要求非常高的应用，就需要使用其他功能更加强大的密码系统来进行管理了，比如 <a href="https://www.vaultproject.io/" target="_blank" rel="noopener noreferrer">Vault<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="_7-持久化"><a href="#_7-持久化" class="header-anchor">#</a> 7. 持久化</h2> <p>现在还有一个比较大的问题就是我们的数据还没有做持久化，MySQL 数据库没有做，Wordpress 应用本身也没有做，这显然不是一个合格的线上应用。这里我们使用StorageClass 来创建我们的数据库存储后端：</p> <p>我们这里仍旧使用nfs：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#每个节点 都要安装</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># yum install -y nfs-utils</span>
<span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># vim /etc/exports</span>
/data/mysql *<span class="token punctuation">(</span>insecure,rw,sync,no_root_squash<span class="token punctuation">)</span>
/data/wordpress *<span class="token punctuation">(</span>insecure,rw,sync,no_root_squash<span class="token punctuation">)</span>     
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /data/wordpress</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># chmod -R 777 /data/wordpress      </span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /data/mysql</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># chmod -R 777 /data/mysql  </span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># exportfs -r</span>
<span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># systemctl start nfs</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>storageClass.yaml</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1 <span class="token comment">## 创建了一个存储类</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>storage
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">storageclass.kubernetes.io/is-default-class</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>data  <span class="token comment">#Deployment中spec.template.spec.containers.env.name.PROVISIONER_NAME 保持一致</span>
<span class="token key atrule">parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">archiveOnDelete</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>  <span class="token comment">## 删除pv的时候，pv的内容是否要备份</span>

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1 <span class="token comment">## 创建了一个存储类</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>storage
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">storageclass.kubernetes.io/is-default-class</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>data  <span class="token comment">#Deployment中spec.template.spec.containers.env.name.PROVISIONER_NAME 保持一致</span>
<span class="token key atrule">parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">archiveOnDelete</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>  <span class="token comment">## 删除pv的时候，pv的内容是否要备份</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>hangzhou.aliyuncs.com/lfy_k8s_images/nfs<span class="token punctuation">-</span>subdir<span class="token punctuation">-</span>external<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>v4.0.2
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME
              <span class="token key atrule">value</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>data
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER
              <span class="token key atrule">value</span><span class="token punctuation">:</span> 192.168.200.101 <span class="token comment">## 指定自己nfs服务器地址</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH  
              <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/wordpress  <span class="token comment">## nfs服务器共享的目录</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root
          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
            <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.200.101
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/wordpress
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>hangzhou.aliyuncs.com/lfy_k8s_images/nfs<span class="token punctuation">-</span>subdir<span class="token punctuation">-</span>external<span class="token punctuation">-</span>provisioner<span class="token punctuation">:</span>v4.0.2
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /persistentvolumes
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> PROVISIONER_NAME
              <span class="token key atrule">value</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>data
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_SERVER
              <span class="token key atrule">value</span><span class="token punctuation">:</span> 192.168.200.101 <span class="token comment">## 指定自己nfs服务器地址</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> NFS_PATH  
              <span class="token key atrule">value</span><span class="token punctuation">:</span> /data/mysql  <span class="token comment">## nfs服务器共享的目录</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>root
          <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
            <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.200.101
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/mysql
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;nodes&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;persistentvolumes&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;create&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;delete&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;persistentvolumeclaims&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;storage.k8s.io&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;storageclasses&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;events&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;create&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;patch&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> run<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner<span class="token punctuation">-</span>runner
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;endpoints&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;watch&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;create&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;patch&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span>  kube<span class="token punctuation">-</span>example
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> leader<span class="token punctuation">-</span>locking<span class="token punctuation">-</span>nfs<span class="token punctuation">-</span>client<span class="token punctuation">-</span>provisioner
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br></div></div><p>mysql-pvc.yaml</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>pvc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>storage
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 20Gi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>wordpress-pvc.yaml</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>pvc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> wordpress
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>storage
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>但是由于 Wordpress 应用是多个副本，所以需要同时在多个节点进行读写，也就是 <code>accessModes</code> 需要 <code>ReadWriteMany</code> 模式。</p> <p>直接创建上面的资源对象：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f storageclass.yaml</span>
<span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f mysql-pvc.yaml </span>
persistentvolumeclaim/mysql-pvc created
<span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f wordpress-pvc.yaml      </span>
persistentvolumeclaim/wordpress-pvc created
<span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># kubectl get pvc -n kube-example                    </span>
NAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS        AGE
mysql-pvc       Bound    pvc-fd2fb917-0464-4d80-87a0-da55b1fa7a15   20Gi       RWO            mysql-storage       5m49s
wordpress-pvc   Bound    pvc-ec7db925-74a5-4fd7-a005-d8bb3540e004   2Gi        RWX            wordpress-storage   106s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在 Wordpress 应用上添加对 <code>/var/www/html</code> 目录的挂载声明：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>  <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>data
    <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/www/html
<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>data
  <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
    <span class="token key atrule">claimName</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>pvc
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在 MySQL 应用上添加对 <code>/var/lib/mysql</code> 目录的挂载声明：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>  <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>data
    <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql
<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>data
  <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
    <span class="token key atrule">claimName</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>pvc
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>
<span class="token punctuation">[</span>root@master data<span class="token punctuation">]</span><span class="token comment"># cd wordpress/</span>
<span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">4</span>
drwxrwxrwx <span class="token number">5</span> <span class="token number">33</span> tape <span class="token number">4096</span> Sep <span class="token number">26</span> 01:11 kube-example-wordpress-pvc-pvc-ec7db925-74a5-4fd7-a005-d8bb3540e004
<span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># cd kube-example-wordpress-pvc-pvc-ec7db925-74a5-4fd7-a005-d8bb3540e004/</span>
<span class="token punctuation">[</span>root@master kube-example-wordpress-pvc-pvc-ec7db925-74a5-4fd7-a005-d8bb3540e004<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">208</span>
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape   <span class="token number">420</span> Nov <span class="token number">30</span>  <span class="token number">2017</span> index.php
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape <span class="token number">19935</span> Jan  <span class="token number">1</span>  <span class="token number">2019</span> license.txt
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape  <span class="token number">7368</span> Sep <span class="token number">26</span> 01:11 readme.html
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape  <span class="token number">6939</span> Sep  <span class="token number">2</span>  <span class="token number">2019</span> wp-activate.php
drwxr-xr-x  <span class="token number">9</span> <span class="token number">33</span> tape  <span class="token number">4096</span> Dec <span class="token number">18</span>  <span class="token number">2019</span> wp-admin
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape   <span class="token number">369</span> Nov <span class="token number">30</span>  <span class="token number">2017</span> wp-blog-header.php
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape  <span class="token number">2340</span> Sep <span class="token number">26</span> 01:11 wp-comments-post.php
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape  <span class="token number">3197</span> Sep <span class="token number">26</span> 01:09 wp-config.php
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape  <span class="token number">2808</span> Sep <span class="token number">26</span> 01:09 wp-config-sample.php
drwxr-xr-x  <span class="token number">7</span> <span class="token number">33</span> tape    <span class="token number">99</span> Sep <span class="token number">26</span> 01:11 wp-content
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape  <span class="token number">3955</span> Oct <span class="token number">10</span>  <span class="token number">2019</span> wp-cron.php
drwxr-xr-x <span class="token number">20</span> <span class="token number">33</span> tape  <span class="token number">8192</span> Dec <span class="token number">18</span>  <span class="token number">2019</span> wp-includes
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape  <span class="token number">2504</span> Sep  <span class="token number">2</span>  <span class="token number">2019</span> wp-links-opml.php
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape  <span class="token number">3326</span> Sep  <span class="token number">2</span>  <span class="token number">2019</span> wp-load.php
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape <span class="token number">47597</span> Dec  <span class="token number">9</span>  <span class="token number">2019</span> wp-login.php
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape  <span class="token number">8483</span> Sep  <span class="token number">2</span>  <span class="token number">2019</span> wp-mail.php
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape <span class="token number">19120</span> Oct <span class="token number">15</span>  <span class="token number">2019</span> wp-settings.php
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape <span class="token number">31112</span> Sep  <span class="token number">2</span>  <span class="token number">2019</span> wp-signup.php
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape  <span class="token number">4764</span> Nov <span class="token number">30</span>  <span class="token number">2017</span> wp-trackback.php
-rw-r--r--  <span class="token number">1</span> <span class="token number">33</span> tape  <span class="token number">3150</span> Jul  <span class="token number">1</span>  <span class="token number">2019</span> xmlrpc.php
<span class="token punctuation">[</span>root@master kube-example-wordpress-pvc-pvc-ec7db925-74a5-4fd7-a005-d8bb3540e004<span class="token punctuation">]</span><span class="token comment"># </span>

<span class="token punctuation">[</span>root@master data<span class="token punctuation">]</span><span class="token comment"># cd mysql/</span>
<span class="token punctuation">[</span>root@master mysql<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">4</span>
drwxrwxrwx <span class="token number">6</span> polkitd root <span class="token number">4096</span> Sep <span class="token number">26</span> 01:10 kube-example-mysql-pvc-pvc-fd2fb917-0464-4d80-87a0-da55b1fa7a15
<span class="token punctuation">[</span>root@master mysql<span class="token punctuation">]</span><span class="token comment"># cd kube-example-mysql-pvc-pvc-fd2fb917-0464-4d80-87a0-da55b1fa7a15/</span>
<span class="token punctuation">[</span>root@master kube-example-mysql-pvc-pvc-fd2fb917-0464-4d80-87a0-da55b1fa7a15<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">188488</span>
-rw-r----- <span class="token number">1</span> polkitd input       <span class="token number">56</span> Sep <span class="token number">26</span> 01:10 auto.cnf
-rw------- <span class="token number">1</span> polkitd input     <span class="token number">1676</span> Sep <span class="token number">26</span> 01:10 ca-key.pem
-rw-r--r-- <span class="token number">1</span> polkitd input     <span class="token number">1112</span> Sep <span class="token number">26</span> 01:10 ca.pem
-rw-r--r-- <span class="token number">1</span> polkitd input     <span class="token number">1112</span> Sep <span class="token number">26</span> 01:10 client-cert.pem
-rw------- <span class="token number">1</span> polkitd input     <span class="token number">1676</span> Sep <span class="token number">26</span> 01:10 client-key.pem
-rw-r----- <span class="token number">1</span> polkitd input     <span class="token number">1316</span> Sep <span class="token number">26</span> 01:10 ib_buffer_pool
-rw-r----- <span class="token number">1</span> polkitd input <span class="token number">79691776</span> Sep <span class="token number">26</span> 01:11 ibdata1
-rw-r----- <span class="token number">1</span> polkitd input <span class="token number">50331648</span> Sep <span class="token number">26</span> 01:11 ib_logfile0
-rw-r----- <span class="token number">1</span> polkitd input <span class="token number">50331648</span> Sep <span class="token number">26</span> 01:10 ib_logfile1
-rw-r----- <span class="token number">1</span> polkitd input <span class="token number">12582912</span> Sep <span class="token number">26</span> 01:11 ibtmp1
drwxr-x--- <span class="token number">2</span> polkitd input     <span class="token number">4096</span> Sep <span class="token number">26</span> 01:10 mysql
lrwxrwxrwx <span class="token number">1</span> polkitd input       <span class="token number">27</span> Sep <span class="token number">26</span> 01:10 mysql.sock -<span class="token operator">&gt;</span> /var/run/mysqld/mysqld.sock
drwxr-x--- <span class="token number">2</span> polkitd input     <span class="token number">8192</span> Sep <span class="token number">26</span> 01:10 performance_schema
-rw------- <span class="token number">1</span> polkitd input     <span class="token number">1676</span> Sep <span class="token number">26</span> 01:10 private_key.pem
-rw-r--r-- <span class="token number">1</span> polkitd input      <span class="token number">452</span> Sep <span class="token number">26</span> 01:10 public_key.pem
-rw-r--r-- <span class="token number">1</span> polkitd input     <span class="token number">1112</span> Sep <span class="token number">26</span> 01:10 server-cert.pem
-rw------- <span class="token number">1</span> polkitd input     <span class="token number">1676</span> Sep <span class="token number">26</span> 01:10 server-key.pem
drwxr-x--- <span class="token number">2</span> polkitd input     <span class="token number">8192</span> Sep <span class="token number">26</span> 01:10 sys
drwxr-x--- <span class="token number">2</span> polkitd input     <span class="token number">4096</span> Sep <span class="token number">26</span> 01:11 wordpress
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><h2 id="_8-ingress"><a href="#_8-ingress" class="header-anchor">#</a> 8. Ingress</h2> <p>对于一个线上的应用对外暴露服务用一个域名显然是更加合适的，上面我们使用的 NodePort 类型的服务不适合用于线上生产环境，这里我们通过 Ingress 对象来暴露服务。</p> <p>wordpress-ingress.yaml</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress<span class="token punctuation">-</span>ingress
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/rewrite-target</span><span class="token punctuation">:</span> /
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>example
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> wp.example.com  <span class="token comment">#ingress 将域名映射到你的服务</span>
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">path</span><span class="token punctuation">:</span> /
        <span class="token key atrule">pathType</span><span class="token punctuation">:</span> Prefix
        <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">service</span><span class="token punctuation">:</span>   
            <span class="token key atrule">name</span><span class="token punctuation">:</span> wordpress <span class="token comment">#将所有请求发送到wordpress服务的80端口</span>
            <span class="token key atrule">port</span><span class="token punctuation">:</span>
              <span class="token key atrule">number</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>直接创建上面的资源对象即可：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master wordpress<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f wordpress-ingress.yaml </span>
ingress.networking.k8s.io/wordpress-ingress created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后对域名 <code>wp.example.com</code> 加上对应的 DNS 解析即可正常访问了，到这里就完成了我们一个生产级别应用的部署，虽然应用本身很简单，但是如果真的要部署到生产环境我们需要关注的内容就比较多了，当然对于线上应用除了上面我们提到的还有很多值得我们关注的地方，比如监控报警、日志收集等方面都是我们关注的层面。</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/wulinghui/TechnicalSummary/edit/master/docs/Kubernetes/02.k8s/90.k8s实战部署/10.wordpress实战部署.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/01/26, 22:57:26</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/2c0ab9/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">StatefulSet讲解</div></a> <a href="/pages/76a20e/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">k8s部署IM项目-springCloud</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/2c0ab9/" class="prev">StatefulSet讲解</a></span> <span class="next"><a href="/pages/76a20e/">k8s部署IM项目-springCloud</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/fff88c/"><div>
            架构升级踩坑之路
            <!----></div></a> <span class="date">02-27</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/ba6503/"><div>
            总结
            <!----></div></a> <span class="date">02-27</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/1b4e40/"><div>
            语法学习
            <!----></div></a> <span class="date">02-27</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:873406903@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/wulinghui" title="GitHub(移步到gitee)" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/hellowllh/projects" title="gitee" target="_blank" class="iconfont icon-gitee"></a><a href="https://blog.csdn.net/qq_41720208" title="CSDN" target="_blank" class="iconfont icon-gitee"></a><a href="https://www.cnblogs.com/wlh1995" title="博客园" target="_blank" class="iconfont icon-bokeyuan"></a></div> 
    | Copyright © 2021-2025
    <span>Wu lingui | <a href="" target="_blank"></a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.7f63dd6c.js" defer></script><script src="/assets/js/2.fe5f2a1d.js" defer></script><script src="/assets/js/3.eb8c603e.js" defer></script><script src="/assets/js/39.e4494792.js" defer></script>
  </body>
</html>
