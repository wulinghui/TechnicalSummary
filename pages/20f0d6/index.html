<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Prometheus Operator | 资料总结</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="个人资料总结，存放笔记">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.76dfa4dd.css" as="style"><link rel="preload" href="/assets/js/app.7f63dd6c.js" as="script"><link rel="preload" href="/assets/js/2.fe5f2a1d.js" as="script"><link rel="preload" href="/assets/js/3.eb8c603e.js" as="script"><link rel="preload" href="/assets/js/52.c0444208.js" as="script"><link rel="prefetch" href="/assets/js/10.fe6b23fc.js"><link rel="prefetch" href="/assets/js/100.523c1b31.js"><link rel="prefetch" href="/assets/js/101.bbee1e6c.js"><link rel="prefetch" href="/assets/js/102.36d68ded.js"><link rel="prefetch" href="/assets/js/103.482d8685.js"><link rel="prefetch" href="/assets/js/104.9b20475d.js"><link rel="prefetch" href="/assets/js/105.0edc73b7.js"><link rel="prefetch" href="/assets/js/106.a9abfe31.js"><link rel="prefetch" href="/assets/js/107.2178a4c5.js"><link rel="prefetch" href="/assets/js/108.21d19ed0.js"><link rel="prefetch" href="/assets/js/109.5e1e3698.js"><link rel="prefetch" href="/assets/js/11.7d4a2ffb.js"><link rel="prefetch" href="/assets/js/110.ccc910aa.js"><link rel="prefetch" href="/assets/js/111.fcfd17d0.js"><link rel="prefetch" href="/assets/js/112.f91ccf6e.js"><link rel="prefetch" href="/assets/js/113.5cd28a7e.js"><link rel="prefetch" href="/assets/js/114.4ca8676c.js"><link rel="prefetch" href="/assets/js/115.c4d64d4e.js"><link rel="prefetch" href="/assets/js/116.47ba7426.js"><link rel="prefetch" href="/assets/js/117.3062ccb9.js"><link rel="prefetch" href="/assets/js/118.27991bba.js"><link rel="prefetch" href="/assets/js/119.53538539.js"><link rel="prefetch" href="/assets/js/12.ac798cdb.js"><link rel="prefetch" href="/assets/js/120.e9666755.js"><link rel="prefetch" href="/assets/js/121.73a1660e.js"><link rel="prefetch" href="/assets/js/122.59ac137e.js"><link rel="prefetch" href="/assets/js/123.b9124c91.js"><link rel="prefetch" href="/assets/js/124.12ffcf50.js"><link rel="prefetch" href="/assets/js/125.0403278b.js"><link rel="prefetch" href="/assets/js/126.cec37905.js"><link rel="prefetch" href="/assets/js/127.605a5010.js"><link rel="prefetch" href="/assets/js/128.a4cf61d9.js"><link rel="prefetch" href="/assets/js/129.164a08ce.js"><link rel="prefetch" href="/assets/js/13.8de4385c.js"><link rel="prefetch" href="/assets/js/130.1d4164bd.js"><link rel="prefetch" href="/assets/js/131.7796e583.js"><link rel="prefetch" href="/assets/js/132.c79c715f.js"><link rel="prefetch" href="/assets/js/133.48384f22.js"><link rel="prefetch" href="/assets/js/134.bf85bfff.js"><link rel="prefetch" href="/assets/js/135.1244d4cb.js"><link rel="prefetch" href="/assets/js/136.6650b052.js"><link rel="prefetch" href="/assets/js/137.e9f394e2.js"><link rel="prefetch" href="/assets/js/138.ae16527d.js"><link rel="prefetch" href="/assets/js/139.df1c969c.js"><link rel="prefetch" href="/assets/js/14.d82e6d84.js"><link rel="prefetch" href="/assets/js/140.a80aa424.js"><link rel="prefetch" href="/assets/js/141.10ab646d.js"><link rel="prefetch" href="/assets/js/142.508278ee.js"><link rel="prefetch" href="/assets/js/143.62aa16a7.js"><link rel="prefetch" href="/assets/js/144.c734b314.js"><link rel="prefetch" href="/assets/js/145.7dae44b0.js"><link rel="prefetch" href="/assets/js/146.b08fb7ab.js"><link rel="prefetch" href="/assets/js/147.6fee9f53.js"><link rel="prefetch" href="/assets/js/148.5a09fe8b.js"><link rel="prefetch" href="/assets/js/149.27046d2c.js"><link rel="prefetch" href="/assets/js/15.f0dc0e66.js"><link rel="prefetch" href="/assets/js/150.c05ae37c.js"><link rel="prefetch" href="/assets/js/151.57194eb1.js"><link rel="prefetch" href="/assets/js/152.bc7ad385.js"><link rel="prefetch" href="/assets/js/153.b3c7d891.js"><link rel="prefetch" href="/assets/js/154.0d3a00e5.js"><link rel="prefetch" href="/assets/js/155.b9afdc01.js"><link rel="prefetch" href="/assets/js/156.bfc71798.js"><link rel="prefetch" href="/assets/js/157.43852835.js"><link rel="prefetch" href="/assets/js/158.785caaa2.js"><link rel="prefetch" href="/assets/js/159.1716fd78.js"><link rel="prefetch" href="/assets/js/16.1217969a.js"><link rel="prefetch" href="/assets/js/160.54dfc0be.js"><link rel="prefetch" href="/assets/js/161.3a486b71.js"><link rel="prefetch" href="/assets/js/162.4365dac4.js"><link rel="prefetch" href="/assets/js/163.9e0305ed.js"><link rel="prefetch" href="/assets/js/164.9af7099c.js"><link rel="prefetch" href="/assets/js/165.07230640.js"><link rel="prefetch" href="/assets/js/166.a13e993d.js"><link rel="prefetch" href="/assets/js/167.233c305e.js"><link rel="prefetch" href="/assets/js/168.86996235.js"><link rel="prefetch" href="/assets/js/169.c643487c.js"><link rel="prefetch" href="/assets/js/17.65771bc0.js"><link rel="prefetch" href="/assets/js/170.fed7e19e.js"><link rel="prefetch" href="/assets/js/171.a191947e.js"><link rel="prefetch" href="/assets/js/172.a2368c89.js"><link rel="prefetch" href="/assets/js/173.aad8acd6.js"><link rel="prefetch" href="/assets/js/174.e5c4e9f4.js"><link rel="prefetch" href="/assets/js/175.ef19ddcf.js"><link rel="prefetch" href="/assets/js/176.7b8490c3.js"><link rel="prefetch" href="/assets/js/177.7d1f01a3.js"><link rel="prefetch" href="/assets/js/178.c5ea1f87.js"><link rel="prefetch" href="/assets/js/179.e54bc218.js"><link rel="prefetch" href="/assets/js/18.69d253af.js"><link rel="prefetch" href="/assets/js/180.a0fc0bcd.js"><link rel="prefetch" href="/assets/js/181.8029f765.js"><link rel="prefetch" href="/assets/js/182.72075fe8.js"><link rel="prefetch" href="/assets/js/183.f74d77ba.js"><link rel="prefetch" href="/assets/js/184.3277cbcd.js"><link rel="prefetch" href="/assets/js/185.15940a23.js"><link rel="prefetch" href="/assets/js/186.810a303a.js"><link rel="prefetch" href="/assets/js/187.9c8777f6.js"><link rel="prefetch" href="/assets/js/188.fed55d48.js"><link rel="prefetch" href="/assets/js/189.7f09c5db.js"><link rel="prefetch" href="/assets/js/19.87ab5597.js"><link rel="prefetch" href="/assets/js/190.082d7cbc.js"><link rel="prefetch" href="/assets/js/191.9fb2ec38.js"><link rel="prefetch" href="/assets/js/192.167d2083.js"><link rel="prefetch" href="/assets/js/193.d1eeb947.js"><link rel="prefetch" href="/assets/js/194.09e61c12.js"><link rel="prefetch" href="/assets/js/195.969efb5f.js"><link rel="prefetch" href="/assets/js/196.3932e830.js"><link rel="prefetch" href="/assets/js/197.1dc355f6.js"><link rel="prefetch" href="/assets/js/198.1ad8dbbf.js"><link rel="prefetch" href="/assets/js/199.c6b23b90.js"><link rel="prefetch" href="/assets/js/20.3d741608.js"><link rel="prefetch" href="/assets/js/200.81a125db.js"><link rel="prefetch" href="/assets/js/201.5e2fd593.js"><link rel="prefetch" href="/assets/js/202.51a3fbc4.js"><link rel="prefetch" href="/assets/js/203.4ae7c4f4.js"><link rel="prefetch" href="/assets/js/204.5ba79932.js"><link rel="prefetch" href="/assets/js/205.05bb64e4.js"><link rel="prefetch" href="/assets/js/206.c1d5472b.js"><link rel="prefetch" href="/assets/js/207.ad43feb1.js"><link rel="prefetch" href="/assets/js/208.250144c5.js"><link rel="prefetch" href="/assets/js/209.41667b8a.js"><link rel="prefetch" href="/assets/js/21.23841fc1.js"><link rel="prefetch" href="/assets/js/210.b85ec988.js"><link rel="prefetch" href="/assets/js/211.8f2f9335.js"><link rel="prefetch" href="/assets/js/212.dea21e7c.js"><link rel="prefetch" href="/assets/js/213.9074d848.js"><link rel="prefetch" href="/assets/js/214.baaf02d5.js"><link rel="prefetch" href="/assets/js/215.e3149f2c.js"><link rel="prefetch" href="/assets/js/216.5ede3f02.js"><link rel="prefetch" href="/assets/js/217.06eb8901.js"><link rel="prefetch" href="/assets/js/218.ffe5fc66.js"><link rel="prefetch" href="/assets/js/219.69c6166f.js"><link rel="prefetch" href="/assets/js/22.b55e8e09.js"><link rel="prefetch" href="/assets/js/220.a83c1ecf.js"><link rel="prefetch" href="/assets/js/221.fb65c799.js"><link rel="prefetch" href="/assets/js/222.1ff261ff.js"><link rel="prefetch" href="/assets/js/223.807c2de7.js"><link rel="prefetch" href="/assets/js/224.33540594.js"><link rel="prefetch" href="/assets/js/225.21d88d75.js"><link rel="prefetch" href="/assets/js/226.00d419d7.js"><link rel="prefetch" href="/assets/js/227.19678a11.js"><link rel="prefetch" href="/assets/js/228.d09fe33c.js"><link rel="prefetch" href="/assets/js/229.c8dcc95e.js"><link rel="prefetch" href="/assets/js/23.d7449079.js"><link rel="prefetch" href="/assets/js/230.7477ad3f.js"><link rel="prefetch" href="/assets/js/231.f1013950.js"><link rel="prefetch" href="/assets/js/232.1e07d0e6.js"><link rel="prefetch" href="/assets/js/233.34e0f2b8.js"><link rel="prefetch" href="/assets/js/234.645446d8.js"><link rel="prefetch" href="/assets/js/235.3368fdbc.js"><link rel="prefetch" href="/assets/js/236.35ed0de0.js"><link rel="prefetch" href="/assets/js/237.4a189e89.js"><link rel="prefetch" href="/assets/js/238.d6580ef3.js"><link rel="prefetch" href="/assets/js/239.c518fd70.js"><link rel="prefetch" href="/assets/js/24.26f18aa6.js"><link rel="prefetch" href="/assets/js/240.14979636.js"><link rel="prefetch" href="/assets/js/241.95c3b00d.js"><link rel="prefetch" href="/assets/js/242.a214e307.js"><link rel="prefetch" href="/assets/js/243.273af8d4.js"><link rel="prefetch" href="/assets/js/244.e2d74303.js"><link rel="prefetch" href="/assets/js/245.fe562cb9.js"><link rel="prefetch" href="/assets/js/246.b40011af.js"><link rel="prefetch" href="/assets/js/247.dc1a9aae.js"><link rel="prefetch" href="/assets/js/248.d691ac20.js"><link rel="prefetch" href="/assets/js/249.191f742a.js"><link rel="prefetch" href="/assets/js/25.198594bf.js"><link rel="prefetch" href="/assets/js/250.205b92cf.js"><link rel="prefetch" href="/assets/js/251.acb8a80e.js"><link rel="prefetch" href="/assets/js/26.c817356c.js"><link rel="prefetch" href="/assets/js/27.6b812306.js"><link rel="prefetch" href="/assets/js/28.9048721b.js"><link rel="prefetch" href="/assets/js/29.bfda8510.js"><link rel="prefetch" href="/assets/js/30.eb1b6ab9.js"><link rel="prefetch" href="/assets/js/31.3f3dbd2f.js"><link rel="prefetch" href="/assets/js/32.006bc754.js"><link rel="prefetch" href="/assets/js/33.05d371fe.js"><link rel="prefetch" href="/assets/js/34.27cd6ff5.js"><link rel="prefetch" href="/assets/js/35.35409a6d.js"><link rel="prefetch" href="/assets/js/36.fd6a950b.js"><link rel="prefetch" href="/assets/js/37.c8fd6ef4.js"><link rel="prefetch" href="/assets/js/38.028a36a2.js"><link rel="prefetch" href="/assets/js/39.e4494792.js"><link rel="prefetch" href="/assets/js/4.ff2df22c.js"><link rel="prefetch" href="/assets/js/40.979dec53.js"><link rel="prefetch" href="/assets/js/41.ff9662db.js"><link rel="prefetch" href="/assets/js/42.5c1441fc.js"><link rel="prefetch" href="/assets/js/43.9657eae8.js"><link rel="prefetch" href="/assets/js/44.a6cb5e5c.js"><link rel="prefetch" href="/assets/js/45.c675440c.js"><link rel="prefetch" href="/assets/js/46.06205970.js"><link rel="prefetch" href="/assets/js/47.ded0c65e.js"><link rel="prefetch" href="/assets/js/48.296a6f26.js"><link rel="prefetch" href="/assets/js/49.1b2ec2ab.js"><link rel="prefetch" href="/assets/js/5.ecde23f9.js"><link rel="prefetch" href="/assets/js/50.e551e67f.js"><link rel="prefetch" href="/assets/js/51.122d5b68.js"><link rel="prefetch" href="/assets/js/53.f47d6b86.js"><link rel="prefetch" href="/assets/js/54.e9c9b41b.js"><link rel="prefetch" href="/assets/js/55.77010c1f.js"><link rel="prefetch" href="/assets/js/56.387aacbb.js"><link rel="prefetch" href="/assets/js/57.ddcf78ad.js"><link rel="prefetch" href="/assets/js/58.908b88fc.js"><link rel="prefetch" href="/assets/js/59.8ff535f1.js"><link rel="prefetch" href="/assets/js/6.b928f1b9.js"><link rel="prefetch" href="/assets/js/60.c5018386.js"><link rel="prefetch" href="/assets/js/61.1514e08b.js"><link rel="prefetch" href="/assets/js/62.79bc9197.js"><link rel="prefetch" href="/assets/js/63.a6cb5e14.js"><link rel="prefetch" href="/assets/js/64.f149661c.js"><link rel="prefetch" href="/assets/js/65.30fa2026.js"><link rel="prefetch" href="/assets/js/66.e7f9f54e.js"><link rel="prefetch" href="/assets/js/67.7361f4a3.js"><link rel="prefetch" href="/assets/js/68.b67cc099.js"><link rel="prefetch" href="/assets/js/69.ba730416.js"><link rel="prefetch" href="/assets/js/7.b0514d37.js"><link rel="prefetch" href="/assets/js/70.45b9e858.js"><link rel="prefetch" href="/assets/js/71.2055eaae.js"><link rel="prefetch" href="/assets/js/72.75ec1304.js"><link rel="prefetch" href="/assets/js/73.3aa09b6b.js"><link rel="prefetch" href="/assets/js/74.fb3013f1.js"><link rel="prefetch" href="/assets/js/75.c837c896.js"><link rel="prefetch" href="/assets/js/76.9e6df886.js"><link rel="prefetch" href="/assets/js/77.4eb09ab0.js"><link rel="prefetch" href="/assets/js/78.06d19c8c.js"><link rel="prefetch" href="/assets/js/79.dfde586d.js"><link rel="prefetch" href="/assets/js/8.f86f2563.js"><link rel="prefetch" href="/assets/js/80.476da6d1.js"><link rel="prefetch" href="/assets/js/81.2b778375.js"><link rel="prefetch" href="/assets/js/82.abbf449f.js"><link rel="prefetch" href="/assets/js/83.24b0e8ea.js"><link rel="prefetch" href="/assets/js/84.f8694c96.js"><link rel="prefetch" href="/assets/js/85.f030e8b6.js"><link rel="prefetch" href="/assets/js/86.18853c72.js"><link rel="prefetch" href="/assets/js/87.4eca3df6.js"><link rel="prefetch" href="/assets/js/88.26b81c78.js"><link rel="prefetch" href="/assets/js/89.ae216049.js"><link rel="prefetch" href="/assets/js/9.7a3e1618.js"><link rel="prefetch" href="/assets/js/90.b0ee8ab4.js"><link rel="prefetch" href="/assets/js/91.a07b34f1.js"><link rel="prefetch" href="/assets/js/92.1c2952b1.js"><link rel="prefetch" href="/assets/js/93.e199901d.js"><link rel="prefetch" href="/assets/js/94.a901578c.js"><link rel="prefetch" href="/assets/js/95.641f6644.js"><link rel="prefetch" href="/assets/js/96.84a54aa3.js"><link rel="prefetch" href="/assets/js/97.c489ec61.js"><link rel="prefetch" href="/assets/js/98.5fb17174.js"><link rel="prefetch" href="/assets/js/99.c004152a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.76dfa4dd.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="资料总结" class="logo"> <span class="site-name can-hide">资料总结</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/goVersion181/" class="nav-link">go</a></div><div class="nav-item"><a href="/pages/springFramework/" class="nav-link">java</a></div><div class="nav-item"><a href="/pages/e5d517/" class="nav-link">云原生</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/pages/410b25/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/00291d/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/pages/846ee6/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/pages/5465c3/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/853b5b/" class="nav-link">设计模式详解</a></li><li class="dropdown-item"><!----> <a href="/pages/ebc515/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/pages/57778e/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/pages/282cd0/" class="nav-link">项目</a></li><li class="dropdown-item"><!----> <a href="/pages/2cd810/" class="nav-link">理论基础</a></li><li class="dropdown-item"><!----> <a href="/pages/6acd46/" class="nav-link">运营</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/wulinghui/TechnicalSummary" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src=""> <div class="blogger-info"><h3>linghui Wu</h3> <span>一只努力学飞的鱼</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/goVersion181/" class="nav-link">go</a></div><div class="nav-item"><a href="/pages/springFramework/" class="nav-link">java</a></div><div class="nav-item"><a href="/pages/e5d517/" class="nav-link">云原生</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/pages/410b25/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/00291d/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/pages/846ee6/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/pages/5465c3/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/853b5b/" class="nav-link">设计模式详解</a></li><li class="dropdown-item"><!----> <a href="/pages/ebc515/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/pages/57778e/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/pages/282cd0/" class="nav-link">项目</a></li><li class="dropdown-item"><!----> <a href="/pages/2cd810/" class="nav-link">理论基础</a></li><li class="dropdown-item"><!----> <a href="/pages/6acd46/" class="nav-link">运营</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/wulinghui/TechnicalSummary" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/e5d517/" class="sidebar-link">01-云原生概念</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>k8s</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>监控</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Prometheus</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/26db66/" class="sidebar-link">监控概述</a></li><li><a href="/pages/bac902/" class="sidebar-link">Prometheus介绍+安装</a></li><li><a href="/pages/e085a4/" class="sidebar-link">k8s运行Prometheus</a></li><li><a href="/pages/db7b00/" class="sidebar-link">监控</a></li></ul></section></li><li><a href="/pages/2ea5fe/" class="sidebar-link">PromQL</a></li><li><a href="/pages/ff01bf/" class="sidebar-link">Grafana</a></li><li><a href="/pages/f02f2e/" class="sidebar-link">AlertManager</a></li><li><a href="/pages/237c28/" class="sidebar-link">Thanos</a></li><li><a href="/pages/f1f1ce/" class="sidebar-link">Prometheus Adpater</a></li><li><a href="/pages/7f2db1/" class="sidebar-link">CRD和Operator</a></li><li><a href="/pages/20f0d6/" aria-current="page" class="active sidebar-link">Prometheus Operator</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/20f0d6/#_1-安装" class="sidebar-link">1. 安装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/20f0d6/#_1-1-介绍" class="sidebar-link">1.1 介绍</a></li><li class="sidebar-sub-header level3"><a href="/pages/20f0d6/#_1-2-安装" class="sidebar-link">1.2 安装</a></li><li class="sidebar-sub-header level3"><a href="/pages/20f0d6/#_1-3-配置" class="sidebar-link">1.3 配置</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/20f0d6/#_2-自定义监控报警" class="sidebar-link">2. 自定义监控报警</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/20f0d6/#_2-1-etcd-监控" class="sidebar-link">2.1 etcd 监控</a></li><li class="sidebar-sub-header level3"><a href="/pages/20f0d6/#_2-2-配置-prometheusrule" class="sidebar-link">2.2 配置 PrometheusRule</a></li><li class="sidebar-sub-header level3"><a href="/pages/20f0d6/#_2-3-配置报警" class="sidebar-link">2.3 配置报警</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/20f0d6/#_3-高级配置" class="sidebar-link">3. 高级配置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/20f0d6/#_3-1-自动发现配置" class="sidebar-link">3.1 自动发现配置</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>日志</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DevOps</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ServiceMesh</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/pages/076b5d/" class="sidebar-link">Knative</a></li><li><a href="/pages/6d3863/" class="sidebar-link">spring-cloud-kubernetes</a></li><li><a href="/pages/cb6fc2/" class="sidebar-link">ms总结</a></li><li><a href="/pages/fff88c/" class="sidebar-link">架构升级踩坑之路</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/categories/?category=Kubernetes" title="分类" data-v-06970110>Kubernetes</a></li><li data-v-06970110><a href="/categories/?category=%E7%9B%91%E6%8E%A7" title="分类" data-v-06970110>监控</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://gitee.com/hellowllh/projects" target="_blank" title="作者" class="beLink" data-v-06970110>wulinghui</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2023-01-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">Prometheus Operator<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="prometheus-operator"><a href="#prometheus-operator" class="header-anchor">#</a> Prometheus Operator</h1> <p>Prometheus Operator 为监控 Kubernetes 资源和 Prometheus 实例的管理提供了简单的定义，简化在 Kubernetes 上部署、管理和运行 Prometheus 和 Alertmanager 集群。</p> <h2 id="_1-安装"><a href="#_1-安装" class="header-anchor">#</a> 1. 安装</h2> <h3 id="_1-1-介绍"><a href="#_1-1-介绍" class="header-anchor">#</a> 1.1 介绍</h3> <p>首先我们先来了解下 Prometheus-Operator 的架构图：</p> <p><img src="img/20200410141511.png" alt="promtheus opeator"></p> <p>上图是 Prometheus-Operator 官方提供的架构图，各组件以不同的方式运行在 Kubernetes 集群中，其中 Operator 是最核心的部分，作为一个控制器，他会去创建Prometheus、ServiceMonitor、AlertManager 以及 PrometheusRule 4个 CRD 资源对象，然后会一直监控并维持这4个资源对象的状态。</p> <ul><li><code>Operator</code>：根据自定义资源来部署和管理 Prometheus Server，同时监控这些自定义资源事件的变化来做相应的处理，是整个系统的控制中心。</li> <li><code>Prometheus</code>：声明 Prometheus 资源对象期望的状态，Operator 确保这个资源对象运行时一直与定义保持一致。</li> <li><code>Prometheus Server</code>：Operator 根据自定义资源 Prometheus 类型中定义的内容而部署的 Prometheus Server 集群，这些自定义资源可以看作是用来管理 Prometheus Server 集群的 StatefulSets 资源。</li> <li><code>ServiceMonitor</code>：声明指定监控的服务，描述了一组被 Prometheus 监控的目标列表，就是 exporter 的抽象，用来提供 metrics 数据接口的工具。该资源通过 Labels 来选取对应的 Service Endpoint，让 Prometheus Server 通过选取的 Service 来获取 Metrics 信息。</li> <li><code>Service</code>：简单的说就是 Prometheus 监控的对象。</li> <li><code>Alertmanager</code>：定义 AlertManager 资源对象期望的状态，Operator 确保这个资源对象运行时一直与定义保持一致。</li></ul> <p>这样我们要在集群中监控什么数据，就变成了直接去操作 Kubernetes 集群的资源对象了，是不是方便很多了。</p> <h3 id="_1-2-安装"><a href="#_1-2-安装" class="header-anchor">#</a> 1.2 安装</h3> <p>我们可以使用 Helm 来快速安装 Prometheus Operator，也可以通过 <a href="https://github.com/coreos/kube-prometheus" target="_blank" rel="noopener noreferrer">https://github.com/coreos/kube-prometheus<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 项目来手动安装，我们这里采用手动安装的方式可以去了解更多的实现细节。</p> <p>首先 clone 项目代码：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master operator<span class="token punctuation">]</span><span class="token comment"># git clone https://github.com/coreos/kube-prometheus.git</span>
<span class="token punctuation">[</span>root@master operator<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">4</span>
drwxr-xr-x <span class="token number">12</span> root root <span class="token number">4096</span> Oct <span class="token number">14</span> 07:52 kube-prometheus
<span class="token punctuation">[</span>root@master operator<span class="token punctuation">]</span><span class="token comment"># cd kube-prometheus/</span>
<span class="token punctuation">[</span>root@master kube-prometheus<span class="token punctuation">]</span><span class="token comment"># cd manifests/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>进入到 <code>manifests</code> 目录下面，首先我们需要安装 <code>setup</code> 目录下面的 CRD 和 Operator 资源对象：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl create -f setup/      </span>
customresourcedefinition.apiextensions.k8s.io/alertmanagerconfigs.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/alertmanagers.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/podmonitors.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/probes.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/prometheuses.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/prometheusrules.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/servicemonitors.monitoring.coreos.com created
customresourcedefinition.apiextensions.k8s.io/thanosrulers.monitoring.coreos.com created
namespace/monitoring created
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl get ns</span>
NAME               STATUS   AGE
monitoring         Active   2m14s
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl get crd |grep coreos</span>
alertmanagerconfigs.monitoring.coreos.com             <span class="token number">2022</span>-10-14T15:23:48Z
alertmanagers.monitoring.coreos.com                   <span class="token number">2022</span>-10-14T15:23:48Z
podmonitors.monitoring.coreos.com                     <span class="token number">2022</span>-10-14T15:23:48Z
probes.monitoring.coreos.com                          <span class="token number">2022</span>-10-14T15:23:48Z
prometheuses.monitoring.coreos.com                    <span class="token number">2022</span>-10-14T15:23:48Z
prometheusrules.monitoring.coreos.com                 <span class="token number">2022</span>-10-14T15:23:48Z
servicemonitors.monitoring.coreos.com                 <span class="token number">2022</span>-10-14T15:23:48Z
thanosrulers.monitoring.coreos.com                    <span class="token number">2022</span>-10-14T15:23:49Z
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>这会创建一个名为 <code>monitoring</code> 的命名空间，以及相关的 CRD 资源对象声明。</p> <p>在 <code>manifests</code> 目录下面的就是我们要去创建的 Prometheus、Alertmanager 以及各种监控对象的资源清单。</p> <p>没有特殊的定制需求我们可以直接一键安装：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f .</span>
alertmanager.monitoring.coreos.com/main created
networkpolicy.networking.k8s.io/alertmanager-main created
poddisruptionbudget.policy/alertmanager-main created
prometheusrule.monitoring.coreos.com/alertmanager-main-rules created
secret/alertmanager-main created
service/alertmanager-main created
serviceaccount/alertmanager-main created
servicemonitor.monitoring.coreos.com/alertmanager-main created
clusterrole.rbac.authorization.k8s.io/blackbox-exporter created
clusterrolebinding.rbac.authorization.k8s.io/blackbox-exporter created
configmap/blackbox-exporter-configuration created
<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这会自动安装 node-exporter、kube-state-metrics、grafana、prometheus-adapter 以及 prometheus 和 alertmanager ,operator,blackbox_exporter 组件，而且 prometheus 和 alertmanager 还是多副本的。</p> <p>blackbox exporter 可以实现对 <code>http</code>，<code>https</code>，<code>tcp(可以实现服务器接口是否在线)</code>，<code>icmp(实现主机探活)</code>，<code>dns</code>的探测。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n monitoring</span>
NAME                                  READY   STATUS              RESTARTS   AGE
alertmanager-main-0                   <span class="token number">0</span>/2     ContainerCreating   <span class="token number">0</span>          24s
alertmanager-main-1                   <span class="token number">0</span>/2     ContainerCreating   <span class="token number">0</span>          24s
alertmanager-main-2                   <span class="token number">0</span>/2     ContainerCreating   <span class="token number">0</span>          24s
blackbox-exporter-c5547b8bb-5h5gb     <span class="token number">0</span>/3     ContainerCreating   <span class="token number">0</span>          37s
grafana-7c4645d965-ffzqg              <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          37s
kube-state-metrics-8658546b69-v728r   <span class="token number">0</span>/3     ContainerCreating   <span class="token number">0</span>          37s
node-exporter-62sm7                   <span class="token number">0</span>/2     ContainerCreating   <span class="token number">0</span>          36s
node-exporter-g57tr                   <span class="token number">2</span>/2     Running             <span class="token number">0</span>          36s
node-exporter-p5kqx                   <span class="token number">0</span>/2     ContainerCreating   <span class="token number">0</span>          36s
prometheus-adapter-678b454b8b-n4kz6   <span class="token number">0</span>/1     ErrImagePull        <span class="token number">0</span>          36s
prometheus-adapter-678b454b8b-t2w8r   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          36s
prometheus-k8s-0                      <span class="token number">0</span>/2     PodInitializing     <span class="token number">0</span>          23s
prometheus-k8s-1                      <span class="token number">0</span>/2     PodInitializing     <span class="token number">0</span>          23s
prometheus-operator-5ddfd64d6-87m7h   <span class="token number">0</span>/2     ContainerCreating   <span class="token number">0</span>          36s
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n monitoring</span>
NAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                      AGE
alertmanager-main       ClusterIP   <span class="token number">10.107</span>.154.95    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9093</span>/TCP,8080/TCP            2m7s
alertmanager-operated   ClusterIP   None             <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9093</span>/TCP,9094/TCP,9094/UDP   114s
blackbox-exporter       ClusterIP   <span class="token number">10.106</span>.242.209   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9115</span>/TCP,19115/TCP           2m7s
grafana                 ClusterIP   <span class="token number">10.103</span>.252.136   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">3000</span>/TCP                     2m7s
kube-state-metrics      ClusterIP   None             <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8443</span>/TCP,9443/TCP            2m7s
node-exporter           ClusterIP   None             <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9100</span>/TCP                     2m6s
prometheus-adapter      ClusterIP   <span class="token number">10.100</span>.17.155    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP                      2m6s
prometheus-k8s          ClusterIP   <span class="token number">10.111</span>.69.230    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9090</span>/TCP,8080/TCP            2m6s
prometheus-operated     ClusterIP   None             <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9090</span>/TCP                     114s
prometheus-operator     ClusterIP   None             <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8443</span>/TCP                     2m6s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>注意：有些服务启动会有问题，还是镜像翻墙问题，可以做一些修改</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl edit deploy kube-state-metrics -n monitoring</span>
image: bitnami/kube-state-metrics:2.6.0
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl edit deploy prometheus-adapter -n monitoring</span>
willdockerhub/prometheus-adapter:v0.9.1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到上面针对 grafana、alertmanager 和 prometheus 都创建了一个类型为 ClusterIP 的 Service，当然如果我们想要在外网访问这两个服务的话可以通过创建对应的 Ingress 对象或者使用 NodePort 类型的 Service，我们这里为了简单，直接使用 NodePort 类型的服务即可，编辑 grafana、alertmanager-main 和 prometheus-k8s 这3个 Service，将服务类型更改为 NodePort:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 将 type: ClusterIP 更改为 type: NodePort</span>
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl edit svc grafana -n monitoring </span>
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl edit svc alertmanager-main -n monitoring</span>
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl edit svc prometheus-k8s -n monitoring</span>
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n monitoring</span>
NAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                         AGE
alertmanager-main       NodePort    <span class="token number">10.107</span>.154.95    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9093</span>:30353/TCP,8080:30764/TCP   4m12s
alertmanager-operated   ClusterIP   None             <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9093</span>/TCP,9094/TCP,9094/UDP      3m59s
blackbox-exporter       ClusterIP   <span class="token number">10.106</span>.242.209   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9115</span>/TCP,19115/TCP              4m12s
grafana                 NodePort    <span class="token number">10.103</span>.252.136   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">3000</span>:30674/TCP                  4m12s
kube-state-metrics      ClusterIP   None             <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8443</span>/TCP,9443/TCP               4m12s
node-exporter           ClusterIP   None             <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9100</span>/TCP                        4m11s
prometheus-adapter      ClusterIP   <span class="token number">10.100</span>.17.155    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP                         4m11s
prometheus-k8s          NodePort    <span class="token number">10.111</span>.69.230    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9090</span>:32687/TCP,8080:31305/TCP   4m11s
prometheus-operated     ClusterIP   None             <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9090</span>/TCP                        3m59s
prometheus-operator     ClusterIP   None             <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8443</span>/TCP                        4m11s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>更改完成后，我们就可以通过上面的 NodePort 去访问对应的服务了，比如查看 prometheus 的服务发现页面：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 网络策略相关的 删除 影响访问</span>
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f prometheus-networkPolicy.yaml </span>
networkpolicy.networking.k8s.io <span class="token string">&quot;prometheus-k8s&quot;</span> deleted
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f grafana-networkPolicy.yaml </span>
networkpolicy.networking.k8s.io <span class="token string">&quot;grafana&quot;</span> deleted
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f alertmanager-networkPolicy.yaml </span>
networkpolicy.networking.k8s.io <span class="token string">&quot;alertmanager-main&quot;</span> deleted
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="img/image-20221015003129965.png" alt="image-20221015003129965"></p> <p>可以看到已经监控上了很多指标数据了，上面我们可以看到 Prometheus 是两个副本，我们这里通过 Service 去访问， Service 在创建的时候添加了 <code>sessionAffinity: ClientIP</code> 这样的属性，会根据 <code>ClientIP</code> 来做 session 亲和性，所以我们不用担心请求会到不同的副本上去：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> prometheus
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> k8s
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> prometheus
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.39.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> web
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9090</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> web
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> reloader<span class="token punctuation">-</span>web
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> reloader<span class="token punctuation">-</span>web
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> prometheus
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> k8s
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> prometheus
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> ClientIP
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="_1-3-配置"><a href="#_1-3-配置" class="header-anchor">#</a> 1.3 配置</h3> <p><img src="img/image-20221015004147227.png" alt="image-20221015004147227"></p> <p>在监控中我们并没有发现kube-scheduler和KubeControllerManager的监控</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># cat kubernetesControlPlane-serviceMonitorKubeScheduler.yaml</span>
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/name: kube-scheduler
    app.kubernetes.io/part-of: kube-prometheus
  name: kube-scheduler
  namespace: monitoring
spec:
  endpoints:
  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    interval: 30s
    port: https-metrics
    scheme: https
    tlsConfig:
      insecureSkipVerify: <span class="token boolean">true</span>
  jobLabel: app.kubernetes.io/name
  namespaceSelector:
    matchNames:
    - kube-system
  selector:
    matchLabels:
      app.kubernetes.io/name: kube-scheduler
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>我们需要去创建一个对应的 Service 对象,和上方的 <code>ServiceMonitor</code> 进行关联：(prometheus-kubeSchedulerService.yaml)</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">component</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>scheduler
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>metrics
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10259</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">10259</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>其中最重要的是上面 labels 和 selector 部分，labels 区域的配置必须和我们上面的 ServiceMonitor 对象中的 selector 保持一致，selector 下面配置的是 <code>component=kube-scheduler</code>，为什么会是这个 label 标签呢，我们可以去 describe 下 kube-scheduler 这个 Pod：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod kube-scheduler-master -n kube-system  </span>
Name:                 kube-scheduler-master
Namespace:            kube-system
Priority:             <span class="token number">2000001000</span>
Priority Class Name:  system-node-critical
Node:                 master/192.168.200.101
Start Time:           Fri, <span class="token number">14</span> Oct <span class="token number">2022</span> <span class="token number">12</span>:09:42 <span class="token parameter variable">-0400</span>
Labels:               <span class="token assign-left variable">component</span><span class="token operator">=</span>kube-scheduler
                      <span class="token assign-left variable">tier</span><span class="token operator">=</span>control-plane
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>我们可以看到这个 Pod 具有 <code>component=kube-scheduler</code> 和 <code>tier=control-plane</code> 这两个标签，而前面这个标签具有更唯一的特性，所以使用前面这个标签较好，这样上面创建的 Service 就可以和我们的 Pod 进行关联了，直接创建即可：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f prometheus-kubeSchedulerService.yaml </span>
service/kube-scheduler created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>kube-scheduler使用了--secure-port绑定到127.0.0.1而不是0.0.0.0，所以会出现连接不上的情况，还需要修改：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># vim /etc/kubernetes/manifests/kube-scheduler.yaml </span>
- --bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>创建完成后，隔一小会儿后去 Prometheus 页面上查看 targets 下面 kube-scheduler 已经可以采集到指标数据了。</p> <p><img src="img/image-20221015010454869.png" alt="image-20221015010454869"></p> <p>可以用同样的方式来修复下 kube-controller-manager 组件的监控。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># cat kubernetesControlPlane-serviceMonitorKubeControllerManager.yaml </span>
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/name: kube-controller-manager
    app.kubernetes.io/part-of: kube-prometheus
  name: kube-controller-manager
  namespace: monitoring
spec:
  endpoints:
  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    interval: 30s
    metricRelabelings:
    - action: drop
      regex: kubelet_<span class="token punctuation">(</span>pod_worker_latency_microseconds<span class="token operator">|</span>pod_start_latency_microseconds<span class="token operator">|</span>cgroup_manager_latency_microseconds<span class="token operator">|</span>pod_worker_start_latency_microseconds<span class="token operator">|</span>pleg_relist_latency_microseconds<span class="token operator">|</span>pleg_relist_interval_microseconds<span class="token operator">|</span>runtime_operations<span class="token operator">|</span>runtime_operations_latency_microseconds<span class="token operator">|</span>runtime_operations_errors<span class="token operator">|</span>eviction_stats_age_microseconds<span class="token operator">|</span>device_plugin_registration_count<span class="token operator">|</span>device_plugin_alloc_latency_microseconds<span class="token operator">|</span>network_plugin_operations_latency_microseconds<span class="token punctuation">)</span>
      sourceLabels:
      - __name__
    - action: drop
      regex: scheduler_<span class="token punctuation">(</span>e2e_scheduling_latency_microseconds<span class="token operator">|</span>scheduling_algorithm_predicate_evaluation<span class="token operator">|</span>scheduling_algorithm_priority_evaluation<span class="token operator">|</span>scheduling_algorithm_preemption_evaluation<span class="token operator">|</span>scheduling_algorithm_latency_microseconds<span class="token operator">|</span>binding_latency_microseconds<span class="token operator">|</span>scheduling_latency_seconds<span class="token punctuation">)</span>
      sourceLabels:
      - __name__
    - action: drop
      regex: apiserver_<span class="token punctuation">(</span>request_count<span class="token operator">|</span>request_latencies<span class="token operator">|</span>request_latencies_summary<span class="token operator">|</span>dropped_requests<span class="token operator">|</span>storage_data_key_generation_latencies_microseconds<span class="token operator">|</span>storage_transformation_failures_total<span class="token operator">|</span>storage_transformation_latencies_microseconds<span class="token operator">|</span>proxy_tunnel_sync_latency_secs<span class="token operator">|</span>longrunning_gauge<span class="token operator">|</span>registered_watchers<span class="token punctuation">)</span>
      sourceLabels:
      - __name__
    - action: drop
      regex: kubelet_docker_<span class="token punctuation">(</span>operations<span class="token operator">|</span>operations_latency_microseconds<span class="token operator">|</span>operations_errors<span class="token operator">|</span>operations_timeout<span class="token punctuation">)</span>
      sourceLabels:
      - __name__
    - action: drop
      regex: reflector_<span class="token punctuation">(</span>items_per_list<span class="token operator">|</span>items_per_watch<span class="token operator">|</span>list_duration_seconds<span class="token operator">|</span>lists_total<span class="token operator">|</span>short_watches_total<span class="token operator">|</span>watch_duration_seconds<span class="token operator">|</span>watches_total<span class="token punctuation">)</span>
      sourceLabels:
      - __name__
    - action: drop
      regex: etcd_<span class="token punctuation">(</span>helper_cache_hit_count<span class="token operator">|</span>helper_cache_miss_count<span class="token operator">|</span>helper_cache_entry_count<span class="token operator">|</span>object_counts<span class="token operator">|</span>request_cache_get_latencies_summary<span class="token operator">|</span>request_cache_add_latencies_summary<span class="token operator">|</span>request_latencies_summary<span class="token punctuation">)</span>
      sourceLabels:
      - __name__
    - action: drop
      regex: transformation_<span class="token punctuation">(</span>transformation_latencies_microseconds<span class="token operator">|</span>failures_total<span class="token punctuation">)</span>
      sourceLabels:
      - __name__
    - action: drop
      regex: <span class="token punctuation">(</span>admission_quota_controller_adds<span class="token operator">|</span>admission_quota_controller_depth<span class="token operator">|</span>admission_quota_controller_longest_running_processor_microseconds<span class="token operator">|</span>admission_quota_controller_queue_latency<span class="token operator">|</span>admission_quota_controller_unfinished_work_seconds<span class="token operator">|</span>admission_quota_controller_work_duration<span class="token operator">|</span>APIServiceOpenAPIAggregationControllerQueue1_adds<span class="token operator">|</span>APIServiceOpenAPIAggregationControllerQueue1_depth<span class="token operator">|</span>APIServiceOpenAPIAggregationControllerQueue1_longest_running_processor_microseconds<span class="token operator">|</span>APIServiceOpenAPIAggregationControllerQueue1_queue_latency<span class="token operator">|</span>APIServiceOpenAPIAggregationControllerQueue1_retries<span class="token operator">|</span>APIServiceOpenAPIAggregationControllerQueue1_unfinished_work_seconds<span class="token operator">|</span>APIServiceOpenAPIAggregationControllerQueue1_work_duration<span class="token operator">|</span>APIServiceRegistrationController_adds<span class="token operator">|</span>APIServiceRegistrationController_depth<span class="token operator">|</span>APIServiceRegistrationController_longest_running_processor_microseconds<span class="token operator">|</span>APIServiceRegistrationController_queue_latency<span class="token operator">|</span>APIServiceRegistrationController_retries<span class="token operator">|</span>APIServiceRegistrationController_unfinished_work_seconds<span class="token operator">|</span>APIServiceRegistrationController_work_duration<span class="token operator">|</span>autoregister_adds<span class="token operator">|</span>autoregister_depth<span class="token operator">|</span>autoregister_longest_running_processor_microseconds<span class="token operator">|</span>autoregister_queue_latency<span class="token operator">|</span>autoregister_retries<span class="token operator">|</span>autoregister_unfinished_work_seconds<span class="token operator">|</span>autoregister_work_duration<span class="token operator">|</span>AvailableConditionController_adds<span class="token operator">|</span>AvailableConditionController_depth<span class="token operator">|</span>AvailableConditionController_longest_running_processor_microseconds<span class="token operator">|</span>AvailableConditionController_queue_latency<span class="token operator">|</span>AvailableConditionController_retries<span class="token operator">|</span>AvailableConditionController_unfinished_work_seconds<span class="token operator">|</span>AvailableConditionController_work_duration<span class="token operator">|</span>crd_autoregistration_controller_adds<span class="token operator">|</span>crd_autoregistration_controller_depth<span class="token operator">|</span>crd_autoregistration_controller_longest_running_processor_microseconds<span class="token operator">|</span>crd_autoregistration_controller_queue_latency<span class="token operator">|</span>crd_autoregistration_controller_retries<span class="token operator">|</span>crd_autoregistration_controller_unfinished_work_seconds<span class="token operator">|</span>crd_autoregistration_controller_work_duration<span class="token operator">|</span>crdEstablishing_adds<span class="token operator">|</span>crdEstablishing_depth<span class="token operator">|</span>crdEstablishing_longest_running_processor_microseconds<span class="token operator">|</span>crdEstablishing_queue_latency<span class="token operator">|</span>crdEstablishing_retries<span class="token operator">|</span>crdEstablishing_unfinished_work_seconds<span class="token operator">|</span>crdEstablishing_work_duration<span class="token operator">|</span>crd_finalizer_adds<span class="token operator">|</span>crd_finalizer_depth<span class="token operator">|</span>crd_finalizer_longest_running_processor_microseconds<span class="token operator">|</span>crd_finalizer_queue_latency<span class="token operator">|</span>crd_finalizer_retries<span class="token operator">|</span>crd_finalizer_unfinished_work_seconds<span class="token operator">|</span>crd_finalizer_work_duration<span class="token operator">|</span>crd_naming_condition_controller_adds<span class="token operator">|</span>crd_naming_condition_controller_depth<span class="token operator">|</span>crd_naming_condition_controller_longest_running_processor_microseconds<span class="token operator">|</span>crd_naming_condition_controller_queue_latency<span class="token operator">|</span>crd_naming_condition_controller_retries<span class="token operator">|</span>crd_naming_condition_controller_unfinished_work_seconds<span class="token operator">|</span>crd_naming_condition_controller_work_duration<span class="token operator">|</span>crd_openapi_controller_adds<span class="token operator">|</span>crd_openapi_controller_depth<span class="token operator">|</span>crd_openapi_controller_longest_running_processor_microseconds<span class="token operator">|</span>crd_openapi_controller_queue_latency<span class="token operator">|</span>crd_openapi_controller_retries<span class="token operator">|</span>crd_openapi_controller_unfinished_work_seconds<span class="token operator">|</span>crd_openapi_controller_work_duration<span class="token operator">|</span>DiscoveryController_adds<span class="token operator">|</span>DiscoveryController_depth<span class="token operator">|</span>DiscoveryController_longest_running_processor_microseconds<span class="token operator">|</span>DiscoveryController_queue_latency<span class="token operator">|</span>DiscoveryController_retries<span class="token operator">|</span>DiscoveryController_unfinished_work_seconds<span class="token operator">|</span>DiscoveryController_work_duration<span class="token operator">|</span>kubeproxy_sync_proxy_rules_latency_microseconds<span class="token operator">|</span>non_structural_schema_condition_controller_adds<span class="token operator">|</span>non_structural_schema_condition_controller_depth<span class="token operator">|</span>non_structural_schema_condition_controller_longest_running_processor_microseconds<span class="token operator">|</span>non_structural_schema_condition_controller_queue_latency<span class="token operator">|</span>non_structural_schema_condition_controller_retries<span class="token operator">|</span>non_structural_schema_condition_controller_unfinished_work_seconds<span class="token operator">|</span>non_structural_schema_condition_controller_work_duration<span class="token operator">|</span>rest_client_request_latency_seconds<span class="token operator">|</span>storage_operation_errors_total<span class="token operator">|</span>storage_operation_status_count<span class="token punctuation">)</span>
      sourceLabels:
      - __name__
    - action: drop
      regex: etcd_<span class="token punctuation">(</span>debugging<span class="token operator">|</span>disk<span class="token operator">|</span>request<span class="token operator">|</span>server<span class="token punctuation">)</span>.*
      sourceLabels:
      - __name__
    port: https-metrics
    scheme: https
    tlsConfig:
      insecureSkipVerify: <span class="token boolean">true</span>
  jobLabel: app.kubernetes.io/name
  namespaceSelector:
    matchNames:
    - kube-system
  selector:
    matchLabels:
      app.kubernetes.io/name: kube-controller-manager
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>创建一个如下所示的 Service 对象：(prometheus-kubeControllerManagerService.yaml)</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">component</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https<span class="token punctuation">-</span>metrics
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10257</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">10257</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># vim /etc/kubernetes/manifests/kube-controller-manager.yaml</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="img/image-20221015010906225.png" alt="image-20221015010906225"></p> <p>上面的监控数据配置完成后，我们就可以去查看下 Grafana 下面的监控图表了，同样使用上面的 NodePort 访问即可，第一次登录使用 <code>admin:admin</code> 登录即可，进入首页后，我们可以发现其实 Grafana 已经有很多配置好的监控图表了。</p> <p><img src="img/image-20221015011011305.png" alt="image-20221015011011305"></p> <p>我们可以随便选择一个 Dashboard 查看监控图表信息。</p> <p><img src="img/image-20221015011039793.png" alt="image-20221015011039793"></p> <p>接下来我们再来学习如何完全自定义一个 <code>ServiceMonitor</code> 以及 AlertManager 相关的配置</p> <h2 id="_2-自定义监控报警"><a href="#_2-自定义监控报警" class="header-anchor">#</a> 2. 自定义监控报警</h2> <p>除了 Kubernetes 集群中的一些资源对象、节点以及组件需要监控，有的时候我们可能还需要根据实际的业务需求去添加自定义的监控项，添加一个自定义监控的步骤也是非常简单的。</p> <ul><li>第一步建立一个 ServiceMonitor 对象，用于 Prometheus 添加监控项</li> <li>第二步为 ServiceMonitor 对象关联 metrics 数据接口的一个 Service 对象</li> <li>第三步确保 Service 对象可以正确获取到 metrics 数据</li></ul> <p>接下来我们就来为大家演示如何添加 <code>etcd</code> 集群的监控。无论是 Kubernetes 集群外的还是使用 Kubeadm 安装在集群内部的 etcd 集群，我们这里都将其视作集群外的独立集群，因为对于二者的使用方法没什么特殊之处。</p> <h3 id="_2-1-etcd-监控"><a href="#_2-1-etcd-监控" class="header-anchor">#</a> 2.1 etcd 监控</h3> <p>由于我们这里的环境使用的是 Kubeadm 搭建的集群，我们可以使用 kubectl 工具去获取 etcd 启动的相关参数：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n kube-system -l component=etcd</span>
NAME          READY   STATUS    RESTARTS       AGE
etcd-master   <span class="token number">1</span>/1     Running   <span class="token number">17</span> <span class="token punctuation">(</span>61m ago<span class="token punctuation">)</span>   21d
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl get pods etcd-master -n kube-system -o yaml</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
spec:
  containers:
  - command:
    - etcd
    - --advertise-client-urls<span class="token operator">=</span>https://192.168.200.101:2379
    - --cert-file<span class="token operator">=</span>/etc/kubernetes/pki/etcd/server.crt
    - --client-cert-auth<span class="token operator">=</span>true
    - --data-dir<span class="token operator">=</span>/var/lib/etcd
    - --experimental-initial-corrupt-check<span class="token operator">=</span>true
    - --initial-advertise-peer-urls<span class="token operator">=</span>https://192.168.200.101:2380
    - --initial-cluster<span class="token operator">=</span>master<span class="token operator">=</span>https://192.168.200.101:2380
    - --key-file<span class="token operator">=</span>/etc/kubernetes/pki/etcd/server.key
    - --listen-client-urls<span class="token operator">=</span>https://127.0.0.1:2379,https://192.168.200.101:2379
    - --listen-metrics-urls<span class="token operator">=</span>http://127.0.0.1:2381
    - --listen-peer-urls<span class="token operator">=</span>https://192.168.200.101:2380
    - <span class="token parameter variable">--name</span><span class="token operator">=</span>master
    - --peer-cert-file<span class="token operator">=</span>/etc/kubernetes/pki/etcd/peer.crt
    - --peer-client-cert-auth<span class="token operator">=</span>true
    - --peer-key-file<span class="token operator">=</span>/etc/kubernetes/pki/etcd/peer.key
    - --peer-trusted-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/etcd/ca.crt
    - --snapshot-count<span class="token operator">=</span><span class="token number">10000</span>
    - --trusted-ca-file<span class="token operator">=</span>/etc/kubernetes/pki/etcd/ca.crt
    image: registry.aliyuncs.com/google_containers/etcd:3.5.3-0
    imagePullPolicy: IfNotPresent
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
    volumeMounts:
    - mountPath: /var/lib/etcd
      name: etcd-data
    - mountPath: /etc/kubernetes/pki/etcd
      name: etcd-certs
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
  volumes:
  - hostPath:
      path: /etc/kubernetes/pki/etcd
      type: DirectoryOrCreate
    name: etcd-certs
  - hostPath:
      path: /var/lib/etcd
      type: DirectoryOrCreate
    name: etcd-data
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>我们可以看到启动参数里面有一个 <code>--listen-metrics-urls=http://127.0.0.1:2381</code> 的配置，该参数就是来指定 metrics 接口运行在 2381 端口下面的，而且是 http 的协议，所以也不需要什么证书配置。</p> <p>接下来我们直接创建对应的 ServiceMonitor 对象即可（prometheus-serviceMonitorEtcd.yaml）:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceMonitor
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>k8s
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>k8s
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">jobLabel</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>app
  <span class="token key atrule">endpoints</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> port
    <span class="token key atrule">interval</span><span class="token punctuation">:</span> 15s
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> etcd
  <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchNames</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> kube<span class="token punctuation">-</span>system
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>上面我们在 monitoring 命名空间下面创建了名为 etcd-k8s 的 ServiceMonitor 对象，匹配 kube-system 这个命名空间下面的具有 <code>k8s-app=etcd</code> 这个 label 标签的 Service，<code>jobLabel</code> 表示用于检索 job 任务名称的标签，由于 etcd 的 metrics 接口在 2381 端口下面，不需要 https 安全认证，所以用默认的配置即可。关于 ServiceMonitor 更多的配置属性，可以参考<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#servicemonitorspec" target="_blank" rel="noopener noreferrer">官方的 API 文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的描述。</p> <p>然后我们直接创建这个 ServiceMonitor 对象即可：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f prometheus-serviceMonitorEtcd.yaml</span>
servicemonitor.monitoring.coreos.com/etcd-k8s created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>但实际上现在并不能监控到 etcd 集群，因为并没有一个满足 ServiceMonitor 条件的 Service 对象与之关联：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n kube-system -l k8s-app=etcd</span>
No resources found <span class="token keyword">in</span> kube-system namespace.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>所以接下来我们需要创建一个满足上面条件的 Service 对象，由于我们把 etcd 当成是集群外部的服务，所以要引入到集群中来我们就需要自定义 Endpoints 对象来创建 Service 对象了：(etcd-service.yaml)</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>k8s
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> etcd
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token comment"># 一定要设置 clusterIP:None</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> port
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2381</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoints
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>k8s
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> etcd
<span class="token key atrule">subsets</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 192.168.200.101  <span class="token comment"># 指定etcd节点地址，如果是集群则继续向下添加</span>
    <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> etc<span class="token punctuation">-</span>master
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> port
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2381</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>我们这里创建的 Service 没有采用前面通过 label 标签的形式去匹配 Pod 的做法，因为前面我们说过很多时候我们创建的 etcd 集群是独立于集群之外的，这种情况下面我们就需要自定义一个 Endpoints，要注意 <code>metadata</code> 区域的内容要和 Service 保持一致，Service 的 clusterIP 设置为 None，新版本的 etcd 将 metrics 接口数据放置到了 2381 端口。直接创建该资源对象即可：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f etcd-service.yaml</span>
service/etcd-k8s created
endpoints/etcd-k8s created
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n kube-system -l k8s-app=etcd</span>
NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
etcd-k8s   ClusterIP   None         <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">2381</span>/TCP   4s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>创建完成后，隔一会儿去 Prometheus 的 Dashboard 中查看 targets，便会有 etcd 的监控项了：</p> <p><img src="img/image-20221015011731793.png" alt="image-20221015011731793"></p> <p>可以看到有一个明显的错误，2381 端口链接被拒绝，这是因为我们这里的 etcd 的 metrics 接口是监听在 <code>127.0.0.1</code> 这个 IP 上面的，所以访问会拒绝：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>--listen-metrics-urls<span class="token operator">=</span>http://127.0.0.1:2381
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们只需要在 <code>/etc/kubernetes/manifest/</code> 目录下面（静态 Pod 默认的目录）的 <code>etcd.yaml</code> 文件中将上面的<code>listen-metrics-urls</code> 更改成节点 IP 即可：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>--listen-metrics-urls<span class="token operator">=</span>http://0.0.0.0:2381
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当 etcd 重启生效后，查看 etcd 这个监控任务就正常了：</p> <p><img src="img/image-20221015012432377.png" alt="image-20221015012432377"></p> <p>数据采集到后，可以在 grafana 中导入编号为 <code>10323</code> 的 dashboard，就可以获取到 etcd 的监控图表：</p> <p><img src="img/image-20221015013007713.png" alt="image-20221015013007713"></p> <h3 id="_2-2-配置-prometheusrule"><a href="#_2-2-配置-prometheusrule" class="header-anchor">#</a> 2.2 配置 PrometheusRule</h3> <p>现在我们知道怎么自定义一个 <code>ServiceMonitor</code> 对象了，但是如果需要自定义一个报警规则的话呢？我们去查看 Prometheus Dashboard 的 Alert 页面下面就已经有很多报警规则了，这一系列的规则其实都来自于项目 https://github.com/kubernetes-monitoring/kubernetes-mixin，我们都通过 Prometheus Operator 安装配置上了。</p> <p>但是这些报警信息是哪里来的呢？他们应该用怎样的方式通知我们呢？我们知道之前我们使用自定义的方式可以在 Prometheus 的配置文件之中指定 AlertManager 实例和 报警的 rules 文件，现在我们通过 Operator 部署的呢？我们可以在 Prometheus Dashboard 的 Config 页面下面查看关于 AlertManager 的配置：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">alerting</span><span class="token punctuation">:</span>
  <span class="token key atrule">alert_relabel_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">separator</span><span class="token punctuation">:</span> ;
    <span class="token key atrule">regex</span><span class="token punctuation">:</span> prometheus_replica
    <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1
    <span class="token key atrule">action</span><span class="token punctuation">:</span> labeldrop
  <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">follow_redirects</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">enable_http2</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">scheme</span><span class="token punctuation">:</span> http
    <span class="token key atrule">path_prefix</span><span class="token punctuation">:</span> /
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 10s
    <span class="token key atrule">api_version</span><span class="token punctuation">:</span> v2
    <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_name<span class="token punctuation">]</span>
      <span class="token key atrule">separator</span><span class="token punctuation">:</span> ;
      <span class="token key atrule">regex</span><span class="token punctuation">:</span> alertmanager<span class="token punctuation">-</span>main
      <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1
      <span class="token key atrule">action</span><span class="token punctuation">:</span> keep
    <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_endpoint_port_name<span class="token punctuation">]</span>
      <span class="token key atrule">separator</span><span class="token punctuation">:</span> ;
      <span class="token key atrule">regex</span><span class="token punctuation">:</span> web
      <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1
      <span class="token key atrule">action</span><span class="token punctuation">:</span> keep
    <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> endpoints
      <span class="token key atrule">kubeconfig_file</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
      <span class="token key atrule">follow_redirects</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">enable_http2</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">namespaces</span><span class="token punctuation">:</span>
        <span class="token key atrule">own_namespace</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
        <span class="token key atrule">names</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> monitoring
<span class="token key atrule">rule_files</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> /etc/prometheus/rules/prometheus<span class="token punctuation">-</span>k8s<span class="token punctuation">-</span>rulefiles<span class="token punctuation">-</span>0/<span class="token important">*.yaml</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>上面 <code>alertmanagers</code> 的配置我们可以看到是通过 role 为 <code>endpoints</code> 的 kubernetes 的自动发现机制获取的，匹配的是服务名为 <code>alertmanager-main</code>，端口名为 web 的 Service 服务，我们可以查看下 alertmanager-main 这个 Service：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl describe svc alertmanager-main -n monitoring</span>
Name:                     alertmanager-main
Namespace:                monitoring
Labels:                   app.kubernetes.io/component<span class="token operator">=</span>alert-router
                          app.kubernetes.io/instance<span class="token operator">=</span>main
                          app.kubernetes.io/name<span class="token operator">=</span>alertmanager
                          app.kubernetes.io/part-of<span class="token operator">=</span>kube-prometheus
                          app.kubernetes.io/version<span class="token operator">=</span><span class="token number">0.24</span>.0
Annotations:              <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
Selector:                 app.kubernetes.io/component<span class="token operator">=</span>alert-router,app.kubernetes.io/instance<span class="token operator">=</span>main,app.kubernetes.io/name<span class="token operator">=</span>alertmanager,app.kubernetes.io/part-of<span class="token operator">=</span>kube-prometheus
Type:                     NodePort
IP Family Policy:         SingleStack
IP Families:              IPv4
IP:                       <span class="token number">10.101</span>.111.78
IPs:                      <span class="token number">10.101</span>.111.78
Port:                     web  <span class="token number">9093</span>/TCP
TargetPort:               web/TCP
NodePort:                 web  <span class="token number">31999</span>/TCP
Endpoints:                <span class="token number">10.244</span>.104.29:9093,10.244.166.148:9093,10.244.166.150:9093
Port:                     reloader-web  <span class="token number">8080</span>/TCP
TargetPort:               reloader-web/TCP
NodePort:                 reloader-web  <span class="token number">32208</span>/TCP
Endpoints:                <span class="token number">10.244</span>.104.29:8080,10.244.166.148:8080,10.244.166.150:8080
Session Affinity:         ClientIP
External Traffic Policy:  Cluster
Events:                   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>可以看到服务名正是 <code>alertmanager-main</code>，Port 定义的名称也是 <code>web</code>，符合上面的规则，所以 Prometheus 和 AlertManager 组件就正确关联上了。而对应的报警规则文件位于：<code>/etc/prometheus/rules/prometheus-k8s-rulefiles-0/</code>目录下面所有的 YAML 文件。我们可以进入 Prometheus 的 Pod 中验证下该目录下面是否有 YAML 文件：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it prometheus-k8s-0  -n monitoring -- /bin/sh</span>
/prometheus $ <span class="token function">ls</span> /etc/prometheus/rules/prometheus-k8s-rulefiles-0/
monitoring-alertmanager-main-rules-65684fa0-2ac2-44cb-8285-c600ef0337d9.yaml
monitoring-grafana-rules-94dbedc4-7498-4acb-942d-aac98fd61a0d.yaml
monitoring-kube-prometheus-rules-00aef2e2-2f47-4274-9c64-80e786f52959.yaml
monitoring-kube-state-metrics-rules-570164d9-a73a-4103-b1ca-32d2a0870ac1.yaml
monitoring-kubernetes-monitoring-rules-e6ac08d1-8378-4de7-add7-93532af0690f.yaml
monitoring-node-exporter-rules-5ebbb7d5-2e8b-44b7-bf88-b7de3916ac1e.yaml
monitoring-prometheus-k8s-prometheus-rules-26d84cbb-baf7-4654-b00d-05f66b4ddef0.yaml
monitoring-prometheus-operator-rules-cf0a2d8b-f9c8-48ff-87f2-664a1f95a34f.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># cat prometheus-prometheusRule.yaml </span>
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    app.kubernetes.io/component: prometheus
    app.kubernetes.io/instance: k8s
    app.kubernetes.io/name: prometheus
    app.kubernetes.io/part-of: kube-prometheus
    app.kubernetes.io/version: <span class="token number">2.39</span>.1
    prometheus: k8s
    role: alert-rules
  name: prometheus-k8s-prometheus-rules
  namespace: monitoring
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>我们这里的 <code>PrometheusRule</code> 的 name 为 <code>prometheus-k8s-prometheus-rules</code>，namespace 为 <code>monitoring</code>，我们可以猜想到我们创建一个 PrometheusRule 资源对象后，会自动在上面的 <code>prometheus-k8s-rulefiles-0</code> 目录下面生成一个对应的 <code>&lt;namespace&gt;-&lt;name&gt;.yaml</code> 文件，所以如果以后我们需要自定义一个报警选项的话，只需要定义一个 <code>PrometheusRule</code> 资源对象即可。至于为什么 Prometheus 能够识别这个 PrometheusRule 资源对象呢？只要具有 <code>prometheus=k8s</code> 和 <code>role=alert-rules</code> 标签的 <code>PrometheusRule</code> 资源对象，就能够被识别。</p> <p>所以我们要想自定义一个报警规则，只需要创建一个具有 <code>prometheus=k8s</code> 和 <code>role=alert-rules</code> 标签的 <code>PrometheusRule</code> 对象就行了，比如现在我们添加一个 etcd 是否可用的报警，我们知道 etcd 整个集群有一半以上的节点可用的话集群就是可用的，所以我们判断如果不可用的 etcd 数量超过了一半那么就触发报警，创建文件 <code>prometheus-etcdRules.yaml</code>：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PrometheusRule
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">prometheus</span><span class="token punctuation">:</span> k8s
    <span class="token key atrule">role</span><span class="token punctuation">:</span> alert<span class="token punctuation">-</span>rules
  <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>rules
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">groups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd
    <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">alert</span><span class="token punctuation">:</span> EtcdClusterUnavailable
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token key atrule">summary</span><span class="token punctuation">:</span> etcd cluster small
        <span class="token key atrule">description</span><span class="token punctuation">:</span> If one more etcd peer goes down the cluster will be unavailable
      <span class="token key atrule">expr</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        count(up{job=&quot;etcd&quot;} == 0) &gt; (count(up{job=&quot;etcd&quot;}) / 2 - 1)</span>
      <span class="token key atrule">for</span><span class="token punctuation">:</span> 3m
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">severity</span><span class="token punctuation">:</span> critical
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>注意 label 标签一定至少要有 <code>prometheus=k8s</code> 和 <code>role=alert-rules</code>，创建完成后，隔一会儿再去容器中查看下 rules 文件夹：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f prometheus-etcdRules.yaml</span>
prometheusrule.monitoring.coreos.com/etcd-rules created
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it prometheus-k8s-0 -n monitoring -- /bin/sh</span>
/prometheus $ <span class="token function">ls</span> /etc/prometheus/rules/prometheus-k8s-rulefiles-0/
monitoring-alertmanager-main-rules-65684fa0-2ac2-44cb-8285-c600ef0337d9.yaml
monitoring-etcd-rules-e3dfc19b-5c7e-4671-b899-024400697208.yaml
monitoring-grafana-rules-94dbedc4-7498-4acb-942d-aac98fd61a0d.yaml
monitoring-kube-prometheus-rules-00aef2e2-2f47-4274-9c64-80e786f52959.yaml
monitoring-kube-state-metrics-rules-570164d9-a73a-4103-b1ca-32d2a0870ac1.yaml
monitoring-kubernetes-monitoring-rules-e6ac08d1-8378-4de7-add7-93532af0690f.yaml
monitoring-node-exporter-rules-5ebbb7d5-2e8b-44b7-bf88-b7de3916ac1e.yaml
monitoring-prometheus-k8s-prometheus-rules-26d84cbb-baf7-4654-b00d-05f66b4ddef0.yaml
monitoring-prometheus-operator-rules-cf0a2d8b-f9c8-48ff-87f2-664a1f95a34f.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>可以看到我们创建的 rule 文件已经被注入到了对应的 <code>rulefiles</code> 文件夹下面了，证明我们上面的设想是正确的。然后再去 Prometheus Dashboard 的 Alert 页面下面就可以查看到上面我们新建的报警规则了：</p> <p><img src="img/image-20221015015420837.png" alt="image-20221015015420837"></p> <h3 id="_2-3-配置报警"><a href="#_2-3-配置报警" class="header-anchor">#</a> 2.3 配置报警</h3> <p>我们知道了如何去添加一个报警规则配置项，但是这些报警信息用怎样的方式去发送呢？前面的课程中我们知道我们可以通过 AlertManager 的配置文件去配置各种报警接收器，现在我们是通过 Operator 提供的 alertmanager 资源对象创建的组件，应该怎样去修改配置呢？</p> <p>首先我们去 Alertmanager 的页面上 <code>status</code> 路径下面查看 AlertManager 的配置信息:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl get svc -n monitoring</span>
NAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                         AGE
alertmanager-main       NodePort    <span class="token number">10.101</span>.111.78    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">9093</span>:31999/TCP,8080:32208/TCP   94m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="img/image-20221015015553181.png" alt="image-20221015015553181"></p> <p>这些配置信息实际上是来自于前面创建的 <code>alertmanager-secret.yaml</code> 文件：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># cat alertmanager-secret.yaml </span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> alert<span class="token punctuation">-</span>router
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> main
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> alertmanager
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 0.24.0
  <span class="token key atrule">name</span><span class="token punctuation">:</span> alertmanager<span class="token punctuation">-</span>main
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">stringData</span><span class="token punctuation">:</span>
  <span class="token key atrule">alertmanager.yaml</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    <span class="token key atrule">&quot;global&quot;</span><span class="token punctuation">:</span>
      <span class="token key atrule">&quot;resolve_timeout&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;5m&quot;</span>
    <span class="token key atrule">&quot;inhibit_rules&quot;</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">&quot;equal&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;namespace&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;alertname&quot;</span>
      <span class="token key atrule">&quot;source_matchers&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;severity = critical&quot;</span>
      <span class="token key atrule">&quot;target_matchers&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;severity =~ warning|info&quot;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">&quot;equal&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;namespace&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;alertname&quot;</span>
      <span class="token key atrule">&quot;source_matchers&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;severity = warning&quot;</span>
      <span class="token key atrule">&quot;target_matchers&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;severity = info&quot;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">&quot;equal&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;namespace&quot;</span>
      <span class="token key atrule">&quot;source_matchers&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;alertname = InfoInhibitor&quot;</span>
      <span class="token key atrule">&quot;target_matchers&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;severity = info&quot;</span>
    <span class="token key atrule">&quot;receivers&quot;</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Default&quot;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Watchdog&quot;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Critical&quot;</span>
    <span class="token punctuation">-</span> <span class="token key atrule">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;null&quot;</span>
    <span class="token key atrule">&quot;route&quot;</span><span class="token punctuation">:</span>
      <span class="token key atrule">&quot;group_by&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;namespace&quot;</span>
      <span class="token key atrule">&quot;group_interval&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;5m&quot;</span>
      <span class="token key atrule">&quot;group_wait&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;30s&quot;</span>
      <span class="token key atrule">&quot;receiver&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Default&quot;</span>
      <span class="token key atrule">&quot;repeat_interval&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;12h&quot;</span>
      <span class="token key atrule">&quot;routes&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">&quot;matchers&quot;</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;alertname = Watchdog&quot;</span>
        <span class="token key atrule">&quot;receiver&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Watchdog&quot;</span>
      <span class="token punctuation">-</span> <span class="token key atrule">&quot;matchers&quot;</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;alertname = InfoInhibitor&quot;</span>
        <span class="token key atrule">&quot;receiver&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;null&quot;</span>
      <span class="token punctuation">-</span> <span class="token key atrule">&quot;matchers&quot;</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">&quot;severity = critical&quot;</span>
        <span class="token key atrule">&quot;receiver&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Critical&quot;</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br></div></div><p>我们可以看到内容和上面查看的配置信息是一致的，所以如果我们想要添加自己的接收器，我们就可以直接更改这个文件，比如我们将 <code>Critical</code> 这个接收器的报警信息都发送到邮件进行报警。</p> <p>修改报警配置文件 <code>alertmanager-secret.yaml</code>：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">&quot;global&quot;</span><span class="token punctuation">:</span>
      <span class="token key atrule">&quot;smtp_smarthost&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;smtp.163.com:25&quot;</span>
      <span class="token key atrule">&quot;smtp_from&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;huo9190@163.com&quot;</span>
      <span class="token key atrule">&quot;smtp_auth_username&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;huo9190@163.com&quot;</span>
      <span class="token key atrule">&quot;smtp_auth_password&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;xx&quot;</span>
      <span class="token key atrule">&quot;smtp_hello&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;163.com&quot;</span>
      <span class="token key atrule">&quot;smtp_require_tls&quot;</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">&quot;resolve_timeout&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;5m&quot;</span>
<span class="token punctuation">-</span> <span class="token key atrule">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Critical&quot;</span>
      <span class="token key atrule">&quot;email_configs&quot;</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">&quot;to&quot;</span><span class="token punctuation">:</span> <span class="token string">'130823919@qq.com'</span>
        <span class="token key atrule">&quot;send_resolved&quot;</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">&quot;route&quot;</span><span class="token punctuation">:</span>
  <span class="token key atrule">&quot;group_by&quot;</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;namespace&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>修改完成后，重新更新这个资源对象：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f alertmanager-secret.yaml</span>
secret <span class="token string">&quot;alertmanager-main&quot;</span> deleted
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f alertmanager-secret.yaml</span>
secret/alertmanager-main created
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl delete -f alertmanager-alertmanager.yaml</span>
alertmanager.monitoring.coreos.com <span class="token string">&quot;main&quot;</span> deleted
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f alertmanager-alertmanager.yaml      </span>
alertmanager.monitoring.coreos.com/main created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>更新完成后，很快我们就会收到的报警消息了，而且 AlertManager 页面的 status 页面的配置信息可以看到也已经变成上面我们的配置信息了：</p> <p><img src="img/image-20221015021012157.png" alt="image-20221015021012157"></p> <p>到这里我们就完成了 Prometheus Operator 的自定义监控和报警。</p> <h2 id="_3-高级配置"><a href="#_3-高级配置" class="header-anchor">#</a> 3. 高级配置</h2> <p>如果在我们的 Kubernetes 集群中有了很多的 Service/Pod，那么我们都需要一个一个的去建立一个对应的 <code>ServiceMonitor</code> 对象来进行监控吗？这样岂不是又变得麻烦起来了？</p> <h3 id="_3-1-自动发现配置"><a href="#_3-1-自动发现配置" class="header-anchor">#</a> 3.1 自动发现配置</h3> <p>为解决上面的问题，Prometheus Operator 为我们提供了一个额外的抓取配置的来解决这个问题，我们可以通过添加额外的配置来进行服务发现进行自动监控。和前面自定义的方式一样，我们可以在 Prometheus Operator 当中去自动发现并监控具有<code>prometheus.io/scrape=true</code> 这个 <code>annotations</code> 的 Service，之前我们定义的 Prometheus 的配置如下：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'kubernetes-endpoints'</span>
  <span class="token key atrule">kubernetes_sd_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">role</span><span class="token punctuation">:</span> endpoints
  <span class="token key atrule">relabel_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_annotation_prometheus_io_scrape<span class="token punctuation">]</span>
    <span class="token key atrule">action</span><span class="token punctuation">:</span> keep
    <span class="token key atrule">regex</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_annotation_prometheus_io_scheme<span class="token punctuation">]</span>
    <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
    <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __scheme__
    <span class="token key atrule">regex</span><span class="token punctuation">:</span> (https<span class="token punctuation">?</span>)
  <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_annotation_prometheus_io_path<span class="token punctuation">]</span>
    <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
    <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __metrics_path__
    <span class="token key atrule">regex</span><span class="token punctuation">:</span> (.+)
  <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__address__<span class="token punctuation">,</span> __meta_kubernetes_service_annotation_prometheus_io_port<span class="token punctuation">]</span>
    <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
    <span class="token key atrule">target_label</span><span class="token punctuation">:</span> __address__
    <span class="token key atrule">regex</span><span class="token punctuation">:</span> (<span class="token punctuation">[</span>^<span class="token punctuation">:</span><span class="token punctuation">]</span>+)(<span class="token punctuation">?</span><span class="token punctuation">:</span><span class="token punctuation">:</span>\d+)<span class="token punctuation">?</span>;(\d+)
    <span class="token key atrule">replacement</span><span class="token punctuation">:</span> $1<span class="token punctuation">:</span>$2
  <span class="token punctuation">-</span> <span class="token key atrule">action</span><span class="token punctuation">:</span> labelmap
    <span class="token key atrule">regex</span><span class="token punctuation">:</span> __meta_kubernetes_service_label_(.+)
  <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_namespace<span class="token punctuation">]</span>
    <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
    <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_namespace
  <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_service_name<span class="token punctuation">]</span>
    <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
    <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_name
  <span class="token punctuation">-</span> <span class="token key atrule">source_labels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>__meta_kubernetes_pod_name<span class="token punctuation">]</span>
    <span class="token key atrule">action</span><span class="token punctuation">:</span> replace
    <span class="token key atrule">target_label</span><span class="token punctuation">:</span> kubernetes_pod_name
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>要想自动发现集群中的 Service，就需要我们在 Service 的 annotation 区域添加 <code>prometheus.io/scrape=true</code> 的声明，将上面文件直接保存为 <code>prometheus-additional.yaml</code>，然后通过这个文件创建一个对应的 Secret 对象：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>$ kubectl create secret generic additional-configs --from-file<span class="token operator">=</span>prometheus-additional.yaml <span class="token parameter variable">-n</span> monitoring
secret <span class="token string">&quot;additional-configs&quot;</span> created
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后我们需要在声明 prometheus 的资源对象文件中通过 <code>additionalScrapeConfigs</code> 属性添加上这个额外的配置：(prometheus-prometheus.yaml)</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> monitoring.coreos.com/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Prometheus
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> prometheus
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> k8s
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> prometheus
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.39.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> k8s
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">alerting</span><span class="token punctuation">:</span>
    <span class="token key atrule">alertmanagers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v2
      <span class="token key atrule">name</span><span class="token punctuation">:</span> alertmanager<span class="token punctuation">-</span>main
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> monitoring
      <span class="token key atrule">port</span><span class="token punctuation">:</span> web
  <span class="token key atrule">enableFeatures</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token key atrule">externalLabels</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/prometheus/prometheus<span class="token punctuation">:</span>v2.39.1
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
  <span class="token key atrule">podMetadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> prometheus
      <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> k8s
      <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> prometheus
      <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
      <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.39.1
  <span class="token key atrule">podMonitorNamespaceSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">podMonitorSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">probeNamespaceSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">probeSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 400Mi
  <span class="token key atrule">ruleNamespaceSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">ruleSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
    <span class="token key atrule">fsGroup</span><span class="token punctuation">:</span> <span class="token number">2000</span>
    <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s
  <span class="token key atrule">serviceMonitorNamespaceSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">serviceMonitorSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">version</span><span class="token punctuation">:</span> 2.39.1
  <span class="token key atrule">additionalScrapeConfigs</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> additional<span class="token punctuation">-</span>configs
    <span class="token key atrule">key</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>additional.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>关于 <code>additionalScrapeConfigs</code> 属性的具体介绍，我们可以使用 <code>kubectl explain</code> 命令来了解详细信息：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl explain prometheus.spec.additionalScrapeConfigs</span>
KIND:     Prometheus
VERSION:  monitoring.coreos.com/v1

RESOURCE: additionalScrapeConfigs <span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>

DESCRIPTION:
     AdditionalScrapeConfigs allows specifying a key of a Secret containing
     additional Prometheus scrape configurations. Scrape configurations
     specified are appended to the configurations generated by the Prometheus
     Operator. Job configurations specified must have the form as specified <span class="token keyword">in</span>
     the official Prometheus documentation:
     https://prometheus.io/docs/prometheus/latest/configuration/configuration/<span class="token comment">#scrape_config.</span>
     As scrape configs are appended, the user is responsible to <span class="token function">make</span> sure it is
     valid. Note that using this feature may expose the possibility to <span class="token builtin class-name">break</span>
     upgrades of Prometheus. It is advised to review Prometheus release notes to
     ensure that no incompatible scrape configs are going to <span class="token builtin class-name">break</span> Prometheus
     after the upgrade.

FIELDS:
   key  <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> -required-
     The key of the secret to <span class="token keyword">select</span> from. Must be a valid secret key.

   name <span class="token operator">&lt;</span>string<span class="token operator">&gt;</span>
     Name of the referent. More info:
     https://kubernetes.io/docs/concepts/overview/working-with-objects/names/<span class="token comment">#names</span>
     TODO: Add other useful fields. apiVersion, kind, uid?

   optional     <span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span>
     Specify whether the Secret or its key must be defined
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>添加完成后，直接更新 prometheus 这个 CRD 资源对象即可：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f prometheus-prometheus.yaml</span>
prometheus.monitoring.coreos.com/k8s configured
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>隔一小会儿，可以前往 Prometheus 的 Dashboard 中查看配置已经生效了：</p> <p><img src="img/image-20221015021809517.png" alt="image-20221015021809517"></p> <p>但是我们切换到 targets 页面下面却并没有发现对应的监控任务，查看 Prometheus 的 Pod 日志：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl logs -f prometheus-k8s-0 prometheus -n monitoring</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
<span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2022</span>-10-14T18:19:45.430Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>klog.go:116 <span class="token assign-left variable">level</span><span class="token operator">=</span>error <span class="token assign-left variable">component</span><span class="token operator">=</span>k8s_client_runtime <span class="token assign-left variable">func</span><span class="token operator">=</span>ErrorDepth <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;pkg/mod/k8s.io/client-go@v0.25.1/tools/cache/reflector.go:169: Failed to watch *v1.Pod: failed to list *v1.Pod: pods is forbidden: User <span class="token entity" title="\&quot;">\&quot;</span>system:serviceaccount:monitoring:prometheus-k8s<span class="token entity" title="\&quot;">\&quot;</span> cannot list resource <span class="token entity" title="\&quot;">\&quot;</span>pods<span class="token entity" title="\&quot;">\&quot;</span> in API group <span class="token entity" title="\&quot;">\&quot;</span><span class="token entity" title="\&quot;">\&quot;</span> at the cluster scope&quot;</span>
<span class="token assign-left variable">ts</span><span class="token operator">=</span><span class="token number">2022</span>-10-14T18:19:50.307Z <span class="token assign-left variable">caller</span><span class="token operator">=</span>klog.go:108 <span class="token assign-left variable">level</span><span class="token operator">=</span>warn <span class="token assign-left variable">component</span><span class="token operator">=</span>k8s_client_runtime <span class="token assign-left variable">func</span><span class="token operator">=</span>Warningf <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">&quot;pkg/mod/k8s.io/client-go@v0.25.1/tools/cache/reflector.go:169: failed to list *v1.Service: services is forbidden: User <span class="token entity" title="\&quot;">\&quot;</span>system:serviceaccount:monitoring:prometheus-k8s<span class="token entity" title="\&quot;">\&quot;</span> cannot list resource <span class="token entity" title="\&quot;">\&quot;</span>services<span class="token entity" title="\&quot;">\&quot;</span> in API group <span class="token entity" title="\&quot;">\&quot;</span><span class="token entity" title="\&quot;">\&quot;</span> at the cluster scope&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到有很多错误日志出现，都是 <code>xxx is forbidden</code>，这说明是 RBAC 权限的问题，通过 prometheus 资源对象的配置可以知道 Prometheus 绑定了一个名为 <code>prometheus-k8s</code> 的 ServiceAccount 对象，而这个对象绑定的是一个名为 <code>prometheus-k8s</code> 的 ClusterRole：（prometheus-clusterRole.yaml）</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> prometheus
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> k8s
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> prometheus
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.39.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> nodes/metrics
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
<span class="token punctuation">-</span> <span class="token key atrule">nonResourceURLs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> /metrics
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>上面的权限规则中我们可以看到明显没有对 Service 或者 Pod 的 <code>list</code> 权限，所以报错了，要解决这个问题，我们只需要添加上需要的权限即可：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> prometheus
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> k8s
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> prometheus
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>prometheus
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> 2.39.1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> prometheus<span class="token punctuation">-</span>k8s
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> nodes
  <span class="token punctuation">-</span> services
  <span class="token punctuation">-</span> endpoints
  <span class="token punctuation">-</span> pods
  <span class="token punctuation">-</span> nodes/proxy
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> configmaps
  <span class="token punctuation">-</span> nodes/metrics
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
<span class="token punctuation">-</span> <span class="token key atrule">nonResourceURLs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> /metrics
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f prometheus-clusterRole.yaml</span>
clusterrole.rbac.authorization.k8s.io/prometheus-k8s configured
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl delete pod prometheus-k8s-0 -n monitoring</span>
pod <span class="token string">&quot;prometheus-k8s-0&quot;</span> deleted
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl delete pod prometheus-k8s-1 -n monitoring </span>
pod <span class="token string">&quot;prometheus-k8s-1&quot;</span> deleted
<span class="token punctuation">[</span>root@master manifests<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -n monitoring  </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>更新上面的 <code>ClusterRole</code> 这个资源对象，然后重建下 Prometheus 的所有 Pod，正常就可以看到 targets 页面下面有 <code>kubernetes-endpoints</code> 这个监控任务了：</p> <p><img src="img/image-20221015022318444.png" alt="image-20221015022318444"></p> <p>这里发现的几个抓取目标是因为 Service 中都有 <code>prometheus.io/scrape=true</code> 这个 annotation。：</p> <p>到这里 Prometheus Operator 的一些基本配置就算完成了，对于大型的监控集群还需要做一些其他配置，比如前面我们学习的使用 <code>Thanos</code> 来做 Prometheus 集群的高可用以及数据远程存储，关于 prometheus operator 中如何配置 thanos，可以查看官方文档的介绍：https://github.com/coreos/prometheus-operator/blob/master/Documentation/thanos.md，配置和前面学的Thanos一样。</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/wulinghui/TechnicalSummary/edit/master/docs/Kubernetes/03.监控/08.Prometheus Operator.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/01/26, 22:57:26</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/7f2db1/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">CRD和Operator</div></a> <a href="/pages/5f99a4/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">日志收集</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/7f2db1/" class="prev">CRD和Operator</a></span> <span class="next"><a href="/pages/5f99a4/">日志收集</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/fff88c/"><div>
            架构升级踩坑之路
            <!----></div></a> <span class="date">02-27</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/ba6503/"><div>
            总结
            <!----></div></a> <span class="date">02-27</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/1b4e40/"><div>
            语法学习
            <!----></div></a> <span class="date">02-27</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:873406903@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/wulinghui" title="GitHub(移步到gitee)" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/hellowllh/projects" title="gitee" target="_blank" class="iconfont icon-gitee"></a><a href="https://blog.csdn.net/qq_41720208" title="CSDN" target="_blank" class="iconfont icon-gitee"></a><a href="https://www.cnblogs.com/wlh1995" title="博客园" target="_blank" class="iconfont icon-bokeyuan"></a></div> 
    | Copyright © 2021-2025
    <span>Wu lingui | <a href="" target="_blank"></a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.7f63dd6c.js" defer></script><script src="/assets/js/2.fe5f2a1d.js" defer></script><script src="/assets/js/3.eb8c603e.js" defer></script><script src="/assets/js/52.c0444208.js" defer></script>
  </body>
</html>
