<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>部署k8s1.24版本 | 资料总结</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="个人资料总结，存放笔记">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.76dfa4dd.css" as="style"><link rel="preload" href="/assets/js/app.7f63dd6c.js" as="script"><link rel="preload" href="/assets/js/2.fe5f2a1d.js" as="script"><link rel="preload" href="/assets/js/3.eb8c603e.js" as="script"><link rel="preload" href="/assets/js/36.fd6a950b.js" as="script"><link rel="prefetch" href="/assets/js/10.fe6b23fc.js"><link rel="prefetch" href="/assets/js/100.523c1b31.js"><link rel="prefetch" href="/assets/js/101.bbee1e6c.js"><link rel="prefetch" href="/assets/js/102.36d68ded.js"><link rel="prefetch" href="/assets/js/103.482d8685.js"><link rel="prefetch" href="/assets/js/104.9b20475d.js"><link rel="prefetch" href="/assets/js/105.0edc73b7.js"><link rel="prefetch" href="/assets/js/106.a9abfe31.js"><link rel="prefetch" href="/assets/js/107.2178a4c5.js"><link rel="prefetch" href="/assets/js/108.21d19ed0.js"><link rel="prefetch" href="/assets/js/109.5e1e3698.js"><link rel="prefetch" href="/assets/js/11.7d4a2ffb.js"><link rel="prefetch" href="/assets/js/110.ccc910aa.js"><link rel="prefetch" href="/assets/js/111.fcfd17d0.js"><link rel="prefetch" href="/assets/js/112.f91ccf6e.js"><link rel="prefetch" href="/assets/js/113.5cd28a7e.js"><link rel="prefetch" href="/assets/js/114.4ca8676c.js"><link rel="prefetch" href="/assets/js/115.c4d64d4e.js"><link rel="prefetch" href="/assets/js/116.47ba7426.js"><link rel="prefetch" href="/assets/js/117.3062ccb9.js"><link rel="prefetch" href="/assets/js/118.27991bba.js"><link rel="prefetch" href="/assets/js/119.53538539.js"><link rel="prefetch" href="/assets/js/12.ac798cdb.js"><link rel="prefetch" href="/assets/js/120.e9666755.js"><link rel="prefetch" href="/assets/js/121.73a1660e.js"><link rel="prefetch" href="/assets/js/122.59ac137e.js"><link rel="prefetch" href="/assets/js/123.b9124c91.js"><link rel="prefetch" href="/assets/js/124.12ffcf50.js"><link rel="prefetch" href="/assets/js/125.0403278b.js"><link rel="prefetch" href="/assets/js/126.cec37905.js"><link rel="prefetch" href="/assets/js/127.605a5010.js"><link rel="prefetch" href="/assets/js/128.a4cf61d9.js"><link rel="prefetch" href="/assets/js/129.164a08ce.js"><link rel="prefetch" href="/assets/js/13.8de4385c.js"><link rel="prefetch" href="/assets/js/130.1d4164bd.js"><link rel="prefetch" href="/assets/js/131.7796e583.js"><link rel="prefetch" href="/assets/js/132.c79c715f.js"><link rel="prefetch" href="/assets/js/133.48384f22.js"><link rel="prefetch" href="/assets/js/134.bf85bfff.js"><link rel="prefetch" href="/assets/js/135.1244d4cb.js"><link rel="prefetch" href="/assets/js/136.6650b052.js"><link rel="prefetch" href="/assets/js/137.e9f394e2.js"><link rel="prefetch" href="/assets/js/138.ae16527d.js"><link rel="prefetch" href="/assets/js/139.df1c969c.js"><link rel="prefetch" href="/assets/js/14.d82e6d84.js"><link rel="prefetch" href="/assets/js/140.a80aa424.js"><link rel="prefetch" href="/assets/js/141.10ab646d.js"><link rel="prefetch" href="/assets/js/142.508278ee.js"><link rel="prefetch" href="/assets/js/143.62aa16a7.js"><link rel="prefetch" href="/assets/js/144.c734b314.js"><link rel="prefetch" href="/assets/js/145.7dae44b0.js"><link rel="prefetch" href="/assets/js/146.b08fb7ab.js"><link rel="prefetch" href="/assets/js/147.6fee9f53.js"><link rel="prefetch" href="/assets/js/148.5a09fe8b.js"><link rel="prefetch" href="/assets/js/149.27046d2c.js"><link rel="prefetch" href="/assets/js/15.f0dc0e66.js"><link rel="prefetch" href="/assets/js/150.c05ae37c.js"><link rel="prefetch" href="/assets/js/151.57194eb1.js"><link rel="prefetch" href="/assets/js/152.bc7ad385.js"><link rel="prefetch" href="/assets/js/153.b3c7d891.js"><link rel="prefetch" href="/assets/js/154.0d3a00e5.js"><link rel="prefetch" href="/assets/js/155.b9afdc01.js"><link rel="prefetch" href="/assets/js/156.bfc71798.js"><link rel="prefetch" href="/assets/js/157.43852835.js"><link rel="prefetch" href="/assets/js/158.785caaa2.js"><link rel="prefetch" href="/assets/js/159.1716fd78.js"><link rel="prefetch" href="/assets/js/16.1217969a.js"><link rel="prefetch" href="/assets/js/160.54dfc0be.js"><link rel="prefetch" href="/assets/js/161.3a486b71.js"><link rel="prefetch" href="/assets/js/162.4365dac4.js"><link rel="prefetch" href="/assets/js/163.9e0305ed.js"><link rel="prefetch" href="/assets/js/164.9af7099c.js"><link rel="prefetch" href="/assets/js/165.07230640.js"><link rel="prefetch" href="/assets/js/166.a13e993d.js"><link rel="prefetch" href="/assets/js/167.233c305e.js"><link rel="prefetch" href="/assets/js/168.86996235.js"><link rel="prefetch" href="/assets/js/169.c643487c.js"><link rel="prefetch" href="/assets/js/17.65771bc0.js"><link rel="prefetch" href="/assets/js/170.fed7e19e.js"><link rel="prefetch" href="/assets/js/171.a191947e.js"><link rel="prefetch" href="/assets/js/172.a2368c89.js"><link rel="prefetch" href="/assets/js/173.aad8acd6.js"><link rel="prefetch" href="/assets/js/174.e5c4e9f4.js"><link rel="prefetch" href="/assets/js/175.ef19ddcf.js"><link rel="prefetch" href="/assets/js/176.7b8490c3.js"><link rel="prefetch" href="/assets/js/177.7d1f01a3.js"><link rel="prefetch" href="/assets/js/178.c5ea1f87.js"><link rel="prefetch" href="/assets/js/179.e54bc218.js"><link rel="prefetch" href="/assets/js/18.69d253af.js"><link rel="prefetch" href="/assets/js/180.a0fc0bcd.js"><link rel="prefetch" href="/assets/js/181.8029f765.js"><link rel="prefetch" href="/assets/js/182.72075fe8.js"><link rel="prefetch" href="/assets/js/183.f74d77ba.js"><link rel="prefetch" href="/assets/js/184.3277cbcd.js"><link rel="prefetch" href="/assets/js/185.15940a23.js"><link rel="prefetch" href="/assets/js/186.810a303a.js"><link rel="prefetch" href="/assets/js/187.9c8777f6.js"><link rel="prefetch" href="/assets/js/188.fed55d48.js"><link rel="prefetch" href="/assets/js/189.7f09c5db.js"><link rel="prefetch" href="/assets/js/19.87ab5597.js"><link rel="prefetch" href="/assets/js/190.082d7cbc.js"><link rel="prefetch" href="/assets/js/191.9fb2ec38.js"><link rel="prefetch" href="/assets/js/192.167d2083.js"><link rel="prefetch" href="/assets/js/193.d1eeb947.js"><link rel="prefetch" href="/assets/js/194.09e61c12.js"><link rel="prefetch" href="/assets/js/195.969efb5f.js"><link rel="prefetch" href="/assets/js/196.3932e830.js"><link rel="prefetch" href="/assets/js/197.1dc355f6.js"><link rel="prefetch" href="/assets/js/198.1ad8dbbf.js"><link rel="prefetch" href="/assets/js/199.c6b23b90.js"><link rel="prefetch" href="/assets/js/20.3d741608.js"><link rel="prefetch" href="/assets/js/200.81a125db.js"><link rel="prefetch" href="/assets/js/201.5e2fd593.js"><link rel="prefetch" href="/assets/js/202.51a3fbc4.js"><link rel="prefetch" href="/assets/js/203.4ae7c4f4.js"><link rel="prefetch" href="/assets/js/204.5ba79932.js"><link rel="prefetch" href="/assets/js/205.05bb64e4.js"><link rel="prefetch" href="/assets/js/206.c1d5472b.js"><link rel="prefetch" href="/assets/js/207.ad43feb1.js"><link rel="prefetch" href="/assets/js/208.250144c5.js"><link rel="prefetch" href="/assets/js/209.41667b8a.js"><link rel="prefetch" href="/assets/js/21.23841fc1.js"><link rel="prefetch" href="/assets/js/210.b85ec988.js"><link rel="prefetch" href="/assets/js/211.8f2f9335.js"><link rel="prefetch" href="/assets/js/212.dea21e7c.js"><link rel="prefetch" href="/assets/js/213.9074d848.js"><link rel="prefetch" href="/assets/js/214.baaf02d5.js"><link rel="prefetch" href="/assets/js/215.e3149f2c.js"><link rel="prefetch" href="/assets/js/216.5ede3f02.js"><link rel="prefetch" href="/assets/js/217.06eb8901.js"><link rel="prefetch" href="/assets/js/218.ffe5fc66.js"><link rel="prefetch" href="/assets/js/219.69c6166f.js"><link rel="prefetch" href="/assets/js/22.b55e8e09.js"><link rel="prefetch" href="/assets/js/220.a83c1ecf.js"><link rel="prefetch" href="/assets/js/221.fb65c799.js"><link rel="prefetch" href="/assets/js/222.1ff261ff.js"><link rel="prefetch" href="/assets/js/223.807c2de7.js"><link rel="prefetch" href="/assets/js/224.33540594.js"><link rel="prefetch" href="/assets/js/225.21d88d75.js"><link rel="prefetch" href="/assets/js/226.00d419d7.js"><link rel="prefetch" href="/assets/js/227.19678a11.js"><link rel="prefetch" href="/assets/js/228.d09fe33c.js"><link rel="prefetch" href="/assets/js/229.c8dcc95e.js"><link rel="prefetch" href="/assets/js/23.d7449079.js"><link rel="prefetch" href="/assets/js/230.7477ad3f.js"><link rel="prefetch" href="/assets/js/231.f1013950.js"><link rel="prefetch" href="/assets/js/232.1e07d0e6.js"><link rel="prefetch" href="/assets/js/233.34e0f2b8.js"><link rel="prefetch" href="/assets/js/234.645446d8.js"><link rel="prefetch" href="/assets/js/235.3368fdbc.js"><link rel="prefetch" href="/assets/js/236.35ed0de0.js"><link rel="prefetch" href="/assets/js/237.4a189e89.js"><link rel="prefetch" href="/assets/js/238.d6580ef3.js"><link rel="prefetch" href="/assets/js/239.c518fd70.js"><link rel="prefetch" href="/assets/js/24.26f18aa6.js"><link rel="prefetch" href="/assets/js/240.14979636.js"><link rel="prefetch" href="/assets/js/241.95c3b00d.js"><link rel="prefetch" href="/assets/js/242.a214e307.js"><link rel="prefetch" href="/assets/js/243.273af8d4.js"><link rel="prefetch" href="/assets/js/244.e2d74303.js"><link rel="prefetch" href="/assets/js/245.fe562cb9.js"><link rel="prefetch" href="/assets/js/246.b40011af.js"><link rel="prefetch" href="/assets/js/247.dc1a9aae.js"><link rel="prefetch" href="/assets/js/248.d691ac20.js"><link rel="prefetch" href="/assets/js/249.191f742a.js"><link rel="prefetch" href="/assets/js/25.198594bf.js"><link rel="prefetch" href="/assets/js/250.205b92cf.js"><link rel="prefetch" href="/assets/js/251.acb8a80e.js"><link rel="prefetch" href="/assets/js/26.c817356c.js"><link rel="prefetch" href="/assets/js/27.6b812306.js"><link rel="prefetch" href="/assets/js/28.9048721b.js"><link rel="prefetch" href="/assets/js/29.bfda8510.js"><link rel="prefetch" href="/assets/js/30.eb1b6ab9.js"><link rel="prefetch" href="/assets/js/31.3f3dbd2f.js"><link rel="prefetch" href="/assets/js/32.006bc754.js"><link rel="prefetch" href="/assets/js/33.05d371fe.js"><link rel="prefetch" href="/assets/js/34.27cd6ff5.js"><link rel="prefetch" href="/assets/js/35.35409a6d.js"><link rel="prefetch" href="/assets/js/37.c8fd6ef4.js"><link rel="prefetch" href="/assets/js/38.028a36a2.js"><link rel="prefetch" href="/assets/js/39.e4494792.js"><link rel="prefetch" href="/assets/js/4.ff2df22c.js"><link rel="prefetch" href="/assets/js/40.979dec53.js"><link rel="prefetch" href="/assets/js/41.ff9662db.js"><link rel="prefetch" href="/assets/js/42.5c1441fc.js"><link rel="prefetch" href="/assets/js/43.9657eae8.js"><link rel="prefetch" href="/assets/js/44.a6cb5e5c.js"><link rel="prefetch" href="/assets/js/45.c675440c.js"><link rel="prefetch" href="/assets/js/46.06205970.js"><link rel="prefetch" href="/assets/js/47.ded0c65e.js"><link rel="prefetch" href="/assets/js/48.296a6f26.js"><link rel="prefetch" href="/assets/js/49.1b2ec2ab.js"><link rel="prefetch" href="/assets/js/5.ecde23f9.js"><link rel="prefetch" href="/assets/js/50.e551e67f.js"><link rel="prefetch" href="/assets/js/51.122d5b68.js"><link rel="prefetch" href="/assets/js/52.c0444208.js"><link rel="prefetch" href="/assets/js/53.f47d6b86.js"><link rel="prefetch" href="/assets/js/54.e9c9b41b.js"><link rel="prefetch" href="/assets/js/55.77010c1f.js"><link rel="prefetch" href="/assets/js/56.387aacbb.js"><link rel="prefetch" href="/assets/js/57.ddcf78ad.js"><link rel="prefetch" href="/assets/js/58.908b88fc.js"><link rel="prefetch" href="/assets/js/59.8ff535f1.js"><link rel="prefetch" href="/assets/js/6.b928f1b9.js"><link rel="prefetch" href="/assets/js/60.c5018386.js"><link rel="prefetch" href="/assets/js/61.1514e08b.js"><link rel="prefetch" href="/assets/js/62.79bc9197.js"><link rel="prefetch" href="/assets/js/63.a6cb5e14.js"><link rel="prefetch" href="/assets/js/64.f149661c.js"><link rel="prefetch" href="/assets/js/65.30fa2026.js"><link rel="prefetch" href="/assets/js/66.e7f9f54e.js"><link rel="prefetch" href="/assets/js/67.7361f4a3.js"><link rel="prefetch" href="/assets/js/68.b67cc099.js"><link rel="prefetch" href="/assets/js/69.ba730416.js"><link rel="prefetch" href="/assets/js/7.b0514d37.js"><link rel="prefetch" href="/assets/js/70.45b9e858.js"><link rel="prefetch" href="/assets/js/71.2055eaae.js"><link rel="prefetch" href="/assets/js/72.75ec1304.js"><link rel="prefetch" href="/assets/js/73.3aa09b6b.js"><link rel="prefetch" href="/assets/js/74.fb3013f1.js"><link rel="prefetch" href="/assets/js/75.c837c896.js"><link rel="prefetch" href="/assets/js/76.9e6df886.js"><link rel="prefetch" href="/assets/js/77.4eb09ab0.js"><link rel="prefetch" href="/assets/js/78.06d19c8c.js"><link rel="prefetch" href="/assets/js/79.dfde586d.js"><link rel="prefetch" href="/assets/js/8.f86f2563.js"><link rel="prefetch" href="/assets/js/80.476da6d1.js"><link rel="prefetch" href="/assets/js/81.2b778375.js"><link rel="prefetch" href="/assets/js/82.abbf449f.js"><link rel="prefetch" href="/assets/js/83.24b0e8ea.js"><link rel="prefetch" href="/assets/js/84.f8694c96.js"><link rel="prefetch" href="/assets/js/85.f030e8b6.js"><link rel="prefetch" href="/assets/js/86.18853c72.js"><link rel="prefetch" href="/assets/js/87.4eca3df6.js"><link rel="prefetch" href="/assets/js/88.26b81c78.js"><link rel="prefetch" href="/assets/js/89.ae216049.js"><link rel="prefetch" href="/assets/js/9.7a3e1618.js"><link rel="prefetch" href="/assets/js/90.b0ee8ab4.js"><link rel="prefetch" href="/assets/js/91.a07b34f1.js"><link rel="prefetch" href="/assets/js/92.1c2952b1.js"><link rel="prefetch" href="/assets/js/93.e199901d.js"><link rel="prefetch" href="/assets/js/94.a901578c.js"><link rel="prefetch" href="/assets/js/95.641f6644.js"><link rel="prefetch" href="/assets/js/96.84a54aa3.js"><link rel="prefetch" href="/assets/js/97.c489ec61.js"><link rel="prefetch" href="/assets/js/98.5fb17174.js"><link rel="prefetch" href="/assets/js/99.c004152a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.76dfa4dd.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="资料总结" class="logo"> <span class="site-name can-hide">资料总结</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/goVersion181/" class="nav-link">go</a></div><div class="nav-item"><a href="/pages/springFramework/" class="nav-link">java</a></div><div class="nav-item"><a href="/pages/e5d517/" class="nav-link">云原生</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/pages/410b25/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/00291d/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/pages/846ee6/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/pages/5465c3/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/853b5b/" class="nav-link">设计模式详解</a></li><li class="dropdown-item"><!----> <a href="/pages/ebc515/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/pages/57778e/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/pages/282cd0/" class="nav-link">项目</a></li><li class="dropdown-item"><!----> <a href="/pages/2cd810/" class="nav-link">理论基础</a></li><li class="dropdown-item"><!----> <a href="/pages/6acd46/" class="nav-link">运营</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/wulinghui/TechnicalSummary" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src=""> <div class="blogger-info"><h3>linghui Wu</h3> <span>一只努力学飞的鱼</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/goVersion181/" class="nav-link">go</a></div><div class="nav-item"><a href="/pages/springFramework/" class="nav-link">java</a></div><div class="nav-item"><a href="/pages/e5d517/" class="nav-link">云原生</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><a href="/pages/410b25/" class="link-title">数据库</a> <span class="title" style="display:none;">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/00291d/" class="nav-link">mysql</a></li><li class="dropdown-item"><!----> <a href="/pages/846ee6/" class="nav-link">redis</a></li><li class="dropdown-item"><!----> <a href="/pages/5465c3/" class="nav-link">MongoDB</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><!----> <span class="title" style="display:;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/853b5b/" class="nav-link">设计模式详解</a></li><li class="dropdown-item"><!----> <a href="/pages/ebc515/" class="nav-link">数据结构与算法</a></li><li class="dropdown-item"><!----> <a href="/pages/57778e/" class="nav-link">前端</a></li><li class="dropdown-item"><!----> <a href="/pages/282cd0/" class="nav-link">项目</a></li><li class="dropdown-item"><!----> <a href="/pages/2cd810/" class="nav-link">理论基础</a></li><li class="dropdown-item"><!----> <a href="/pages/6acd46/" class="nav-link">运营</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/wulinghui/TechnicalSummary" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/pages/e5d517/" class="sidebar-link">01-云原生概念</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>k8s</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/517943/" class="sidebar-link">基础介绍</a></li><li><a href="/pages/c1223e/" class="sidebar-link">安装</a></li><li><a href="/pages/6ed476/" class="sidebar-link">命令详解</a></li><li><a href="/pages/a11481/" class="sidebar-link">Pod配置以及生命周期</a></li><li><a href="/pages/ad6362/" class="sidebar-link">Pod调度</a></li><li><a href="/pages/eed6b8/" class="sidebar-link">Pod控制器</a></li><li><a href="/pages/49c21a/" class="sidebar-link">Service详解</a></li><li><a href="/pages/7a877a/" class="sidebar-link">数据存储</a></li><li><a href="/pages/33d194/" class="sidebar-link">安全</a></li><li><a href="/pages/29fa5c/" class="sidebar-link">网络</a></li><li><a href="/pages/97cddc/" class="sidebar-link">调度框架</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>Helm包管理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>k8s实战部署</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/a3c23a/" aria-current="page" class="active sidebar-link">部署k8s1.24版本</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/a3c23a/#_1-准备" class="sidebar-link">1.准备</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a3c23a/#_1-1-系统配置" class="sidebar-link">1.1 系统配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/a3c23a/#_1-2-配置服务器支持开启ipvs的前提条件" class="sidebar-link">1.2 配置服务器支持开启ipvs的前提条件</a></li><li class="sidebar-sub-header level3"><a href="/pages/a3c23a/#_1-3-部署容器运行时containerd" class="sidebar-link">1.3 部署容器运行时Containerd</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/a3c23a/#_2-使用kubeadm部署kubernetes" class="sidebar-link">2.使用kubeadm部署Kubernetes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a3c23a/#_2-1-安装kubeadm和kubelet" class="sidebar-link">2.1 安装kubeadm和kubelet</a></li><li class="sidebar-sub-header level3"><a href="/pages/a3c23a/#_2-2-使用kubeadm-init初始化集群" class="sidebar-link">2.2 使用kubeadm init初始化集群</a></li><li class="sidebar-sub-header level3"><a href="/pages/a3c23a/#_2-3-安装包管理器helm-3" class="sidebar-link">2.3 安装包管理器helm 3</a></li><li class="sidebar-sub-header level3"><a href="/pages/a3c23a/#_2-4-部署pod-network组件calico" class="sidebar-link">2.4 部署Pod Network组件Calico</a></li><li class="sidebar-sub-header level3"><a href="/pages/a3c23a/#_2-5-验证k8s-dns是否可用" class="sidebar-link">2.5 验证k8s DNS是否可用</a></li><li class="sidebar-sub-header level3"><a href="/pages/a3c23a/#_2-6-向kubernetes集群中添加node节点" class="sidebar-link">2.6 向Kubernetes集群中添加Node节点</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/a3c23a/#_3-kubernetes常用组件部署" class="sidebar-link">3.Kubernetes常用组件部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a3c23a/#_3-1-使用helm部署ingress-nginx" class="sidebar-link">3.1 使用Helm部署ingress-nginx</a></li><li class="sidebar-sub-header level3"><a href="/pages/a3c23a/#_3-2-使用helm部署dashboard" class="sidebar-link">3.2 使用Helm部署dashboard</a></li></ul></li></ul></li><li><a href="/pages/18f4c5/" class="sidebar-link">Harbor部署</a></li><li><a href="/pages/2c0ab9/" class="sidebar-link">StatefulSet讲解</a></li><li><a href="/pages/c5a8b8/" class="sidebar-link">wordpress实战部署</a></li><li><a href="/pages/76a20e/" class="sidebar-link">k8s部署IM项目-springCloud</a></li></ul></section></li><li><a href="/pages/7322db/" class="sidebar-link">总结-实战与基本原理</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>监控</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>日志</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DevOps</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>ServiceMesh</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/pages/076b5d/" class="sidebar-link">Knative</a></li><li><a href="/pages/6d3863/" class="sidebar-link">spring-cloud-kubernetes</a></li><li><a href="/pages/cb6fc2/" class="sidebar-link">ms总结</a></li><li><a href="/pages/fff88c/" class="sidebar-link">架构升级踩坑之路</a></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/categories/?category=Kubernetes" title="分类" data-v-06970110>Kubernetes</a></li><li data-v-06970110><a href="/categories/?category=k8s" title="分类" data-v-06970110>k8s</a></li><li data-v-06970110><a href="/categories/?category=k8s%E5%AE%9E%E6%88%98%E9%83%A8%E7%BD%B2" title="分类" data-v-06970110>k8s实战部署</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://gitee.com/hellowllh/projects" target="_blank" title="作者" class="beLink" data-v-06970110>wulinghui</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2023-01-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">部署k8s1.24版本<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="helm-部署-k8s-1-24"><a href="#helm-部署-k8s-1-24" class="header-anchor">#</a> Helm 部署 k8s 1.24</h1> <p>容器运行时 docker ，1.24版本以后 移除docker，CRI容器运行时接口 ，docker-cri</p> <h2 id="_1-准备"><a href="#_1-准备" class="header-anchor">#</a> 1.准备</h2> <h3 id="_1-1-系统配置"><a href="#_1-1-系统配置" class="header-anchor">#</a> 1.1 系统配置</h3> <p>在安装之前，需要先做好如下准备。3台CentOS 7.9主机如下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master /<span class="token punctuation">]</span><span class="token comment"># cat /etc/hosts</span>
<span class="token number">192.168</span>.200.101 master
<span class="token number">192.168</span>.200.102 node1
<span class="token number">192.168</span>.200.103 node2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在各个主机上完成下面的系统配置。</p> <p>如果各个主机启用了防火墙策略，需要开放Kubernetes各个组件所需要的端口，可以查看<a href="https://kubernetes.io/docs/reference/ports-and-protocols/" target="_blank" rel="noopener noreferrer">Ports and Protocols<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中的内容, 开放相关端口或者关闭主机的防火墙。</p> <p>禁用SELINUX：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master /<span class="token punctuation">]</span><span class="token comment"># setenforce 0 </span>
setenforce: SELinux is disable
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master /<span class="token punctuation">]</span><span class="token comment"># vim /etc/selinux/config</span>

<span class="token comment"># This file controls the state of SELinux on the system.</span>
<span class="token comment"># SELINUX= can take one of these three values:</span>
<span class="token comment">#     enforcing - SELinux security policy is enforced.</span>
<span class="token comment">#     permissive - SELinux prints warnings instead of enforcing.</span>
<span class="token comment">#     disabled - No SELinux policy is loaded.</span>
<span class="token assign-left variable">SELINUX</span><span class="token operator">=</span>disabled
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>创建/etc/modules-load.d/containerd.conf配置文件:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/modules-load.d/containerd.conf</span>
overlay
br_netfilter
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>执行以下命令使配置生效:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master /<span class="token punctuation">]</span><span class="token comment"># modprobe overlay</span>
<span class="token punctuation">[</span>root@master /<span class="token punctuation">]</span><span class="token comment"># modprobe br_netfilter</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>创建/etc/sysctl.d/99-kubernetes-cri.conf配置文件：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/sysctl.d/99-kubernetes-cri.conf</span>
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
user.max_user_namespaces=28633
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>执行以下命令使配置生效:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sysctl</span> <span class="token parameter variable">-p</span> /etc/sysctl.d/99-kubernetes-cri.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_1-2-配置服务器支持开启ipvs的前提条件"><a href="#_1-2-配置服务器支持开启ipvs的前提条件" class="header-anchor">#</a> 1.2 配置服务器支持开启ipvs的前提条件</h3> <p>由于ipvs已经加入到了内核的主干，所以为kube-proxy开启ipvs的前提需要加载以下的内核模块：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack_ipv4
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>在各个服务器节点上执行以下脚本:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> /etc/sysconfig/modules/ipvs.modules <span class="token operator">&lt;&lt;</span><span class="token string">EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
EOF</span>
<span class="token comment"># 注意 低内核版本用 nf_conntrack_ipv4</span>
<span class="token function">chmod</span> <span class="token number">755</span> /etc/sysconfig/modules/ipvs.modules <span class="token operator">&amp;&amp;</span> <span class="token function">bash</span> /etc/sysconfig/modules/ipvs.modules <span class="token operator">&amp;&amp;</span> lsmod <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-e</span> ip_vs <span class="token parameter variable">-e</span> nf_conntrack
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>上面脚本创建了的<code>/etc/sysconfig/modules/ipvs.modules</code>文件，保证在节点重启后能自动加载所需模块。 使用<code>lsmod | grep -e ip_vs -e nf_conntrack_ipv4</code>命令查看是否已经正确加载所需的内核模块。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span>
ip_vs_sh               <span class="token number">16384</span>  <span class="token number">0</span> 
ip_vs_wrr              <span class="token number">16384</span>  <span class="token number">0</span> 
ip_vs_rr               <span class="token number">16384</span>  <span class="token number">0</span> 
ip_vs                 <span class="token number">163840</span>  <span class="token number">6</span> ip_vs_rr,ip_vs_sh,ip_vs_wrr
nf_conntrack          <span class="token number">163840</span>  <span class="token number">1</span> ip_vs
nf_defrag_ipv6         <span class="token number">24576</span>  <span class="token number">2</span> nf_conntrack,ip_vs
nf_defrag_ipv4         <span class="token number">16384</span>  <span class="token number">1</span> nf_conntrack
libcrc32c              <span class="token number">16384</span>  <span class="token number">3</span> nf_conntrack,xfs,ip_vs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>接下来还需要确保各个节点上已经安装了ipset软件包，为了便于查看ipvs的代理规则，最好安装一下管理工具ipvsadm。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master ~<span class="token punctuation">]</span><span class="token comment"># yum install -y ipset ipvsadm</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果不满足以上前提条件，则即使kube-proxy的配置开启了ipvs模式，也会退回到iptables模式。</p> <h3 id="_1-3-部署容器运行时containerd"><a href="#_1-3-部署容器运行时containerd" class="header-anchor">#</a> 1.3 部署容器运行时Containerd</h3> <p>在各个服务器节点上安装容器运行时Containerd。</p> <p>下载Containerd的二进制包:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">wget</span> https://github.com/containerd/containerd/releases/download/v1.6.4/cri-containerd-cni-1.6.4-linux-amd64.tar.gz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>cri-containerd-cni-1.6.4-linux-amd64.tar.gz</code>压缩包中已经按照官方二进制部署推荐的目录结构布局好。 里面包含了systemd配置文件，containerd以及cni的部署文件。 将解压缩到系统的根目录<code>/</code>中:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master k8s<span class="token punctuation">]</span><span class="token comment"># tar -zxvf cri-containerd-cni-1.6.4-linux-amd64.tar.gz -C /</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>注意经测试cri-containerd-cni-1.6.4-linux-amd64.tar.gz包中包含的runc在CentOS 7下的动态链接有问题，这里从runc的github上单独下载runc，并替换上面安装的containerd中的runc:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master k8s<span class="token punctuation">]</span><span class="token comment"># wget https://github.com/opencontainers/runc/releases/download/v1.1.2/runc.amd64</span>
<span class="token punctuation">[</span>root@master k8s<span class="token punctuation">]</span><span class="token comment"># cp runc.amd64 /usr/local/sbin/runc</span>
cp：是否覆盖<span class="token string">&quot;/usr/local/sbin/runc&quot;</span>？ y
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接下来生成containerd的配置文件:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master k8s<span class="token punctuation">]</span><span class="token comment"># mkdir -p /etc/containerd</span>
<span class="token punctuation">[</span>root@master k8s<span class="token punctuation">]</span><span class="token comment"># containerd config default &gt; /etc/containerd/config.toml</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>根据文档<a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/" target="_blank" rel="noopener noreferrer">Container runtimes <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中的内容，对于使用systemd作为init system的Linux的发行版，使用systemd作为容器的cgroup driver可以确保服务器节点在资源紧张的情况更加稳定，因此这里配置各个节点上containerd的cgroup driver为systemd。</p> <p>修改前面生成的配置文件<code>/etc/containerd/config.toml</code>：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc<span class="token punctuation">]</span>
  <span class="token punctuation">..</span>.
  <span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc.options<span class="token punctuation">]</span>
    SystemdCgroup <span class="token operator">=</span> <span class="token boolean">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>再修改<code>/etc/containerd/config.toml</code>中的</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>plugins.<span class="token string">&quot;io.containerd.grpc.v1.cri&quot;</span><span class="token punctuation">]</span>
  <span class="token punctuation">..</span>.
  <span class="token comment"># sandbox_image = &quot;k8s.gcr.io/pause:3.6&quot;</span>
  sandbox_image <span class="token operator">=</span> <span class="token string">&quot;registry.aliyuncs.com/google_containers/pause:3.7&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>配置containerd开机启动，并启动containerd</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>systemctl <span class="token builtin class-name">enable</span> containerd <span class="token parameter variable">--now</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用crictl测试一下，确保可以打印出版本信息并且没有错误信息输出:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master k8s<span class="token punctuation">]</span><span class="token comment"># systemctl restart containerd</span>
<span class="token punctuation">[</span>root@master k8s<span class="token punctuation">]</span><span class="token comment"># crictl version              </span>
Version:  <span class="token number">0.1</span>.0
RuntimeName:  containerd
RuntimeVersion:  v1.6.4
RuntimeApiVersion:  v1alpha2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="_2-使用kubeadm部署kubernetes"><a href="#_2-使用kubeadm部署kubernetes" class="header-anchor">#</a> 2.使用kubeadm部署Kubernetes</h2> <h3 id="_2-1-安装kubeadm和kubelet"><a href="#_2-1-安装kubeadm和kubelet" class="header-anchor">#</a> 2.1 安装kubeadm和kubelet</h3> <p>下面在各节点安装kubeadm和kubelet：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/yum.repos.d/kubernetes.repo</span>
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=0
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
        http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>yum makecache fast
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> kubelet-1.24.0 kubeadm-1.24.0 kubectl-1.24.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>运行<code>kubelet --help</code>可以看到原来kubelet的绝大多数命令行flag参数都被<code>DEPRECATED</code>了，官方推荐我们使用<code>--config</code>指定配置文件，并在配置文件中指定原来这些flag所配置的内容。具体内容可以查看这里<a href="https://kubernetes.io/docs/tasks/administer-cluster/kubelet-config-file/" target="_blank" rel="noopener noreferrer">Set Kubelet parameters via a config file<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。<strong>最初Kubernetes这么做是为了支持动态Kubelet配置（Dynamic Kubelet Configuration），但动态Kubelet配置特性从k8s 1.22中已弃用，并在1.24中被移除。如果需要调整集群汇总所有节点kubelet的配置，还是推荐使用ansible等工具将配置分发到各个节点</strong>。</p> <p>kubelet的配置文件必须是json或yaml格式。</p> <p>Kubernetes 1.8开始要求关闭系统的Swap，如果不关闭，默认配置下kubelet将无法启动。 关闭系统的Swap方法如下:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>swapoff <span class="token parameter variable">-a</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>修改 /etc/fstab 文件，注释掉 SWAP 的自动挂载，使用<code>free -m</code>确认swap已经关闭。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master k8s<span class="token punctuation">]</span><span class="token comment"># vim /etc/fstab</span>

<span class="token comment">#</span>
<span class="token comment"># /etc/fstab</span>
<span class="token comment"># Created by anaconda on Fri Mar 11 19:06:01 2022</span>
<span class="token comment">#</span>
<span class="token comment"># Accessible filesystems, by reference, are maintained under '/dev/disk'</span>
<span class="token comment"># See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info</span>
<span class="token comment">#</span>
/dev/mapper/centos-root /                       xfs     defaults        <span class="token number">0</span> <span class="token number">0</span>
<span class="token comment">#UUID=cfe586e4-74bf-4670-b28c-85110dbcb55b /boot                   xfs     defaults        0 0</span>
<span class="token comment">#/dev/mapper/centos-swap swap                    swap    defaults        0 0</span>
~                                                                                            
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master k8s<span class="token punctuation">]</span><span class="token comment"># free -m</span>
              total        used        <span class="token function">free</span>      shared  buff/cache   available
Mem:           <span class="token number">1819</span>         <span class="token number">277</span>         <span class="token number">200</span>           <span class="token number">9</span>        <span class="token number">1341</span>        <span class="token number">1373</span>
Swap:             <span class="token number">0</span>           <span class="token number">0</span>           <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>swappiness参数调整，修改/etc/sysctl.d/99-kubernetes-cri.conf添加下面一行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">vm.swappiness</span><span class="token operator">=</span><span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>执行<code>sysctl -p /etc/sysctl.d/99-kubernetes-cri.conf</code>使修改生效。</p> <h3 id="_2-2-使用kubeadm-init初始化集群"><a href="#_2-2-使用kubeadm-init初始化集群" class="header-anchor">#</a> 2.2 使用kubeadm init初始化集群</h3> <p>在各节点开机启动kubelet服务：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master k8s<span class="token punctuation">]</span><span class="token comment"># systemctl enable kubelet.service</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用<code>kubeadm config print init-defaults --component-configs KubeletConfiguration</code>可以打印集群初始化默认的使用的配置：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master k8s<span class="token punctuation">]</span><span class="token comment"># kubeadm config print init-defaults --component-configs KubeletConfiguration</span>
apiVersion: kubeadm.k8s.io/v1beta3
bootstrapTokens:
- groups:
  - system:bootstrappers:kubeadm:default-node-token
  token: abcdef.0123456789abcdef
  ttl: 24h0m0s
  usages:
  - signing
  - authentication
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: <span class="token number">1.2</span>.3.4
  bindPort: <span class="token number">6443</span>
nodeRegistration:
  criSocket: unix:///var/run/containerd/containerd.sock
  imagePullPolicy: IfNotPresent
  name: <span class="token function">node</span>
  taints: null
---
apiServer:
  timeoutForControlPlane: 4m0s
apiVersion: kubeadm.k8s.io/v1beta3
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controllerManager: <span class="token punctuation">{</span><span class="token punctuation">}</span>
dns: <span class="token punctuation">{</span><span class="token punctuation">}</span>
etcd:
  local:
    dataDir: /var/lib/etcd
imageRepository: registry.k8s.io
kind: ClusterConfiguration
kubernetesVersion: <span class="token number">1.25</span>.0
networking:
  dnsDomain: cluster.local
  serviceSubnet: <span class="token number">10.96</span>.0.0/12
scheduler: <span class="token punctuation">{</span><span class="token punctuation">}</span>
---
apiVersion: kubelet.config.k8s.io/v1beta1
authentication:
  anonymous:
    enabled: <span class="token boolean">false</span>
  webhook:
    cacheTTL: 0s
    enabled: <span class="token boolean">true</span>
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.crt
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 0s
    cacheUnauthorizedTTL: 0s
cgroupDriver: systemd
clusterDNS:
- <span class="token number">10.96</span>.0.10
clusterDomain: cluster.local
cpuManagerReconcilePeriod: 0s
evictionPressureTransitionPeriod: 0s
fileCheckFrequency: 0s
healthzBindAddress: <span class="token number">127.0</span>.0.1
healthzPort: <span class="token number">10248</span>
httpCheckFrequency: 0s
imageMinimumGCAge: 0s
kind: KubeletConfiguration
logging:
  flushFrequency: <span class="token number">0</span>
  options:
    json:
      infoBufferSize: <span class="token string">&quot;0&quot;</span>
  verbosity: <span class="token number">0</span>
memorySwap: <span class="token punctuation">{</span><span class="token punctuation">}</span>
nodeStatusReportFrequency: 0s
nodeStatusUpdateFrequency: 0s
rotateCertificates: <span class="token boolean">true</span>
runtimeRequestTimeout: 0s
shutdownGracePeriod: 0s
shutdownGracePeriodCriticalPods: 0s
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 0s
syncFrequency: 0s
volumeStatsAggPeriod: 0s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br></div></div><p>从默认的配置中可以看到，可以使用<code>imageRepository</code>定制在集群初始化时拉取k8s所需镜像的地址。基于默认配置定制出本次使用kubeadm初始化集群所需的配置文件kubeadm.yaml：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeadm.k8s.io/v1beta3
<span class="token key atrule">kind</span><span class="token punctuation">:</span> InitConfiguration
<span class="token key atrule">localAPIEndpoint</span><span class="token punctuation">:</span>
  <span class="token key atrule">advertiseAddress</span><span class="token punctuation">:</span> 192.168.200.101
  <span class="token key atrule">bindPort</span><span class="token punctuation">:</span> <span class="token number">6443</span>
<span class="token key atrule">nodeRegistration</span><span class="token punctuation">:</span>
  <span class="token key atrule">criSocket</span><span class="token punctuation">:</span> unix<span class="token punctuation">:</span>///run/containerd/containerd.sock
  <span class="token key atrule">taints</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> PreferNoSchedule
    <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeadm.k8s.io/v1beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterConfiguration
<span class="token key atrule">kubernetesVersion</span><span class="token punctuation">:</span> v1.24.0
<span class="token key atrule">imageRepository</span><span class="token punctuation">:</span> registry.aliyuncs.com/google_containers
<span class="token key atrule">networking</span><span class="token punctuation">:</span>
  <span class="token key atrule">podSubnet</span><span class="token punctuation">:</span> 10.244.0.0/16
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubelet.config.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeletConfiguration
<span class="token key atrule">cgroupDriver</span><span class="token punctuation">:</span> systemd
<span class="token key atrule">failSwapOn</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeproxy.config.k8s.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> KubeProxyConfiguration
<span class="token key atrule">mode</span><span class="token punctuation">:</span> ipvs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>这里定制了<code>imageRepository</code>为阿里云的registry，避免因gcr被墙，无法直接拉取镜像。<code>criSocket</code>设置了容器运行时为containerd。 同时设置kubelet的<code>cgroupDriver</code>为systemd，设置kube-proxy代理模式为ipvs。</p> <p>在开始初始化集群之前可以使用<code>kubeadm config images pull --config kubeadm.yaml</code>预先在各个服务器节点上拉取所k8s需要的容器镜像。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master <span class="token number">1.24</span><span class="token punctuation">]</span><span class="token comment"># kubeadm config images pull --config kubeadm.yaml</span>
W0922 <span class="token number">11</span>:42:09.431462   <span class="token number">62205</span> common.go:84<span class="token punctuation">]</span> your configuration <span class="token function">file</span> uses a deprecated API spec: <span class="token string">&quot;kubeadm.k8s.io/v1beta2&quot;</span><span class="token builtin class-name">.</span> Please use <span class="token string">'kubeadm config migrate --old-config old.yaml --new-config new.yaml'</span>, <span class="token function">which</span> will <span class="token function">write</span> the new, similar spec using a newer API version.
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/kube-apiserver:v1.24.0
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/kube-controller-manager:v1.24.0
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/kube-scheduler:v1.24.0
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/kube-proxy:v1.24.0
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/pause:3.8
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/etcd:3.5.4-0
<span class="token punctuation">[</span>config/images<span class="token punctuation">]</span> Pulled registry.aliyuncs.com/google_containers/coredns:v1.9.3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>接下来使用kubeadm初始化集群，选择Master Node，在master上执行下面的命令：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master <span class="token number">1.24</span><span class="token punctuation">]</span><span class="token comment"># kubeadm init --config kubeadm.yaml</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>注意：</p> <p>可能会报如下错误：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master <span class="token number">1.24</span><span class="token punctuation">]</span><span class="token comment"># kubeadm init --config kubeadm.yaml                      </span>
W0922 <span class="token number">11</span>:59:08.319766   <span class="token number">62278</span> common.go:83<span class="token punctuation">]</span> your configuration <span class="token function">file</span> uses a deprecated API spec: <span class="token string">&quot;kubeadm.k8s.io/v1beta2&quot;</span><span class="token builtin class-name">.</span> Please use <span class="token string">'kubeadm config migrate --old-config old.yaml --new-config new.yaml'</span>, <span class="token function">which</span> will <span class="token function">write</span> the new, similar spec using a newer API version.
<span class="token punctuation">[</span>init<span class="token punctuation">]</span> Using Kubernetes version: v1.24.0
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Running pre-flight checks
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> The system verification failed. Printing the output from the verification:
KERNEL_VERSION: <span class="token number">3.10</span>.0-1127.el7.x86_64
OS: Linux
CGROUPS_CPU: enabled
CGROUPS_CPUACCT: enabled
CGROUPS_CPUSET: enabled
CGROUPS_DEVICES: enabled
CGROUPS_FREEZER: enabled
CGROUPS_MEMORY: enabled
CGROUPS_PIDS: enabled
CGROUPS_HUGETLB: enabled
CGROUPS_BLKIO: enabled
error execution phase preflight: <span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Some fatal errors occurred:
        <span class="token punctuation">[</span>ERROR SystemVerification<span class="token punctuation">]</span>: failed to parse kernel config: unable to load kernel module: <span class="token string">&quot;configs&quot;</span>, output: <span class="token string">&quot;modprobe: FATAL: Module configs not found.<span class="token entity" title="\n">\n</span>&quot;</span>, err: <span class="token builtin class-name">exit</span> status <span class="token number">1</span>
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> If you know what you are doing, you can <span class="token function">make</span> a check non-fatal with <span class="token variable"><span class="token variable">`</span>--ignore-preflight-errors<span class="token operator">=</span><span class="token punctuation">..</span>.<span class="token variable">`</span></span>
To see the stack trace of this error execute with <span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">5</span> or higher
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>这种错误，是内核版本问题，可以忽略该问题 安装时加上 <code>--ignore-preflight-errors=SystemVerification</code>，这是在做系统检查时发现的问题，可以暂时忽略。</p> <p>还有一种解决办法就是升级内核版本。</p> <p>kubadm init完成后会输出一些内容，根据输出的内容基本上可以看出手动初始化安装一个Kubernetes集群所需要的关键步骤。 其中有以下关键内容：</p> <ul><li><p><code>[certs]</code>生成相关的各种证书</p></li> <li><p><code>[kubeconfig]</code>生成相关的kubeconfig文件</p></li> <li><p><code>[kubelet-start]</code> 生成kubelet的配置文件&quot;/var/lib/kubelet/config.yaml&quot;</p></li> <li><p><code>[control-plane]</code>使用<code>/etc/kubernetes/manifests</code>目录中的yaml文件创建apiserver、controller-manager、scheduler的静态pod</p></li> <li><p><code>[bootstraptoken]</code>生成token记录下来，后边使用<code>kubeadm join</code>往集群中添加节点时会用到</p></li> <li><p>下面的命令是配置常规用户如何使用kubectl访问集群：、</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>最后给出了将节点加入集群的命令<code>kubeadm join</code></p></li></ul> <p>查看一下集群状态，确认个组件都处于healthy状态:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl get cs
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>集群初始化如果遇到问题，可以使用<code>kubeadm reset</code>命令进行清理。</p> <h3 id="_2-3-安装包管理器helm-3"><a href="#_2-3-安装包管理器helm-3" class="header-anchor">#</a> 2.3 安装包管理器helm 3</h3> <p>Helm是Kubernetes的包管理器，后续流程也将使用Helm安装Kubernetes的常用组件。 这里先在master节点上安装helm。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">wget</span> https://get.helm.sh/helm-v3.9.0-linux-amd64.tar.gz
<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> helm-v3.9.0-linux-amd64.tar.gz
<span class="token function">mv</span> linux-amd64/helm  /usr/local/bin/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>执行<code>helm list</code>确认没有错误输出。</p> <h3 id="_2-4-部署pod-network组件calico"><a href="#_2-4-部署pod-network组件calico" class="header-anchor">#</a> 2.4 部署Pod Network组件Calico</h3> <p>选择calico作为k8s的Pod网络组件，下面使用helm在k8s集群中安装calico。</p> <p>下载<code>tigera-operator</code>的helm chart:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">wget</span> https://github.com/projectcalico/calico/releases/download/v3.23.1/tigera-operator-v3.23.1.tgz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查看这个chart的中可定制的配置:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>helm show values tigera-operator-v3.23.1.tgz

imagePullSecrets: <span class="token punctuation">{</span><span class="token punctuation">}</span>

installation:
  enabled: <span class="token boolean">true</span>
  kubernetesProvider: <span class="token string">&quot;&quot;</span>

apiServer:
  enabled: <span class="token boolean">true</span>

certs:
  node:
    key:
    cert:
    commonName:
  typha:
    key:
    cert:
    commonName:
    caBundle:

resources: <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment"># Configuration for the tigera operator</span>
tigeraOperator:
  image: tigera/operator
  version: v1.27.1
  registry: quay.io
calicoctl:
  image: docker.io/calico/ctl
  tag: v3.23.1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>定制的<code>values.yaml</code>如下:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 可针对上面的配置进行定制,例如calico的镜像改成从私有库拉取。</span>
<span class="token comment"># 这里只是个人本地环境测试k8s新版本，因此保留value.yaml为空即可</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>使用helm安装calico：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>helm <span class="token function">install</span> calico tigera-operator-v3.23.1.tgz <span class="token parameter variable">-n</span> kube-system  --create-namespace <span class="token parameter variable">-f</span> values.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>等待并确认所有pod处于Running状态:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubectl get pod -n kube-system | grep tigera-operator</span>
tigera-operator-5fb55776df-wxbph   <span class="token number">1</span>/1     Running   <span class="token number">0</span>             5m10s

kubectl get pods <span class="token parameter variable">-n</span> calico-system
NAME                                       READY   STATUS    RESTARTS   AGE
calico-kube-controllers-68884f975d-5d7p9   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m24s
calico-node-twbdh                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m24s
calico-typha-7b4bdd99c5-ssdn2              <span class="token number">1</span>/1     Running   <span class="token number">0</span>          5m24s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>查看一下calico向k8s中添加的api资源:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubectl api-resources | grep calico</span>
bgpconfigurations                                                                 crd.projectcalico.org/v1               <span class="token boolean">false</span>        BGPConfiguration
bgppeers                                                                          crd.projectcalico.org/v1               <span class="token boolean">false</span>        BGPPeer
blockaffinities                        
<span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这些api资源是属于calico的，因此不建议使用kubectl来管理，推荐按照calicoctl来管理这些api资源。 将calicoctl安装为kubectl的插件:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># cd /usr/local/bin</span>
<span class="token comment"># curl -o kubectl-calico -O -L  &quot;https://github.com/projectcalico/calicoctl/releases/download/v3.21.5/calicoctl-linux-amd64&quot; </span>
<span class="token comment"># chmod +x kubectl-calico</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>验证插件正常工作:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubectl calico -h</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_2-5-验证k8s-dns是否可用"><a href="#_2-5-验证k8s-dns是否可用" class="header-anchor">#</a> 2.5 验证k8s DNS是否可用</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubectl run curl --image=radial/busyboxplus:curl -it</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>进入后执行<code>nslookup kubernetes.default</code>确认解析正常:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span> root@curl:/ <span class="token punctuation">]</span>$ <span class="token function">nslookup</span> kubernetes.default
Server:    <span class="token number">10.96</span>.0.10
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.10 kube-dns.kube-system.svc.cluster.local

Name:      kubernetes.default
Address <span class="token number">1</span>: <span class="token number">10.96</span>.0.1 kubernetes.default.svc.cluster.local
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_2-6-向kubernetes集群中添加node节点"><a href="#_2-6-向kubernetes集群中添加node节点" class="header-anchor">#</a> 2.6 向Kubernetes集群中添加Node节点</h3> <p>下面将node1, node2添加到Kubernetes集群中，分别在node1, node2上执行:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubeadm join 192.168.200.101:6443 --token ftj2qv.ablclorkmxvdyl2q \</span>
<span class="token operator">&gt;</span>         --discovery-token-ca-cert-hash sha256:b97f28d3727a203678d623b6b1c72d036c053362f23f0242b614c4bfe6dd6f8c
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>node1和node2加入集群很是顺利，在master节点上执行命令查看集群中的节点：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubectl get node</span>
NAME    STATUS   ROLES                  AGE     VERSION
node1   Ready    control-plane,master   29m     v1.24.0
node2   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 70s     v1.24.0
node3   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                 58s     v1.24.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_3-kubernetes常用组件部署"><a href="#_3-kubernetes常用组件部署" class="header-anchor">#</a> 3.Kubernetes常用组件部署</h2> <h3 id="_3-1-使用helm部署ingress-nginx"><a href="#_3-1-使用helm部署ingress-nginx" class="header-anchor">#</a> 3.1 使用Helm部署ingress-nginx</h3> <p>为了便于将集群中的服务暴露到集群外部，需要使用Ingress。接下来使用Helm将ingress-nginx部署到Kubernetes上。 Nginx Ingress Controller被部署在Kubernetes的边缘节点上。</p> <p>这里将master作为边缘节点，打上Label：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubectl label node master node-role.kubernetes.io/edge=</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>下载ingress-nginx的helm chart:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">wget</span> https://github.com/kubernetes/ingress-nginx/releases/download/helm-chart-4.1.2/ingress-nginx-4.1.2.tgz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>查看<code>ingress-nginx-4.1.2.tgz</code>这个chart的可定制配置:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>helm show values ingress-nginx-4.1.2.tgz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对values.yaml配置定制如下:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>controller:
  ingressClassResource:
    name: nginx
    enabled: <span class="token boolean">true</span>
    default: <span class="token boolean">true</span>
    controllerValue: <span class="token string">&quot;k8s.io/ingress-nginx&quot;</span>
  admissionWebhooks:
    enabled: <span class="token boolean">false</span>
  replicaCount: <span class="token number">1</span>
  image:
    registry: docker.io
    image: unreachableg/k8s.gcr.io_ingress-nginx_controller
    tag: <span class="token string">&quot;v1.2.0&quot;</span>
    digest: sha256:314435f9465a7b2973e3aa4f2edad7465cc7bcdc8304be5d146d70e4da136e51
  hostNetwork: <span class="token boolean">true</span>
  nodeSelector:
    node-role.kubernetes.io/edge: <span class="token string">''</span>
  affinity:
    podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
            - key: app
              operator: In
              values:
              - nginx-ingress
            - key: component
              operator: In
              values:
              - controller
          topologyKey: kubernetes.io/hostname
  tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: PreferNoSchedule
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>nginx ingress controller的副本数replicaCount为1，将被调度到master这个边缘节点上。这里并没有指定nginx ingress controller service的externalIPs，而是通过<code>hostNetwork: true</code>设置nginx ingress controller使用宿主机网络。 因为k8s.gcr.io被墙，这里替换成unreachableg/k8s.gcr.io_ingress-nginx_controller提前拉取一下镜像:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># crictl pull unreachableg/k8s.gcr.io_ingress-nginx_controller:v1.2.0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># helm install ingress-nginx ingress-nginx-4.1.2.tgz --create-namespace -n ingress-nginx -f values.yaml</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubectl get pod -n ingress-nginx</span>
NAME                                        READY   STATUS    RESTARTS   AGE
ingress-nginx-controller-7f574989bc-xwbf4   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          117s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>测试访问<code>http://192.168.200.101</code>返回默认的nginx页，则部署完成。</p> <h3 id="_3-2-使用helm部署dashboard"><a href="#_3-2-使用helm部署dashboard" class="header-anchor">#</a> 3.2 使用Helm部署dashboard</h3> <p>先部署metrics-server：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">wget</span> https://github.com/kubernetes-sigs/metrics-server/releases/download/metrics-server-helm-chart-3.8.2/components.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>修改components.yaml中的image为<code>docker.io/unreachableg/k8s.gcr.io_metrics-server_metrics-server:v0.5.2</code>。 修改components.yaml中容器的启动参数，加入<code>--kubelet-insecure-tls=true</code>，在clusterrole里添加 nodes/stats。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> components.yaml

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>metrics-server的pod正常启动后，等一段时间就可以使用<code>kubectl top</code>查看集群和pod的metrics信息:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubectl top node</span>
NAME    CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   CPU%   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>   MEMORY%
master   509m         <span class="token number">12</span>%    3654Mi          <span class="token number">47</span>%
node1   133m         <span class="token number">3</span>%     1786Mi          <span class="token number">23</span>%
node2   117m         <span class="token number">2</span>%     1810Mi          <span class="token number">23</span>%
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubectl top pod -n kube-system</span>
NAME                               CPU<span class="token punctuation">(</span>cores<span class="token punctuation">)</span>   MEMORY<span class="token punctuation">(</span>bytes<span class="token punctuation">)</span>
coredns-74586cf9b6-575nl           6m           16Mi
coredns-74586cf9b6-mbn8s           5m           17Mi
etcd-node1                         49m          91Mi
kube-apiserver-node1               142m         490Mi
kube-controller-manager-node1      38m          54Mi
kube-proxy-k5lzs                   26m          19Mi
kube-proxy-rb5pf                   9m           15Mi
kube-proxy-w5zpk                   27m          16Mi
kube-scheduler-node1               7m           18Mi
metrics-server-8dfd488f5-r8pbh     8m           21Mi
tigera-operator-5fb55776df-wxbph   10m          38Mi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>接下来使用helm部署k8s的dashboard，添加chart repo:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/</span>
<span class="token comment"># helm repo update</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>查看chart的可定制配置:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># helm show values kubernetes-dashboard/kubernetes-dashboard</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对values.yaml定制配置如下:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">image</span><span class="token punctuation">:</span>
  <span class="token key atrule">repository</span><span class="token punctuation">:</span> kubernetesui/dashboard
  <span class="token key atrule">tag</span><span class="token punctuation">:</span> v2.5.1
<span class="token key atrule">ingress</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/ssl-redirect</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
    <span class="token key atrule">nginx.ingress.kubernetes.io/backend-protocol</span><span class="token punctuation">:</span> <span class="token string">&quot;HTTPS&quot;</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> k8s.example.com
  <span class="token key atrule">tls</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">secretName</span><span class="token punctuation">:</span> example<span class="token punctuation">-</span>com<span class="token punctuation">-</span>tls<span class="token punctuation">-</span>secret
      <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> k8s.example.com
<span class="token key atrule">metricsScraper</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>先创建存放<code>k8s.example.com</code>ssl证书的secret:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token punctuation">[</span>root@master dashboard<span class="token punctuation">]</span><span class="token comment"># mkdir crt</span>
<span class="token punctuation">[</span>root@master dashboard<span class="token punctuation">]</span><span class="token comment"># cd crt/</span>
<span class="token punctuation">[</span>root@master crt<span class="token punctuation">]</span><span class="token comment"># ll</span>
total <span class="token number">0</span>
<span class="token punctuation">[</span>root@master crt<span class="token punctuation">]</span><span class="token comment"># openssl genrsa -out ca.key 4096</span>
Generating RSA private key, <span class="token number">4096</span> bit long modulus
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>++
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>++
e is <span class="token number">65537</span> <span class="token punctuation">(</span>0x10001<span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@master crt<span class="token punctuation">]</span><span class="token comment"># openssl req -x509 -new -nodes -sha512 -days 3650 \</span>
  <span class="token parameter variable">-subj</span> <span class="token string">&quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=k8s.example.com&quot;</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">-key</span> ca.key <span class="token punctuation">\</span>
  <span class="token parameter variable">-out</span> ca.crt

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl create secret tls example-com-tls-secret <span class="token punctuation">\</span>
  <span class="token parameter variable">--cert</span><span class="token operator">=</span>ca.crt <span class="token punctuation">\</span>
  <span class="token parameter variable">--key</span><span class="token operator">=</span>ca.key <span class="token punctuation">\</span>
  <span class="token parameter variable">-n</span> kube-system
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>使用helm部署dashboard:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>helm <span class="token function">install</span> kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard <span class="token punctuation">\</span>
<span class="token parameter variable">-n</span> kube-system <span class="token punctuation">\</span>
<span class="token parameter variable">-f</span> values.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>确认上面的命令部署成功。</p> <p>创建管理员sa:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubectl create serviceaccount kube-dashboard-admin-sa -n kube-system</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># kubectl create clusterrolebinding kube-dashboard-admin-sa \</span>
<span class="token parameter variable">--clusterrole</span><span class="token operator">=</span>cluster-admin <span class="token parameter variable">--serviceaccount</span><span class="token operator">=</span>kube-system:kube-dashboard-admin-sa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>创建集群管理员登录dashboard所需token:</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl create token kube-dashboard-admin-sa <span class="token parameter variable">-n</span> kube-system <span class="token parameter variable">--duration</span><span class="token operator">=</span>87600h
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>使用上面的token登录k8s dashboard。</p> <p>[<img src="img/k8s-1.21-dashboard.png" alt="dashboard"></p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/wulinghui/TechnicalSummary/edit/master/docs/Kubernetes/02.k8s/90.k8s实战部署/01.部署k8s1.24版本.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/01/26, 22:57:26</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/8008ac/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">创建一个chart</div></a> <a href="/pages/18f4c5/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Harbor部署</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/8008ac/" class="prev">创建一个chart</a></span> <span class="next"><a href="/pages/18f4c5/">Harbor部署</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/fff88c/"><div>
            架构升级踩坑之路
            <!----></div></a> <span class="date">02-27</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/ba6503/"><div>
            总结
            <!----></div></a> <span class="date">02-27</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/1b4e40/"><div>
            语法学习
            <!----></div></a> <span class="date">02-27</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:873406903@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/wulinghui" title="GitHub(移步到gitee)" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/hellowllh/projects" title="gitee" target="_blank" class="iconfont icon-gitee"></a><a href="https://blog.csdn.net/qq_41720208" title="CSDN" target="_blank" class="iconfont icon-gitee"></a><a href="https://www.cnblogs.com/wlh1995" title="博客园" target="_blank" class="iconfont icon-bokeyuan"></a></div> 
    | Copyright © 2021-2025
    <span>Wu lingui | <a href="" target="_blank"></a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.7f63dd6c.js" defer></script><script src="/assets/js/2.fe5f2a1d.js" defer></script><script src="/assets/js/3.eb8c603e.js" defer></script><script src="/assets/js/36.fd6a950b.js" defer></script>
  </body>
</html>
