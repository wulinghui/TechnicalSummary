(window.webpackJsonp=window.webpackJsonp||[]).push([[52],{411:function(s,t,a){"use strict";a.r(t);var e=a(7),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"prometheus-operator"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#prometheus-operator"}},[s._v("#")]),s._v(" Prometheus Operator")]),s._v(" "),t("p",[s._v("Prometheus Operator 为监控 Kubernetes 资源和 Prometheus 实例的管理提供了简单的定义，简化在 Kubernetes 上部署、管理和运行 Prometheus 和 Alertmanager 集群。")]),s._v(" "),t("h2",{attrs:{id:"_1-安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装"}},[s._v("#")]),s._v(" 1. 安装")]),s._v(" "),t("h3",{attrs:{id:"_1-1-介绍"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-介绍"}},[s._v("#")]),s._v(" 1.1 介绍")]),s._v(" "),t("p",[s._v("首先我们先来了解下 Prometheus-Operator 的架构图：")]),s._v(" "),t("p",[t("img",{attrs:{src:"img/20200410141511.png",alt:"promtheus opeator"}})]),s._v(" "),t("p",[s._v("上图是 Prometheus-Operator 官方提供的架构图，各组件以不同的方式运行在 Kubernetes 集群中，其中 Operator 是最核心的部分，作为一个控制器，他会去创建Prometheus、ServiceMonitor、AlertManager 以及 PrometheusRule 4个 CRD 资源对象，然后会一直监控并维持这4个资源对象的状态。")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("Operator")]),s._v("：根据自定义资源来部署和管理 Prometheus Server，同时监控这些自定义资源事件的变化来做相应的处理，是整个系统的控制中心。")]),s._v(" "),t("li",[t("code",[s._v("Prometheus")]),s._v("：声明 Prometheus 资源对象期望的状态，Operator 确保这个资源对象运行时一直与定义保持一致。")]),s._v(" "),t("li",[t("code",[s._v("Prometheus Server")]),s._v("：Operator 根据自定义资源 Prometheus 类型中定义的内容而部署的 Prometheus Server 集群，这些自定义资源可以看作是用来管理 Prometheus Server 集群的 StatefulSets 资源。")]),s._v(" "),t("li",[t("code",[s._v("ServiceMonitor")]),s._v("：声明指定监控的服务，描述了一组被 Prometheus 监控的目标列表，就是 exporter 的抽象，用来提供 metrics 数据接口的工具。该资源通过 Labels 来选取对应的 Service Endpoint，让 Prometheus Server 通过选取的 Service 来获取 Metrics 信息。")]),s._v(" "),t("li",[t("code",[s._v("Service")]),s._v("：简单的说就是 Prometheus 监控的对象。")]),s._v(" "),t("li",[t("code",[s._v("Alertmanager")]),s._v("：定义 AlertManager 资源对象期望的状态，Operator 确保这个资源对象运行时一直与定义保持一致。")])]),s._v(" "),t("p",[s._v("这样我们要在集群中监控什么数据，就变成了直接去操作 Kubernetes 集群的资源对象了，是不是方便很多了。")]),s._v(" "),t("h3",{attrs:{id:"_1-2-安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-安装"}},[s._v("#")]),s._v(" 1.2 安装")]),s._v(" "),t("p",[s._v("我们可以使用 Helm 来快速安装 Prometheus Operator，也可以通过 "),t("a",{attrs:{href:"https://github.com/coreos/kube-prometheus",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/coreos/kube-prometheus"),t("OutboundLink")],1),s._v(" 项目来手动安装，我们这里采用手动安装的方式可以去了解更多的实现细节。")]),s._v(" "),t("p",[s._v("首先 clone 项目代码：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master operator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# git clone https://github.com/coreos/kube-prometheus.git")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master operator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ll")]),s._v("\ntotal "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\ndrwxr-xr-x "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(" root root "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v(" Oct "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" 07:52 kube-prometheus\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master operator"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd kube-prometheus/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master kube-prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd manifests/")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("进入到 "),t("code",[s._v("manifests")]),s._v(" 目录下面，首先我们需要安装 "),t("code",[s._v("setup")]),s._v(" 目录下面的 CRD 和 Operator 资源对象：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl create -f setup/      ")]),s._v("\ncustomresourcedefinition.apiextensions.k8s.io/alertmanagerconfigs.monitoring.coreos.com created\ncustomresourcedefinition.apiextensions.k8s.io/alertmanagers.monitoring.coreos.com created\ncustomresourcedefinition.apiextensions.k8s.io/podmonitors.monitoring.coreos.com created\ncustomresourcedefinition.apiextensions.k8s.io/probes.monitoring.coreos.com created\ncustomresourcedefinition.apiextensions.k8s.io/prometheuses.monitoring.coreos.com created\ncustomresourcedefinition.apiextensions.k8s.io/prometheusrules.monitoring.coreos.com created\ncustomresourcedefinition.apiextensions.k8s.io/servicemonitors.monitoring.coreos.com created\ncustomresourcedefinition.apiextensions.k8s.io/thanosrulers.monitoring.coreos.com created\nnamespace/monitoring created\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get ns")]),s._v("\nNAME               STATUS   AGE\nmonitoring         Active   2m14s\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get crd |grep coreos")]),s._v("\nalertmanagerconfigs.monitoring.coreos.com             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-10-14T15:23:48Z\nalertmanagers.monitoring.coreos.com                   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-10-14T15:23:48Z\npodmonitors.monitoring.coreos.com                     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-10-14T15:23:48Z\nprobes.monitoring.coreos.com                          "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-10-14T15:23:48Z\nprometheuses.monitoring.coreos.com                    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-10-14T15:23:48Z\nprometheusrules.monitoring.coreos.com                 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-10-14T15:23:48Z\nservicemonitors.monitoring.coreos.com                 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-10-14T15:23:48Z\nthanosrulers.monitoring.coreos.com                    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-10-14T15:23:49Z\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br")])]),t("p",[s._v("这会创建一个名为 "),t("code",[s._v("monitoring")]),s._v(" 的命名空间，以及相关的 CRD 资源对象声明。")]),s._v(" "),t("p",[s._v("在 "),t("code",[s._v("manifests")]),s._v(" 目录下面的就是我们要去创建的 Prometheus、Alertmanager 以及各种监控对象的资源清单。")]),s._v(" "),t("p",[s._v("没有特殊的定制需求我们可以直接一键安装：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f .")]),s._v("\nalertmanager.monitoring.coreos.com/main created\nnetworkpolicy.networking.k8s.io/alertmanager-main created\npoddisruptionbudget.policy/alertmanager-main created\nprometheusrule.monitoring.coreos.com/alertmanager-main-rules created\nsecret/alertmanager-main created\nservice/alertmanager-main created\nserviceaccount/alertmanager-main created\nservicemonitor.monitoring.coreos.com/alertmanager-main created\nclusterrole.rbac.authorization.k8s.io/blackbox-exporter created\nclusterrolebinding.rbac.authorization.k8s.io/blackbox-exporter created\nconfigmap/blackbox-exporter-configuration created\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("这会自动安装 node-exporter、kube-state-metrics、grafana、prometheus-adapter 以及 prometheus 和 alertmanager ,operator,blackbox_exporter 组件，而且 prometheus 和 alertmanager 还是多副本的。")]),s._v(" "),t("p",[s._v("blackbox exporter 可以实现对 "),t("code",[s._v("http")]),s._v("，"),t("code",[s._v("https")]),s._v("，"),t("code",[s._v("tcp(可以实现服务器接口是否在线)")]),s._v("，"),t("code",[s._v("icmp(实现主机探活)")]),s._v("，"),t("code",[s._v("dns")]),s._v("的探测。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods -n monitoring")]),s._v("\nNAME                                  READY   STATUS              RESTARTS   AGE\nalertmanager-main-0                   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/2     ContainerCreating   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          24s\nalertmanager-main-1                   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/2     ContainerCreating   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          24s\nalertmanager-main-2                   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/2     ContainerCreating   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          24s\nblackbox-exporter-c5547b8bb-5h5gb     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/3     ContainerCreating   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          37s\ngrafana-7c4645d965-ffzqg              "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     ContainerCreating   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          37s\nkube-state-metrics-8658546b69-v728r   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/3     ContainerCreating   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          37s\nnode-exporter-62sm7                   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/2     ContainerCreating   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          36s\nnode-exporter-g57tr                   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          36s\nnode-exporter-p5kqx                   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/2     ContainerCreating   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          36s\nprometheus-adapter-678b454b8b-n4kz6   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     ErrImagePull        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          36s\nprometheus-adapter-678b454b8b-t2w8r   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     ContainerCreating   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          36s\nprometheus-k8s-0                      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/2     PodInitializing     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          23s\nprometheus-k8s-1                      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/2     PodInitializing     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          23s\nprometheus-operator-5ddfd64d6-87m7h   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/2     ContainerCreating   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          36s\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc -n monitoring")]),s._v("\nNAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                      AGE\nalertmanager-main       ClusterIP   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.107")]),s._v(".154.95    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9093")]),s._v("/TCP,8080/TCP            2m7s\nalertmanager-operated   ClusterIP   None             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9093")]),s._v("/TCP,9094/TCP,9094/UDP   114s\nblackbox-exporter       ClusterIP   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.106")]),s._v(".242.209   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9115")]),s._v("/TCP,19115/TCP           2m7s\ngrafana                 ClusterIP   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.103")]),s._v(".252.136   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v("/TCP                     2m7s\nkube-state-metrics      ClusterIP   None             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8443")]),s._v("/TCP,9443/TCP            2m7s\nnode-exporter           ClusterIP   None             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9100")]),s._v("/TCP                     2m6s\nprometheus-adapter      ClusterIP   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.100")]),s._v(".17.155    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("/TCP                      2m6s\nprometheus-k8s          ClusterIP   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.111")]),s._v(".69.230    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9090")]),s._v("/TCP,8080/TCP            2m6s\nprometheus-operated     ClusterIP   None             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9090")]),s._v("/TCP                     114s\nprometheus-operator     ClusterIP   None             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8443")]),s._v("/TCP                     2m6s\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br")])]),t("p",[s._v("注意：有些服务启动会有问题，还是镜像翻墙问题，可以做一些修改")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl edit deploy kube-state-metrics -n monitoring")]),s._v("\nimage: bitnami/kube-state-metrics:2.6.0\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl edit deploy prometheus-adapter -n monitoring")]),s._v("\nwilldockerhub/prometheus-adapter:v0.9.1\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("可以看到上面针对 grafana、alertmanager 和 prometheus 都创建了一个类型为 ClusterIP 的 Service，当然如果我们想要在外网访问这两个服务的话可以通过创建对应的 Ingress 对象或者使用 NodePort 类型的 Service，我们这里为了简单，直接使用 NodePort 类型的服务即可，编辑 grafana、alertmanager-main 和 prometheus-k8s 这3个 Service，将服务类型更改为 NodePort:")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 将 type: ClusterIP 更改为 type: NodePort")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl edit svc grafana -n monitoring ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl edit svc alertmanager-main -n monitoring")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl edit svc prometheus-k8s -n monitoring")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc -n monitoring")]),s._v("\nNAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                         AGE\nalertmanager-main       NodePort    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.107")]),s._v(".154.95    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9093")]),s._v(":30353/TCP,8080:30764/TCP   4m12s\nalertmanager-operated   ClusterIP   None             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9093")]),s._v("/TCP,9094/TCP,9094/UDP      3m59s\nblackbox-exporter       ClusterIP   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.106")]),s._v(".242.209   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9115")]),s._v("/TCP,19115/TCP              4m12s\ngrafana                 NodePort    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.103")]),s._v(".252.136   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v(":30674/TCP                  4m12s\nkube-state-metrics      ClusterIP   None             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8443")]),s._v("/TCP,9443/TCP               4m12s\nnode-exporter           ClusterIP   None             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9100")]),s._v("/TCP                        4m11s\nprometheus-adapter      ClusterIP   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.100")]),s._v(".17.155    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("443")]),s._v("/TCP                         4m11s\nprometheus-k8s          NodePort    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.111")]),s._v(".69.230    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9090")]),s._v(":32687/TCP,8080:31305/TCP   4m11s\nprometheus-operated     ClusterIP   None             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9090")]),s._v("/TCP                        3m59s\nprometheus-operator     ClusterIP   None             "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8443")]),s._v("/TCP                        4m11s\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("更改完成后，我们就可以通过上面的 NodePort 去访问对应的服务了，比如查看 prometheus 的服务发现页面：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 网络策略相关的 删除 影响访问")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl delete -f prometheus-networkPolicy.yaml ")]),s._v("\nnetworkpolicy.networking.k8s.io "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"prometheus-k8s"')]),s._v(" deleted\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl delete -f grafana-networkPolicy.yaml ")]),s._v("\nnetworkpolicy.networking.k8s.io "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"grafana"')]),s._v(" deleted\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl delete -f alertmanager-networkPolicy.yaml ")]),s._v("\nnetworkpolicy.networking.k8s.io "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alertmanager-main"')]),s._v(" deleted\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[t("img",{attrs:{src:"img/image-20221015003129965.png",alt:"image-20221015003129965"}})]),s._v(" "),t("p",[s._v("可以看到已经监控上了很多指标数据了，上面我们可以看到 Prometheus 是两个副本，我们这里通过 Service 去访问， Service 在创建的时候添加了 "),t("code",[s._v("sessionAffinity: ClientIP")]),s._v(" 这样的属性，会根据 "),t("code",[s._v("ClientIP")]),s._v(" 来做 session 亲和性，所以我们不用担心请求会到不同的副本上去：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/component")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/instance")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" k8s\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/part-of")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 2.39.1\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("k8s\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" monitoring\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" web\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9090")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" web\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" reloader"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("web\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" reloader"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("web\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/component")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/instance")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" k8s\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/part-of")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("prometheus\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("sessionAffinity")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClientIP\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NodePort\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br")])]),t("h3",{attrs:{id:"_1-3-配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-配置"}},[s._v("#")]),s._v(" 1.3 配置")]),s._v(" "),t("p",[t("img",{attrs:{src:"img/image-20221015004147227.png",alt:"image-20221015004147227"}})]),s._v(" "),t("p",[s._v("在监控中我们并没有发现kube-scheduler和KubeControllerManager的监控")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat kubernetesControlPlane-serviceMonitorKubeScheduler.yaml")]),s._v("\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  labels:\n    app.kubernetes.io/name: kube-scheduler\n    app.kubernetes.io/part-of: kube-prometheus\n  name: kube-scheduler\n  namespace: monitoring\nspec:\n  endpoints:\n  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token\n    interval: 30s\n    port: https-metrics\n    scheme: https\n    tlsConfig:\n      insecureSkipVerify: "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  jobLabel: app.kubernetes.io/name\n  namespaceSelector:\n    matchNames:\n    - kube-system\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: kube-scheduler\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br")])]),t("p",[s._v("我们需要去创建一个对应的 Service 对象,和上方的 "),t("code",[s._v("ServiceMonitor")]),s._v(" 进行关联：(prometheus-kubeSchedulerService.yaml)")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("scheduler\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("scheduler\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("component")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("scheduler\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" https"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("metrics\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10259")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10259")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("其中最重要的是上面 labels 和 selector 部分，labels 区域的配置必须和我们上面的 ServiceMonitor 对象中的 selector 保持一致，selector 下面配置的是 "),t("code",[s._v("component=kube-scheduler")]),s._v("，为什么会是这个 label 标签呢，我们可以去 describe 下 kube-scheduler 这个 Pod：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl describe pod kube-scheduler-master -n kube-system  ")]),s._v("\nName:                 kube-scheduler-master\nNamespace:            kube-system\nPriority:             "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000001000")]),s._v("\nPriority Class Name:  system-node-critical\nNode:                 master/192.168.200.101\nStart Time:           Fri, "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(" Oct "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":09:42 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-0400")]),s._v("\nLabels:               "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("component")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kube-scheduler\n                      "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("tier")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("control-plane\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("我们可以看到这个 Pod 具有 "),t("code",[s._v("component=kube-scheduler")]),s._v(" 和 "),t("code",[s._v("tier=control-plane")]),s._v(" 这两个标签，而前面这个标签具有更唯一的特性，所以使用前面这个标签较好，这样上面创建的 Service 就可以和我们的 Pod 进行关联了，直接创建即可：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f prometheus-kubeSchedulerService.yaml ")]),s._v("\nservice/kube-scheduler created\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("kube-scheduler使用了--secure-port绑定到127.0.0.1而不是0.0.0.0，所以会出现连接不上的情况，还需要修改：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/kubernetes/manifests/kube-scheduler.yaml ")]),s._v("\n- --bind-address"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".0.0\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("创建完成后，隔一小会儿后去 Prometheus 页面上查看 targets 下面 kube-scheduler 已经可以采集到指标数据了。")]),s._v(" "),t("p",[t("img",{attrs:{src:"img/image-20221015010454869.png",alt:"image-20221015010454869"}})]),s._v(" "),t("p",[s._v("可以用同样的方式来修复下 kube-controller-manager 组件的监控。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat kubernetesControlPlane-serviceMonitorKubeControllerManager.yaml ")]),s._v("\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  labels:\n    app.kubernetes.io/name: kube-controller-manager\n    app.kubernetes.io/part-of: kube-prometheus\n  name: kube-controller-manager\n  namespace: monitoring\nspec:\n  endpoints:\n  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token\n    interval: 30s\n    metricRelabelings:\n    - action: drop\n      regex: kubelet_"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("pod_worker_latency_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("pod_start_latency_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("cgroup_manager_latency_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("pod_worker_start_latency_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("pleg_relist_latency_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("pleg_relist_interval_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("runtime_operations"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("runtime_operations_latency_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("runtime_operations_errors"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("eviction_stats_age_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("device_plugin_registration_count"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("device_plugin_alloc_latency_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("network_plugin_operations_latency_microseconds"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      sourceLabels:\n      - __name__\n    - action: drop\n      regex: scheduler_"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("e2e_scheduling_latency_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("scheduling_algorithm_predicate_evaluation"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("scheduling_algorithm_priority_evaluation"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("scheduling_algorithm_preemption_evaluation"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("scheduling_algorithm_latency_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("binding_latency_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("scheduling_latency_seconds"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      sourceLabels:\n      - __name__\n    - action: drop\n      regex: apiserver_"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("request_count"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("request_latencies"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("request_latencies_summary"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("dropped_requests"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("storage_data_key_generation_latencies_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("storage_transformation_failures_total"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("storage_transformation_latencies_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("proxy_tunnel_sync_latency_secs"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("longrunning_gauge"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("registered_watchers"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      sourceLabels:\n      - __name__\n    - action: drop\n      regex: kubelet_docker_"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("operations"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("operations_latency_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("operations_errors"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("operations_timeout"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      sourceLabels:\n      - __name__\n    - action: drop\n      regex: reflector_"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("items_per_list"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("items_per_watch"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("list_duration_seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("lists_total"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("short_watches_total"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("watch_duration_seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("watches_total"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      sourceLabels:\n      - __name__\n    - action: drop\n      regex: etcd_"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("helper_cache_hit_count"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("helper_cache_miss_count"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("helper_cache_entry_count"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("object_counts"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("request_cache_get_latencies_summary"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("request_cache_add_latencies_summary"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("request_latencies_summary"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      sourceLabels:\n      - __name__\n    - action: drop\n      regex: transformation_"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("transformation_latencies_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("failures_total"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      sourceLabels:\n      - __name__\n    - action: drop\n      regex: "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("admission_quota_controller_adds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("admission_quota_controller_depth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("admission_quota_controller_longest_running_processor_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("admission_quota_controller_queue_latency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("admission_quota_controller_unfinished_work_seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("admission_quota_controller_work_duration"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("APIServiceOpenAPIAggregationControllerQueue1_adds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("APIServiceOpenAPIAggregationControllerQueue1_depth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("APIServiceOpenAPIAggregationControllerQueue1_longest_running_processor_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("APIServiceOpenAPIAggregationControllerQueue1_queue_latency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("APIServiceOpenAPIAggregationControllerQueue1_retries"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("APIServiceOpenAPIAggregationControllerQueue1_unfinished_work_seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("APIServiceOpenAPIAggregationControllerQueue1_work_duration"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("APIServiceRegistrationController_adds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("APIServiceRegistrationController_depth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("APIServiceRegistrationController_longest_running_processor_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("APIServiceRegistrationController_queue_latency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("APIServiceRegistrationController_retries"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("APIServiceRegistrationController_unfinished_work_seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("APIServiceRegistrationController_work_duration"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("autoregister_adds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("autoregister_depth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("autoregister_longest_running_processor_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("autoregister_queue_latency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("autoregister_retries"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("autoregister_unfinished_work_seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("autoregister_work_duration"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("AvailableConditionController_adds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("AvailableConditionController_depth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("AvailableConditionController_longest_running_processor_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("AvailableConditionController_queue_latency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("AvailableConditionController_retries"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("AvailableConditionController_unfinished_work_seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("AvailableConditionController_work_duration"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_autoregistration_controller_adds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_autoregistration_controller_depth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_autoregistration_controller_longest_running_processor_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_autoregistration_controller_queue_latency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_autoregistration_controller_retries"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_autoregistration_controller_unfinished_work_seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_autoregistration_controller_work_duration"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crdEstablishing_adds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crdEstablishing_depth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crdEstablishing_longest_running_processor_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crdEstablishing_queue_latency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crdEstablishing_retries"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crdEstablishing_unfinished_work_seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crdEstablishing_work_duration"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_finalizer_adds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_finalizer_depth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_finalizer_longest_running_processor_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_finalizer_queue_latency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_finalizer_retries"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_finalizer_unfinished_work_seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_finalizer_work_duration"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_naming_condition_controller_adds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_naming_condition_controller_depth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_naming_condition_controller_longest_running_processor_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_naming_condition_controller_queue_latency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_naming_condition_controller_retries"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_naming_condition_controller_unfinished_work_seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_naming_condition_controller_work_duration"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_openapi_controller_adds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_openapi_controller_depth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_openapi_controller_longest_running_processor_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_openapi_controller_queue_latency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_openapi_controller_retries"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_openapi_controller_unfinished_work_seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("crd_openapi_controller_work_duration"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("DiscoveryController_adds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("DiscoveryController_depth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("DiscoveryController_longest_running_processor_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("DiscoveryController_queue_latency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("DiscoveryController_retries"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("DiscoveryController_unfinished_work_seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("DiscoveryController_work_duration"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("kubeproxy_sync_proxy_rules_latency_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("non_structural_schema_condition_controller_adds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("non_structural_schema_condition_controller_depth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("non_structural_schema_condition_controller_longest_running_processor_microseconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("non_structural_schema_condition_controller_queue_latency"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("non_structural_schema_condition_controller_retries"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("non_structural_schema_condition_controller_unfinished_work_seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("non_structural_schema_condition_controller_work_duration"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("rest_client_request_latency_seconds"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("storage_operation_errors_total"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("storage_operation_status_count"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      sourceLabels:\n      - __name__\n    - action: drop\n      regex: etcd_"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("debugging"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("disk"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("request"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".*\n      sourceLabels:\n      - __name__\n    port: https-metrics\n    scheme: https\n    tlsConfig:\n      insecureSkipVerify: "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n  jobLabel: app.kubernetes.io/name\n  namespaceSelector:\n    matchNames:\n    - kube-system\n  selector:\n    matchLabels:\n      app.kubernetes.io/name: kube-controller-manager\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br"),t("span",{staticClass:"line-number"},[s._v("61")]),t("br")])]),t("p",[s._v("创建一个如下所示的 Service 对象：(prometheus-kubeControllerManagerService.yaml)")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("controller"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("manager\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("controller"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("manager\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("component")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("controller"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("manager\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" https"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("metrics\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10257")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10257")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/kubernetes/manifests/kube-controller-manager.yaml")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[t("img",{attrs:{src:"img/image-20221015010906225.png",alt:"image-20221015010906225"}})]),s._v(" "),t("p",[s._v("上面的监控数据配置完成后，我们就可以去查看下 Grafana 下面的监控图表了，同样使用上面的 NodePort 访问即可，第一次登录使用 "),t("code",[s._v("admin:admin")]),s._v(" 登录即可，进入首页后，我们可以发现其实 Grafana 已经有很多配置好的监控图表了。")]),s._v(" "),t("p",[t("img",{attrs:{src:"img/image-20221015011011305.png",alt:"image-20221015011011305"}})]),s._v(" "),t("p",[s._v("我们可以随便选择一个 Dashboard 查看监控图表信息。")]),s._v(" "),t("p",[t("img",{attrs:{src:"img/image-20221015011039793.png",alt:"image-20221015011039793"}})]),s._v(" "),t("p",[s._v("接下来我们再来学习如何完全自定义一个 "),t("code",[s._v("ServiceMonitor")]),s._v(" 以及 AlertManager 相关的配置")]),s._v(" "),t("h2",{attrs:{id:"_2-自定义监控报警"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-自定义监控报警"}},[s._v("#")]),s._v(" 2. 自定义监控报警")]),s._v(" "),t("p",[s._v("除了 Kubernetes 集群中的一些资源对象、节点以及组件需要监控，有的时候我们可能还需要根据实际的业务需求去添加自定义的监控项，添加一个自定义监控的步骤也是非常简单的。")]),s._v(" "),t("ul",[t("li",[s._v("第一步建立一个 ServiceMonitor 对象，用于 Prometheus 添加监控项")]),s._v(" "),t("li",[s._v("第二步为 ServiceMonitor 对象关联 metrics 数据接口的一个 Service 对象")]),s._v(" "),t("li",[s._v("第三步确保 Service 对象可以正确获取到 metrics 数据")])]),s._v(" "),t("p",[s._v("接下来我们就来为大家演示如何添加 "),t("code",[s._v("etcd")]),s._v(" 集群的监控。无论是 Kubernetes 集群外的还是使用 Kubeadm 安装在集群内部的 etcd 集群，我们这里都将其视作集群外的独立集群，因为对于二者的使用方法没什么特殊之处。")]),s._v(" "),t("h3",{attrs:{id:"_2-1-etcd-监控"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-etcd-监控"}},[s._v("#")]),s._v(" 2.1 etcd 监控")]),s._v(" "),t("p",[s._v("由于我们这里的环境使用的是 Kubeadm 搭建的集群，我们可以使用 kubectl 工具去获取 etcd 启动的相关参数：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods -n kube-system -l component=etcd")]),s._v("\nNAME          READY   STATUS    RESTARTS       AGE\netcd-master   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("61m ago"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   21d\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods etcd-master -n kube-system -o yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\nspec:\n  containers:\n  - command:\n    - etcd\n    - --advertise-client-urls"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://192.168.200.101:2379\n    - --cert-file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/server.crt\n    - --client-cert-auth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n    - --data-dir"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/lib/etcd\n    - --experimental-initial-corrupt-check"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n    - --initial-advertise-peer-urls"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://192.168.200.101:2380\n    - --initial-cluster"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("master"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://192.168.200.101:2380\n    - --key-file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/server.key\n    - --listen-client-urls"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://127.0.0.1:2379,https://192.168.200.101:2379\n    - --listen-metrics-urls"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://127.0.0.1:2381\n    - --listen-peer-urls"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://192.168.200.101:2380\n    - "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("master\n    - --peer-cert-file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/peer.crt\n    - --peer-client-cert-auth"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n    - --peer-key-file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/peer.key\n    - --peer-trusted-ca-file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/ca.crt\n    - --snapshot-count"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10000")]),s._v("\n    - --trusted-ca-file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/ca.crt\n    image: registry.aliyuncs.com/google_containers/etcd:3.5.3-0\n    imagePullPolicy: IfNotPresent\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n    volumeMounts:\n    - mountPath: /var/lib/etcd\n      name: etcd-data\n    - mountPath: /etc/kubernetes/pki/etcd\n      name: etcd-certs\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n  volumes:\n  - hostPath:\n      path: /etc/kubernetes/pki/etcd\n      type: DirectoryOrCreate\n    name: etcd-certs\n  - hostPath:\n      path: /var/lib/etcd\n      type: DirectoryOrCreate\n    name: etcd-data\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br")])]),t("p",[s._v("我们可以看到启动参数里面有一个 "),t("code",[s._v("--listen-metrics-urls=http://127.0.0.1:2381")]),s._v(" 的配置，该参数就是来指定 metrics 接口运行在 2381 端口下面的，而且是 http 的协议，所以也不需要什么证书配置。")]),s._v(" "),t("p",[s._v("接下来我们直接创建对应的 ServiceMonitor 对象即可（prometheus-serviceMonitorEtcd.yaml）:")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" monitoring.coreos.com/v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ServiceMonitor\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("k8s\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" monitoring\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("k8s-app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("k8s\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("jobLabel")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("app\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("endpoints")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" port\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("interval")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 15s\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("k8s-app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespaceSelector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchNames")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[s._v("上面我们在 monitoring 命名空间下面创建了名为 etcd-k8s 的 ServiceMonitor 对象，匹配 kube-system 这个命名空间下面的具有 "),t("code",[s._v("k8s-app=etcd")]),s._v(" 这个 label 标签的 Service，"),t("code",[s._v("jobLabel")]),s._v(" 表示用于检索 job 任务名称的标签，由于 etcd 的 metrics 接口在 2381 端口下面，不需要 https 安全认证，所以用默认的配置即可。关于 ServiceMonitor 更多的配置属性，可以参考"),t("a",{attrs:{href:"https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#servicemonitorspec",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方的 API 文档"),t("OutboundLink")],1),s._v("的描述。")]),s._v(" "),t("p",[s._v("然后我们直接创建这个 ServiceMonitor 对象即可：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f prometheus-serviceMonitorEtcd.yaml")]),s._v("\nservicemonitor.monitoring.coreos.com/etcd-k8s created\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("但实际上现在并不能监控到 etcd 集群，因为并没有一个满足 ServiceMonitor 条件的 Service 对象与之关联：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc -n kube-system -l k8s-app=etcd")]),s._v("\nNo resources found "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" kube-system namespace.\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("所以接下来我们需要创建一个满足上面条件的 Service 对象，由于我们把 etcd 当成是集群外部的服务，所以要引入到集群中来我们就需要自定义 Endpoints 对象来创建 Service 对象了：(etcd-service.yaml)")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("k8s\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("k8s-app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterIP\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("clusterIP")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" None  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一定要设置 clusterIP:None")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" port\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2381")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Endpoints\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("k8s\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("k8s-app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("subsets")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("addresses")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ip")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.200.101  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 指定etcd节点地址，如果是集群则继续向下添加")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodeName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etc"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" port\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2381")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br")])]),t("p",[s._v("我们这里创建的 Service 没有采用前面通过 label 标签的形式去匹配 Pod 的做法，因为前面我们说过很多时候我们创建的 etcd 集群是独立于集群之外的，这种情况下面我们就需要自定义一个 Endpoints，要注意 "),t("code",[s._v("metadata")]),s._v(" 区域的内容要和 Service 保持一致，Service 的 clusterIP 设置为 None，新版本的 etcd 将 metrics 接口数据放置到了 2381 端口。直接创建该资源对象即可：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f etcd-service.yaml")]),s._v("\nservice/etcd-k8s created\nendpoints/etcd-k8s created\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc -n kube-system -l k8s-app=etcd")]),s._v("\nNAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("    AGE\netcd-k8s   ClusterIP   None         "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2381")]),s._v("/TCP   4s\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("创建完成后，隔一会儿去 Prometheus 的 Dashboard 中查看 targets，便会有 etcd 的监控项了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"img/image-20221015011731793.png",alt:"image-20221015011731793"}})]),s._v(" "),t("p",[s._v("可以看到有一个明显的错误，2381 端口链接被拒绝，这是因为我们这里的 etcd 的 metrics 接口是监听在 "),t("code",[s._v("127.0.0.1")]),s._v(" 这个 IP 上面的，所以访问会拒绝：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("--listen-metrics-urls"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://127.0.0.1:2381\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("我们只需要在 "),t("code",[s._v("/etc/kubernetes/manifest/")]),s._v(" 目录下面（静态 Pod 默认的目录）的 "),t("code",[s._v("etcd.yaml")]),s._v(" 文件中将上面的"),t("code",[s._v("listen-metrics-urls")]),s._v(" 更改成节点 IP 即可：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("--listen-metrics-urls"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http://0.0.0.0:2381\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("当 etcd 重启生效后，查看 etcd 这个监控任务就正常了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"img/image-20221015012432377.png",alt:"image-20221015012432377"}})]),s._v(" "),t("p",[s._v("数据采集到后，可以在 grafana 中导入编号为 "),t("code",[s._v("10323")]),s._v(" 的 dashboard，就可以获取到 etcd 的监控图表：")]),s._v(" "),t("p",[t("img",{attrs:{src:"img/image-20221015013007713.png",alt:"image-20221015013007713"}})]),s._v(" "),t("h3",{attrs:{id:"_2-2-配置-prometheusrule"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-配置-prometheusrule"}},[s._v("#")]),s._v(" 2.2 配置 PrometheusRule")]),s._v(" "),t("p",[s._v("现在我们知道怎么自定义一个 "),t("code",[s._v("ServiceMonitor")]),s._v(" 对象了，但是如果需要自定义一个报警规则的话呢？我们去查看 Prometheus Dashboard 的 Alert 页面下面就已经有很多报警规则了，这一系列的规则其实都来自于项目 https://github.com/kubernetes-monitoring/kubernetes-mixin，我们都通过 Prometheus Operator 安装配置上了。")]),s._v(" "),t("p",[s._v("但是这些报警信息是哪里来的呢？他们应该用怎样的方式通知我们呢？我们知道之前我们使用自定义的方式可以在 Prometheus 的配置文件之中指定 AlertManager 实例和 报警的 rules 文件，现在我们通过 Operator 部署的呢？我们可以在 Prometheus Dashboard 的 Config 页面下面查看关于 AlertManager 的配置：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("alerting")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("alert_relabel_configs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("separator")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ;\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus_replica\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replacement")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" $1\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" labeldrop\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("alertmanagers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("follow_redirects")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("enable_http2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("scheme")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" http\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path_prefix")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("timeout")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10s\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("api_version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v2\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("relabel_configs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_service_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("separator")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ;\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" alertmanager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("main\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replacement")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" $1\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" keep\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_endpoint_port_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("separator")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ;\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" web\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replacement")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" $1\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" keep\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetes_sd_configs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" endpoints\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubeconfig_file")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("follow_redirects")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("enable_http2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespaces")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("own_namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("names")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" monitoring\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rule_files")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /etc/prometheus/rules/prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("k8s"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rulefiles"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("0/"),t("span",{pre:!0,attrs:{class:"token important"}},[s._v("*.yaml")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br")])]),t("p",[s._v("上面 "),t("code",[s._v("alertmanagers")]),s._v(" 的配置我们可以看到是通过 role 为 "),t("code",[s._v("endpoints")]),s._v(" 的 kubernetes 的自动发现机制获取的，匹配的是服务名为 "),t("code",[s._v("alertmanager-main")]),s._v("，端口名为 web 的 Service 服务，我们可以查看下 alertmanager-main 这个 Service：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl describe svc alertmanager-main -n monitoring")]),s._v("\nName:                     alertmanager-main\nNamespace:                monitoring\nLabels:                   app.kubernetes.io/component"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("alert-router\n                          app.kubernetes.io/instance"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("main\n                          app.kubernetes.io/name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("alertmanager\n                          app.kubernetes.io/part-of"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kube-prometheus\n                          app.kubernetes.io/version"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.24")]),s._v(".0\nAnnotations:              "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nSelector:                 app.kubernetes.io/component"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("alert-router,app.kubernetes.io/instance"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("main,app.kubernetes.io/name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("alertmanager,app.kubernetes.io/part-of"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kube-prometheus\nType:                     NodePort\nIP Family Policy:         SingleStack\nIP Families:              IPv4\nIP:                       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.101")]),s._v(".111.78\nIPs:                      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.101")]),s._v(".111.78\nPort:                     web  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9093")]),s._v("/TCP\nTargetPort:               web/TCP\nNodePort:                 web  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("31999")]),s._v("/TCP\nEndpoints:                "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".104.29:9093,10.244.166.148:9093,10.244.166.150:9093\nPort:                     reloader-web  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8080")]),s._v("/TCP\nTargetPort:               reloader-web/TCP\nNodePort:                 reloader-web  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("32208")]),s._v("/TCP\nEndpoints:                "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".104.29:8080,10.244.166.148:8080,10.244.166.150:8080\nSession Affinity:         ClientIP\nExternal Traffic Policy:  Cluster\nEvents:                   "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br")])]),t("p",[s._v("可以看到服务名正是 "),t("code",[s._v("alertmanager-main")]),s._v("，Port 定义的名称也是 "),t("code",[s._v("web")]),s._v("，符合上面的规则，所以 Prometheus 和 AlertManager 组件就正确关联上了。而对应的报警规则文件位于："),t("code",[s._v("/etc/prometheus/rules/prometheus-k8s-rulefiles-0/")]),s._v("目录下面所有的 YAML 文件。我们可以进入 Prometheus 的 Pod 中验证下该目录下面是否有 YAML 文件：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec -it prometheus-k8s-0  -n monitoring -- /bin/sh")]),s._v("\n/prometheus $ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /etc/prometheus/rules/prometheus-k8s-rulefiles-0/\nmonitoring-alertmanager-main-rules-65684fa0-2ac2-44cb-8285-c600ef0337d9.yaml\nmonitoring-grafana-rules-94dbedc4-7498-4acb-942d-aac98fd61a0d.yaml\nmonitoring-kube-prometheus-rules-00aef2e2-2f47-4274-9c64-80e786f52959.yaml\nmonitoring-kube-state-metrics-rules-570164d9-a73a-4103-b1ca-32d2a0870ac1.yaml\nmonitoring-kubernetes-monitoring-rules-e6ac08d1-8378-4de7-add7-93532af0690f.yaml\nmonitoring-node-exporter-rules-5ebbb7d5-2e8b-44b7-bf88-b7de3916ac1e.yaml\nmonitoring-prometheus-k8s-prometheus-rules-26d84cbb-baf7-4654-b00d-05f66b4ddef0.yaml\nmonitoring-prometheus-operator-rules-cf0a2d8b-f9c8-48ff-87f2-664a1f95a34f.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat prometheus-prometheusRule.yaml ")]),s._v("\napiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  labels:\n    app.kubernetes.io/component: prometheus\n    app.kubernetes.io/instance: k8s\n    app.kubernetes.io/name: prometheus\n    app.kubernetes.io/part-of: kube-prometheus\n    app.kubernetes.io/version: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.39")]),s._v(".1\n    prometheus: k8s\n    role: alert-rules\n  name: prometheus-k8s-prometheus-rules\n  namespace: monitoring\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("我们这里的 "),t("code",[s._v("PrometheusRule")]),s._v(" 的 name 为 "),t("code",[s._v("prometheus-k8s-prometheus-rules")]),s._v("，namespace 为 "),t("code",[s._v("monitoring")]),s._v("，我们可以猜想到我们创建一个 PrometheusRule 资源对象后，会自动在上面的 "),t("code",[s._v("prometheus-k8s-rulefiles-0")]),s._v(" 目录下面生成一个对应的 "),t("code",[s._v("<namespace>-<name>.yaml")]),s._v(" 文件，所以如果以后我们需要自定义一个报警选项的话，只需要定义一个 "),t("code",[s._v("PrometheusRule")]),s._v(" 资源对象即可。至于为什么 Prometheus 能够识别这个 PrometheusRule 资源对象呢？只要具有 "),t("code",[s._v("prometheus=k8s")]),s._v(" 和 "),t("code",[s._v("role=alert-rules")]),s._v(" 标签的 "),t("code",[s._v("PrometheusRule")]),s._v(" 资源对象，就能够被识别。")]),s._v(" "),t("p",[s._v("所以我们要想自定义一个报警规则，只需要创建一个具有 "),t("code",[s._v("prometheus=k8s")]),s._v(" 和 "),t("code",[s._v("role=alert-rules")]),s._v(" 标签的 "),t("code",[s._v("PrometheusRule")]),s._v(" 对象就行了，比如现在我们添加一个 etcd 是否可用的报警，我们知道 etcd 整个集群有一半以上的节点可用的话集群就是可用的，所以我们判断如果不可用的 etcd 数量超过了一半那么就触发报警，创建文件 "),t("code",[s._v("prometheus-etcdRules.yaml")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" monitoring.coreos.com/v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" PrometheusRule\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("prometheus")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" k8s\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" alert"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rules\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rules\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" monitoring\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("groups")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rules")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("alert")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" EtcdClusterUnavailable\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("annotations")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("summary")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd cluster small\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("description")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" If one more etcd peer goes down the cluster will be unavailable\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("expr")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token scalar string"}},[s._v('\n        count(up{job="etcd"} == 0) > (count(up{job="etcd"}) / 2 - 1)')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("for")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 3m\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("severity")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" critical\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("p",[s._v("注意 label 标签一定至少要有 "),t("code",[s._v("prometheus=k8s")]),s._v(" 和 "),t("code",[s._v("role=alert-rules")]),s._v("，创建完成后，隔一会儿再去容器中查看下 rules 文件夹：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f prometheus-etcdRules.yaml")]),s._v("\nprometheusrule.monitoring.coreos.com/etcd-rules created\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl exec -it prometheus-k8s-0 -n monitoring -- /bin/sh")]),s._v("\n/prometheus $ "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" /etc/prometheus/rules/prometheus-k8s-rulefiles-0/\nmonitoring-alertmanager-main-rules-65684fa0-2ac2-44cb-8285-c600ef0337d9.yaml\nmonitoring-etcd-rules-e3dfc19b-5c7e-4671-b899-024400697208.yaml\nmonitoring-grafana-rules-94dbedc4-7498-4acb-942d-aac98fd61a0d.yaml\nmonitoring-kube-prometheus-rules-00aef2e2-2f47-4274-9c64-80e786f52959.yaml\nmonitoring-kube-state-metrics-rules-570164d9-a73a-4103-b1ca-32d2a0870ac1.yaml\nmonitoring-kubernetes-monitoring-rules-e6ac08d1-8378-4de7-add7-93532af0690f.yaml\nmonitoring-node-exporter-rules-5ebbb7d5-2e8b-44b7-bf88-b7de3916ac1e.yaml\nmonitoring-prometheus-k8s-prometheus-rules-26d84cbb-baf7-4654-b00d-05f66b4ddef0.yaml\nmonitoring-prometheus-operator-rules-cf0a2d8b-f9c8-48ff-87f2-664a1f95a34f.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("可以看到我们创建的 rule 文件已经被注入到了对应的 "),t("code",[s._v("rulefiles")]),s._v(" 文件夹下面了，证明我们上面的设想是正确的。然后再去 Prometheus Dashboard 的 Alert 页面下面就可以查看到上面我们新建的报警规则了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"img/image-20221015015420837.png",alt:"image-20221015015420837"}})]),s._v(" "),t("h3",{attrs:{id:"_2-3-配置报警"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-配置报警"}},[s._v("#")]),s._v(" 2.3 配置报警")]),s._v(" "),t("p",[s._v("我们知道了如何去添加一个报警规则配置项，但是这些报警信息用怎样的方式去发送呢？前面的课程中我们知道我们可以通过 AlertManager 的配置文件去配置各种报警接收器，现在我们是通过 Operator 提供的 alertmanager 资源对象创建的组件，应该怎样去修改配置呢？")]),s._v(" "),t("p",[s._v("首先我们去 Alertmanager 的页面上 "),t("code",[s._v("status")]),s._v(" 路径下面查看 AlertManager 的配置信息:")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get svc -n monitoring")]),s._v("\nNAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                         AGE\nalertmanager-main       NodePort    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.101")]),s._v(".111.78    "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9093")]),s._v(":31999/TCP,8080:32208/TCP   94m\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[t("img",{attrs:{src:"img/image-20221015015553181.png",alt:"image-20221015015553181"}})]),s._v(" "),t("p",[s._v("这些配置信息实际上是来自于前面创建的 "),t("code",[s._v("alertmanager-secret.yaml")]),s._v(" 文件：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat alertmanager-secret.yaml ")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Secret\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/component")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" alert"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("router\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/instance")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" main\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" alertmanager\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/part-of")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 0.24.0\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" alertmanager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("main\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" monitoring\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("stringData")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("alertmanager.yaml")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"global"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"resolve_timeout"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5m"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"inhibit_rules"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"equal"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespace"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alertname"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"source_matchers"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"severity = critical"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"target_matchers"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"severity =~ warning|info"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"equal"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespace"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alertname"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"source_matchers"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"severity = warning"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"target_matchers"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"severity = info"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"equal"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespace"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"source_matchers"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alertname = InfoInhibitor"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"target_matchers"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"severity = info"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"receivers"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"name"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Default"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"name"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Watchdog"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"name"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Critical"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"name"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"null"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"route"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"group_by"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespace"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"group_interval"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5m"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"group_wait"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"30s"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"receiver"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Default"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"repeat_interval"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"12h"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"routes"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"matchers"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alertname = Watchdog"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"receiver"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Watchdog"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"matchers"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alertname = InfoInhibitor"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"receiver"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"null"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"matchers"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"severity = critical"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"receiver"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Critical"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Opaque\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br"),t("span",{staticClass:"line-number"},[s._v("52")]),t("br"),t("span",{staticClass:"line-number"},[s._v("53")]),t("br"),t("span",{staticClass:"line-number"},[s._v("54")]),t("br"),t("span",{staticClass:"line-number"},[s._v("55")]),t("br"),t("span",{staticClass:"line-number"},[s._v("56")]),t("br"),t("span",{staticClass:"line-number"},[s._v("57")]),t("br"),t("span",{staticClass:"line-number"},[s._v("58")]),t("br"),t("span",{staticClass:"line-number"},[s._v("59")]),t("br"),t("span",{staticClass:"line-number"},[s._v("60")]),t("br")])]),t("p",[s._v("我们可以看到内容和上面查看的配置信息是一致的，所以如果我们想要添加自己的接收器，我们就可以直接更改这个文件，比如我们将 "),t("code",[s._v("Critical")]),s._v(" 这个接收器的报警信息都发送到邮件进行报警。")]),s._v(" "),t("p",[s._v("修改报警配置文件 "),t("code",[s._v("alertmanager-secret.yaml")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"global"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"smtp_smarthost"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"smtp.163.com:25"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"smtp_from"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"huo9190@163.com"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"smtp_auth_username"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"huo9190@163.com"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"smtp_auth_password"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"xx"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"smtp_hello"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"163.com"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"smtp_require_tls"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("false")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"resolve_timeout"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5m"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"name"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Critical"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"email_configs"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"to"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'130823919@qq.com'")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"send_resolved"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"route"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"group_by"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespace"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[s._v("修改完成后，重新更新这个资源对象：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl delete -f alertmanager-secret.yaml")]),s._v("\nsecret "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alertmanager-main"')]),s._v(" deleted\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f alertmanager-secret.yaml")]),s._v("\nsecret/alertmanager-main created\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl delete -f alertmanager-alertmanager.yaml")]),s._v("\nalertmanager.monitoring.coreos.com "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"main"')]),s._v(" deleted\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f alertmanager-alertmanager.yaml      ")]),s._v("\nalertmanager.monitoring.coreos.com/main created\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("更新完成后，很快我们就会收到的报警消息了，而且 AlertManager 页面的 status 页面的配置信息可以看到也已经变成上面我们的配置信息了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"img/image-20221015021012157.png",alt:"image-20221015021012157"}})]),s._v(" "),t("p",[s._v("到这里我们就完成了 Prometheus Operator 的自定义监控和报警。")]),s._v(" "),t("h2",{attrs:{id:"_3-高级配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-高级配置"}},[s._v("#")]),s._v(" 3. 高级配置")]),s._v(" "),t("p",[s._v("如果在我们的 Kubernetes 集群中有了很多的 Service/Pod，那么我们都需要一个一个的去建立一个对应的 "),t("code",[s._v("ServiceMonitor")]),s._v(" 对象来进行监控吗？这样岂不是又变得麻烦起来了？")]),s._v(" "),t("h3",{attrs:{id:"_3-1-自动发现配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-自动发现配置"}},[s._v("#")]),s._v(" 3.1 自动发现配置")]),s._v(" "),t("p",[s._v("为解决上面的问题，Prometheus Operator 为我们提供了一个额外的抓取配置的来解决这个问题，我们可以通过添加额外的配置来进行服务发现进行自动监控。和前面自定义的方式一样，我们可以在 Prometheus Operator 当中去自动发现并监控具有"),t("code",[s._v("prometheus.io/scrape=true")]),s._v(" 这个 "),t("code",[s._v("annotations")]),s._v(" 的 Service，之前我们定义的 Prometheus 的配置如下：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("job_name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubernetes-endpoints'")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetes_sd_configs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("role")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" endpoints\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("relabel_configs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_service_annotation_prometheus_io_scrape"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" keep\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_service_annotation_prometheus_io_scheme"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" replace\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_label")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" __scheme__\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" (https"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("?")]),s._v(")\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_service_annotation_prometheus_io_path"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" replace\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_label")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" __metrics_path__\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" (.+)\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__address__"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" __meta_kubernetes_service_annotation_prometheus_io_port"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" replace\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_label")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" __address__\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ("),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("^"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("+)("),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("?")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\\d+)"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("?")]),s._v(";(\\d+)\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replacement")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" $1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("$2\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" labelmap\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("regex")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" __meta_kubernetes_service_label_(.+)\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_namespace"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" replace\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_label")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes_namespace\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_service_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" replace\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_label")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes_name\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("source_labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("__meta_kubernetes_pod_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("action")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" replace\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target_label")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes_pod_name\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br")])]),t("p",[s._v("要想自动发现集群中的 Service，就需要我们在 Service 的 annotation 区域添加 "),t("code",[s._v("prometheus.io/scrape=true")]),s._v(" 的声明，将上面文件直接保存为 "),t("code",[s._v("prometheus-additional.yaml")]),s._v("，然后通过这个文件创建一个对应的 Secret 对象：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("$ kubectl create secret generic additional-configs --from-file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("prometheus-additional.yaml "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" monitoring\nsecret "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"additional-configs"')]),s._v(" created\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("然后我们需要在声明 prometheus 的资源对象文件中通过 "),t("code",[s._v("additionalScrapeConfigs")]),s._v(" 属性添加上这个额外的配置：(prometheus-prometheus.yaml)")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" monitoring.coreos.com/v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Prometheus\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/component")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/instance")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" k8s\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/part-of")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 2.39.1\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" k8s\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" monitoring\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("alerting")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("alertmanagers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v2\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" alertmanager"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("main\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" monitoring\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" web\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("enableFeatures")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("externalLabels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" quay.io/prometheus/prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("v2.39.1\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodeSelector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetes.io/os")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" linux\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podMetadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/component")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/instance")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" k8s\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/part-of")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("prometheus\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 2.39.1\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podMonitorNamespaceSelector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podMonitorSelector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("probeNamespaceSelector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("probeSelector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 400Mi\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ruleNamespaceSelector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ruleSelector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("securityContext")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("fsGroup")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2000")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("runAsNonRoot")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("runAsUser")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("serviceAccountName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("k8s\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("serviceMonitorNamespaceSelector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("serviceMonitorSelector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 2.39.1\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("additionalScrapeConfigs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" additional"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("configs\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("additional.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br"),t("span",{staticClass:"line-number"},[s._v("39")]),t("br"),t("span",{staticClass:"line-number"},[s._v("40")]),t("br"),t("span",{staticClass:"line-number"},[s._v("41")]),t("br"),t("span",{staticClass:"line-number"},[s._v("42")]),t("br"),t("span",{staticClass:"line-number"},[s._v("43")]),t("br"),t("span",{staticClass:"line-number"},[s._v("44")]),t("br"),t("span",{staticClass:"line-number"},[s._v("45")]),t("br"),t("span",{staticClass:"line-number"},[s._v("46")]),t("br"),t("span",{staticClass:"line-number"},[s._v("47")]),t("br"),t("span",{staticClass:"line-number"},[s._v("48")]),t("br"),t("span",{staticClass:"line-number"},[s._v("49")]),t("br"),t("span",{staticClass:"line-number"},[s._v("50")]),t("br"),t("span",{staticClass:"line-number"},[s._v("51")]),t("br")])]),t("p",[s._v("关于 "),t("code",[s._v("additionalScrapeConfigs")]),s._v(" 属性的具体介绍，我们可以使用 "),t("code",[s._v("kubectl explain")]),s._v(" 命令来了解详细信息：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl explain prometheus.spec.additionalScrapeConfigs")]),s._v("\nKIND:     Prometheus\nVERSION:  monitoring.coreos.com/v1\n\nRESOURCE: additionalScrapeConfigs "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Object"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\nDESCRIPTION:\n     AdditionalScrapeConfigs allows specifying a key of a Secret containing\n     additional Prometheus scrape configurations. Scrape configurations\n     specified are appended to the configurations generated by the Prometheus\n     Operator. Job configurations specified must have the form as specified "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v("\n     the official Prometheus documentation:\n     https://prometheus.io/docs/prometheus/latest/configuration/configuration/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#scrape_config.")]),s._v("\n     As scrape configs are appended, the user is responsible to "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),s._v(" sure it is\n     valid. Note that using this feature may expose the possibility to "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("break")]),s._v("\n     upgrades of Prometheus. It is advised to review Prometheus release notes to\n     ensure that no incompatible scrape configs are going to "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("break")]),s._v(" Prometheus\n     after the upgrade.\n\nFIELDS:\n   key  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("string"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" -required-\n     The key of the secret to "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" from. Must be a valid secret key.\n\n   name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("string"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n     Name of the referent. More info:\n     https://kubernetes.io/docs/concepts/overview/working-with-objects/names/"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#names")]),s._v("\n     TODO: Add other useful fields. apiVersion, kind, uid?\n\n   optional     "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("boolean"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n     Specify whether the Secret or its key must be defined\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br")])]),t("p",[s._v("添加完成后，直接更新 prometheus 这个 CRD 资源对象即可：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f prometheus-prometheus.yaml")]),s._v("\nprometheus.monitoring.coreos.com/k8s configured\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("隔一小会儿，可以前往 Prometheus 的 Dashboard 中查看配置已经生效了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"img/image-20221015021809517.png",alt:"image-20221015021809517"}})]),s._v(" "),t("p",[s._v("但是我们切换到 targets 页面下面却并没有发现对应的监控任务，查看 Prometheus 的 Pod 日志：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl logs -f prometheus-k8s-0 prometheus -n monitoring")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ts")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-10-14T18:19:45.430Z "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("caller")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("klog.go:116 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("level")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("error "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("component")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("k8s_client_runtime "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("func")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ErrorDepth "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("msg")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pkg/mod/k8s.io/client-go@v0.25.1/tools/cache/reflector.go:169: Failed to watch *v1.Pod: failed to list *v1.Pod: pods is forbidden: User '),t("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("system:serviceaccount:monitoring:prometheus-k8s"),t("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(" cannot list resource "),t("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("pods"),t("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(" in API group "),t("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),t("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(' at the cluster scope"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ts")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-10-14T18:19:50.307Z "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("caller")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("klog.go:108 "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("level")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("warn "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("component")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("k8s_client_runtime "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("func")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Warningf "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("msg")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pkg/mod/k8s.io/client-go@v0.25.1/tools/cache/reflector.go:169: failed to list *v1.Service: services is forbidden: User '),t("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("system:serviceaccount:monitoring:prometheus-k8s"),t("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(" cannot list resource "),t("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("services"),t("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(" in API group "),t("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),t("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(' at the cluster scope"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("可以看到有很多错误日志出现，都是 "),t("code",[s._v("xxx is forbidden")]),s._v("，这说明是 RBAC 权限的问题，通过 prometheus 资源对象的配置可以知道 Prometheus 绑定了一个名为 "),t("code",[s._v("prometheus-k8s")]),s._v(" 的 ServiceAccount 对象，而这个对象绑定的是一个名为 "),t("code",[s._v("prometheus-k8s")]),s._v(" 的 ClusterRole：（prometheus-clusterRole.yaml）")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io/v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterRole\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/component")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/instance")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" k8s\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/part-of")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 2.39.1\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("k8s\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rules")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiGroups")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" nodes/metrics\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("verbs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" get\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nonResourceURLs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /metrics\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("verbs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" get\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("p",[s._v("上面的权限规则中我们可以看到明显没有对 Service 或者 Pod 的 "),t("code",[s._v("list")]),s._v(" 权限，所以报错了，要解决这个问题，我们只需要添加上需要的权限即可：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io/v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterRole\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/component")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/instance")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" k8s\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/part-of")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("prometheus\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 2.39.1\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prometheus"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("k8s\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rules")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiGroups")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" nodes\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" services\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" endpoints\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" pods\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" nodes/proxy\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("verbs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" get\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" list\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" watch\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiGroups")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" configmaps\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" nodes/metrics\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("verbs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" get\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nonResourceURLs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" /metrics\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("verbs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" get\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br")])]),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl apply -f prometheus-clusterRole.yaml")]),s._v("\nclusterrole.rbac.authorization.k8s.io/prometheus-k8s configured\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl delete pod prometheus-k8s-0 -n monitoring")]),s._v("\npod "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"prometheus-k8s-0"')]),s._v(" deleted\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl delete pod prometheus-k8s-1 -n monitoring ")]),s._v("\npod "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"prometheus-k8s-1"')]),s._v(" deleted\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("root@master manifests"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pods -n monitoring  ")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("更新上面的 "),t("code",[s._v("ClusterRole")]),s._v(" 这个资源对象，然后重建下 Prometheus 的所有 Pod，正常就可以看到 targets 页面下面有 "),t("code",[s._v("kubernetes-endpoints")]),s._v(" 这个监控任务了：")]),s._v(" "),t("p",[t("img",{attrs:{src:"img/image-20221015022318444.png",alt:"image-20221015022318444"}})]),s._v(" "),t("p",[s._v("这里发现的几个抓取目标是因为 Service 中都有 "),t("code",[s._v("prometheus.io/scrape=true")]),s._v(" 这个 annotation。：")]),s._v(" "),t("p",[s._v("到这里 Prometheus Operator 的一些基本配置就算完成了，对于大型的监控集群还需要做一些其他配置，比如前面我们学习的使用 "),t("code",[s._v("Thanos")]),s._v(" 来做 Prometheus 集群的高可用以及数据远程存储，关于 prometheus operator 中如何配置 thanos，可以查看官方文档的介绍：https://github.com/coreos/prometheus-operator/blob/master/Documentation/thanos.md，配置和前面学的Thanos一样。")])])}),[],!1,null,null,null);t.default=n.exports}}]);