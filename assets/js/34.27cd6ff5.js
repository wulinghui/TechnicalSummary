(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{393:function(s,t,a){"use strict";a.r(t);var e=a(7),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"chart-hooks"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#chart-hooks"}},[s._v("#")]),s._v(" Chart Hooks")]),s._v(" "),t("p",[s._v("Helm 也提供了一种 Hook 机制，可以允许 chart 开发人员在 release 生命周期的某些时间点进行干预。比如，可以使用 hook 来进行下面的操作：")]),s._v(" "),t("ul",[t("li",[s._v("在加载任何 charts 之前，在安装的时候加载 ConfigMap 或者 Secret")]),s._v(" "),t("li",[s._v("在安装新的 chart 之前，执行一个 Job 来备份数据库，然后在升级后执行第二个 Job 还原数据")]),s._v(" "),t("li",[s._v("在删除 release 之前运行一个 JOb，以在删除 release 之前适当地取消相关服务")])]),s._v(" "),t("p",[s._v("Hooks 的工作方式类似于普通的模板，但是他们具有特殊的注解，这些注解使 Helm 可以用不同的方式来使用他们。")]),s._v(" "),t("h2",{attrs:{id:"_1-hooks"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-hooks"}},[s._v("#")]),s._v(" 1. Hooks")]),s._v(" "),t("p",[s._v("在 Helm 中定义了如下一些可供我们使用的 Hooks：")]),s._v(" "),t("ul",[t("li",[s._v("预安装"),t("code",[s._v("pre-install")]),s._v("：在模板渲染后，kubernetes 创建任何资源之前执行")]),s._v(" "),t("li",[s._v("安装后"),t("code",[s._v("post-install")]),s._v("：在所有 kubernetes 资源安装到集群后执行")]),s._v(" "),t("li",[s._v("预删除"),t("code",[s._v("pre-delete")]),s._v("：在从 kubernetes 删除任何资源之前执行删除请求")]),s._v(" "),t("li",[s._v("删除后"),t("code",[s._v("post-delete")]),s._v("：删除所有 release 的资源后执行")]),s._v(" "),t("li",[s._v("升级前"),t("code",[s._v("pre-upgrade")]),s._v("：在模板渲染后，但在任何资源升级之前执行")]),s._v(" "),t("li",[s._v("升级后"),t("code",[s._v("post-upgrade")]),s._v("：在所有资源升级后执行")]),s._v(" "),t("li",[s._v("预回滚"),t("code",[s._v("pre-rollback")]),s._v("：在模板渲染后，在任何资源回滚之前执行")]),s._v(" "),t("li",[s._v("回滚后"),t("code",[s._v("post-rollback")]),s._v("：在修改所有资源后执行回滚请求")]),s._v(" "),t("li",[s._v("测试"),t("code",[s._v("test")]),s._v("：在调用 Helm "),t("code",[s._v("test")]),s._v(" 子命令的时候执行（可以查看"),t("a",{attrs:{href:"https://helm.sh/docs/chart_tests/",target:"_blank",rel:"noopener noreferrer"}},[s._v("测试文档"),t("OutboundLink")],1),s._v("）")])]),s._v(" "),t("h2",{attrs:{id:"_2-生命周期"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-生命周期"}},[s._v("#")]),s._v(" 2. 生命周期")]),s._v(" "),t("p",[s._v("Hooks 允许开发人员在 release 的生命周期中的一些关键节点执行一些钩子函数，我们正常安装一个 chart 包的时候的生命周期如下所示：")]),s._v(" "),t("ul",[t("li",[s._v("用户运行 "),t("code",[s._v("helm install foo")])]),s._v(" "),t("li",[s._v("Helm 库文件调用安装 API")]),s._v(" "),t("li",[s._v("经过一些验证，Helm 库渲染 "),t("code",[s._v("foo")]),s._v(" 模板")]),s._v(" "),t("li",[s._v("Helm 库将产生的资源加载到 kubernetes 中去")]),s._v(" "),t("li",[s._v("Helm 库将 release 对象和其他数据返回给客户端")]),s._v(" "),t("li",[s._v("Helm 客户端退出")])]),s._v(" "),t("p",[s._v("如果开发人员在 "),t("code",[s._v("install")]),s._v(" 的生命周期中定义了两个 hook："),t("code",[s._v("pre-install")]),s._v("和"),t("code",[s._v("post-install")]),s._v("，那么我们安装一个 chart 包的生命周期就会多一些步骤了：")]),s._v(" "),t("ul",[t("li",[s._v("用户运行"),t("code",[s._v("helm install foo")])]),s._v(" "),t("li",[s._v("Helm 库文件调用安装 API")]),s._v(" "),t("li",[s._v("在 "),t("code",[s._v("crds/")]),s._v(" 目录下面的 CRDs 被安装")]),s._v(" "),t("li",[s._v("经过一些验证，Helm 库渲染 "),t("code",[s._v("foo")]),s._v(" 模板")]),s._v(" "),t("li",[s._v("Helm 库将 hook 资源加载到 kubernetes 中，准备执行"),t("code",[s._v("pre-install")]),s._v(" hooks")]),s._v(" "),t("li",[s._v("Helm 库会根据权重对 hooks 进行排序（默认分配权重0，权重相同的 hook 按升序排序）")]),s._v(" "),t("li",[s._v("Helm 库然后加载最低权重的 hook")]),s._v(" "),t("li",[s._v("Helm 库会等待，直到 hook 准备就绪")]),s._v(" "),t("li",[s._v("Helm 库将产生的资源加载到 kubernetes 中，注意如果添加了 "),t("code",[s._v("--wait")]),s._v(" 参数，Helm 库会等待所有资源都准备好，在这之前不会运行 "),t("code",[s._v("post-install")]),s._v(" hook")]),s._v(" "),t("li",[s._v("Helm 库执行 "),t("code",[s._v("post-install")]),s._v(" hook（加载 hook 资源）")]),s._v(" "),t("li",[s._v("Helm 库等待，直到 hook 准备就绪")]),s._v(" "),t("li",[s._v("Helm 库将 release 对象和其他数据返回给客户端")]),s._v(" "),t("li",[s._v("Helm 客户端退出")])]),s._v(" "),t("p",[s._v("等待 hook 准备就绪，这是一个阻塞的操作，如果 hook 中声明的是一个 Job 资源，Helm 将等待 Job 成功完成，如果失败，则发布失败，在这个期间，Helm 客户端是处于暂停状态的。")]),s._v(" "),t("p",[s._v("对于所有其他类型，只要 kubernetes 将资源标记为加载（添加或更新），资源就被视为就绪状态，当一个 hook 声明了很多资源时，这些资源是被串行执行的。")]),s._v(" "),t("p",[s._v("另外需要注意的是 hook 创建的资源不会作为 release 的一部分进行跟踪和管理，一旦 Helm 验证了 hook 已经达到了就绪状态，它就不会去管它了。")]),s._v(" "),t("p",[s._v("所以，如果我们在 hook 中创建了资源，那么不能依赖 "),t("code",[s._v("helm uninstall")]),s._v(" 去删除资源，因为 hook 创建的资源已经不受控制了，要销毁这些资源，你需要将 "),t("code",[s._v("helm.sh/hook-delete-policy")]),s._v(" 这个 annotation 添加到 hook 模板文件中，或者设置 "),t("a",{attrs:{href:"https://kubernetes.io/docs/concepts/workloads/controllers/ttlafterfinished/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Job 资源的生存（TTL）字段"),t("OutboundLink")],1),s._v("。")]),s._v(" "),t("h2",{attrs:{id:"_3-编写-hook"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-编写-hook"}},[s._v("#")]),s._v(" 3. 编写 Hook")]),s._v(" "),t("p",[s._v("Hooks 就是 Kubernetes 资源清单文件，在元数据部分带有一些特殊的注解，因为他们是模板文件，所以你可以使用普通模板所有的功能，包括读取 "),t("code",[s._v(".Values")]),s._v("、"),t("code",[s._v(".Release")]),s._v(" 和 "),t("code",[s._v(".Template")]),s._v("。")]),s._v(" "),t("p",[s._v("例如，在 "),t("code",[s._v("templates/post-install-job.yaml")]),s._v(" 文件中声明一个 post-install 的 hook：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" batch/v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Job\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ .Release.Name }}"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/managed-by")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" .Release.Service "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" quote "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/instance")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" .Release.Name "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" quote "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" .Chart.AppVersion "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("helm.sh/chart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ .Chart.Name }}-{{ .Chart.Version }}"')]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("annotations")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 因为添加了这个 hook，所以我们这个资源被定义为了 hook")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果没有这行，则当前这个 Job 会被当成 release 的一部分内容。")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"helm.sh/hook"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" post"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("install\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"helm.sh/hook-weight"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-5"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"helm.sh/hook-delete-policy"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" hook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("succeeded\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ .Release.Name }}"')]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/managed-by")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" .Release.Service "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" quote "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app.kubernetes.io/instance")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" .Release.Name "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),s._v(" quote "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("helm.sh/chart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{{ .Chart.Name }}-{{ .Chart.Version }}"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restartPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Never\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" post"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("install"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("job\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"alpine:3.3"')]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/bin/sleep"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v('"'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(' default "10" .Values.sleepyTime '),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v('"'),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br")])]),t("p",[s._v("当前这个模板成为 hook 的原因就是添加这个注解：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("annotations")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"helm.sh/hook"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" post"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("install\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("一种资源也可以实现多个 hooks：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("annotations")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"helm.sh/hook"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" post"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("install"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("post"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("upgrade\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("类似的，实现给定 hook 的资源数量也没有限制，比如可以将 secret 和一个 configmap 都声明为 "),t("code",[s._v("pre-install")]),s._v(" hook。")]),s._v(" "),t("p",[s._v("当子 chart 声明 hooks 的时候，也会对其进行调用，顶层的 chart 无法禁用子 chart 所声明的 hooks。可以为 hooks 定义权重，这将有助于确定 hooks 的执行顺序：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("annotations")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"helm.sh/hook-weight"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"5"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("hook 权重可以是正数也可以是负数，但是必须用字符串表示，当 Helm 开始执行特定种类的 hooks 的时候，它将以升序的方式对这些 hooks 进行排序。")]),s._v(" "),t("h2",{attrs:{id:"_4-hook-删除策略"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-hook-删除策略"}},[s._v("#")]),s._v(" 4. Hook 删除策略")]),s._v(" "),t("p",[s._v("我们还可以定义确定何时删除相应 hook 资源的策略，hook 删除策略可以使用下面的注解进行定义：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("annotations")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v('"helm.sh/hook-delete-policy"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" before"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("hook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("creation"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("hook"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("succeeded\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("我们也可以选择一个或多个已定义的注解：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("before-hook-creation")]),s._v("：运行一个新的 hook 之前删除前面的资源（默认）")]),s._v(" "),t("li",[t("code",[s._v("hook-succeeded")]),s._v("：hook 成功执行后删除资源")]),s._v(" "),t("li",[t("code",[s._v("hook-failed")]),s._v("：hook 如果执行失败则删除资源")])]),s._v(" "),t("p",[s._v("如果未指定任何 hook 删除策略注解，则默认情况下会使用 "),t("code",[s._v("before-hook-creation")]),s._v(" 策略。")])])}),[],!1,null,null,null);t.default=n.exports}}]);